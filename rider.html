<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø±Ø§ÙƒØ¨ - ØªÙƒØ³ÙŠ Ø§Ù„Ø¹Ø±Ø§Ù‚ Ø§Ù„Ø´Ø§Ù…Ù„</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2e7d32">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="/icons/icon-192x192.png">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body,html{margin:0;padding:0;height:100%;font-family:Tahoma;}
#map{height:60vh;}
#panel{background:#fff;text-align:center;padding:10px;box-shadow:0 -2px 5px rgba(0,0,0,0.2);}
button{background:#ffca28;border:none;padding:10px 20px;border-radius:8px;font-weight:bold;cursor:pointer;margin:5px;}

/* Ù†Ù…Ø· Ø¬Ø¯ÙŠØ¯ Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ù„ØªÙƒØ¨ÙŠØ± ÙˆØªØ«Ø®ÙŠÙ† Ø§Ù„Ø®Ø· */
#panel p#status {
    font-size: 1.2em; /* ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø· */
    font-weight: bold; /* ØªØ«Ø®ÙŠÙ† Ø§Ù„Ø®Ø· */
    margin: 10px 0;
    line-height: 1.6;
    color: #333;
}

#searchContainer{margin:10px 0;padding:0 10px;}
#searchInput{
    width:100%;padding:10px;border:1px solid #ccc;border-radius:5px;
    font-size:16px;box-sizing:border-box;direction:rtl;
}
#searchResults{
    list-style:none;padding:0;margin:5px 0 0;max-height:150px;overflow-y:auto;
    border:1px solid #eee;border-radius:5px;box-shadow:0 1px 3px rgba(0,0,0,0.1);
    display:none;text-align:right;
}
#searchResults li{
    padding:10px;border-bottom:1px solid #eee;cursor:pointer;font-size:15px;background:#fff;
}
#searchResults li:hover{background:#f0f0f0;}
#searchResults li:last-child{border-bottom:none;}

#logoutBtn{background:#607d8b;color:white;margin-top:10px;width:95%;}

/* Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ */
#driverInfo{
    font-size: 1.1em;
    color: #4CAF50;
    font-weight: bold;
    margin-top: 10px;
    display:none;
}
.phone-link {
    color: #007bff;
    text-decoration: none;
    font-weight: bold;
    display: block;
    margin-top: 5px;
}
.phone-link:hover {
    text-decoration: underline;
}
</style>
</head>
<body>

<div id="map"></div>

<div id="panel">
  <h3>ğŸš– Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>

  <div id="searchContainer">
      <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© (Ù…Ù†Ø·Ù‚Ø©ØŒ Ø´Ø§Ø±Ø¹...)">
      <ul id="searchResults"></ul>
  </div>

  <p id="status">ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø§Ù„Ø¢Ù†...</p>
  <div id="driverInfo"></div> <button id="sendRide" disabled>Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
  <button id="cancelRideBtn" style="display:none;background:#E53935;color:white;">âŒ Ø¥Ù†Ù‡Ø§Ø¡/Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>

  <button id="logoutBtn" onclick="window.logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</div>

<script>
// ØªÙ‡ÙŠØ¦Ø© Firebase
const app=firebase.initializeApp({
  apiKey:"AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M",
  authDomain:"taxi-15314.firebaseapp.com",
  databaseURL:"https://taxi-15314-default-rtdb.firebaseio.com/",
  projectId:"taxi-15314"
});
const db=firebase.database();

// Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
let map=L.map('map').setView([33.3152,44.3661],13);

L.tileLayer(
  "https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}&key=AIzaSyD7TtwniAdUtB8-pnTny4ZwE6gqX36SGUk",
  { maxZoom: 20 }
).addTo(map);

map.whenReady(()=>map.invalidateSize());

// ---------------- Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø© ÙˆØ§Ù„Ø®Ø±ÙŠØ·Ø© ----------------
let startCoords=null,endCoords=null;
let startMarker=null,endMarker=null;
let rideId=null;

let startAreaName="Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ"; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„
let endAreaName="Ø§Ù„ÙˆØ¬Ù‡Ø©"; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„

let driverMarker=null;
let driverRoute=null;
let rideRef=null; 
let driverRef=null; 
let currentDriverPhone=null;

const sendBtn=document.getElementById("sendRide");
const endBtn=document.getElementById("cancelRideBtn");
const searchInput=document.getElementById('searchInput');
const searchResultsUl=document.getElementById('searchResults');
const searchContainer=document.getElementById('searchContainer');
const driverInfoDiv=document.getElementById('driverInfo');
const logoutBtn=document.getElementById('logoutBtn'); // Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø¬Ø¹ Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬

const SEARCH_DELAY=500;
let searchInputTimer=null;

// ---------------- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ§Ù„ØªÙ†Ø¸ÙŠÙ ÙˆØ§Ù„Ù…Ø³Ø§Ø± ----------------

// Ø§Ù„Ø¯Ø§Ù„Ø©: Ø§Ø³ØªØ®Ù„Ø§Øµ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£Ù‚ØµØ± Ù„Ù„Ù…Ù†Ø·Ù‚Ø© (Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·)
function getShortAreaName(fullArea) {
    if (!fullArea) return "Ù…Ù†Ø·Ù‚Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©";
    const parts = fullArea.split(',').map(p => p.trim()).filter(p => p.length > 0);
    
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø°ÙŠ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙƒÙ„Ù…Ø§Øª Ø¥Ø¯Ø§Ø±ÙŠØ©
    const relevantParts = parts.filter(p => 
        !p.includes("Ù‚Ø¶Ø§Ø¡") && 
        !p.includes("Ù†Ø§Ø­ÙŠØ©") && 
        !p.includes("Ù…Ø±ÙƒØ²") &&
        !p.includes("Ø¨ØºØ¯Ø§Ø¯") 
    );

    if (relevantParts.length > 0) {
        // Ù†Ø£Ø®Ø° Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£ÙƒØ«Ø± Ø¯Ù‚Ø© (Ø¹Ø§Ø¯Ø© Ø§Ù„Ø£Ù‚Ø±Ø¨ Ù„Ù„Ø¨Ø¯Ø§ÙŠØ© ÙÙŠ Ø³Ù„Ø³Ù„Ø© Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†)
        return relevantParts[0]; 
    }
    
    // Ø¥Ø°Ø§ Ù„Ù… ØªÙ†Ø¬Ø­ Ø§Ù„ÙÙ„ØªØ±Ø©ØŒ Ù†Ø£Ø®Ø° Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£Ø®ÙŠØ± (Ø§Ù„Ø£ÙƒØ«Ø± Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ø³Ù… Ø§Ù„Ø­ÙŠ)
    return parts[parts.length - 1]; 
}

function clearRideMarkers(){
    // ÙŠØªÙ… Ø¥Ø²Ø§Ù„Ø© Ù…Ø¤Ø´Ø± Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø±Ø³ÙˆÙ…
    if(driverMarker) map.removeLayer(driverMarker);
    if(driverRoute) map.removeLayer(driverRoute);
    driverMarker = null;
    driverRoute = null;
}

// Ø¯Ø§Ù„Ø© Ø±Ø³Ù… Ù…Ø³Ø§Ø± Ø­Ù‚ÙŠÙ‚ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø´ÙˆØ§Ø±Ø¹ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… OSRM
async function drawStreetRoute(lat1, lng1, lat2, lng2, color, dashArray = '') {
    // Ø®Ø¯Ù…Ø© OSRM ØªØªØ·Ù„Ø¨ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø¨ØµÙŠØºØ©: lng,lat
    const OSRM_URL = `https://router.project-osrm.org/route/v1/driving/${lng1},${lat1};${lng2},${lat2}?geometries=geojson&overview=full`;
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø±Ø³Ù… (Ù†ÙØ²ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø± ÙÙ‚Ø·ØŒ Ù„Ø£Ù† Ù…Ø¤Ø´Ø± Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ ÙÙŠ startMonitoringDriver)
    if(driverRoute) map.removeLayer(driverRoute); 
    driverRoute = null;
    
    try {
        const response = await fetch(OSRM_URL);
        const data = await response.json();

        if (data.code !== 'Ok' || !data.routes || data.routes.length === 0) {
            console.error('OSRM route calculation failed or no route found. Falling back to straight line.');
            // Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨Ø³ÙŠØ· ÙÙŠ Ø­Ø§Ù„ Ø§Ù„ÙØ´Ù„
            driverRoute = L.polyline([[lat1, lng1], [lat2, lng2]], { color: color, dashArray: dashArray, weight: 5 }).addTo(map);
        } else {
            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø§Ø± Ù…Ù† Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© (Ø¨ØµÙŠØºØ© GeoJSON: [lng, lat])
            const geojsonCoords = data.routes[0].geometry.coordinates;

            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø¥Ù„Ù‰ ØµÙŠØºØ© Leaflet ([lat, lng])
            const leafletCoords = geojsonCoords.map(coord => [coord[1], coord[0]]);

            driverRoute = L.polyline(leafletCoords, { color: color, dashArray: dashArray, weight: 5 }).addTo(map);
        }
        
        map.fitBounds(driverRoute.getBounds());

    } catch (error) {
        console.error('Error fetching route from OSRM. Falling back to straight line.', error);
        // Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨Ø³ÙŠØ· ÙÙŠ Ø­Ø§Ù„ Ø§Ù„ÙØ´Ù„
        driverRoute = L.polyline([[lat1, lng1], [lat2, lng2]], { color: color, dashArray: dashArray, weight: 5 }).addTo(map);
        map.fitBounds(driverRoute.getBounds());
    }
}


function cleanupRide(){
    if(rideRef) rideRef.off();
    if(driverRef) driverRef.off();
    rideRef = null;
    driverRef = null;
    currentDriverPhone = null;
    localStorage.removeItem('activeRideId');
    clearRideMarkers();
    
    endBtn.style.display='none';
    sendBtn.style.display='inline-block';
    searchContainer.style.display='block';
    driverInfoDiv.style.display='none';
    driverInfoDiv.innerHTML = '';
    logoutBtn.style.display='inline-block'; // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
}

async function startMonitoringDriver(driverPhone, startLat, startLng, endLat, endLng, rideStatus){
    driverRef = db.ref("drivers/"+driverPhone);
    
    driverRef.on('value', async snap => { // Ø¬Ø¹Ù„ on('value') ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù†Ø©
        const d = snap.val();
        if(!d || !d.lat || !d.lng) return;

        const driverCoords = [d.lat, d.lng];
        
        // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚
        driverInfoDiv.innerHTML = `Ø§Ù„Ø³Ø§Ø¦Ù‚: ${driverPhone} | Ø§Ù„Ø­Ø§Ù„Ø©: ${d.status || 'Ù…ØªØµÙ„'}`;

        // ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø± Ø§Ù„Ø³Ø§Ø¦Ù‚
        if(driverMarker) map.removeLayer(driverMarker);
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ§ÙƒØ³ÙŠ Ø§Ù„Ù…Ù…ÙŠØ²Ø©
        driverMarker = L.marker(driverCoords, {
            icon: L.divIcon({
                className: 'custom-driver-icon',
                html: 'ğŸš•', 
                iconSize: [30, 30]
            })
        }).addTo(map).bindPopup("Ø§Ù„Ø³Ø§Ø¦Ù‚").openPopup();
        
        // Ù…Ù†Ø·Ù‚ Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø±: Ù†Ø±Ø³Ù… ÙÙ‚Ø· Ø¹Ù†Ø¯Ù…Ø§ ØªÙƒÙˆÙ† Ø§Ù„Ø­Ø§Ù„Ø© "Ù…Ù‚Ø¨ÙˆÙ„Ø©" (Ø£ÙŠ ÙÙŠ Ø·Ø±ÙŠÙ‚Ù‡ Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø±Ø§ÙƒØ¨)
        if (rideStatus === "Ù…Ù‚Ø¨ÙˆÙ„Ø©" && startLat && startLng) {
            // Ø§Ù„Ù…Ø³Ø§Ø± Ù…Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø§ÙƒØ¨ (Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©)
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ø­Ø§Ù„ÙŠØ© d.lat, d.lng
            await drawStreetRoute(d.lat, d.lng, startLat, startLng, '#4CAF50', '5, 5'); 
        } else {
            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª "Ø¨Ø¯Ø£Øª" Ø£Ùˆ Ø­Ø§Ù„Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§ ØªØªØ·Ù„Ø¨ ØªØªØ¨Ø¹ Ø§Ù„ÙˆØµÙˆÙ„ØŒ Ù†Ø²ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø±
            if(driverRoute) map.removeLayer(driverRoute);
            driverRoute = null;
        }
        
        // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ù‚Ø¨ÙˆÙ„Ø©/Ø¨Ø¯Ø£Øª
        map.setView(driverCoords, map.getZoom() > 14 ? map.getZoom() : 14);

    });
}

function startMonitoringRide(id){
    rideRef = db.ref("rides/"+id);
    endBtn.style.display='inline-block';
    sendBtn.style.display='none';
    searchContainer.style.display='none';

    // ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ù…Ø¶Ø§ÙØ© Ø­Ø¯ÙŠØ«Ø§Ù‹ Ù„Ø¬Ø¹Ù„ Ø§Ù„Ø£Ø¬Ø±Ø© ÙˆØ§Ù„Ù…Ø³Ø§ÙØ© Ø¨Ø§Ø±Ø²Ø©
    const fareStyle = "font-size: 1em; font-weight: bold; color: #E53935;"; 
    const distanceStyle = "font-size: 1em; font-weight: bold; color: #455A64;"; 

    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø­Ù„Ø©
    rideRef.on('value', snap => {
        const r = snap.val();
        if(!r) {
            cleanupRide();
            document.getElementById("status").innerHTML=`âš ï¸ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø±Ø­Ù„Ø© Ø£Ùˆ Ø£Ù„ØºÙŠØª Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù….`;
            return;
        }
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const r_startLat = r.startLat;
        const r_startLng = r.startLng;
        const r_endLat = r.endLat;
        const r_endLng = r.endLng;

        const distance = r.distance || 0;
        const fare = r.fare ? r.fare.toLocaleString('ar-IQ') : '---';
        
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø¬ÙˆÙ… ÙˆØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ
        let statusHtml = `Ø§Ù„Ù…Ø³Ø§ÙØ©: <span style="${distanceStyle}">${distance} ÙƒÙ…</span> â€” Ø§Ù„Ø£Ø¬Ø±Ø©: <span style="${fareStyle}">${fare} Ø¯.Ø¹</span><br>`;
        
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø±Ø§Ø¨Ø· Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù„ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ ÙÙŠ Ø§Ù„Ø­Ø§Ù„ØªÙŠÙ† (Ù…Ù‚Ø¨ÙˆÙ„Ø© ÙˆØ¨Ø¯Ø£Øª)
        let driverPhoneHtml = '';
        if (r.driverPhone) {
            driverPhoneHtml = `<a href="tel:${r.driverPhone}" class="phone-link">ğŸ“ Ø§ØªØµÙ„ Ø¨Ø§Ù„Ø³Ø§Ø¦Ù‚: ${r.driverPhone}</a>`;
        }
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª
        if (r.status === "Ø¬Ø¯ÙŠØ¯Ø©") {
            document.getElementById("status").innerHTML=`âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„. ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚...<br>` + statusHtml;
            driverInfoDiv.style.display='none';
            // Ù†Ø¶Ù…Ù† Ù…Ø³Ø­ Ø£ÙŠ Ù…Ø³Ø§Ø± Ø£Ùˆ Ø³Ø§Ø¦Ù‚ Ù‚Ø¯ÙŠÙ…
            clearRideMarkers();
            logoutBtn.style.display='inline-block'; // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø²Ø±
            
        } else if (r.status === "Ù…Ù‚Ø¨ÙˆÙ„Ø©" && r.driverPhone) {
            
            const shortStartArea = getShortAreaName(r.startArea);
            document.getElementById("status").innerHTML=`ğŸš– ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©! Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù‚Ø§Ø¯Ù… Ø¥Ù„ÙŠÙƒ (${shortStartArea}).<br>` + statusHtml + driverPhoneHtml;
            driverInfoDiv.style.display='block';
            
            // Ø§Ù„Ø¨Ø¯Ø¡ Ø¨ØªØªØ¨Ø¹ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø¥Ù„ÙŠÙ‡
            if (r.driverPhone !== currentDriverPhone) {
                if(driverRef) driverRef.off(); 
                currentDriverPhone = r.driverPhone;
                // Ù†Ù…Ø±Ø± Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø±Ø§ÙƒØ¨ ÙˆØ§Ù„ÙˆØ¬Ù‡Ø© ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ø±Ø­Ù„Ø©
                startMonitoringDriver(r.driverPhone, r_startLat, r_startLng, r_endLat, r_endLng, r.status);
            } else if(driverRef) {
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³Ø§Ø± Ø­ØªÙ‰ Ù„Ùˆ Ù„Ù… ÙŠØªØºÙŠØ± Ø§Ù„Ø³Ø§Ø¦Ù‚ (Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø±Ø³Ù…Ù‡)
                startMonitoringDriver(r.driverPhone, r_startLat, r_startLng, r_endLat, r_endLng, r.status);
            }
            logoutBtn.style.display='none'; // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
            
        } else if (r.status === "Ø¨Ø¯Ø£Øª") {
             // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø§Ø¨Ø· Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ù„Ø©
             const shortEndArea = getShortAreaName(r.endArea);
             // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø¬ÙˆÙ…
             document.getElementById("status").innerHTML=`ğŸš¦ Ø§Ù„Ø±Ø­Ù„Ø© Ø¨Ø¯Ø£Øª! ÙÙŠ Ø·Ø±ÙŠÙ‚Ùƒ Ø¥Ù„Ù‰ ${shortEndArea}<br>` + statusHtml + driverPhoneHtml;
             driverInfoDiv.style.display='block';

             // ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ (Ù…Ø¹ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø± Ø¯Ø§Ø®Ù„ÙŠØ§Ù‹ ÙÙŠ startMonitoringDriver)
             if (r.driverPhone !== currentDriverPhone) {
                if(driverRef) driverRef.off(); 
                currentDriverPhone = r.driverPhone;
                startMonitoringDriver(r.driverPhone, r_startLat, r_startLng, r_endLat, r_endLng, r.status);
            } else if(driverRef) {
                startMonitoringDriver(r.driverPhone, r_startLat, r_startLng, r_endLat, r_endLng, r.status);
            }
            logoutBtn.style.display='none'; // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
             
        } else if (r.status === "Ù…Ù†ØªÙ‡ÙŠØ©" || r.status === "Ù…Ù„ØºØ§Ø©" || r.status === "Ù…Ø±ÙÙˆØ¶Ø©") {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø¬ÙˆÙ…
            document.getElementById("status").innerHTML=`Ø§Ù„Ø±Ø­Ù„Ø© ${r.status}.`;
            cleanupRide(); 
        }
    });
}

// ---------------- Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ----------------

// reverse geocode
async function reverseGeocode(lat,lon){
  const url=`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=ar`;
  try{
    const r=await fetch(url);const d=await r.json();
    // Ù†Ø±Ø¬Ø¹ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ÙØµÙ„ (Ø§Ù„Ù…Ù‚ØµÙˆØµ) ÙˆÙ†Ø³ØªØ®Ø¯Ù… getShortAreaName Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·
    if(d&&d.display_name) return d.display_name.split(',').slice(0,3).reverse().join(', ');
    return `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
  }catch{return `${lat.toFixed(4)}, ${lon.toFixed(4)}`;}
}

// ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹
navigator.geolocation.getCurrentPosition(async pos=>{
  startCoords=[pos.coords.latitude,pos.coords.longitude];
  if(startMarker) map.removeLayer(startMarker);
  startMarker=L.marker(startCoords).addTo(map).bindPopup("ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ").openPopup();
  map.setView(startCoords,15);

  startAreaName=await reverseGeocode(startCoords[0],startCoords[1]);
  const shortStartArea = getShortAreaName(startAreaName); // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø®ØªØµØ± Ù„Ù„Ø¹Ø±Ø¶
  document.getElementById("status").innerHTML=`ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ: <b>${shortStartArea}</b><br>Ø­Ø¯Ø¯ Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ©.`;

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø±Ø­Ù„Ø© Ù†Ø´Ø·Ø© ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹
  rideId = localStorage.getItem('activeRideId');
  if(rideId){
    map.whenReady(() => {
        startMonitoringRide(rideId);
    });
  }
},err=>{
  document.getElementById("status").innerText="âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.";
},{enableHighAccuracy:true,timeout:10000,maximumAge:0});

// ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ø¨Ø§Ù„Ù†Ù‚Ø±
map.on('click',async function(e){
  searchInput.value='';
  searchResultsUl.innerHTML='';searchResultsUl.style.display='none';

  if(endMarker) map.removeLayer(endMarker);
  endCoords=[e.latlng.lat,e.latlng.lng];
  endMarker=L.marker(endCoords).addTo(map).bindPopup("ğŸ Ù†Ù‡Ø§ÙŠØ©").openPopup();

  endAreaName=await reverseGeocode(endCoords[0],endCoords[1]);
  const shortEndArea = getShortAreaName(endAreaName); // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø®ØªØµØ± Ù„Ù„Ø¹Ø±Ø¶
  document.getElementById("status").innerHTML=`ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©: <b>${shortEndArea}</b>`;
  sendBtn.disabled=false;
});

// ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¨Ø­Ø«
function searchLocation(q){
  if(q.length<3){searchResultsUl.innerHTML='';searchResultsUl.style.display='none';return;}
  const url=`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(q+", Ø¨ØºØ¯Ø§Ø¯, Ø§Ù„Ø¹Ø±Ø§Ù‚")}&format=json&limit=5&addressdetails=1&accept-language=ar`;
  fetch(url).then(r=>r.json()).then(data=>{
    searchResultsUl.innerHTML='';
    if(data.length>0){
      data.forEach(item=>{
        let li=document.createElement('li');
        let fullArea=item.display_name.split(',').slice(0,3).reverse().join(', '); // Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„
        let shortArea=getShortAreaName(fullArea); // Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø®ØªØµØ± Ù„Ù„Ø¹Ø±Ø¶
        
        li.innerText=shortArea; // Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø®ØªØµØ±
        li.onclick=()=>selectSearchResult(item.lat,item.lon,fullArea); // ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ø¯Ø§Ù„Ø©
        searchResultsUl.appendChild(li);
      });
      searchResultsUl.style.display='block';
    }else{
      searchResultsUl.innerHTML='<li>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.</li>';
      searchResultsUl.style.display='block';
    }
  });
}

function selectSearchResult(lat,lng,name){
  searchResultsUl.innerHTML='';searchResultsUl.style.display='none';
  
  const shortName = getShortAreaName(name); // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø®ØªØµØ± Ù„Ù„Ø¹Ø±Ø¶
  searchInput.value=shortName;
  endAreaName=name; // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ ÙÙŠ Firebase

  let latlng=L.latLng(parseFloat(lat),parseFloat(lng));
  if(endMarker) map.removeLayer(endMarker);
  endCoords=[latlng.lat,latlng.lng];
  endMarker=L.marker(endCoords).addTo(map).bindPopup(`ğŸ ${shortName}`).openPopup();
  map.setView(endCoords,15);

  if(!rideId){document.getElementById("status").innerHTML=`ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©: <b>${shortName}</b>`;sendBtn.disabled=false;}
}

searchInput.addEventListener('input',e=>{
  clearTimeout(searchInputTimer);
  searchInputTimer=setTimeout(()=>searchLocation(e.target.value.trim()),SEARCH_DELAY);
});

document.addEventListener('click',e=>{
  if(!searchContainer.contains(e.target)) searchResultsUl.style.display='none';
});

// Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
sendBtn.onclick=function(){
  if(!startCoords||!endCoords){alert("Ø­Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹.");return;}

  const phone=localStorage.getItem('phone');

  const R=6371;
  const dLat=(endCoords[0]-startCoords[0])*Math.PI/180;
  const dLon=(endCoords[1]-startCoords[1])*Math.PI/180;
  const a=Math.sin(dLat/2)*Math.sin(dLat/2)+
           Math.cos(startCoords[0]*Math.PI/180)*Math.cos(endCoords[0]*Math.PI/180)*
           Math.sin(dLon/2)*Math.sin(dLon/2);
  const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  const distance=(R*c).toFixed(2);
  const fare=Math.round(distance*1000);

  rideId=Date.now();
  localStorage.setItem('activeRideId',rideId);

  endBtn.style.display='inline-block';
  sendBtn.style.display='none';
  searchContainer.style.display='none';
  
  db.ref("rides/"+rideId).set({
    riderPhone:phone,
    startLat:startCoords[0], startLng:startCoords[1], // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù…Ù†ÙØµÙ„Ø©
    endLat:endCoords[0], endLng:endCoords[1],         // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù…Ù†ÙØµÙ„Ø©
    startArea:startAreaName,endArea:endAreaName, // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ø³Ø§Ø¨Ù‚Ø§Ù‹
    distance:distance,fare:fare,status:"Ø¬Ø¯ÙŠØ¯Ø©"
  });

  const shortStartArea = getShortAreaName(startAreaName);
  const shortEndArea = getShortAreaName(endAreaName);

  // ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ù…Ø¶Ø§ÙØ© Ø­Ø¯ÙŠØ«Ø§Ù‹ Ù„Ø¬Ø¹Ù„ Ø§Ù„Ø£Ø¬Ø±Ø© ÙˆØ§Ù„Ù…Ø³Ø§ÙØ© Ø¨Ø§Ø±Ø²Ø©
  const fareStyle = "font-size: 1em; font-weight: bold; color: #E53935;"; 
  const distanceStyle = "font-size: 1em; font-weight: bold; color: #455A64;"; 
  
  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø¬ÙˆÙ… ÙˆØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ
  document.getElementById("status").innerHTML=
    `ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„<br>Ù…Ù† ${shortStartArea} Ø¥Ù„Ù‰ ${shortEndArea}<br>
     Ø§Ù„Ù…Ø³Ø§ÙØ©: <span style="${distanceStyle}">${distance} ÙƒÙ…</span> â€” Ø§Ù„Ø£Ø¬Ø±Ø©: <span style="${fareStyle}">${fare.toLocaleString('ar-IQ')} Ø¯.Ø¹</span>`;
  
  startMonitoringRide(rideId);
};

// Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨
endBtn.onclick=function(){
    if(!rideId) return;

    db.ref("rides/"+rideId).update({status:"Ù…Ù„ØºØ§Ø©", canceledBy:"rider"});
    cleanupRide();
    document.getElementById("status").innerHTML=`ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨.`;
};

// Ù…Ù†Ø¹ Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
window.onload=function(){
    let phone=localStorage.getItem("phone");
    let userType=localStorage.getItem("userType");

    if(!phone||!userType){window.location.href="index.html";return;}
    if(userType==="driver") window.location.href="driver.html";
    
    // ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ startMonitoringRide Ø¯Ø§Ø®Ù„ geolocation listener Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹
};

window.logout=function(){
    if(rideRef) rideRef.off();
    if(driverRef) driverRef.off();
    localStorage.removeItem('phone');
    localStorage.removeItem('userType');
    localStorage.removeItem('activeRideId');
    window.location.href="index.html";
};

</script>

</body>
</html>
