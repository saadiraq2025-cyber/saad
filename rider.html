<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ø§Ù„Ø±Ø§ÙƒØ¨ - ØªÙƒØ³ÙŠ Ø§Ù„Ø¹Ø±Ø§Ù‚</title>
<meta name="theme-color" content="#f97316">
<meta name="apple-mobile-web-app-capable" content="yes">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
    /* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø·ÙˆØ· ÙˆØ§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª */
    body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #eee; overflow: hidden; }
    
    #map { height: 100vh; width: 100%; z-index: 1; }

    /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¯Ø¨ÙˆØ³ ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ */
    #map-center-pin {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -100%);
        z-index: 1000;
        pointer-events: none;
        display: none; /* ÙŠØªÙ… Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ù‡ Ø¹Ø¨Ø± JS */
    }
    #map-center-pin img { width: 40px; height: 40px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }

    /* Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
    #panel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #fff;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        padding: 20px;
        box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
        z-index: 2000;
        transition: transform 0.3s ease;
    }

    /* Ø­Ø§ÙˆÙŠØ© Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ (Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ ÙˆØ§Ù„ÙˆØµÙˆÙ„) */
    .inputs-container {
        background: #fff;
        border: 1px solid #eee;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        margin-bottom: 15px;
        overflow: hidden;
    }

    .input-row {
        display: flex;
        align-items: center;
        padding: 12px 15px;
        position: relative;
    }

    .input-row:first-child {
        border-bottom: 1px solid #f0f0f0;
    }

    /* Ù…Ø¤Ø´Ø±Ø§Øª Ù…Ù„ÙˆÙ†Ø© (Ø¯Ø§Ø¦Ø±Ø© ÙˆÙ…Ø±Ø¨Ø¹) */
    .indicator {
        width: 10px;
        height: 10px;
        margin-left: 10px;
        flex-shrink: 0;
    }
    .indicator.start { background: #f97316; border-radius: 50%; } /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ù„Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ */
    .indicator.end { border: 2px solid #333; box-sizing: border-box; background: transparent; } /* Ù…Ø±Ø¨Ø¹ Ù„Ù„ÙˆØµÙˆÙ„ */

    .location-text {
        flex-grow: 1;
        font-size: 0.95em;
        color: #333;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .location-text.placeholder { color: #999; }

    /* Ø²Ø± Ø§Ù„ØªØºÙŠÙŠØ± Ø§Ù„ØµØºÙŠØ± */
    .change-btn {
        background: none;
        border: none;
        color: #999;
        font-size: 0.8em;
        cursor: pointer;
        padding: 5px;
    }

    /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
    .main-btn {
        width: 100%;
        background: #f97316;
        color: white;
        border: none;
        padding: 16px;
        border-radius: 12px;
        font-size: 1.1em;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(249, 115, 22, 0.3);
        transition: background 0.2s;
    }
    .main-btn:active { background: #e65100; transform: scale(0.98); }
    .main-btn:disabled { background: #ccc; box-shadow: none; cursor: default; }

    /* Ø§Ù„ØµÙ Ø§Ù„Ø£Ø®ÙŠØ± (Ø§Ù„ØªÙƒÙ„ÙØ© + Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„) - ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ */
    #finalActionRow {
        display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
        display: flex;
        gap: 10px;
        align-items: stretch;
    }

    /* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ØªÙƒÙ„ÙØ© (Ø£Ø²Ø±Ù‚ ÙØ§ØªØ­/Ø£Ø¨ÙŠØ¶) */
    .cost-box {
        flex: 1;
        background: #fff;
        border: 2px solid #3b82f6; /* Ø¥Ø·Ø§Ø± Ø£Ø²Ø±Ù‚ */
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 5px;
        color: #3b82f6;
    }
    .cost-label { font-size: 0.8em; font-weight: bold; }
    .cost-value { font-size: 1.1em; font-weight: 900; }

    /* Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙÙŠ Ø§Ù„ØµÙ Ø§Ù„Ø£Ø®ÙŠØ± */
    #sendRequestBtn {
        flex: 2;
        background: #f97316;
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: bold;
        font-size: 1.1em;
        box-shadow: 0 4px 10px rgba(249, 115, 22, 0.3);
    }

    /* Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ±Ù‚Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ */
    #status-area {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 10px;
        font-size: 0.9em;
        text-align: center;
        display: none;
        border: 1px solid #ddd;
    }
    .driver-phone-link {
        display: block;
        margin-top: 5px;
        font-size: 1.3em;
        font-weight: bold;
        color: #004d40;
        text-decoration: none;
        background: #e0f2f1;
        padding: 8px;
        border-radius: 8px;
    }

    /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ù„ÙˆÙŠ */
    #top-search {
        position: fixed;
        top: 20px;
        left: 20px;
        right: 20px;
        z-index: 1500;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    #back-btn {
        background: #fff;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: none;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        font-size: 1.2em;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Ø¥Ø®ÙØ§Ø¡ Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
    .leaflet-control-zoom { display: none; }
    .leaflet-control-attribution { display: none; }

</style>
</head>
<body>

<div id="top-search">
    <button id="back-btn" onclick="handleBack()">&#x2039;</button>
</div>

<div id="map"></div>

<div id="map-center-pin">
    <svg width="46" height="46" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 0C7.58 0 4 3.58 4 8C4 13.5 12 24 12 24C12 24 20 13.5 20 8C20 3.58 16.42 0 12 0ZM12 11C10.34 11 9 9.66 9 8C9 6.34 10.34 5 12 5C13.66 5 15 6.34 15 8C15 9.66 13.66 11 12 11Z" fill="#E53935"/>
    </svg>
</div>

<div id="panel">
    
    <div id="status-area"></div>

    <div class="inputs-container">
        
        <div class="input-row" id="start-row">
            <div class="indicator start"></div>
            <div class="location-text" id="start-text">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...</div>
            <button class="change-btn" id="edit-start" style="display:none;">ØªØºÙŠÙŠØ±</button>
        </div>

        <div class="input-row" id="end-row" style="display:none;">
            <div class="indicator end"></div>
            <div class="location-text placeholder" id="end-text">Ø¥Ù„Ù‰ Ø£ÙŠÙ† ØªØ±ÙŠØ¯ Ø§Ù„Ø°Ù‡Ø§Ø¨ØŸ</div>
            <button class="change-btn" id="edit-end" style="display:none;">ØªØºÙŠÙŠØ±</button>
        </div>

    </div>

    <button id="main-action-btn" class="main-btn">ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</button>

    <div id="finalActionRow" style="display:none;">
        <div class="cost-box">
            <span class="cost-label">Ø§Ù„ØªÙƒÙ„ÙØ©</span>
            <span class="cost-value" id="fare-display">IQD 0</span>
        </div>
        <button id="sendRequestBtn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
    </div>

    <button id="cancel-ride-btn" class="main-btn" style="background:#d32f2f; margin-top:10px; display:none;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>

</div>

<script>
// ---------------- ØªÙ‡ÙŠØ¦Ø© Firebase ----------------
const app = firebase.initializeApp({
  apiKey: "AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M",
  authDomain: "taxi-15314.firebaseapp.com",
  databaseURL: "https://taxi-15314-default-rtdb.firebaseio.com/",
  projectId: "taxi-15314"
});
const db = firebase.database();

// ---------------- Ø§Ù„Ø®Ø±ÙŠØ·Ø© ----------------
let map = L.map('map', {zoomControl: false}).setView([33.3152, 44.3661], 15);
L.tileLayer("https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}&key=AIzaSyD7TtwniAdUtB8-pnTny4ZwE6gqX36SGUk", {
    maxZoom: 20
}).addTo(map);

// ---------------- Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ----------------
let stage = 'start'; // 'start', 'end', 'confirm', 'active'
let startCoords = null, endCoords = null;
let startName = "", endName = "";
let isDragging = false;
let rideId = null;
let rideListener = null;
let driverListener = null;
let driverMarker = null;

// Ø¹Ù†Ø§ØµØ± DOM
const pin = document.getElementById('map-center-pin');
const startText = document.getElementById('start-text');
const endText = document.getElementById('end-text');
const endRow = document.getElementById('end-row');
const mainBtn = document.getElementById('main-action-btn');
const finalRow = document.getElementById('finalActionRow');
const sendBtn = document.getElementById('sendRequestBtn');
const fareDisplay = document.getElementById('fare-display');
const statusArea = document.getElementById('status-area');
const cancelBtn = document.getElementById('cancel-ride-btn');
const editStartBtn = document.getElementById('edit-start');
const editEndBtn = document.getElementById('edit-end');

// ---------------- Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ----------------

// Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø®ØªØµØ±
async function getAreaName(lat, lng) {
    try {
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&accept-language=ar`);
        const data = await res.json();
        
        if (data.address) {
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ø­ÙŠ Ø£Ùˆ Ø§Ù„Ù…Ø¹Ù„Ù… Ø£Ùˆ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©
            const parts = [];
            if(data.address.suburb) parts.push(data.address.suburb);
            else if(data.address.neighbourhood) parts.push(data.address.neighbourhood);
            else if(data.address.road) parts.push(data.address.road);
            
            if(data.address.city || data.address.town || data.address.state) {
                parts.push(data.address.city || data.address.town || data.address.state);
            }
            
            return parts.slice(0, 2).join(' - ') || "Ù…ÙˆÙ‚Ø¹ Ù…Ø­Ø¯Ø¯";
        }
        return "Ù…ÙˆÙ‚Ø¹ Ù…Ø­Ø¯Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©";
    } catch(e) {
        return "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
    }
}

// Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Øµ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ø±ÙƒØ© Ø§Ù„Ø®Ø±ÙŠØ·Ø©
function onMapMove() {
    if (stage === 'active') return;
    
    isDragging = true;
    const center = map.getCenter();
    
    if (stage === 'start') {
        startText.innerText = "Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...";
        startText.style.color = "#f97316";
        mainBtn.disabled = true;
    } else if (stage === 'end') {
        endText.innerText = "Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...";
        endText.style.color = "#f97316";
        mainBtn.disabled = true;
    }
}

// Ø¹Ù†Ø¯ ØªÙˆÙ‚Ù Ø­Ø±ÙƒØ© Ø§Ù„Ø®Ø±ÙŠØ·Ø©
let moveTimeout;
map.on('moveend', async () => {
    if (stage === 'active') return;
    isDragging = false;
    
    clearTimeout(moveTimeout);
    moveTimeout = setTimeout(async () => {
        const center = map.getCenter();
        const name = await getAreaName(center.lat, center.lng);
        
        if (stage === 'start') {
            startCoords = [center.lat, center.lng];
            startName = name;
            startText.innerText = name;
            startText.style.color = "#333";
            mainBtn.disabled = false;
        } else if (stage === 'end') {
            endCoords = [center.lat, center.lng];
            endName = name;
            endText.innerText = name;
            endText.style.color = "#333";
            mainBtn.disabled = false;
        }
    }, 500);
});

map.on('movestart', onMapMove);

// ---------------- Ø¥Ø¯Ø§Ø±Ø© ØªØ¯ÙÙ‚ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ (UX Flow) ----------------

// 1. Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚"
mainBtn.addEventListener('click', () => {
    if (stage === 'start') {
        if(!startCoords) return;
        
        // Ø§Ù„ØªØ­ÙˆÙ„ Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ÙˆØ¬Ù‡Ø©
        stage = 'end';
        endRow.style.display = 'flex'; // Ø¥Ø¸Ù‡Ø§Ø± Ø­Ù‚Ù„ Ø§Ù„ÙˆØ¬Ù‡Ø©
        startText.style.color = "#666"; // ØªØºÙ…ÙŠÙ‚ Ù†Øµ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚
        editStartBtn.style.display = 'block'; // Ø²Ø± ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚
        
        mainBtn.innerText = "ØªØ«Ø¨ÙŠØª Ø§Ù„ÙˆØµÙˆÙ„";
        mainBtn.disabled = true; // Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ù„ÙˆØ¬Ù‡Ø©
        
        // ØªØ­Ø±ÙŠÙƒ Ø¨Ø³ÙŠØ· Ù„Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø£Ùˆ Ø§Ù„Ø¨Ù‚Ø§Ø¡
        endText.innerText = "Ø­Ø¯Ø¯ Ø§Ù„ÙˆØ¬Ù‡Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©";
        
    } else if (stage === 'end') {
        if(!endCoords) return;
        
        // Ø§Ù„ØªØ­ÙˆÙ„ Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ (Ù…Ø«Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ 00:20)
        stage = 'confirm';
        pin.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¯Ø¨ÙˆØ³
        mainBtn.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø± Ø§Ù„Ø¹Ø±ÙŠØ¶
        finalRow.style.display = 'flex'; // Ø¥Ø¸Ù‡Ø§Ø± ØµÙ Ø§Ù„ØªÙƒÙ„ÙØ© ÙˆØ§Ù„Ø²Ø±
        editEndBtn.style.display = 'block';
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ©
        const dist = calcDistance(startCoords[0], startCoords[1], endCoords[0], endCoords[1]);
        const fare = Math.max(1000, Math.round(dist * 750 / 250) * 250); // ØªÙ‚Ø±ÙŠØ¨ Ù„Ø£Ù‚Ø±Ø¨ 250
        fareDisplay.innerText = `IQD ${fare.toLocaleString('en-US')}`;
        
        // Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ø¨ØµØ±ÙŠ)
        fitBounds();
    }
});

// Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø®Ù„Ù)
editStartBtn.onclick = () => {
    stage = 'start';
    endRow.style.display = 'none';
    finalRow.style.display = 'none';
    mainBtn.style.display = 'block';
    mainBtn.innerText = "ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚";
    mainBtn.disabled = false;
    pin.style.display = 'block';
    map.setView(startCoords, 16);
    editStartBtn.style.display = 'none';
};

editEndBtn.onclick = () => {
    stage = 'end';
    finalRow.style.display = 'none';
    mainBtn.style.display = 'block';
    mainBtn.innerText = "ØªØ«Ø¨ÙŠØª Ø§Ù„ÙˆØµÙˆÙ„";
    pin.style.display = 'block';
    map.setView(endCoords, 16);
    editEndBtn.style.display = 'none';
};

// ---------------- Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ ÙˆÙ…Ø±Ø§Ù‚Ø¨ØªÙ‡ ----------------

sendBtn.onclick = () => {
    const phone = localStorage.getItem('phone');
    if (!phone) { window.location.href = 'index.html'; return; }
    
    rideId = Date.now().toString();
    localStorage.setItem('activeRideId', rideId);
    
    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø©
    const rideData = {
        riderPhone: phone,
        startLat: startCoords[0], startLng: startCoords[1],
        endLat: endCoords[0], endLng: endCoords[1],
        startArea: startName, endArea: endName,
        fare: fareDisplay.innerText,
        status: "Ø¬Ø¯ÙŠØ¯Ø©",
        timestamp: firebase.database.ServerValue.TIMESTAMP
    };
    
    db.ref('rides/' + rideId).set(rideData);
    
    startMonitoring(rideId);
};

function startMonitoring(id) {
    stage = 'active';
    finalRow.style.display = 'none';
    cancelBtn.style.display = 'block';
    statusArea.style.display = 'block';
    statusArea.innerHTML = "ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ù‚Ø±Ø¨ Ø³Ø§Ø¦Ù‚...";
    
    // ØªØ¬Ù…ÙŠØ¯ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    editStartBtn.style.display = 'none';
    editEndBtn.style.display = 'none';

    const rRef = db.ref('rides/' + id);
    rideListener = rRef.on('value', snap => {
        const r = snap.val();
        if (!r) {
            handleRideEnd("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©.");
            return;
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
        if (r.status === "Ù…Ù‚Ø¨ÙˆÙ„Ø©") {
            // ** Ù‡Ù†Ø§ ÙŠØ¸Ù‡Ø± Ø±Ù‚Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª **
            statusArea.innerHTML = `
                <div style="color:green; font-weight:bold;">âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©!</div>
                <div>Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù‚Ø§Ø¯Ù… Ø¥Ù„ÙŠÙƒ</div>
                <a href="tel:${r.driverPhone}" class="driver-phone-link">ğŸ“ ${r.driverPhone}</a>
            `;
            cancelBtn.style.display = 'block'; // ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¥Ù„ØºØ§Ø¡
            
            // Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚
            if (r.driverPhone) monitorDriver(r.driverPhone);
            
        } else if (r.status === "Ø¨Ø¯Ø£Øª") {
            statusArea.innerHTML = `
                <div style="color:#f97316; font-weight:bold;">ğŸš€ Ø§Ù„Ø±Ø­Ù„Ø© Ø¬Ø§Ø±ÙŠØ©</div>
                <div>ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ¬Ù‡Ø©</div>
                <a href="tel:${r.driverPhone}" class="driver-phone-link">ğŸ“ ${r.driverPhone}</a>
            `;
            cancelBtn.style.display = 'none'; // Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ø¨Ø¹Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
        } else if (r.status === "Ù…Ù†ØªÙ‡ÙŠØ©") {
            handleRideEnd("ÙˆØµÙ„Øª Ø¨Ø³Ù„Ø§Ù…Ø©! Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ.");
        } else if (r.status === "Ù…Ù„ØºØ§Ø©" || r.status === "Ù…Ø±ÙÙˆØ¶Ø©") {
            handleRideEnd("Ø¹Ø°Ø±Ø§Ù‹ØŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©.");
        }
    });
}

// Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚
function monitorDriver(driverPhone) {
    if(driverListener) return; // Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
    const dRef = db.ref('drivers/' + driverPhone);
    driverListener = dRef.on('value', snap => {
        const d = snap.val();
        if(d && d.lat && d.lng) {
            if(driverMarker) map.removeLayer(driverMarker);
            
            // Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©
            const carIcon = L.divIcon({
                html: 'ğŸš–',
                className: '',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            
            driverMarker = L.marker([d.lat, d.lng], {icon: carIcon}).addTo(map);
        }
    });
}

function handleRideEnd(msg) {
    alert(msg);
    localStorage.removeItem('activeRideId');
    if(rideListener) db.ref('rides/' + rideId).off();
    if(driverListener) db.ref('drivers').off(); // Ø¥ÙŠÙ‚Ø§Ù Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ÙƒÙ„ Ù„Ù„ØªØ¨Ø³ÙŠØ·
    location.reload(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù„Ø¨Ø¯Ø¡ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù†Ø¸ÙŠÙØ©
}

cancelBtn.onclick = () => {
    if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©ØŸ")) {
        db.ref('rides/' + rideId).update({status: "Ù…Ù„ØºØ§Ø©", canceledBy: "rider"});
    }
};

// ---------------- Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ----------------

// Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© (ÙƒÙ…)
function calcDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; 
    const dLat = (lat2-lat1) * Math.PI/180;
    const dLon = (lon2-lon1) * Math.PI/180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function fitBounds() {
    if(startCoords && endCoords) {
        const bounds = L.latLngBounds(startCoords, endCoords);
        map.fitBounds(bounds, {padding: [50, 50]});
    }
}

function handleBack() {
    if(stage === 'active') return;
    if(stage === 'end') {
        editStartBtn.click();
    } else if (stage === 'confirm') {
        editEndBtn.click();
    } else {
        history.back();
    }
}

// ---------------- Ø§Ù„Ø¨Ø¯Ø¡ ----------------
window.onload = () => {
    const phone = localStorage.getItem('phone');
    if(!phone) { window.location.href = 'index.html'; return; }
    
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            map.setView([lat, lng], 16);
            pin.style.display = 'block';
            
            // ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ø±Ø­Ù„Ø© Ù†Ø´Ø·Ø©
            const savedRide = localStorage.getItem('activeRideId');
            if(savedRide) {
                rideId = savedRide;
                // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø³ÙŠØ·Ø© Ù„Ù„Ø¹Ø±Ø¶
                stage = 'active';
                mainBtn.style.display = 'none';
                startText.innerText = "Ø±Ø­Ù„Ø© Ø¬Ø§Ø±ÙŠØ©...";
                endRow.style.display = 'flex';
                endText.innerText = "...";
                startMonitoring(savedRide);
            }
            
        }, () => {
            pin.style.display = 'block'; // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¯Ø¨ÙˆØ³ Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹
        });
    }
};

</script>
</body>
</html>
