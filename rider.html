<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¨Ù„ÙŠ - Ø§Ù„Ø±Ø§ÙƒØ¨</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        :root { --baly-yellow: #FFD200; --baly-black: #1A1A1A; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; }
        .floating-panel { position: absolute; bottom: 0; left: 0; right: 0; background: white; border-radius: 25px 25px 0 0; padding: 20px; z-index: 1000; box-shadow: 0 -10px 30px rgba(0,0,0,0.1); }
        .input-group { background: #f8f8f8; border-radius: 12px; padding: 5px 15px; margin-bottom: 10px; border: 1px solid #eee; display: flex; align-items: center; }
        .input-group input { border: none; background: transparent; width: 100%; padding: 10px; outline: none; font-size: 15px; }
        .btn-order { background: var(--baly-yellow); border: none; width: 100%; padding: 16px; border-radius: 12px; font-weight: bold; font-size: 18px; cursor: pointer; display: none; margin-top: 10px; }
        .btn-cancel { background: #ff4444; color: white; border: none; width: 100%; padding: 12px; border-radius: 12px; margin-top: 10px; cursor: pointer; }
        .ride-stats { display: flex; justify-content: space-around; background: #FFF9E6; padding: 10px; border-radius: 10px; margin-top: 10px; border: 1px solid #FFE58F; display: none; }
        .driver-card { background: #1A1A1A; color: white; padding: 15px; border-radius: 15px; margin-top: 10px; display: none; }
        #results { list-style: none; padding: 0; margin: 0; max-height: 150px; overflow-y: auto; background: white; position: absolute; width: 90%; z-index: 2000; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        #results li { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 13px; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="floating-panel">
    <div id="statusMsg" style="font-weight: bold; text-align: center; margin-bottom: 10px;">Ø­Ø¯Ø¯ Ø§Ù„ÙˆØ¬Ù‡Ø© Ù„Ù„Ø·Ù„Ø¨</div>
    
    <div id="searchUI">
        <div class="input-group">ğŸŸ¢ <input type="text" id="startInput" placeholder="Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚" readonly></div>
        <div class="input-group">ğŸ”´ <input type="text" id="destInput" placeholder="Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙˆØ¬Ù‡Ø©..."></div>
        <ul id="results"></ul>
    </div>

    <div class="ride-stats" id="rideStats">
        <div>Ø§Ù„Ø£Ø¬Ø±Ø©: <b id="fareTxt">0</b> Ø¯.Ø¹</div>
        <div>Ø§Ù„Ù…Ø³Ø§ÙØ©: <b id="distTxt">0</b> ÙƒÙ…</div>
    </div>

    <div class="driver-card" id="driverCard">
        <div>Ø§Ù„ÙƒØ§Ø¨ØªÙ† Ù‚Ø§Ø¯Ù… Ø¥Ù„ÙŠÙƒ: <b id="dPhone"></b></div>
        <div style="margin-top:10px;">
            <a id="callBtn" style="color: var(--baly-yellow); text-decoration: none; font-weight: bold; margin-right: 15px;">ğŸ“ Ø§ØªØµØ§Ù„</a>
            <button class="btn-cancel" onclick="cancelRide()" style="width: auto; padding: 5px 15px; font-size: 14px;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>
        </div>
    </div>

    <button class="btn-order" id="orderBtn">Ø·Ù„Ø¨ ÙƒØ§Ø¨ØªÙ† Ø¨Ù„ÙŠ</button>
    <button class="btn-cancel" id="cancelSearchBtn" style="display:none;" onclick="cancelRide()">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¨Ø­Ø«</button>
</div>

<script>
const firebaseConfig = { apiKey: "AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M", databaseURL: "https://taxi-15314-default-rtdb.firebaseio.com/" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let map = L.map('map', {zoomControl: false}).setView([33.3152, 44.3661], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let startMarker, endMarker, currentRideId = null;
const riderPhone = localStorage.getItem("phone") || "07700000000";

navigator.geolocation.getCurrentPosition(pos => {
    const p = [pos.coords.latitude, pos.coords.longitude];
    map.setView(p, 15);
    startMarker = L.marker(p, {draggable: true, icon: L.divIcon({html: 'ğŸŸ¢', className:'m'})}).addTo(map);
    endMarker = L.marker([p[0]+0.005, p[1]+0.005], {draggable: true, icon: L.divIcon({html: 'ğŸ”´', className:'m'})}).addTo(map);
    
    startMarker.on('dragend', calculateRide);
    endMarker.on('dragend', calculateRide);
    calculateRide();
});

async function getAddress(lat, lng, elementId) {
    try {
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
        const data = await res.json();
        document.getElementById(elementId).value = data.display_name.split(',')[0] + (data.display_name.split(',')[1] || "");
    } catch(e) {}
}

async function calculateRide() {
    if(currentRideId) return;
    const start = startMarker.getLatLng();
    const end = endMarker.getLatLng();
    const dist = (map.distance(start, end) / 1000).toFixed(1);
    const fare = Math.round(dist * 1500);

    getAddress(start.lat, start.lng, 'startInput');
    document.getElementById('rideStats').style.display = 'flex';
    document.getElementById('fareTxt').innerText = fare.toLocaleString();
    document.getElementById('distTxt').innerText = dist;
    document.getElementById('orderBtn').style.display = 'block';
}

document.getElementById('orderBtn').onclick = function() {
    currentRideId = Date.now();
    const rideData = {
        riderPhone,
        start: [startMarker.getLatLng().lat, startMarker.getLatLng().lng],
        end: [endMarker.getLatLng().lat, endMarker.getLatLng().lng],
        startAddr: document.getElementById('startInput').value,
        endAddr: document.getElementById('destInput').value || "ÙˆØ¬Ù‡Ø© Ù…Ø­Ø¯Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©",
        fare: document.getElementById('fareTxt').innerText,
        status: "Ø¬Ø¯ÙŠØ¯Ø©"
    };
    
    db.ref("rides/"+currentRideId).set(rideData);
    document.getElementById('searchUI').style.opacity = "0.5";
    document.getElementById('orderBtn').style.display = 'none';
    document.getElementById('cancelSearchBtn').style.display = 'block';
    document.getElementById('statusMsg').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙƒØ§Ø¨ØªÙ†...";
    
    db.ref("rides/"+currentRideId).on('value', snap => {
        const r = snap.val();
        if(!r) { resetUI(); return; }
        if(r.status === "Ù…Ù‚Ø¨ÙˆÙ„Ø©") {
            document.getElementById('statusMsg').innerText = "Ø§Ù„ÙƒØ§Ø¨ØªÙ† ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ!";
            document.getElementById('driverCard').style.display = 'block';
            document.getElementById('cancelSearchBtn').style.display = 'none';
            document.getElementById('dPhone').innerText = r.driverPhone;
            document.getElementById('callBtn').href = "tel:" + r.driverPhone;
        } else if(r.status === "Ù…Ù„ØºÙŠØ©" || r.status === "Ù…ÙƒØªÙ…Ù„Ø©") {
            alert(r.status === "Ù…Ù„ØºÙŠØ©" ? "ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©" : "Ø´ÙƒØ±Ø§Ù‹ Ù„Ø±Ø­Ù„ØªÙƒ Ù…Ø¹ Ø¨Ù„ÙŠ!");
            resetUI();
        }
    });
};

function cancelRide() {
    if(currentRideId) {
        db.ref("rides/"+currentRideId).update({status: "Ù…Ù„ØºÙŠØ©"});
        resetUI();
    }
}

function resetUI() {
    currentRideId = null;
    document.getElementById('searchUI').style.opacity = "1";
    document.getElementById('driverCard').style.display = 'none';
    document.getElementById('cancelSearchBtn').style.display = 'none';
    document.getElementById('orderBtn').style.display = 'block';
    document.getElementById('statusMsg').innerText = "Ø­Ø¯Ø¯ Ø§Ù„ÙˆØ¬Ù‡Ø© Ù„Ù„Ø·Ù„Ø¨";
}
</script>
</body>
</html>
