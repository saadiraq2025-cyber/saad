<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø±Ø§ÙƒØ¨ - ØªÙƒØ³ÙŠ Ø§Ù„Ø¹Ø±Ø§Ù‚ Ø§Ù„Ø´Ø§Ù…Ù„</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#f97316"> <meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="/icons/icon-192x192.png">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body,html{margin:0;padding:0;height:100%;font-family:Tahoma;}
#map{height:100vh;position:relative; padding-top: 80px;} /* Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§ÙØ© Ù„Ø£Ø³ÙÙ„ Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« */
#panel{
    position:fixed;
    bottom:0;
    left:0;
    right:0;
    background:#fff;
    text-align:center;
    padding:10px 0; /* ØªÙ… ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¨Ø§Ø¯ÙŠÙ†Øº Ø§Ù„Ø±Ø£Ø³ÙŠ */
    box-shadow:0 -2px 10px rgba(0,0,0,0.3);
    border-top-left-radius: 15px;
    border-top-right-radius: 15px;
    z-index: 1000;
}
button{
    background:#f97316; /* Ù„ÙˆÙ† Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„ÙÙŠØ¯ÙŠÙˆ */
    color:white;
    border:none;
    padding:15px 10px;
    border-radius:10px;
    font-weight:bold;
    cursor:pointer;
    margin:5px 10px;
    width:calc(100% - 20px);
    font-size: 1.1em;
}

/* Ù†Ù…Ø· Ø¬Ø¯ÙŠØ¯ Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ù„ØªÙƒØ¨ÙŠØ± ÙˆØªØ«Ø®ÙŠÙ† Ø§Ù„Ø®Ø· */
#panel p#status {
    font-size: 1.0em;
    font-weight: normal;
    margin: 10px 10px 5px;
    line-height: 1.4;
    color: #333;
    padding: 5px 10px;
    border-radius: 8px;
    background: #f0f0f0;
}
#panel p#status b a {
    color: #004d40; /* Ù„ÙˆÙ† Ù…Ù…ÙŠØ² Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù‡Ø§ØªÙ */
    text-decoration: none;
    font-size: 1.1em;
}

/* Ù†Ù…Ø· Ø¹Ø±Ø¶ Ø§Ù„ØªÙƒÙ„ÙØ© - Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙŠ Ø­Ø§Ù„ØªÙ‡ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© */
#costDisplay {
    background: #e0f2f1; /* Ù„ÙˆÙ† ÙØ§ØªØ­ Ù„Ù„Ø®Ù„ÙÙŠØ© - Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ù€ HTML Ø§Ù„Ø£ØµÙ„ÙŠ */
    color: #004d40; /* Ù„ÙˆÙ† ØºØ§Ù…Ù‚ Ù„Ù„Ù†Øµ - Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ù€ HTML Ø§Ù„Ø£ØµÙ„ÙŠ */
    font-size: 1.2em;
    font-weight: bold;
    padding: 10px;
    margin: 10px 10px 5px; /* ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‡Ø§Ù…Ø´ Ø§Ù„Ø³ÙÙ„ÙŠ Ù„Ù„Ø§Ù‚ØªØ±Ø§Ø¨ Ù…Ù† Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ */
    border-radius: 8px;
    display: none; 
}
#costDisplay strong {
    color: #e53935; 
    font-size: 1.3em;
}

#map-center-pin {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -100%); 
    z-index: 999;
    font-size: 40px;
    color: #e53935;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    pointer-events: none; 
    display: none; 
}

/* ğŸ¯ Ø­Ø§ÙˆÙŠØ© Ù†Ù‚Ø§Ø· Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ ÙˆØ§Ù„ÙˆØµÙˆÙ„ (Ù…ÙØ¹Ø§Ø¯ ØªØµÙ…ÙŠÙ…Ù‡Ø§ Ù„ØªØ·Ø§Ø¨Ù‚ Ù…Ø¸Ù‡Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ) */
#pointContainer {
    display: flex;
    flex-direction: column;
    padding: 0 10px;
    margin-bottom: 5px; /* ØªÙ… ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù‡Ø§Ù…Ø´ Ø§Ù„Ø³ÙÙ„ÙŠ */
    text-align: right;
    gap: 10px; /* Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø¹Ù†Ø§ØµØ± */
}

.point-field {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f5f5f5; /* Ø®Ù„ÙÙŠØ© ÙØ§ØªØ­Ø© ØªØ´Ø¨Ù‡ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙÙŠ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ */
    padding: 10px 15px; 
    border-radius: 10px;
    font-size: 1.0em;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

.point-field:last-child {
    border-bottom: none;
}

.point-label {
    font-weight: bold;
    color: #333;
    white-space: nowrap;
    margin-left: 10px;
    flex-shrink: 0;
    font-size: 0.9em; /* ØªÙ‚Ù„ÙŠÙ„ Ø­Ø¬Ù… Ø§Ù„Ø®Ø· Ù„Ù„Ø¹Ù†ÙˆØ§Ù† */
}

.point-value {
    color: #666;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex-grow: 1;
    text-align: right;
    font-weight: normal; /* Ø¬Ø¹Ù„ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¨Ø®Ø· Ø¹Ø§Ø¯ÙŠ */
    font-size: 1.1em; /* ØªÙƒØ¨ÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ø®Ø· Ù„Ù„Ù‚ÙŠÙ…Ø© */
}

.point-action {
    background: none;
    border: none;
    color: #f97316;
    font-weight: bold;
    cursor: pointer;
    padding: 0 5px;
    white-space: nowrap;
    flex-shrink: 0;
    font-size: 0.9em;
}

/* Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« ÙˆØ²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ø§Ù„Ø°ÙŠ ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…) */
#searchContainer {
    display: none !important; 
}


/* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© ØªØµÙ…ÙŠÙ…Ù‡Ø§ */
#driverInfo{display:none;}
#logoutBtn{display:none; width:auto; background:#607d8b; padding:10px 20px;}
#cancelRideBtn{background:#E53935;color:white; display:none;}


</style>
</head>
<body>

<div id="map"></div>
<div id="map-center-pin">ğŸ“</div>

<div id="searchContainer" style="display:none;">
    <button id="back-button" onclick="history.back()">&#x2039;</button> 
    <input type="text" id="search-input" placeholder="Ø£Ø¨Ø­Ø« Ø¹Ù† Ù…ÙƒØ§Ù†" />
    <span id="search-icon">ğŸ”</span>
</div>

<div id="searchResults" style="display:none;">
    </div>

<div id="panel">

    <div id="pointContainer">
        <div class="point-field" id="startPointField">
            <span class="point-label">Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</span>
            <span id="startPointValue" class="point-value">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù†Ø·Ù‚Ø©...</span>
            <button id="changeStartPointBtn" class="point-action" style="display:none;">ØªØºÙŠÙŠØ±</button>
        </div>
        <div class="point-field" id="endPointField" style="display:none;">
            <span class="point-label">Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„</span>
            <span id="endPointValue" class="point-value">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù†Ø·Ù‚Ø©...</span>
            <button id="changeEndPointBtn" class="point-action" style="display:none;">ØªØºÙŠÙŠØ±</button>
        </div>
    </div>
    
    <div id="costDisplay">
        Ø§Ù„ØªÙƒÙ„ÙØ©: <strong><span id="fareValue">---</span> Ø¯.Ø¹</strong>
    </div>

    <p id="status" style="display:none;"></p> 
    <button id="mainActionBtn">ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</button> 
    
    <button id="cancelRideBtn" style="display:none;">âŒ Ø¥Ù†Ù‡Ø§Ø¡/Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>
</div>

<script>
// ---------------- ØªÙ‡ÙŠØ¦Ø© Firebase Ùˆ Leaflet ----------------
const app=firebase.initializeApp({
  apiKey:"AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M",
  authDomain:"taxi-15314.firebaseapp.com",
  databaseURL:"https://taxi-15314-default-rtdb.firebaseio.com/",
  projectId:"taxi-15314"
});
const db=firebase.database();

// ** ØªÙ… Ø§Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ø¹Ù„Ù‰ Ø·Ø¨Ù‚Ø© Google Maps ÙƒÙ…Ø§ Ù‡ÙŠ Ù„ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø±ÙÙ‚ **
let map=L.map('map').setView([33.3603, 44.5066],14); 

L.tileLayer(
  "https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}&key=AIzaSyD7TtwniAdUtB8-pnTny4ZwE6gqX36SGUk",
  { maxZoom: 20 }
).addTo(map);

map.whenReady(()=>map.invalidateSize());

// ---------------- Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© ----------------
let startCoords=null, endCoords=null;
let startAreaName="", endAreaName="";

let currentStage="settingStart"; // settingStart, settingEnd, confirmed
let isMapMoving = false;

let rideId=null;
let driverMarker=null;
let driverRoute=null;
let rideRef=null; 
let driverRef=null; 
let currentDriverPhone=null;

// ---------------- Ù…Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± ----------------
const pin = document.getElementById("map-center-pin");
const startPointValue = document.getElementById("startPointValue");
const endPointValue = document.getElementById("endPointValue");
const mainActionBtn = document.getElementById("mainActionBtn");
const cancelRideBtn = document.getElementById("cancelRideBtn");
const costDisplay = document.getElementById("costDisplay");
const fareValue = document.getElementById("fareValue");
const oldStatus = document.getElementById("status");
const changeStartBtn = document.getElementById("changeStartPointBtn");
const changeEndBtn = document.getElementById("changeEndPointBtn");
// ğŸ¯ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ÙƒØ¨ÙŠØ±Ø© ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
const startPointField = document.getElementById("startPointField");
const endPointField = document.getElementById("endPointField");


// Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (ØªÙ… Ø§Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ø¹Ù„ÙŠÙ‡Ø§ ÙÙŠ JS Ø±ØºÙ… Ø¥Ø®ÙØ§Ø¡Ù‡Ø§ ÙÙŠ HTML/CSS)
const searchInput = document.getElementById("search-input");
const searchResultsContainer = document.getElementById("searchResults");


// ---------------- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙˆØ§Ù„Ù€ Geocoding ----------------

// Ø§Ù„Ø¯Ø§Ù„Ø©: Ø§Ø³ØªØ®Ù„Ø§Øµ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£Ù‚ØµØ± Ù„Ù„Ù…Ù†Ø·Ù‚Ø© (Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·) - ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø°ÙŠ ÙŠØ£ØªÙŠ Ù…Ù† reverseGeocode
function getShortAreaName(fullArea) {
    if (!fullArea) return "Ù…Ù†Ø·Ù‚Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©";
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø§Ø³Ù… Ù‚ØµÙŠØ±Ø§Ù‹ØŒ Ù†ÙØªØ±Ø¶Ù‡ Ø§Ø³Ù… Ù…Ø¹Ù„Ù… Ø¨Ø§Ø±Ø² ÙˆÙ†Ø±Ø¬Ø¹Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø©
    if (fullArea.length < 50 && !fullArea.includes(',')) {
        return fullArea; 
    }
    
    // Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø·ÙˆÙŠÙ„
    const parts = fullArea.split(',').map(p => p.trim()).filter(p => p.length > 0);
    
    const relevantParts = parts.filter(p => 
        !p.includes("Ù‚Ø¶Ø§Ø¡") && 
        !p.includes("Ù†Ø§Ø­ÙŠØ©") && 
        !p.includes("Ù…Ø±ÙƒØ²") &&
        !p.includes("Ø¨ØºØ¯Ø§Ø¯") 
    );

    if (relevantParts.length > 0) {
        return relevantParts[0]; 
    }
    
    return parts[parts.length - 1]; 
}

// reverse geocode (ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ø¬Ù„Ø¨ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ù… Ø§Ù„Ø¨Ø§Ø±Ø²Ø©)
async function reverseGeocode(lat, lon) {
    const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=ar`;
    try {
        const r = await fetch(url);
        const d = await r.json();

        if (d && d.display_name) {
            const address = d.address;
            // Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„ØªÙŠ Ù‚Ø¯ ØªÙƒÙˆÙ† POI 
            const poiKeys = ['amenity', 'shop', 'building', 'restaurant', 'bakery', 'pharmacy', 'supermarket', 'public_building']; 
            
            let poiName = null;
            for (const key of poiKeys) {
                if (address[key]) {
                    poiName = address[key];
                    break; 
                }
            }

            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø¨Ø§Ø±Ø² Ù…Ø¹Ù‚ÙˆÙ„ (Ù„ÙŠØ³ Ø·ÙˆÙŠÙ„Ø§Ù‹ Ø¬Ø¯Ø§Ù‹)
            if (poiName && typeof poiName === 'string' && poiName.length > 3 && poiName.length < 50) {
                return poiName;
            }

            // ÙˆØ¥Ù„Ø§ØŒ Ù†Ø±Ø¬Ø¹ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ÙØµÙ„ Ø§Ù„Ù…Ø¹ØªØ§Ø¯
            return d.display_name.split(',').slice(0, 3).reverse().join(', ');
        }
        return `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
    } catch {
        return `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
    }
}

// Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© ÙˆØ§Ù„Ø£Ø¬Ø±Ø©
function calculateDistanceAndFare(lat1, lng1, lat2, lng2) {
    const R = 6371; // Ù†ØµÙ Ù‚Ø·Ø± Ø§Ù„Ø£Ø±Ø¶ Ø¨Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lng2 - lng1) * Math.PI / 180;
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    const distance = (R * c).toFixed(2);
    // Ø§ÙØªØ±Ø§Ø¶: 1000 Ø¯ÙŠÙ†Ø§Ø± Ù„ÙƒÙ„ ÙƒÙ…
    const fare = Math.round(distance * 1000); 
    return { distance: distance, fare: fare };
}


// ---------------- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ù‚Ø±Ø¨ Ø³Ø§Ø¦Ù‚ ----------------

/**
 * Ø¯Ø§Ù„Ø© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© (ÙƒÙŠÙ„ÙˆÙ…ØªØ±) Ø¨ÙŠÙ† Ù†Ù‚Ø·ØªÙŠÙ† Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØµÙŠØºØ© Ù‡Ø§ÙØ±Ø³ÙŠÙ†.
 * @param {number} lat1 - Ø®Ø· Ø¹Ø±Ø¶ Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰.
 * @param {number} lng1 - Ø®Ø· Ø·ÙˆÙ„ Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰.
 * @param {number} lat2 - Ø®Ø· Ø¹Ø±Ø¶ Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©.
 * @param {number} lng2 - Ø®Ø· Ø·ÙˆÙ„ Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©.
 * @returns {number} Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±.
 */
function getDistanceKm(lat1, lng1, lat2, lng2) {
    const R = 6371; // Ù†ØµÙ Ù‚Ø·Ø± Ø§Ù„Ø£Ø±Ø¶ Ø¨Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lng2 - lng1) * Math.PI / 180;
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
}


/**
 * Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ù‚Ø±Ø¨ Ø³Ø§Ø¦Ù‚ Ù…ØªØ§Ø­ ÙÙŠ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© (3 ÙƒÙ…).
 * @param {number} riderLat - Ø®Ø· Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø§ÙƒØ¨.
 * @param {number} riderLng - Ø®Ø· Ø·ÙˆÙ„ Ø§Ù„Ø±Ø§ÙƒØ¨.
 * @param {number} maxDistanceKm - Ø£Ù‚ØµÙ‰ Ù…Ø³Ø§ÙØ© Ù„Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±.
 * @returns {Promise<string|null>} Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø£Ù‚Ø±Ø¨ Ø³Ø§Ø¦Ù‚ Ø£Ùˆ null Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯.
 */
async function findNearbyDriver(riderLat, riderLng, maxDistanceKm = 3) {
    let closestDriverPhone = null;
    let minDistance = Infinity;
    
    // Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ø§Ù„Ù…ØªØ§Ø­ÙŠÙ† (Ø§ÙØªØ±Ø§Ø¶Ø§Ù‹: Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
    const snapshot = await db.ref("drivers").once('value');
    const drivers = snapshot.val();

    if (!drivers) {
        return null;
    }

    // Ø§Ù„Ù…Ø±ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ù‚Ø±Ø¨ Ø¶Ù…Ù† Ù†Ø·Ø§Ù‚ 3 ÙƒÙ…
    for (const phone in drivers) {
        const driver = drivers[phone];
        
        // ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù…ØªØ§Ø­Ø§Ù‹ (Ù…Ø«Ù„Ø§Ù‹: Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‡ÙŠ 'available')
        // *Ø§ÙØªØ±Ø§Ø¶ Ø¨Ø³ÙŠØ·: Ù†Ø¹ØªØ¨Ø± ÙƒÙ„ Ø³Ø§Ø¦Ù‚ Ù„Ø¯ÙŠÙ‡ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª 'lat' Ùˆ 'lng' Ù…ØªØ§Ø­Ø§Ù‹*
        if (driver.lat && driver.lng) {
            const distance = getDistanceKm(riderLat, riderLng, driver.lat, driver.lng);

            if (distance <= maxDistanceKm && distance < minDistance) {
                minDistance = distance;
                closestDriverPhone = phone;
            }
        }
    }

    return closestDriverPhone;
}


// ---------------- ÙˆØ¸Ø§Ø¦Ù ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ----------------

// ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø­Ø³Ø¨ Ù…Ø±Ø­Ù„Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ù‚Ø§Ø· (settingStart, settingEnd, confirmed)
async function updateUIForStage() {
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙƒÙ„ ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
    pin.style.display = 'none';
    mainActionBtn.style.display = 'none';
    costDisplay.style.display = 'none';
    changeStartBtn.style.display = 'none';
    changeEndBtn.style.display = 'none';
    cancelRideBtn.style.display = 'none';
    oldStatus.style.display = 'none'; 
    
    // ğŸ¯ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø¥Ø¸Ù‡Ø§Ø± Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚/Ø§Ù„ÙˆØµÙˆÙ„
    startPointField.style.display = 'flex'; // Ø­Ù‚Ù„ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ Ù…Ø±Ø¦ÙŠ Ø¯Ø§Ø¦Ù…Ø§Ù‹

    if (rideId) {
        // Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø­Ù„Ø© Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
        endPointField.style.display = 'flex';
        return; 
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ø¯Ø¨ÙˆØ³ Ù„Ù„ØªØ­Ø±ÙŠÙƒ ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†Ù‚Ø·Ø©
    pin.style.display = 'block';
    mainActionBtn.style.display = 'block';

    if (currentStage === "settingStart") {
        mainActionBtn.innerText = "ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚";
        mainActionBtn.disabled = !startCoords;
        mainActionBtn.style.background = '#f97316';
        
        startPointValue.innerText = startAreaName ? getShortAreaName(startAreaName) : 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù†Ø·Ù‚Ø©...';
        
        endPointField.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚Ù„ Ø§Ù„ÙˆØµÙˆÙ„
        
    } else if (currentStage === "settingEnd") {
        mainActionBtn.innerText = "ØªØ«Ø¨ÙŠØª Ø§Ù„ÙˆØµÙˆÙ„";
        mainActionBtn.disabled = !endCoords;
        mainActionBtn.style.background = '#f97316';
        
        startPointValue.innerText = getShortAreaName(startAreaName);
        
        endPointField.style.display = 'flex'; // Ø¥Ø¸Ù‡Ø§Ø± Ø­Ù‚Ù„ Ø§Ù„ÙˆØµÙˆÙ„
        endPointValue.innerText = endAreaName ? getShortAreaName(endAreaName) : 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù†Ø·Ù‚Ø©...';
        
        changeStartBtn.style.display = 'inline-block';

        if (startCoords && endCoords) {
            const { distance, fare } = calculateDistanceAndFare(startCoords[0], startCoords[1], endCoords[0], endCoords[1]);
            // ğŸ¯ ØªÙ… ØªØ¹Ø¯ÙŠÙ„ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø¬Ø±Ø© Ù„ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (1,500 IQD)
            fareValue.innerText = fare.toLocaleString('ar-IQ') + ' IQD'; 
            costDisplay.style.display = 'block';
            mainActionBtn.innerText = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨"; // ÙŠØªØºÙŠØ± Ù†Øµ Ø§Ù„Ø²Ø± Ø¥Ù„Ù‰ "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨" Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù†Ù‚Ø·ØªÙŠÙ†
        } else {
            fareValue.innerText = '---';
            costDisplay.style.display = 'none';
            mainActionBtn.innerText = "ØªØ«Ø¨ÙŠØª Ø§Ù„ÙˆØµÙˆÙ„";
        }
        
    } else if (currentStage === "confirmed") {
        // Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø© ØªØ­Ø¯Ø« Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹
        mainActionBtn.innerText = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨";
        mainActionBtn.disabled = !(startCoords && endCoords);
        mainActionBtn.style.background = '#f97316';
        changeStartBtn.style.display = 'inline-block';
        changeEndBtn.style.display = 'inline-block';
        pin.style.display = 'none';
        endPointField.style.display = 'flex';
        
        // Ø¹Ø±Ø¶ Ø§Ù„ØªÙƒÙ„ÙØ© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
        if (startCoords && endCoords) {
            const { distance, fare } = calculateDistanceAndFare(startCoords[0], startCoords[1], endCoords[0], endCoords[1]);
            fareValue.innerText = fare.toLocaleString('ar-IQ') + ' IQD';
            costDisplay.style.display = 'block';
        }
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ø±ÙƒØ© Ø§Ù„Ø®Ø±ÙŠØ·Ø© (Center Pin Logic)
let geocodeTimer = null;
map.on('moveend', async function() {
    const center = map.getCenter();
    const lat = center.lat;
    const lng = center.lng;

    // ØªÙˆÙ‚Ù Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ Ù…Ø±Ø­Ù„Ø© Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø±Ø­Ù„Ø©
    if (rideId) return;

    // Ù…Ù†Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø±Ùƒ Ø§Ù„Ù†Ø´Ø· (Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡)
    // ğŸ¯ ØªÙ… Ø¥Ø²Ø§Ù„Ø© isMapMoving ÙÙŠ Ø­Ø¯Ø« moveend Ù„ØªØ¬Ù†Ø¨ ØªØ¹Ø§Ø±Ø¶ move/moveend
    // if (isMapMoving) return; 

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ù…Ø¹Ù†ÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹
    const currentLat = lat;
    const currentLng = lng;

    if (currentStage === "settingStart") {
        // ØªØ­Ø¯ÙŠØ« Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚
        startCoords = [currentLat, currentLng];
        startPointValue.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù†Ø·Ù‚Ø©...';
    } else if (currentStage === "settingEnd") {
        // ØªØ­Ø¯ÙŠØ« Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„ÙˆØµÙˆÙ„
        endCoords = [currentLat, currentLng];
        endPointValue.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù†Ø·Ù‚Ø©...';
    }
    
    // ØªØ£Ø®ÙŠØ± Reverse Geocoding
    clearTimeout(geocodeTimer);
    geocodeTimer = setTimeout(async () => {
        const areaName = await reverseGeocode(currentLat, currentLng);

        if (currentStage === "settingStart") {
            startAreaName = areaName;
        } else if (currentStage === "settingEnd") {
            endAreaName = areaName;
        }
        
        await updateUIForStage();
    }, 500); 
});

map.on('movestart', function() {
    isMapMoving = true;
    // ğŸ¯ ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ù„ØªÙ†Ø§Ø³Ø¨ ØªØµÙ…ÙŠÙ… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø£ÙƒØ«Ø±
    if (currentStage === "settingStart") {
        startPointValue.innerText = 'Ø¬Ø§Ø±ÙŠ ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø®Ø±ÙŠØ·Ø©...';
        startPointValue.style.color = '#e53935'; // Ù„ÙˆÙ† Ø§Ù„Ø­Ø±ÙƒØ©
    } else if (currentStage === "settingEnd") {
        endPointValue.innerText = 'Ø¬Ø§Ø±ÙŠ ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø®Ø±ÙŠØ·Ø©...';
        endPointValue.style.color = '#e53935'; // Ù„ÙˆÙ† Ø§Ù„Ø­Ø±ÙƒØ©
    }
});

map.on('move', function() {
    // ğŸ¯ ØªÙ… Ø§Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ø¹Ù„Ù‰ isMapMoving = false Ù‡Ù†Ø§ (Ø¨Ø´ÙƒÙ„ Ø®Ø§Ø·Ø¦) Ù„ØªØ·Ø§Ø¨Ù‚ Ù…Ù„ÙÙƒ Ø§Ù„Ø£ØµÙ„ÙŠØŒ 
    // Ù„ÙƒÙ† ØªÙ… Ù†Ù‚Ù„ isMapMoving = false Ø¥Ù„Ù‰ moveend ÙÙŠ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£ØµÙ„ÙŠ (Ø£Ø¹ÙŠØ¯ Ø¥Ø¯Ø®Ø§Ù„Ù‡ Ù‡Ù†Ø§ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­).
    isMapMoving = false;
    if (currentStage === "settingStart") {
        startPointValue.style.color = '#666';
    } else if (currentStage === "settingEnd") {
        endPointValue.style.color = '#666';
    }
});

// ---------------- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ----------------

let searchTimer = null;

// ğŸ¯ ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø¨Ø­Ø« Ù„Ø£Ù† Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« Ù…Ø®ÙÙŠ Ù„ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
/* searchInput.addEventListener('input', function() {
    clearTimeout(searchTimer);
    const query = searchInput.value.trim();

    if (query.length < 3) {
        searchResultsContainer.style.display = 'none';
        searchResultsContainer.innerHTML = '';
        return;
    }

    searchTimer = setTimeout(() => {
        performGeocoding(query);
    }, 700);
}); */

// ğŸ¯ ØªÙ… Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ§Ù„ØŒ Ù„ÙƒÙ†Ù‡Ø§ Ù„Ù† ØªÙØ³ØªØ®Ø¯Ù… Ù…Ø§ Ù„Ù… ÙŠØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¨Ø­Ø«

async function performGeocoding(query) {
    const bbox = '43.3,30.0,48.5,37.3'; 
    const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=10&countrycodes=iq&viewbox=${bbox}&bounded=1&accept-language=ar`;

    try {
        const response = await fetch(url);
        const data = await response.json();
        displaySearchResults(data);
    } catch (error) {
        console.error("Geocoding error:", error);
        searchResultsContainer.style.display = 'none';
    }
}

function displaySearchResults(results) {
    searchResultsContainer.innerHTML = '';
    
    if (results.length === 0) {
        searchResultsContainer.innerHTML = '<div class="search-result-item" style="color:#e53935;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©.</div>';
        searchResultsContainer.style.display = 'block';
        return;
    }

    results.forEach(item => {
        const div = document.createElement('div');
        div.className = 'search-result-item';
        div.innerText = item.display_name;
        
        div.onclick = function() {
            const lat = parseFloat(item.lat);
            const lng = parseFloat(item.lon);
            
            map.setView([lat, lng], 16); 
            map.fire('moveend'); 
            
            searchResultsContainer.style.display = 'none';
            searchInput.value = '';
        };
        searchResultsContainer.appendChild(div);
    });

    searchResultsContainer.style.display = 'block';
}


// ---------------- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø£Ø²Ø±Ø§Ø± ----------------

// ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø²Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ -> ØªØ«Ø¨ÙŠØª Ø§Ù„ÙˆØµÙˆÙ„ -> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨)
mainActionBtn.onclick = async function() {
    if (currentStage === "settingStart") {
        if (!startCoords || !startAreaName) return;
        currentStage = "settingEnd";
        // Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ù† ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ Ø¥Ù„Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØµÙˆÙ„ØŒ Ù†Ø­Ø±Ùƒ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¥Ù„Ù‰ Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚
        map.setView(startCoords, map.getZoom());
        endCoords = null; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
        endAreaName = "";
        await updateUIForStage();
        
    } else if (currentStage === "settingEnd") {
        if (!endCoords || !endAreaName) return;
        // Ù‡Ù†Ø§ ÙƒØ§Ù† "ØªØ«Ø¨ÙŠØª Ø§Ù„ÙˆØµÙˆÙ„"ØŒ Ø§Ù„Ø¢Ù† Ù‡Ùˆ Ø²Ø± "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨" Ø¥Ø°Ø§ ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ù‚Ø·ØªÙŠÙ†
        if (startCoords && endCoords) {
             sendRideRequest();
        } else {
             // ØªØ«Ø¨ÙŠØª Ø§Ù„ÙˆØµÙˆÙ„
            currentStage = "confirmed"; // Ù†ØºÙŠØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ù‚ÙŠÙ…
            await updateUIForStage();
        }
        
    } else if (currentStage === "confirmed") {
        sendRideRequest();
    }
};

changeStartBtn.onclick = async function() {
    currentStage = "settingStart";
    endCoords = null;
    endAreaName = "";
    map.setView(startCoords, map.getZoom()); // Ù†Ø±ÙƒØ² Ø¹Ù„Ù‰ Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    await updateUIForStage();
};

changeEndBtn.onclick = async function() {
    currentStage = "settingEnd";
    map.setView(endCoords, map.getZoom()); // Ù†Ø±ÙƒØ² Ø¹Ù„Ù‰ Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    await updateUIForStage();
};


function sendRideRequest(){
  if(!startCoords||!endCoords){alert("Ø­Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹.");return;}
  mainActionBtn.disabled = true;
  mainActionBtn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ù‚Ø±Ø¨ Ø³Ø§Ø¦Ù‚...";
  mainActionBtn.style.background = '#607d8b'; // Ù„ÙˆÙ† Ù…Ø®ØªÙ„Ù Ù„Ù„Ø¨Ø­Ø«

  // 1. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ù‚Ø±Ø¨ Ø³Ø§Ø¦Ù‚ ÙÙŠ Ø­Ø¯ÙˆØ¯ 3 ÙƒÙ…
  findNearbyDriver(startCoords[0], startCoords[1], 3).then(closestDriverPhone => {
        if (closestDriverPhone) {
            // 2. Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø§Ø¦Ù‚ØŒ ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„ÙŠÙ‡ Ù…Ø¨Ø§Ø´Ø±Ø©
            const phone=localStorage.getItem('phone');
            const { distance, fare } = calculateDistanceAndFare(startCoords[0], startCoords[1], endCoords[0], endCoords[1]);

            rideId=Date.now();
            localStorage.setItem('activeRideId',rideId);

            // Ø¥Ø®ÙØ§Ø¡ Ø¹Ù†Ø§ØµØ± Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†Ù‚Ø·Ø©
            mainActionBtn.style.display='none';
            pin.style.display='none';
            costDisplay.style.display='none';
            changeStartBtn.style.display = 'none';
            changeEndBtn.style.display = 'none';
            
            // Ø¥Ø®ÙØ§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø­Ø«
            searchResultsContainer.style.display = 'none';

            // ğŸ¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø­Ø§Ù„Ø© "Ù…Ù‚Ø¨ÙˆÙ„Ø©" Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ù…Ø­Ø¯Ø¯
            db.ref("rides/"+rideId).set({
                riderPhone:phone,
                startLat:startCoords[0], startLng:startCoords[1], 
                endLat:endCoords[0], endLng:endCoords[1],         
                startArea:startAreaName,endArea:endAreaName, 
                distance:distance,fare:fare,
                status:"Ù…Ù‚Ø¨ÙˆÙ„Ø©", // ÙŠØªÙ… ÙˆØ¶Ø¹Ù‡Ø§ ÙƒÙ…Ù‚Ø¨ÙˆÙ„Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ù‚Ø±ÙŠØ¨
                driverPhone: closestDriverPhone // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ø°ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø·Ù„Ø¨
            });
            
            // ğŸ¯ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù€ Driver Ù„ÙŠØ¹Ù„Ù… Ø¨Ø£Ù† Ù„Ø¯ÙŠÙ‡ Ø±Ø­Ù„Ø© Ù…Ù‚Ø¨ÙˆÙ„Ø©
            // Ù‡Ø°Ù‡ Ø®Ø·ÙˆØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¹Ù„Ù‰ ØªØ·Ø¨ÙŠÙ‚Ù‡ØŒ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ù…Ù†Ø·Ù‚ ÙÙŠ Ø¬Ù‡Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¹Ù‚Ø¯ Ø§Ù„Ù€ driverPhone
            db.ref("driverRequests/"+closestDriverPhone).set({
                rideId: rideId,
                status: "Ù…Ù‚Ø¨ÙˆÙ„Ø©",
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            startPointValue.innerText = getShortAreaName(startAreaName);
            endPointValue.innerText = getShortAreaName(endAreaName);

            startMonitoringRide(rideId);
            
        } else {
            // 3. Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø§Ø¦Ù‚ØŒ ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø­Ø§Ù„Ø© Ø®Ø·Ø£
            mainActionBtn.disabled = false;
            mainActionBtn.innerText = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨";
            mainActionBtn.style.background = '#f97316';
            
            oldStatus.innerHTML = `âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ø³Ø§Ø¦Ù‚ Ù…ØªØ§Ø­ Ø¶Ù…Ù† 3 ÙƒÙ…. Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹.`;
            oldStatus.style.display = 'block';
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙƒÙ„ÙØ©
            updateUIForStage();
        }
  }).catch(error => {
        console.error("Error finding nearby driver:", error);
        mainActionBtn.disabled = false;
        mainActionBtn.innerText = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨";
        mainActionBtn.style.background = '#f97316';
        oldStatus.innerHTML = `âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†.`;
        oldStatus.style.display = 'block';
  });
}

// Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ (ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¥Ù„ØºØ§Ø¡ ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ)
cancelRideBtn.onclick=function(){
    if(!rideId) return;

    db.ref("rides/"+rideId).update({status:"Ù…Ù„ØºØ§Ø©", canceledBy:"rider"});
    cleanupRide();
    alert(`ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨.`); // Ø§Ø³ØªØ®Ø¯Ø§Ù… alert Ø¨Ø³ÙŠØ· Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ØªØ­Ø¯ÙŠØ« Ø­Ù‚Ù„ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…
    
    // Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ù…Ø±Ø­Ù„Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ù„ØºØ§Ø¡
    initGeolocation(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
};


// ---------------- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ§Ù„ØªÙ†Ø¸ÙŠÙ ÙˆØ§Ù„Ù…Ø³Ø§Ø± ----------------

function clearRideMarkers(){
    if(driverMarker) map.removeLayer(driverMarker);
    if(driverRoute) map.removeLayer(driverRoute);
    driverMarker = null;
    driverRoute = null;
}

// Ø¯Ø§Ù„Ø© Ø±Ø³Ù… Ù…Ø³Ø§Ø± Ø­Ù‚ÙŠÙ‚ÙŠ (Ù…Ø®ØªØµØ±Ø© Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£ØµÙ„ÙŠ)
async function drawStreetRoute(lat1, lng1, lat2, lng2, color, dashArray = '') {
    // ... (Ù…Ù†Ø·Ù‚ Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… OSRM) ...
    // ØªÙ… Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø¨Ø³ÙŠØ·Ø§Ù‹ Ù‡Ù†Ø§ Ù„ØºØ±Ø¶ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    if(driverRoute) map.removeLayer(driverRoute); 
    driverRoute = L.polyline([[lat1, lng1], [lat2, lng2]], { color: color, dashArray: dashArray, weight: 5 }).addTo(map);
    map.fitBounds(driverRoute.getBounds());
}

/**
 * Ø¯Ø§Ù„Ø© ØªÙ†Ø¸ÙŠÙ Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø­Ù„Ø© ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¥Ù„Ù‰ ÙˆØ¶Ø¹ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚.
 * ØªÙ… Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù†Ù‚Ø§Ø· Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ ÙˆØ§Ù„ÙˆØµÙˆÙ„.
 */
function cleanupRide(){
    if(rideRef) rideRef.off();
    if(driverRef) driverRef.off();
    rideRef = null;
    driverRef = null;
    currentDriverPhone = null;
    localStorage.removeItem('activeRideId');
    clearRideMarkers();
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¥Ù„Ù‰ ÙˆØ¶Ø¹ Ø§Ù„Ø¨Ø¯Ø¡
    currentStage = "settingStart";
    rideId = null;
    startCoords = null;
    endCoords = null;
    startAreaName = "";
    endAreaName = "";
    
    // ğŸ†• Ø¥Ø®ÙØ§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„Ø©
    oldStatus.style.display = 'none';
    
    // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡
    cancelRideBtn.style.display='none';
    
}

async function startMonitoringDriver(driverPhone, startLat, startLng, endLat, endLng, rideStatus){
    driverRef = db.ref("drivers/"+driverPhone);
    
    driverRef.on('value', async snap => { 
        const d = snap.val();
        if(!d || !d.lat || !d.lng) return;

        const driverCoords = [d.lat, d.lng];
        
        // ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø± Ø§Ù„Ø³Ø§Ø¦Ù‚
        if(driverMarker) map.removeLayer(driverMarker);
        driverMarker = L.marker(driverCoords, {
            icon: L.divIcon({
                className: 'custom-driver-icon',
                html: 'ğŸš•', 
                iconSize: [30, 30]
            })
        }).addTo(map).bindPopup("Ø§Ù„Ø³Ø§Ø¦Ù‚").openPopup();
        
        // Ù…Ù†Ø·Ù‚ Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø±
        if (rideStatus === "Ù…Ù‚Ø¨ÙˆÙ„Ø©" && startLat && startLng) {
            // Ø§Ù„Ù…Ø³Ø§Ø± Ù…Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø§ÙƒØ¨ (Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©)
            //await drawStreetRoute(d.lat, d.lng, startLat, startLng, '#4CAF50', '5, 5'); 
        } else if (rideStatus === "Ø¨Ø¯Ø£Øª" && endLat && endLng) {
             // Ø§Ù„Ù…Ø³Ø§Ø± Ù…Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ¬Ù‡Ø© (Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„)
             //await drawStreetRoute(d.lat, d.lng, endLat, endLng, '#f97316'); 
        }
        
        // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ù‚Ø¨ÙˆÙ„Ø©/Ø¨Ø¯Ø£Øª
        map.setView(driverCoords, map.getZoom() > 14 ? map.getZoom() : 14);

    });
}

function startMonitoringRide(id){
    rideRef = db.ref("rides/"+id);
    mainActionBtn.style.display='none';
    pin.style.display = 'none';
    costDisplay.style.display = 'none';
    cancelRideBtn.style.display='inline-block';
    
    // ğŸ†• Ø¥Ø¸Ù‡Ø§Ø± Ù„ÙˆØ­Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ù„ØªÙ„Ù‚ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
    oldStatus.style.display = 'block';

    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø­Ù„Ø©
    rideRef.on('value', snap => {
        const r = snap.val();
        if(!r) {
            cleanupRide();
            alert(`âš ï¸ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø±Ø­Ù„Ø© Ø£Ùˆ Ø£Ù„ØºÙŠØª Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù….`);
            initGeolocation(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†Ø¸ÙŠÙ
            return;
        }
        
        const r_startLat = r.startLat;
        const r_startLng = r.startLng;
        const r_endLat = r.endLat;
        const r_endLng = r.endLng;

        const distance = r.distance || 0;
        const fare = r.fare ? r.fare.toLocaleString('ar-IQ') : '---';
        
        // ğŸ¯ ØªØ¹Ø¯ÙŠÙ„ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø¬Ø±Ø© Ù„ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (1,500 IQD)
        fareValue.innerText = fare + ' IQD';
        costDisplay.style.display = 'block';

        // ğŸ¯ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¸Ù‡Ø§Ø± Ø­Ù‚Ù„ Ø§Ù„ÙˆØµÙˆÙ„ ÙˆØ­Ù‚Ù„ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
        startPointField.style.display = 'flex';
        endPointField.style.display = 'flex';


        if (r.status === "Ø¬Ø¯ÙŠØ¯Ø©") {
            // Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù† ØªØ­Ø¯Ø« Ø¨Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¬Ø¯ÙŠØ¯ØŒ Ù„ÙƒÙ† Ù†ØªØ±ÙƒÙ‡Ø§ Ø§Ø­ØªÙŠØ§Ø·Ø§Ù‹ Ø¥Ø°Ø§ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            mainActionBtn.innerText=`âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„. ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚...`;
            mainActionBtn.style.display = 'block';
            mainActionBtn.disabled = true; // Ù„Ù…Ù†Ø¹ Ø§Ù„Ø¶ØºØ· Ø¹Ù„ÙŠÙ‡ ÙˆÙ‡Ùˆ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
            mainActionBtn.style.background = '#607d8b'; // Ù„ÙˆÙ† Ù…Ø®ØªÙ„Ù Ù„Ù„Ø§Ù†ØªØ¸Ø§Ø±
            clearRideMarkers();
            
            oldStatus.innerHTML = `âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†... Ø¨Ø¥Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù‚Ø¨ÙˆÙ„.`;
            
        } else if (r.status === "Ù…Ù‚Ø¨ÙˆÙ„Ø©" && r.driverPhone) {
            mainActionBtn.style.display = 'none';
            cancelRideBtn.style.display='inline-block';
            
            // ** ğŸ¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ: Ø¹Ø±Ø¶ Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ø³Ø§Ø¦Ù‚ **
            oldStatus.innerHTML = `
                ğŸš– ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©! Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù‚Ø§Ø¯Ù… Ø¥Ù„ÙŠÙƒ.<br>
                Ø±Ù‚Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚: <b><a href="tel:${r.driverPhone}">${r.driverPhone}</a></b>.
            `;
            
            if (r.driverPhone !== currentDriverPhone) {
                if(driverRef) driverRef.off(); 
                currentDriverPhone = r.driverPhone;
                startMonitoringDriver(r.driverPhone, r_startLat, r_startLng, r_endLat, r_endLng, r.status);
            } 
            
        } else if (r.status === "Ø¨Ø¯Ø£Øª") {
             mainActionBtn.style.display = 'none';
             cancelRideBtn.style.display='inline-block';
             oldStatus.innerHTML = `
                ğŸš¦ Ø§Ù„Ø±Ø­Ù„Ø© Ø¨Ø¯Ø£Øª! Ø£Ù†Øª ÙÙŠ Ø·Ø±ÙŠÙ‚Ùƒ Ø¥Ù„Ù‰ ${getShortAreaName(r.endArea)}.<br>
                Ø±Ù‚Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚: <b><a href="tel:${r.driverPhone}">${r.driverPhone}</a></b>.
            `;

             if (r.driverPhone !== currentDriverPhone) {
                if(driverRef) driverRef.off(); 
                currentDriverPhone = r.driverPhone;
                startMonitoringDriver(r.driverPhone, r_startLat, r_startLng, r_endLat, r_endLng, r.status);
            } 
             
        } else if (r.status === "Ù…Ù†ØªÙ‡ÙŠØ©" || r.status === "Ù…Ù„ØºØ§Ø©" || r.status === "Ù…Ø±ÙÙˆØ¶Ø©") {
            const message = `Ø§Ù„Ø±Ø­Ù„Ø© ${r.status}.`;
            oldStatus.innerHTML = message;
            alert(message);
            cleanupRide(); 
            initGeolocation(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†Ø¸ÙŠÙ
        }
    });
}


// ---------------- ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ ----------------

function initGeolocation() {
    navigator.geolocation.getCurrentPosition(async pos=>{
      startCoords=[pos.coords.latitude,pos.coords.longitude];
      map.setView(startCoords,15);

      startAreaName=await reverseGeocode(startCoords[0],startCoords[1]);
      
      // Ø¨Ù…Ø¬Ø±Ø¯ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø£ÙˆÙ„ØŒ Ù†Ø¨Ø¯Ø£ Ø¨Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø©
      rideId = localStorage.getItem('activeRideId');
      if(rideId){
        map.whenReady(() => {
            startMonitoringRide(rideId);
        });
      } else {
        await updateUIForStage(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù„Ø¨Ø¯Ø¡ Ù…Ø±Ø­Ù„Ø© "ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚"
      }
      
    },async err=>{
        // ÙÙŠ Ø­Ø§Ù„ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø¹Ø¨ÙŠØ¯ÙŠ Ø­ÙŠ Ø§Ù„Ø±Ø¦Ø§Ø³Ø© ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠ
        const defaultLat = 33.3603;
        const defaultLng = 44.5066;
        
        startAreaName = "Ø¨ØºØ¯Ø§Ø¯ - Ø§Ù„Ø¹Ø¨ÙŠØ¯ÙŠ - Ø­ÙŠ Ø§Ù„Ø±Ø¦Ø§Ø³Ø©"; // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
        startCoords = [defaultLat, defaultLng];
        
        alert("âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø¯Ù‚Ø©ØŒ ÙŠØ±Ø¬Ù‰ ØªØ«Ø¨ÙŠØª Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ Ø¨ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø®Ø±ÙŠØ·Ø©.");
        
        rideId = localStorage.getItem('activeRideId');
         if(rideId){
            map.whenReady(() => {
                startMonitoringRide(rideId);
            });
         } else {
            // ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù„ØªØ¨Ø¯Ø£ Ø¹Ù…Ù„ÙŠØ© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø¨ÙˆØ³
            await updateUIForStage();
         }
        
    },{enableHighAccuracy:true,timeout:10000,maximumAge:0});
}

// ---------------- ÙˆØ¸Ø§Ø¦Ù ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ----------------

window.onload=function(){
    let phone=localStorage.getItem("phone");
    let userType=localStorage.getItem("userType");

    if(!phone||!userType){window.location.href="index.html";return;}
    if(userType==="driver") window.location.href="driver.html";
    
    initGeolocation();
};

window.logout=function(){
    if(rideRef) rideRef.off();
    if(driverRef) driverRef.off();
    localStorage.removeItem('phone');
    localStorage.removeItem('userType');
    localStorage.removeItem('activeRideId');
    window.location.href="index.html";
};

</script>

</body>
</html>
