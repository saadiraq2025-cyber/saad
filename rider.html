<script>
// Ù…Ù†Ø¹ Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… â€” ÙŠØ¨Ù‚Ù‰ Ù…Ø³Ø¬Ù„ Ø­ØªÙ‰ Ù„Ùˆ ØºÙ„Ù‚ Ø§Ù„Ù…ØªØµÙØ­
window.onload = function () {
    let phone = localStorage.getItem("phone");
    let userType = localStorage.getItem("userType");

    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ±Ø¬Ø¹ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
    if (!phone || !userType) {
        window.location.href = "index.html"; // ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        return;
    }

    // ØªÙˆØ¬ÙŠÙ‡ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    if (userType === "driver" && window.location.pathname.indexOf("driver") === -1) {
        window.location.href = "driver.html";
    }

    if (userType === "rider" && window.location.pathname.indexOf("rider") === -1) {
        window.location.href = "rider.html";
    }
}
</script>
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø±Ø§ÙƒØ¨ - ØªÙƒØ³ÙŠ Ø§Ù„Ø¹Ø±Ø§Ù‚ Ø§Ù„Ø´Ø§Ù…Ù„</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2e7d32">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="/icons/icon-192x192.png">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<style>
/* ** ğŸ†• ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ÙÙŠØ¯ÙŠÙˆ ** */
body, html {
    margin: 0;
    padding: 0;
    height: 100%;
    font-family: 'Droid Arabic Kufi', Tahoma, sans-serif; /* Ø®Ø· Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© */
    overflow: hidden; /* Ù„Ù…Ù†Ø¹ Ø¸Ù‡ÙˆØ± Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± */
}

#map {
    height: 100%; /* Ø§Ù„Ø®Ø±ÙŠØ·Ø© ØªÙ…Ù„Ø£ Ø§Ù„Ø´Ø§Ø´Ø© */
    width: 100%;
}

/* ğŸ†• ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø­Ù…Ø±Ø§Ø¡ ÙÙŠ ÙˆØ³Ø· Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
.fixed-pin {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -100%); /* ØªØ­Ø±ÙŠÙƒ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø°ÙŠÙ„ ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ */
    z-index: 1000; /* ÙÙˆÙ‚ Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
    width: 32px; /* Ø­Ø¬Ù… Ø§Ù„Ø¹Ù„Ø§Ù…Ø© */
    height: 48px;
    background-image: url('data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%2032%2032%22%3E%3Cpath%20fill%3D%22%23E91E63%22%20d%3D%22M16%200C9.37%200%204%205.37%204%2012c0%208%2012%2020%2012%2020s12-12%2012-20c0-6.63-5.37-12-12-12zm0%2018c-3.31%200-6-2.69-6-6s2.69-6%206-6%206%202.69%206%206-2.69%206-6%206z%22%2F%3E%3C%2Fsvg%3E'); /* Ø¹Ù„Ø§Ù…Ø© Ø­Ù…Ø±Ø§Ø¡ Ø¨Ø³ÙŠØ·Ø© */
    background-repeat: no-repeat;
    background-size: contain;
}

/* ğŸ†• Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ (Panel) */
#bottomPanel {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #fff;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
    padding: 15px 10px 10px;
    z-index: 1001; /* ÙÙˆÙ‚ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© ÙˆÙ…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
    transition: height 0.3s ease-in-out, padding 0.3s ease-in-out;
}

/* Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± (Ù†Ù‚Ø§Ø· Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ ÙˆØ§Ù„ÙˆØµÙˆÙ„) */
.ride-selection-state {
    padding-bottom: 90px; /* Ù„ØªØ±Ùƒ Ù…Ø³Ø§Ø­Ø© Ù„Ø²Ø± "ØªØ«Ø¨ÙŠØª Ø§Ù„ÙˆØµÙˆÙ„" */
}

/* Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±/Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© */
.ride-active-state {
    padding-bottom: 20px; /* Ø£Ù‚Ù„ Ø§Ø±ØªÙØ§Ø¹ Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© */
}

/* ØªØ®Ø·ÙŠØ· Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ 1 (ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ù‚Ø§Ø·) */
.location-input-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.location-input-item {
    display: flex;
    align-items: center;
    background: #f5f5f5;
    padding: 10px;
    border-radius: 8px;
    cursor: pointer;
    box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.05);
}

.location-icon {
    font-size: 20px;
    margin-left: 10px;
}

.start-icon { color: #2e7d32; } /* Ø£Ø®Ø¶Ø± */
.end-icon { color: #E53935; } /* Ø£Ø­Ù…Ø± */
.location-text {
    flex-grow: 1;
    font-size: 14px;
    text-align: right;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.location-text b {
    display: block;
    font-size: 16px;
    font-weight: bold;
    color: #333;
}

/* Ø²Ø± Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ / ØªØ«Ø¨ÙŠØª Ø§Ù„ÙˆØµÙˆÙ„ / Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨) */
.main-action-btn {
    width: 100%;
    background: #ff7043; /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„ÙÙŠØ¯ÙŠÙˆ */
    color: white;
    border: none;
    padding: 15px;
    border-radius: 12px;
    font-size: 18px;
    font-weight: bold;
    margin-top: 15px;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(255, 112, 67, 0.4);
}
.main-action-btn:disabled {
    background: #bdbdbd;
    box-shadow: none;
    cursor: not-allowed;
}

/* Ø´Ø§Ø´Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ (Ø§Ù„ØªÙƒÙ„ÙØ©) */
#fareContainer {
    display: none;
    background: #fff8e1;
    border: 1px solid #ffca28;
    padding: 10px;
    border-radius: 8px;
    margin-top: 10px;
    font-size: 16px;
    text-align: center;
}
#fareContainer b {
    font-size: 20px;
    color: #e65100;
}

/* Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø© */
#statusPanel {
    padding: 10px;
    background: #e3f2fd;
    border-radius: 8px;
    text-align: right;
    margin-bottom: 10px;
}
#statusPanel b { color: #1565c0; }
#statusPanel a { color: #e65100; text-decoration: none; font-weight: bold; }

/* ğŸ†• ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø£Ù…Ø§ÙƒÙ† (ØªØ¨Ù‚Ù‰ Ù…Ø®ÙÙŠØ© ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©) */
#searchContainer {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: #fff;
    padding: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    z-index: 1002;
    display: none; /* Ø¥Ø®ÙØ§Ø¡ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
}
#searchInput {
    width: 100%;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 16px;
    box-sizing: border-box; 
    direction: rtl;
}
#searchResults {
    list-style: none;
    padding: 0;
    margin: 5px 0 0 0;
    max-height: calc(100vh - 100px); /* ÙŠÙ…Ù„Ø£ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø´Ø§Ø´Ø© */
    overflow-y: auto;
    border: 1px solid #eee;
    border-radius: 5px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    display: none;
    text-align: right; 
    position: absolute; /* Ù„ÙŠØºØ·ÙŠ Ù…Ø§ ØªØ­ØªÙ‡ */
    top: 60px;
    left: 10px;
    right: 10px;
    background: white;
    z-index: 1003;
}
#searchResults li {
    padding: 12px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    font-size: 16px;
    background: #fff;
}
#searchResults li:hover {
    background: #f0f0f0;
}
/* â¬…ï¸ Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ */
#logoutBtn { 
    background: #607d8b; 
    color: white; 
    margin-top: 10px; 
    width: 100%; 
    border: none;
    padding: 10px;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
}
</style>
</head>
<body>

<div id="map"></div>
<div class="fixed-pin" id="mapPin"></div> <div id="searchContainer">
    <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© (Ù…Ù†Ø·Ù‚Ø©ØŒ Ø´Ø§Ø±Ø¹...)">
</div>
<ul id="searchResults"></ul>
<div id="bottomPanel" class="ride-selection-state">
    
    <div id="selectionMode">
        
        <div class="location-input-item" id="startLocationDisplay">
            <span class="location-icon start-icon">â¦¿</span>
            <div class="location-text">
                Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚
                <b id="startAreaText">... Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ ...</b>
            </div>
            <button id="changeStartBtn" style="background:#f0f0f0; border:1px solid #ccc; color:#333; padding:5px 10px; border-radius:5px; font-size:12px; font-weight:normal; margin-left:10px;">ØªØºÙŠÙŠØ±</button>
        </div>

        <div class="location-input-item" id="endLocationDisplay">
            <span class="location-icon end-icon">âš‘</span>
            <div class="location-text">
                Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„
                <b id="endAreaText">... ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ ...</b>
            </div>
            <button id="changeEndBtn" style="display:none; background:#f0f0f0; border:1px solid #ccc; color:#333; padding:5px 10px; border-radius:5px; font-size:12px; font-weight:normal; margin-left:10px;">ØªØºÙŠÙŠØ±</button>
        </div>
        
        <div id="fareContainer">
            Ø§Ù„ØªÙƒÙ„ÙØ©: <b id="fareAmountText">0</b> IQD
        </div>

        <button class="main-action-btn" id="mainActionButton" disabled>
            ØªØ«Ø¨ÙŠØª Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„
        </button>
    </div>

    <div id="activeMode" style="display:none;">
        <div id="statusPanel">
            </div>
        <button class="main-action-btn" id="cancelRideBtn" style="background:#E53935;">
            âŒ Ø¥Ù†Ù‡Ø§Ø¡/Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©
        </button>
    </div>

    <button id="logoutBtn" onclick="window.logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>

</div>
<script>
// ** â¬…ï¸ Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ **
window.logout = function() {
    localStorage.removeItem('phone');
    localStorage.removeItem('userType');
    // **Ø§Ù„ØªØ¹Ø¯ÙŠÙ„:** Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø±Ø­Ù„Ø© Ù†Ø´Ø·Ø© Ù‚Ø¨Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    localStorage.removeItem('activeRideId');
    window.location.href = "index.html";
};
// ----------------------------------------

// ğŸš¨ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ù„Ø³Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙˆÙ„ Ø´ÙŠØ¡)
const userPhone = localStorage.getItem('phone');
const userType = localStorage.getItem('userType');

if (!userPhone || userType !== 'rider') {
    alert("âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ±Ø§ÙƒØ¨ Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©.");
    window.location.href = "index.html";
}
// ----------------------------------------

// ØªÙ‡ÙŠØ¦Ø© Firebase
const app=firebase.initializeApp({
  apiKey:"AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M",
  authDomain:"taxi-15314.firebaseapp.com",
  databaseURL:"https://taxi-15314-default-rtdb.firebaseio.com/",
  projectId:"taxi-15314"
});
const db=firebase.database();

let map=L.map('map',{zoomControl: false}).setView([33.3152,44.3661],13); // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø²ÙˆÙ… Ø§Ù„Ù…Ø¯Ù…Ø¬
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
// ğŸ’¡ Ø§Ù„Ø­Ù„ Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙÙŠ Ù…ØªØµÙØ­Ø§Øª iOS (ÙŠØ¶Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ø¬ÙŠÙ…Ù‡Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©)
map.whenReady(function() { 
    map.invalidateSize(); 
});

// ** ğŸ†• Ø¥Ø®ÙØ§Ø¡ Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ø¹ØªØ§Ø¯Ø©ØŒ Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø«Ø§Ø¨ØªØ© ÙÙŠ ÙˆØ³Ø· Ø§Ù„Ø´Ø§Ø´Ø© **
//let startMarker=null,endMarker=null;
let rideId=null;

let startCoords=null,endCoords=null; // Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ ÙˆØ§Ù„ÙˆØµÙˆÙ„

// ğŸ†• Ù…ØªØºÙŠØ±Ø§Øª Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚
let startAreaName = "Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...";
let endAreaName = "ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ø¯ÙŠØ¯...";
// ------------------------------------------

// ** ğŸ†• Ù…ØªØºÙŠØ±Ø§Øª Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ (ØªØ¹Ø¯ÙŠÙ„ Ø¬Ø¯ÙŠØ¯) **
let driverMarker = null; // Ø¹Ù„Ø§Ù…Ø© Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚
let driverLocationRef = null; // Ù…Ø±Ø¬Ø¹ Firebase Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚
// ------------------------------------------
// ğŸ†• Ù…ØªØºÙŠØ± Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚ (30 Ø«Ø§Ù†ÙŠØ©)
let searchTimerInterval = null; 

// Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
const mainActionBtn = document.getElementById("mainActionButton");
const cancelRideBtn = document.getElementById("cancelRideBtn");

// Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
const startAreaText = document.getElementById('startAreaText');
const endAreaText = document.getElementById('endAreaText');
const startLocationDisplay = document.getElementById('startLocationDisplay');
const endLocationDisplay = document.getElementById('endLocationDisplay');
const fareContainer = document.getElementById('fareContainer');
const fareAmountText = document.getElementById('fareAmountText');
const bottomPanel = document.getElementById('bottomPanel');
const mapPin = document.getElementById('mapPin');

// Ø¹Ù†Ø§ØµØ± ÙˆØ¶Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„
const selectionMode = document.getElementById('selectionMode');
const activeMode = document.getElementById('activeMode');
const statusPanel = document.getElementById('statusPanel');


// ğŸ†• Ø¹Ù†Ø§ØµØ± ÙˆÙ…Ù†Ø·Ù‚ Ø§Ù„Ø¨Ø­Ø«
const searchInput = document.getElementById('searchInput');
const searchResultsUl = document.getElementById('searchResults');
const searchContainer = document.getElementById('searchContainer'); 
const SEARCH_DELAY = 500; 
let searchInputTimer = null; 
let isSelectingStart = false; // Ù„ØªØªØ¨Ø¹ Ù…Ø§ Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ù†Ø­Ø¯Ø¯ Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ Ø£Ù… Ø§Ù„ÙˆØµÙˆÙ„

// ******************************************************
// ğŸ†• Ø¯Ø§Ù„Ø© Ø§Ù„Ø¹Ù†ÙˆÙ†Ø© Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ© Ø§Ù„Ø¹ÙƒØ³ÙŠØ© (Reverse Geocoding)
// ******************************************************
async function reverseGeocode(lat, lon) {
    const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=ar`;
    try {
        const response = await fetch(url);
        const data = await response.json();
        if (data && data.display_name) {
            // ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø§Ø³Ù… ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙÙ‚Ø· (Ù…Ø«Ù„Ø§Ù‹: Ø§Ù„Ø­ÙŠØŒ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©ØŒ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©)
            // Ù†Ø£Ø®Ø° Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ø£Ø±Ø¨Ø¹Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø© (Ø§Ù„Ø´Ø§Ø±Ø¹ØŒ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©ØŒ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©ØŒ Ø§Ù„Ø¨Ù„Ø¯)
            const parts = data.display_name.split(',');
            // Ù†Ø­Ø°Ù Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„ØªÙŠ ØªØ­Ù…Ù„ Ø£Ø±Ù‚Ø§Ù…Ù‹Ø§ Ø£Ùˆ Ø¹Ù†Ø§ÙˆÙŠÙ† Ø¶ÙŠÙ‚Ø© Ø¬Ø¯Ø§Ù‹ ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
            const relevantParts = parts.filter(p => !/\d/.test(p.trim())).slice(0, 4).reverse();
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø§Ø³Ù… Ù…Ø¨Ù†Ù‰ Ø£Ùˆ Ù…ÙƒØ§Ù† Ù…Ù‡Ù…ØŒ Ù†Ø³ØªØ®Ø¯Ù…Ù‡
            if (data.name) {
                 return data.name + ", " + relevantParts.join(', ').trim();
            }
            return relevantParts.join(', ').trim() || `Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª: ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
        }
        return `Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª: ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
    } catch (error) {
        console.error('Reverse Geocoding Error:', error);
        return `Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª: ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
    }
}


// ğŸ†• Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Nominatim (ØªØ³ØªØ®Ø¯Ù… OpenStreetMap)
function searchLocation(query) {
    if (query.length < 3) {
        searchResultsUl.innerHTML = '';
        searchResultsUl.style.display = 'none';
        return;
    }
    
    // ğŸ’¡ Ø¥Ø¶Ø§ÙØ© 'Ø¨ØºØ¯Ø§Ø¯, Ø§Ù„Ø¹Ø±Ø§Ù‚' ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠ Ù„ØªØ­Ø³ÙŠÙ† Ø¯Ù‚Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    const fullQuery = `${query}, Ø¨ØºØ¯Ø§Ø¯, Ø§Ù„Ø¹Ø±Ø§Ù‚`; 
    const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(fullQuery)}&format=json&limit=7&addressdetails=1&accept-language=ar`;

    fetch(url)
        .then(response => response.json())
        .then(data => {
            searchResultsUl.innerHTML = '';
            if (data.length > 0) {
                data.forEach(item => {
                    const li = document.createElement('li');
                    // Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù† Ù…Ø¹ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø£Ùˆ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø£Ù‡Ù…
                    const areaName = item.display_name.split(',').slice(0, 4).reverse().join(', ').trim();
                    li.innerText = areaName;
                    li.setAttribute('data-lat', item.lat);
                    li.setAttribute('data-lng', item.lon);
                    li.setAttribute('data-name', areaName); // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø§Ø³Ù… Ù„Ù„Ø¹Ø±Ø¶
                    li.onclick = () => selectSearchResult(item.lat, item.lon, areaName);
                    searchResultsUl.appendChild(li);
                });
                searchResultsUl.style.display = 'block';
            } else {
                searchResultsUl.innerHTML = '<li>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©.</li>';
                searchResultsUl.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Search error:', error);
            searchResultsUl.innerHTML = '<li>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«.</li>';
            searchResultsUl.style.display = 'block';
        });
}

// ğŸ†• Ø¯Ø§Ù„Ø© Ø§Ø®ØªÙŠØ§Ø± Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¨Ø­Ø«
function selectSearchResult(lat, lng, name) {
    // 1. Ø¥Ø®ÙØ§Ø¡ ÙˆØ¥ÙØ±Ø§Øº Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    searchResultsUl.innerHTML = '';
    searchResultsUl.style.display = 'none';
    searchInput.value = ''; // Ø¥ÙØ±Ø§Øº Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«
    searchContainer.style.display = 'none';
    
    // 2. ØªØ­Ø¯ÙŠØ« Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ù…Ø¨Ø§Ø´Ø±Ø© ÙˆØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    endCoords = [parseFloat(lat), parseFloat(lng)];
    endAreaName = name; 

    // 3. ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    updateRiderUI(false); // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± (Ù„ÙŠØ³ ÙˆØ¶Ø¹ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©)
    
    // 4. Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    map.setView(endCoords, 15);
}

// ğŸ†• Ø±Ø¨Ø· Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¯Ø§Ù„Ø© Ù…Ø¹ Ø®Ø§ØµÙŠØ© Ø§Ù„ØªØ£Ø®ÙŠØ±
searchInput.addEventListener('input', (e) => {
    clearTimeout(searchInputTimer);
    searchInputTimer = setTimeout(() => {
        searchLocation(e.target.value.trim());
    }, SEARCH_DELAY);
});

// ğŸ†• Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
document.addEventListener('click', (e) => {
    if (!searchContainer.contains(e.target) && searchResultsUl.style.display === 'block') {
        searchResultsUl.style.display = 'none';
    }
});

// ** ğŸ†• Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø§ÙƒØ¨ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± **
function updateRiderUI(isInitialLoad = false) {
    // 1. ØªØ­Ø¯ÙŠØ« Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ
    startAreaText.innerHTML = startAreaName;
    endAreaText.innerHTML = endAreaName;
    
    // 2. Ù…Ù†Ø·Ù‚ ØªÙ…ÙƒÙŠÙ† Ø²Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙˆØªØºÙŠÙŠØ± Ù†ØµÙ‡
    if (startCoords && endCoords) {
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© ÙˆØ§Ù„Ø£Ø¬Ø±Ø© (Ù…ÙƒØ±Ø± Ù…Ù† Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©)
        const R = 6371;
        const dLat = (endCoords[0] - startCoords[0]) * Math.PI / 180;
        const dLon = (endCoords[1] - startCoords[1]) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(startCoords[0] * Math.PI / 180) * Math.cos(endCoords[0] * Math.PI / 180) *
                  Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        const distance = (R * c).toFixed(2);
        const fare = Math.round(distance * 1000);
        
        // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙƒÙ„ÙØ©
        fareAmountText.innerText = fare.toLocaleString('en-US'); // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
        fareContainer.style.display = 'block';
        
        mainActionBtn.innerText = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ (ØªØ£ÙƒÙŠØ¯ Ø§Ù„ÙˆØ¬Ù‡Ø©)";
        mainActionBtn.disabled = false;
        
    } else if (startCoords && !endCoords) {
        fareContainer.style.display = 'none';
        endAreaText.innerHTML = "<b>" + endAreaName + "</b>";
        mainActionBtn.innerText = "ØªØ«Ø¨ÙŠØª Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„";
        mainActionBtn.disabled = false; // Ù„Ø£Ù† Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø­Ù…Ø±Ø§Ø¡ Ø§Ù„Ø«Ø§Ø¨ØªØ© ØªÙ…Ø«Ù„ Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© ØºÙŠØ± Ø§Ù„Ù…Ø¤ÙƒØ¯Ø©
    } else {
        fareContainer.style.display = 'none';
        mainActionBtn.innerText = "Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ...";
        mainActionBtn.disabled = true;
    }
    
    // 3. Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„ØªØºÙŠÙŠØ±
    document.getElementById('changeEndBtn').style.display = endCoords ? 'inline-block' : 'none';
    
    // 4. Ù…Ù†Ø·Ù‚ Ø­Ø§Ù„Ø© ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
    if (isSelectingStart) {
        // Ø­Ø§Ù„Ø© Ø§Ø®ØªÙŠØ§Ø± Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚
        mainActionBtn.innerText = "ØªØ«Ø¨ÙŠØª Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚";
        startLocationDisplay.style.background = '#e3f2fd';
        endLocationDisplay.style.background = '#f5f5f5';
        
        const currentCenter = map.getCenter();
        startCoords = [currentCenter.lat, currentCenter.lng];
        reverseGeocode(startCoords[0], startCoords[1]).then(name => {
            startAreaName = name;
            startAreaText.innerHTML = `<b>${startAreaName}</b>`;
        });
        
    } else if (rideId) {
        // Ù„Ø§ Ø´ÙŠØ¡ØŒ ÙŠØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡ ÙÙŠ checkActiveRide Ùˆ listenForUpdates
    } else {
        // Ø­Ø§Ù„Ø© Ø§Ø®ØªÙŠØ§Ø± Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„ (Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ)
        mainActionBtn.innerText = endCoords ? "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ (ØªØ£ÙƒÙŠØ¯ Ø§Ù„ÙˆØ¬Ù‡Ø©)" : "ØªØ«Ø¨ÙŠØª Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„";
        startLocationDisplay.style.background = '#f5f5f5';
        endLocationDisplay.style.background = '#e3f2fd'; // ØªÙ…ÙŠÙŠØ² Ø®Ø§Ù†Ø© Ø§Ù„ÙˆØµÙˆÙ„
        
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ø¨Ø¹Ø¯ØŒ ØªÙƒÙˆÙ† Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø­Ù…Ø±Ø§Ø¡ Ù‡ÙŠ Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
        if (!endCoords) {
            const currentCenter = map.getCenter();
            // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
            reverseGeocode(currentCenter.lat, currentCenter.lng).then(name => {
                endAreaName = name;
                endAreaText.innerHTML = `<b>${endAreaName}</b>`;
            });
            
            // ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ø²Ø± Ù„ØªØ£ÙƒÙŠØ¯ Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
            mainActionBtn.disabled = false; 
        }
    }
}

// ğŸ†• Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
startLocationDisplay.addEventListener('click', () => {
    if (rideId) return; 
    isSelectingStart = true;
    updateRiderUI();
    mapPin.style.color = '#2e7d32'; // ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ù„Ù„ØªÙ…ÙŠÙŠØ²
});

endLocationDisplay.addEventListener('click', () => {
    if (rideId) return; 
    // ğŸ’¡ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„ÙˆØµÙˆÙ„ØŒ Ù†Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨Ø­Ø«
    if (endCoords) {
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ù…Ø­Ø¯Ø¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ù†Ø¹ÙˆØ¯ Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø¨Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØºÙŠÙŠØ±Ù‡Ø§
        endCoords = null;
    }
    
    isSelectingStart = false;
    searchContainer.style.display = 'block';
    searchInput.focus();
    mapPin.style.color = '#E53935'; 
    updateRiderUI();
});

// Ø²Ø± ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ - Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚
document.getElementById('changeStartBtn').addEventListener('click', (e) => {
    e.stopPropagation(); // Ù…Ù†Ø¹ Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„Ù†Ù‚Ø± Ø¥Ù„Ù‰ Ø§Ù„Ù€ div Ø§Ù„Ø£Ø¨
    if (rideId) return; 
    isSelectingStart = true;
    updateRiderUI();
    mapPin.style.color = '#2e7d32'; 
    // Ù†Ù†Ù‚Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¥Ù„Ù‰ Ø¢Ø®Ø± Ù…ÙˆÙ‚Ø¹ Ø§Ù†Ø·Ù„Ø§Ù‚ Ù…Ø¤ÙƒØ¯
    if(startCoords) map.setView(startCoords, 15);
});

// Ø²Ø± ØªØºÙŠÙŠØ± Ø§Ù„ÙˆØµÙˆÙ„ - Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© Ù„ÙˆØ¶Ø¹ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
document.getElementById('changeEndBtn').addEventListener('click', (e) => {
    e.stopPropagation(); 
    if (rideId) return; 
    endCoords = null; // Ø¥Ù„ØºØ§Ø¡ Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
    endAreaName = "ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ø¯ÙŠØ¯...";
    map.setView(startCoords || map.getCenter(), 15); // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ Ø£Ùˆ Ù…Ø±ÙƒØ² Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    isSelectingStart = false;
    updateRiderUI();
    mapPin.style.color = '#E53935'; 
});

// ğŸ†• Ù…ØªØ§Ø¨Ø¹Ø© ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø© ÙÙŠ Ø§Ù„Ø²Ù…Ù† Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
map.on('move', () => {
    if (rideId) return; 
    if (isSelectingStart || !endCoords) {
        updateRiderUI();
    }
});
// ----------------------------------------


// ** ğŸ†• Ø¯Ø§Ù„Ø© ÙØ­Øµ Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© **
function checkActiveRide() {
    const storedRideId = localStorage.getItem('activeRideId');
    if (storedRideId) {
        rideId = storedRideId;
        
        // ğŸ†• ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
        selectionMode.style.display = 'none';
        activeMode.style.display = 'block';
        bottomPanel.classList.remove('ride-selection-state');
        bottomPanel.classList.add('ride-active-state');
        mapPin.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø«Ø§Ø¨ØªØ©
        
        statusPanel.innerHTML = "Ù„Ø¯ÙŠÙƒ Ø±Ø­Ù„Ø© Ù†Ø´Ø·Ø© Ù‚ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©. ÙŠØªÙ… Ø¬Ù„Ø¨ Ø­Ø§Ù„ØªÙ‡Ø§...";
        
        listenForUpdates();
    } else {
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù„Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
        selectionMode.style.display = 'block';
        activeMode.style.display = 'none';
        bottomPanel.classList.add('ride-selection-state');
        bottomPanel.classList.remove('ride-active-state');
        mapPin.style.display = 'block';
        updateRiderUI(true);
    }
}
// ----------------------------------------

// ******************************************************
// ğŸ†• Ø¯Ø§Ù„Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚ (30 Ø«Ø§Ù†ÙŠØ©)
// ******************************************************
function startSearchCountdown() {
    if (searchTimerInterval) clearInterval(searchTimerInterval);
    
    let timeLeft = 30; // 30 Ø«Ø§Ù†ÙŠØ© Ù„Ù„Ø¨Ø­Ø«
    
    // ØªØ­Ø¯ÙŠØ« Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
    const initialStatus = statusPanel.innerHTML;
    statusPanel.innerHTML = initialStatus + `<br><b>(Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${timeLeft} Ø«Ø§Ù†ÙŠØ©)</b>`;
    
    searchTimerInterval = setInterval(() => {
        timeLeft--;

        if (timeLeft < 0) {
            clearInterval(searchTimerInterval);
            searchTimerInterval = null;
            
            // ğŸš¨ Ø¥Ø¬Ø±Ø§Ø¡: Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ ÙˆÙ‚Øª Ø§Ù„Ø¨Ø­Ø«
            if (rideId) {
                // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ù‚Ø¯ÙŠÙ…
                firebase.database().ref("rides/" + rideId).off("value"); 
                
                firebase.database().ref("rides/" + rideId).update({
                    status: "Ù…Ù„ØºØ§Ø© - Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª",
                    notification: "âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ ÙˆÙ‚Øª Ø§Ù„Ø¨Ø­Ø« (30 Ø«Ø§Ù†ÙŠØ©)"
                }).then(() => {
                    statusPanel.innerHTML = `
                        âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø§Ø¦Ù‚ Ø®Ù„Ø§Ù„ 30 Ø«Ø§Ù†ÙŠØ©.<br>
                        ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¬Ø¯Ø¯Ø§Ù‹.
                    `;
                    resetRiderState();
                });
            } else {
                resetRiderState();
            }
            return;
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const currentHtml = statusPanel.innerHTML;
        const newHtml = currentHtml.replace(/\(Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: \d+ Ø«Ø§Ù†ÙŠØ©\)/, `(Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${timeLeft} Ø«Ø§Ù†ÙŠØ©)`);
        statusPanel.innerHTML = newHtml;

    }, 1000);
}
// ******************************************************


// ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ - ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø±Ø§Øª Ù‚ÙˆÙŠØ© Ù„Ù€ iOS
navigator.geolocation.getCurrentPosition(async pos=>{ // â¬…ï¸ Ø¥Ø¶Ø§ÙØ© async
  startCoords=[pos.coords.latitude,pos.coords.longitude];
  //startMarker=L.marker(startCoords).addTo(map).bindPopup("ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ").openPopup();
  map.setView(startCoords,15);
  
  // **************************************************
  // ğŸ†• Ø¬Ù„Ø¨ Ø§Ø³Ù… Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ ÙˆØªØ®Ø²ÙŠÙ†Ù‡Ø§
  startAreaName = await reverseGeocode(startCoords[0], startCoords[1]);
  // **************************************************
  
  // **Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯:** ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø­Ù„Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹
  checkActiveRide(); 
  
},err=>{
  startAreaText.innerHTML="âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠØŒ ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹.";
  checkActiveRide(); 
},{enableHighAccuracy:true,timeout:10000,maximumAge:0}); // Ø®ÙŠØ§Ø±Ø§Øª Ù‚ÙˆÙŠØ©

// ** ğŸ—ºï¸ Ù…Ù†Ø·Ù‚ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ **
mainActionBtn.onclick = async function() {
    if (rideId) return; // Ø­Ù…Ø§ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ©

    // 1. ØªØ«Ø¨ÙŠØª Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚
    if (isSelectingStart) {
        // Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø¯Ø§Ù„Ø© map.on('move')
        isSelectingStart = false; // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ÙˆØ¶Ø¹ Ø§Ø®ØªÙŠØ§Ø± Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„
        mapPin.style.color = '#E53935';
        updateRiderUI();
        return; 
    }

    // 2. ØªØ«Ø¨ÙŠØª Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„ (ÙÙŠ Ø­Ø§Ù„ Ø¹Ø¯Ù… ØªØ­Ø¯ÙŠØ¯Ù‡Ø§ Ø¨Ø¹Ø¯)
    if (!endCoords) {
        const currentCenter = map.getCenter();
        endCoords = [currentCenter.lat, currentCenter.lng];
        // Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø© ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø¯Ø§Ù„Ø© map.on('move')
        updateRiderUI();
        return;
    }
    
    // 3. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ (Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ ÙˆØ§Ù„ÙˆØµÙˆÙ„)
    if (!startCoords || !endCoords) {
        alert("âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆÙ†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„.");
        return;
    }

    const phone = userPhone || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© ÙˆØ§Ù„Ø£Ø¬Ø±Ø© (Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ù‡Ø§ Ù†ÙØ³ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ØªÙŠ Ø¸Ù‡Ø±Øª ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©)
    const R = 6371;
    const dLat = (endCoords[0] - startCoords[0]) * Math.PI / 180;
    const dLon = (endCoords[1] - startCoords[1]) * Math.PI / 180;
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
             Math.cos(startCoords[0] * Math.PI / 180) * Math.cos(endCoords[0] * Math.PI / 180) *
             Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    const distance = (R * c).toFixed(2);
    const fare = Math.round(distance * 1000);

    rideId = Date.now();
    localStorage.setItem('activeRideId', rideId); 

    // ğŸ†• ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
    selectionMode.style.display = 'none';
    activeMode.style.display = 'block';
    bottomPanel.classList.remove('ride-selection-state');
    bottomPanel.classList.add('ride-active-state');
    mapPin.style.display = 'none';
    
    // Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡
    cancelRideBtn.onclick = cancelRide;

    firebase.database().ref("rides/"+rideId).set({
        riderPhone:phone,
        start:startCoords,
        end:endCoords,
        startArea: startAreaName, 
        endArea: endAreaName, 
        distance:distance,
        fare:fare,
        status:"Ø¬Ø¯ÙŠØ¯Ø©"
    }).then(()=>{
        statusPanel.innerHTML=
          `âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!<br>Ø§Ù„Ù…Ø³Ø§ÙØ©: <b>${distance}</b> ÙƒÙ… â€” Ø§Ù„Ø£Ø¬Ø±Ø©: <b>${fare.toLocaleString('en-US')}</b> Ø¯.Ø¹<br>Ø¨Ø¥Ù†ØªØ¸Ø§Ø± Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚...`;
        
        startSearchCountdown(); 
        listenForUpdates();
    }).catch(err=>{
        statusPanel.innerText="âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: "+err;
        resetRiderState(); // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ù†Ø¹ÙˆØ¯ Ù„Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
    });
};


// ** ğŸ†• Ø¯Ø§Ù„Ø© Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© (Ù‚Ø¨Ù„ Ø£Ùˆ Ø¨Ø¹Ø¯ Ø§Ù„Ù‚Ø¨ÙˆÙ„) **
function cancelRide() {
    if (!rideId) {
        resetRiderState();
        statusPanel.innerText = "ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨. ÙŠÙ…ÙƒÙ†Ùƒ Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©.";
        return;
    }
    
    if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©ØŸ")) {
        // ** Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ: ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø­Ù„Ø© Ø¥Ù„Ù‰ "Ù…Ù„ØºØ§Ø© Ù…Ù† Ø§Ù„Ø±Ø§ÙƒØ¨" **
        firebase.database().ref("rides/" + rideId).update({
            status: "Ù…Ù„ØºØ§Ø© Ù…Ù† Ø§Ù„Ø±Ø§ÙƒØ¨",
            notification: "âŒ Ø§Ù„Ø±Ø§ÙƒØ¨ Ø£Ù„ØºÙ‰ Ø§Ù„Ø±Ø­Ù„Ø©"
        }).then(() => {
            alert("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­.");
            statusPanel.innerText = "ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨. ÙŠÙ…ÙƒÙ†Ùƒ Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©.";
            resetRiderState();
        }).catch(err => {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ù„ØºØ§Ø¡:", err);
            alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
        });
    }
}
// ----------------------------------------


// ğŸ”¹ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
function listenForUpdates(){
  if(!rideId) return;
  // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ Ø§Ø³ØªÙ…Ø§Ø¹ Ø³Ø§Ø¨Ù‚
  firebase.database().ref("rides/"+rideId).off("value");

  firebase.database().ref("rides/"+rideId).on("value",snapshot=>{
    const ride=snapshot.val();
    if(!ride) {
        statusPanel.innerHTML = `âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©. ÙŠÙ…ÙƒÙ†Ùƒ Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©.`;
        resetRiderState();
        return;
    }

    // ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙˆØ§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø®ÙØ§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
    selectionMode.style.display = 'none';
    activeMode.style.display = 'block';
    bottomPanel.classList.remove('ride-selection-state');
    bottomPanel.classList.add('ride-active-state');
    mapPin.style.display = 'none';
    
    const distanceText = parseFloat(ride.distance || 0).toFixed(2);
    const fareText = (ride.fare || 0).toLocaleString('en-US');
    
    if(ride.status==="Ù…Ù‚Ø¨ÙˆÙ„Ø©"){
      // ğŸ†• Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù„Ù„Ø¨Ø­Ø« ÙÙˆØ± Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©
      if (searchTimerInterval) {
          clearInterval(searchTimerInterval);
          searchTimerInterval = null;
      }
      
      const driverPhoneNumber = ride.driverPhone || ride.assignedDriver || "ØºÙŠØ± Ù…ØªÙˆÙØ±";
      
      // *** Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø¸Ù‡Ø§Ø± Ø±Ù‚Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ ***
      statusPanel.innerHTML=`
        ğŸš• Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø¥Ù„ÙŠÙƒ...<br>Ø§Ù„Ù…Ø³Ø§ÙØ©: ${distanceText} ÙƒÙ… â€” Ø§Ù„Ø£Ø¬Ø±Ø©: ${fareText} Ø¯.Ø¹<br>
        Ø±Ù‚Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚: <b><a href="tel:${driverPhoneNumber}">${driverPhoneNumber}</a></b>
      `;
      // ******************************************************
      
      // ** ğŸ—ºï¸ Ù…Ù†Ø·Ù‚ Ù…ØªØ§Ø¨Ø¹Ø© Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ (Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯) **
      const driverId = ride.assignedDriver; 
      if (driverId && !driverLocationRef) {
          driverLocationRef = db.ref(`driverLocations/${driverId}/location`);
          
          driverLocationRef.on('value', (locSnapshot) => {
              const location = locSnapshot.val();
              if (location && Array.isArray(location) && location.length === 2) {
                  const [lat, lng] = location;
                  
                  if (driverMarker) {
                      driverMarker.setLatLng([lat, lng]);
                  } else {
                      // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù„Ù„ØªÙ…ÙŠÙŠØ²
                      const driverIcon = L.icon({
                          iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png',
                          shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                          iconSize: [25, 41],
                          iconAnchor: [12, 41],
                          popupAnchor: [1, -34],
                          shadowSize: [41, 41]
                      });
                      driverMarker = L.marker([lat, lng], { icon: driverIcon }).addTo(map)
                          .bindPopup("ğŸš• Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ø­Ø§Ù„ÙŠ").openPopup();
                  }
              }
          });
      }
      // *********************************************************

      
    } else if (ride.status === "Ù…Ù†ØªÙ‡ÙŠØ©" || ride.status === "Ù…Ù„ØºØ§Ø© Ù…Ù† Ø§Ù„Ø±Ø§ÙƒØ¨" || ride.status === "Ù…Ø±ÙÙˆØ¶Ø©" || ride.status === "Ù…Ù„ØºØ§Ø© - Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª") {
        let msg = '';
        if(ride.status === "Ù…Ù†ØªÙ‡ÙŠØ©") msg = 'ğŸš— ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© â€” Ø´ÙƒØ±Ù‹Ø§ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ùƒ ØªÙƒØ³ÙŠ Ø§Ù„Ø¹Ø±Ø§Ù‚ Ø§Ù„Ø´Ø§Ù…Ù„';
        if(ride.status === "Ù…Ù„ØºØ§Ø© Ù…Ù† Ø§Ù„Ø±Ø§ÙƒØ¨") msg = 'âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© Ø¨ÙˆØ§Ø³Ø·ØªÙƒ.';
        if(ride.status === "Ù…Ø±ÙÙˆØ¶Ø©") msg = 'âŒ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø±ÙØ¶ Ø§Ù„Ø±Ø­Ù„Ø©. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¬Ø¯Ø¯Ø§Ù‹.';
        if(ride.status === "Ù…Ù„ØºØ§Ø© - Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª") msg = 'âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ ÙˆÙ‚Øª Ø§Ù„Ø¨Ø­Ø«.';
        
        statusPanel.innerHTML = msg;
        if(ride.status === "Ù…Ù†ØªÙ‡ÙŠØ©") alert("ğŸš— ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!");
        
        resetRiderState(); 
    }
    // Ø­Ø§Ù„Ø© "Ø¬Ø¯ÙŠØ¯Ø©" Ø£Ùˆ "Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±" (Ø¥Ø°Ø§ Ø£Ø¶ÙÙ†Ø§Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹)
    else if (ride.status === "Ø¬Ø¯ÙŠØ¯Ø©") {
        statusPanel.innerHTML = `âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!<br>Ø§Ù„Ù…Ø³Ø§ÙØ©: <b>${distanceText}</b> ÙƒÙ… â€” Ø§Ù„Ø£Ø¬Ø±Ø©: <b>${fareText}</b> Ø¯.Ø¹<br>Ø¨Ø¥Ù†ØªØ¸Ø§Ø± Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚...`;
    }
  });
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø§ÙƒØ¨
function resetRiderState() {
    
    // ** ğŸ›‘ Ø¥ÙŠÙ‚Ø§Ù Ù…ØªØ§Ø¨Ø¹Ø© Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ (Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯) **
    if(driverLocationRef) firebase.database().ref("driverLocations/" + rideId).off();
    if(driverMarker) map.removeLayer(driverMarker);
    driverLocationRef = null;
    driverMarker = null;
    // -------------------
    
    // ğŸ†• Ø¥ÙŠÙ‚Ø§Ù ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨Ø­Ø«
    if (searchTimerInterval) clearInterval(searchTimerInterval);
    searchTimerInterval = null;
    // -------------------
    
    // **Ø§Ù„ØªØ¹Ø¯ÙŠÙ„:** Ø¥Ø²Ø§Ù„Ø© Ø±Ù‚Ù… Ø§Ù„Ø±Ø­Ù„Ø© Ù…Ù† LocalStorage
    localStorage.removeItem('activeRideId');
    rideId = null; 
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
    endCoords = null;
    endAreaName = "ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ø¯ÙŠØ¯...";
    isSelectingStart = false; // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ÙˆØ¶Ø¹ Ø§Ø®ØªÙŠØ§Ø± Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„
    
    selectionMode.style.display = 'block';
    activeMode.style.display = 'none';
    bottomPanel.classList.add('ride-selection-state');
    bottomPanel.classList.remove('ride-active-state');
    mapPin.style.display = 'block';
    mapPin.style.color = '#E53935'; 

    updateRiderUI(); // Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆØªÙ…ÙƒÙŠÙ† Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    
    // ØªÙ†Ø¸ÙŠÙ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨Ø­Ø« (Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©)
    searchContainer.style.display = 'none';
    searchInput.value = '';
    searchResultsUl.innerHTML = '';
    searchResultsUl.style.display = 'none';
}

// ============================================
// ğŸ“£ Ù‚Ø³Ù… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù†
// ============================================
// Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† db Ùˆ userPhone ØªÙ… ØªØ¹Ø±ÙŠÙÙ‡Ù…Ø§ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰
if(userPhone) {
    db.ref("notifications/" + userPhone).on("value", snap => {
        const data = snap.val();
        if (data && data.message) {
            // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
            alert("ğŸ“£ Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©:\n\n" + data.message);
            
            // Ø­Ø°Ù Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù„Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø¸Ù‡ÙˆØ±Ù‡ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
            db.ref("notifications/" + userPhone).remove();
        }
    });
}
// ============================================

</script>
</body>
</html>
