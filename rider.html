<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø±Ø§ÙƒØ¨ - ØªÙƒØ³ÙŠ Ø§Ù„Ø¹Ø±Ø§Ù‚ Ø§Ù„Ø´Ø§Ù…Ù„</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2e7d32">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="/icons/icon-192x192.png">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body,html{margin:0;padding:0;height:100%;font-family:Tahoma;}
#map{height:60vh;}
#panel{background:#fff;text-align:center;padding:10px;box-shadow:0 -2px 5px rgba(0,0,0,0.2);}
button{background:#ffca28;border:none;padding:10px 20px;border-radius:8px;font-weight:bold;cursor:pointer;margin:5px;}

#searchContainer{margin:10px 0;padding:0 10px;}
#searchInput{
    width:100%;padding:10px;border:1px solid #ccc;border-radius:5px;
    font-size:16px;box-sizing:border-box;direction:rtl;
}
#searchResults{
    list-style:none;padding:0;margin:5px 0 0;max-height:150px;overflow-y:auto;
    border:1px solid #eee;border-radius:5px;box-shadow:0 1px 3px rgba(0,0,0,0.1);
    display:none;text-align:right;
}
#searchResults li{
    padding:10px;border-bottom:1px solid #eee;cursor:pointer;font-size:15px;background:#fff;
}
#searchResults li:hover{background:#f0f0f0;}
#searchResults li:last-child{border-bottom:none;}

#logoutBtn{background:#607d8b;color:white;margin-top:10px;width:95%;}
</style>
</head>
<body>

<div id="map"></div>

<div id="panel">
  <h3>ğŸš– Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>

  <div id="searchContainer">
      <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© (Ù…Ù†Ø·Ù‚Ø©ØŒ Ø´Ø§Ø±Ø¹...)">
      <ul id="searchResults"></ul>
  </div>

  <p id="status">ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø§Ù„Ø¢Ù†...</p>
  <button id="sendRide" disabled>Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
  <button id="cancelRideBtn" style="display:none;background:#E53935;color:white;">âŒ Ø¥Ù†Ù‡Ø§Ø¡/Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>

  <button id="logoutBtn" onclick="window.logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</div>

<script>
// Ù…Ù†Ø¹ Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
window.onload=function(){
    let phone=localStorage.getItem("phone");
    let userType=localStorage.getItem("userType");

    if(!phone||!userType){window.location.href="index.html";return;}
    if(userType==="driver") window.location.href="driver.html";
};

window.logout=function(){
    localStorage.removeItem('phone');
    localStorage.removeItem('userType');
    localStorage.removeItem('activeRideId');
    window.location.href="index.html";
};

// ØªÙ‡ÙŠØ¦Ø© Firebase
const app=firebase.initializeApp({
  apiKey:"AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M",
  authDomain:"taxi-15314.firebaseapp.com",
  databaseURL:"https://taxi-15314-default-rtdb.firebaseio.com/",
  projectId:"taxi-15314"
});
const db=firebase.database();

// Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
let map=L.map('map').setView([33.3152,44.3661],13);

// â­â­ Ø®Ø±ÙŠØ·Ø© Google Maps â€” Ù†ÙØ³ Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯Ù‡ â­â­
L.tileLayer(
  "https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}&key=AIzaSyD7TtwniAdUtB8-pnTny4ZwE6gqX36SGUk",
  { maxZoom: 20 }
).addTo(map);

map.whenReady(()=>map.invalidateSize());

// ---------------- Ø¨Ù‚ÙŠØ© ÙƒÙˆØ¯Ùƒ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ ----------------

let startCoords=null,endCoords=null;
let startMarker=null,endMarker=null;
let rideId=null;

let startAreaName="Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ";
let endAreaName="Ø§Ù„ÙˆØ¬Ù‡Ø©";

let driverMarker=null;
let driverLocationRef=null;
let searchTimerInterval=null;

const sendBtn=document.getElementById("sendRide");
const endBtn=document.getElementById("cancelRideBtn");
const searchInput=document.getElementById('searchInput');
const searchResultsUl=document.getElementById('searchResults');
const searchContainer=document.getElementById('searchContainer');

const SEARCH_DELAY=500;
let searchInputTimer=null;

// reverse geocode
async function reverseGeocode(lat,lon){
  const url=`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=ar`;
  try{
    const r=await fetch(url);const d=await r.json();
    if(d&&d.display_name) return d.display_name.split(',').slice(0,3).reverse().join(', ');
    return `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
  }catch{return `${lat.toFixed(4)}, ${lon.toFixed(4)}`;}
}

// Ø§Ù„Ø¨Ø­Ø«
function searchLocation(q){
  if(q.length<3){searchResultsUl.innerHTML='';searchResultsUl.style.display='none';return;}
  const url=`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(q+", Ø¨ØºØ¯Ø§Ø¯, Ø§Ù„Ø¹Ø±Ø§Ù‚")}&format=json&limit=5&addressdetails=1&accept-language=ar`;
  fetch(url).then(r=>r.json()).then(data=>{
    searchResultsUl.innerHTML='';
    if(data.length>0){
      data.forEach(item=>{
        let li=document.createElement('li');
        let area=item.display_name.split(',').slice(0,3).reverse().join(', ');
        li.innerText=area;
        li.onclick=()=>selectSearchResult(item.lat,item.lon,area);
        searchResultsUl.appendChild(li);
      });
      searchResultsUl.style.display='block';
    }else{
      searchResultsUl.innerHTML='<li>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.</li>';
      searchResultsUl.style.display='block';
    }
  });
}

function selectSearchResult(lat,lng,name){
  searchResultsUl.innerHTML='';searchResultsUl.style.display='none';
  searchInput.value=name;endAreaName=name;

  let latlng=L.latLng(parseFloat(lat),parseFloat(lng));
  if(endMarker) map.removeLayer(endMarker);
  endCoords=[latlng.lat,latlng.lng];
  endMarker=L.marker(endCoords).addTo(map).bindPopup(`ğŸ ${name}`).openPopup();
  map.setView(endCoords,15);

  if(!rideId){document.getElementById("status").innerHTML=`ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©: <b>${name}</b>`;sendBtn.disabled=false;}
}

searchInput.addEventListener('input',e=>{
  clearTimeout(searchInputTimer);
  searchInputTimer=setTimeout(()=>searchLocation(e.target.value.trim()),SEARCH_DELAY);
});

document.addEventListener('click',e=>{
  if(!searchContainer.contains(e.target)) searchResultsUl.style.display='none';
});

// ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹
navigator.geolocation.getCurrentPosition(async pos=>{
  startCoords=[pos.coords.latitude,pos.coords.longitude];
  startMarker=L.marker(startCoords).addTo(map).bindPopup("ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ").openPopup();
  map.setView(startCoords,15);

  startAreaName=await reverseGeocode(startCoords[0],startCoords[1]);
  document.getElementById("status").innerHTML=`ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ: <b>${startAreaName}</b><br>Ø­Ø¯Ø¯ Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ©.`;
},err=>{
  document.getElementById("status").innerText="âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.";
},{enableHighAccuracy:true,timeout:10000,maximumAge:0});

// ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ø¨Ø§Ù„Ù†Ù‚Ø±
map.on('click',async function(e){
  searchInput.value='';
  searchResultsUl.innerHTML='';searchResultsUl.style.display='none';

  if(endMarker) map.removeLayer(endMarker);
  endCoords=[e.latlng.lat,e.latlng.lng];
  endMarker=L.marker(endCoords).addTo(map).bindPopup("ğŸ Ù†Ù‡Ø§ÙŠØ©").openPopup();

  endAreaName=await reverseGeocode(endCoords[0],endCoords[1]);
  document.getElementById("status").innerHTML=`ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©: <b>${endAreaName}</b>`;
  sendBtn.disabled=false;
});

// Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
sendBtn.onclick=function(){
  if(!startCoords||!endCoords){alert("Ø­Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹.");return;}

  const phone=localStorage.getItem('phone');

  const R=6371;
  const dLat=(endCoords[0]-startCoords[0])*Math.PI/180;
  const dLon=(endCoords[1]-startCoords[1])*Math.PI/180;
  const a=Math.sin(dLat/2)*Math.sin(dLat/2)+
           Math.cos(startCoords[0]*Math.PI/180)*Math.cos(endCoords[0]*Math.PI/180)*
           Math.sin(dLon/2)*Math.sin(dLon/2);
  const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  const distance=(R*c).toFixed(2);
  const fare=Math.round(distance*1000);

  rideId=Date.now();
  localStorage.setItem('activeRideId',rideId);

  endBtn.style.display='inline-block';
  
  db.ref("rides/"+rideId).set({
    riderPhone:phone,start:startCoords,end:endCoords,
    startArea:startAreaName,endArea:endAreaName,
    distance:distance,fare:fare,status:"Ø¬Ø¯ÙŠØ¯Ø©"
  });

  document.getElementById("status").innerHTML=
    `ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„<br>Ø§Ù„Ù…Ø³Ø§ÙØ©: ${distance} ÙƒÙ… â€” Ø§Ù„Ø£Ø¬Ø±Ø©: ${fare} Ø¯.Ø¹`;
  sendBtn.disabled=true;
};

// Ù„Ø§ Ø£ØºÙŠÙ‘Ø± Ø£ÙŠ Ø´ÙŠØ¡ Ø¢Ø®Ø± â€” ÙƒÙ„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ù…Ø«Ù„ Ù…Ù„ÙÙƒ ØªÙ…Ø§Ù…Ø§Ù‹

</script>

</body>
</html>