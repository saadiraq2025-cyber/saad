<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø±Ø§ÙƒØ¨ - ØªÙƒØ³ÙŠ Ø§Ù„Ø¹Ø±Ø§Ù‚ Ø§Ù„Ø´Ø§Ù…Ù„</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body,html{margin:0;padding:0;height:100%;font-family:Tahoma,Arial,sans-serif;background-color:#f8f9fa;}
#map{height:60vh;width:100%;}
#panel{background:#fff;text-align:center;padding:15px;box-shadow:0 -3px 10px rgba(0,0,0,0.1);border-top-left-radius:20px;border-top-right-radius:20px;position:relative;z-index:1000;margin-top:-20px;}
#status{font-size:1.1em;font-weight:bold;margin:10px 0;line-height:1.6;color:#333;}
.fare-box{color:#e53935;font-size:1.2em;font-weight:900;}
.dist-box{color:#455a64;font-size:1.1em;font-weight:700;}
#searchContainer{margin:10px 0;padding:0 10px;}
#searchInput{width:100%;padding:12px;border:2px solid #eee;border-radius:10px;font-size:16px;box-sizing:border-box;outline:none;transition:0.3s;}
#searchInput:focus{border-color:#ffca28;}
#searchResults{list-style:none;padding:0;margin:5px 0 0;max-height:180px;overflow-y:auto;border:1px solid #eee;border-radius:10px;display:none;background:#fff;box-shadow:0 4px 6px rgba(0,0,0,0.1);}
#searchResults li{padding:12px;border-bottom:1px solid #f9f9f9;cursor:pointer;text-align:right;}
#searchResults li:hover{background:#fff9c4;}
button{background:#ffca28;border:none;padding:12px 25px;border-radius:10px;font-weight:bold;cursor:pointer;margin:5px;transition:0.3s;}
button:disabled{background:#ccc;}
#logoutBtn{background:#607d8b;color:white;width:90%;margin-top:10px;}
.phone-link{color:#007bff;text-decoration:none;font-weight:bold;display:block;margin-top:10px;border:1px solid #007bff;padding:5px;border-radius:20px;}
.custom-driver-icon{font-size:26px;text-shadow:0 0 5px #fff;}
</style>
</head>
<body>
<div id="map"></div>
<div id="panel">
    <h3>ğŸš– Ø§Ø·Ù„Ø¨ Ø±Ø­Ù„ØªÙƒ Ø§Ù„Ø¢Ù†</h3>
    <div id="searchContainer">
        <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ÙˆØ¬Ù‡ØªÙƒ...">
        <ul id="searchResults"></ul>
    </div>
    <p id="status">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ...</p>
    <div id="driverInfo"></div>
    <button id="sendRide" disabled>Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø©</button>
    <button id="cancelRideBtn" style="display:none;background:#d32f2f;color:white;">âŒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨</button>
    <button id="logoutBtn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</div>

<script>
const firebaseConfig={apiKey:"AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M",authDomain:"taxi-15314.firebaseapp.com",databaseURL:"https://taxi-15314-default-rtdb.firebaseio.com/",projectId:"taxi-15314"};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

let map=L.map('map').setView([33.3152,44.3661],13);
L.tileLayer("https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}&key=AIzaSyD7TtwniAdUtB8-pnTny4ZwE6gqX36SGUk").addTo(map);

let startCoords=null,endCoords=null,startMarker=null,endMarker=null,driverMarker=null,driverRoute=null;
let rideId=null,rideRef=null,driverRef=null;

const statusP=document.getElementById("status");
const sendBtn=document.getElementById("sendRide");
const cancelBtn=document.getElementById("cancelRideBtn");

function getShortAreaName(f){
    if(!f) return "Ù…Ù†Ø·Ù‚Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©";
    const p=f.split(',').map(x=>x.trim());
    const bad=["Ù‚Ø¶Ø§Ø¡","Ù†Ø§Ø­ÙŠØ©","Ù…Ø±ÙƒØ²","Ø¨ØºØ¯Ø§Ø¯","Ø§Ù„Ø¹Ø±Ø§Ù‚"];
    const filtered=p.filter(x=>!bad.some(b=>x.includes(b)));
    return filtered.length>0?filtered[0]:p[0];
}

async function drawStreetRoute(lat1,lng1,lat2,lng2,color,dash=''){
    const url=`https://router.project-osrm.org/route/v1/driving/${lng1},${lat1};${lng2},${lat2}?geometries=geojson`;
    try{
        const res=await fetch(url);const d=await res.json();
        if(d.code==='Ok'){
            const c=d.routes[0].geometry.coordinates.map(x=>[x[1],x[0]]);
            if(driverRoute) map.removeLayer(driverRoute);
            driverRoute=L.polyline(c,{color:color,weight:5,dashArray:dash}).addTo(map);
            map.fitBounds(driverRoute.getBounds(),{padding:[50,50]});
        }
    }catch(e){console.error(e);}
}

function startMonitoringRide(id){
    rideId=id; rideRef=db.ref("rides/"+id);
    cancelBtn.style.display='inline-block'; sendBtn.style.display='none';
    document.getElementById("searchContainer").style.display='none';

    rideRef.on('value',snap=>{
        const r=snap.val();
        if(!r){cleanup(); return;}
        const f=`<span class="fare-box">${r.fare.toLocaleString('ar-IQ')} Ø¯.Ø¹</span>`;
        const d=`<span class="dist-box">${r.distance} ÙƒÙ…</span>`;
        
        if(r.status==="Ø¬Ø¯ÙŠØ¯Ø©"){
            statusP.innerHTML=`â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚...<br>Ø§Ù„Ù…Ø³Ø§ÙØ©: ${d} | Ø§Ù„Ø£Ø¬Ø±Ø©: ${f}`;
        }else if(r.status==="Ù…Ù‚Ø¨ÙˆÙ„Ø©"||r.status==="Ø¨Ø¯Ø£Øª"){
            const call=`<a href="tel:${r.driverPhone}" class="phone-link">ğŸ“ Ø§ØªØµÙ„ Ø¨Ø§Ù„Ø³Ø§Ø¦Ù‚ (${r.driverPhone})</a>`;
            statusP.innerHTML=`ğŸš– Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø¥Ù„ÙŠÙƒ<br>Ø§Ù„Ù…Ø³Ø§ÙØ©: ${d} | Ø§Ù„Ø£Ø¬Ø±Ø©: ${f}${call}`;
            trackDriver(r.driverPhone,r.startLat,r.startLng,r.status);
        }else if(["Ù…Ù†ØªÙ‡ÙŠØ©","Ù…Ù„ØºØ§Ø©"].includes(r.status)){
            statusP.innerHTML=`ğŸ Ø§Ù„Ø±Ø­Ù„Ø© ${r.status}.`;
            cleanup();
        }
    });
}

function trackDriver(p,sLat,sLng,st){
    if(driverRef) driverRef.off();
    driverRef=db.ref("drivers/"+p);
    driverRef.on('value',snap=>{
        const d=snap.val(); if(!d) return;
        if(driverMarker) map.removeLayer(driverMarker);
        driverMarker=L.marker([d.lat,d.lng],{icon:L.divIcon({className:'custom-driver-icon',html:'ğŸš•'})}).addTo(map);
        if(st==="Ù…Ù‚Ø¨ÙˆÙ„Ø©") drawStreetRoute(d.lat,d.lng,sLat,sLng,'#4CAF50','10,10');
    });
}

navigator.geolocation.getCurrentPosition(async pos=>{
    startCoords=[pos.coords.latitude,pos.coords.longitude];
    map.setView(startCoords,15);
    startMarker=L.marker(startCoords).addTo(map).bindPopup("Ù…ÙˆÙ‚Ø¹Ùƒ").openPopup();
    statusP.innerText="ğŸ“ ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ. Ø­Ø¯Ø¯ ÙˆØ¬Ù‡ØªÙƒ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©.";
    const active=localStorage.getItem('activeRideId');
    if(active) startMonitoringRide(active);
});

map.on('click',async e=>{
    if(rideId) return;
    endCoords=[e.latlng.lat,e.latlng.lng];
    if(endMarker) map.removeLayer(endMarker);
    endMarker=L.marker(endCoords).addTo(map).bindPopup("Ø§Ù„ÙˆØ¬Ù‡Ø©").openPopup();
    sendBtn.disabled=false;
    statusP.innerText="ğŸ ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ¬Ù‡Ø©. Ø§Ø¶ØºØ· Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø·Ù„Ø¨.";
});

sendBtn.onclick=()=>{
    const dist=(map.distance(startCoords,endCoords)/1000).toFixed(1);
    const fare=Math.round(dist*1000);
    const id=Date.now();
    db.ref("rides/"+id).set({riderPhone:localStorage.getItem('phone'),startLat:startCoords[0],startLng:startCoords[1],endLat:endCoords[0],endLng:endCoords[1],distance:dist,fare:fare,status:"Ø¬Ø¯ÙŠØ¯Ø©"});
    localStorage.setItem('activeRideId',id);
    startMonitoringRide(id);
};

cancelBtn.onclick=()=>{ if(rideId) db.ref("rides/"+rideId).update({status:"Ù…Ù„ØºØ§Ø©"}); cleanup(); };
function cleanup(){ if(rideRef) rideRef.off(); if(driverRef) driverRef.off(); rideId=null; localStorage.removeItem('activeRideId'); location.reload(); }
function logout(){ localStorage.clear(); location.href="index.html"; }
</script>
</body>
</html>
