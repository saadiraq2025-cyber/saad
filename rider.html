<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¨Ù„ÙŠ - Ø§Ù„Ø±Ø§ÙƒØ¨</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        :root { --baly-yellow: #FFD200; --baly-black: #1A1A1A; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Roboto, sans-serif; background: #f0f0f0; }
        #map { height: 100vh; width: 100%; z-index: 1; }

        /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© */
        .bottom-sheet {
            position: absolute; bottom: 0; left: 0; right: 0; 
            background: white; border-radius: 24px 24px 0 0;
            padding: 20px; z-index: 1000; box-shadow: 0 -10px 30px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .search-bar {
            background: #F3F3F3; border-radius: 12px; display: flex; 
            align-items: center; padding: 12px 15px; margin-bottom: 10px;
        }
        .search-bar input {
            border: none; background: transparent; width: 100%; font-size: 16px;
            outline: none; margin-right: 10px; font-weight: 500;
        }

        .results-list { list-style: none; padding: 0; margin: 0; max-height: 250px; overflow-y: auto; }
        .results-list li { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; }

        .btn-confirm {
            background: var(--baly-yellow); color: var(--baly-black); border: none;
            width: 100%; padding: 16px; border-radius: 14px; font-weight: 800;
            font-size: 18px; cursor: pointer; display: none; margin-top: 10px;
        }

        .fare-card {
            display: flex; justify-content: space-between; align-items: center;
            background: #FFFBE6; border: 1px solid #FFE58F; padding: 15px;
            border-radius: 12px; margin: 10px 0; display: none;
        }

        .status-badge {
            background: var(--baly-black); color: white; padding: 5px 12px;
            border-radius: 20px; font-size: 12px; margin-bottom: 10px; display: inline-block;
        }
        
        #logoutBtn { position: absolute; top: 20px; right: 20px; z-index: 1001; background: white; border: none; border-radius: 50%; width: 40px; height: 40px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); font-weight: bold; }
    </style>
</head>
<body>

<button id="logoutBtn" onclick="localStorage.clear(); location.href='index.html'">âœ•</button>
<div id="map"></div>

<div class="bottom-sheet" id="sheet">
    <div id="statusArea">
        <span class="status-badge" id="statusText">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¨Ù„ÙŠ</span>
    </div>

    <div id="searchView">
        <div class="search-bar">
            <span>ğŸ”</span>
            <input type="text" id="destinationInput" placeholder="Ø¥Ù„Ù‰ Ø£ÙŠÙ† Ù†Ø°Ù‡Ø¨ØŸ">
        </div>
        <ul class="results-list" id="results"></ul>
    </div>

    <div class="fare-card" id="fareCard">
        <div>
            <div style="font-size: 12px; color: #666;">Ø§Ù„Ø£Ø¬Ø±Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠØ©</div>
            <div id="fareAmount" style="font-size: 22px; font-weight: 900;">0 Ø¯.Ø¹</div>
        </div>
        <div style="text-align: left;">
            <div style="font-size: 12px; color: #666;">Ø§Ù„Ù…Ø³Ø§ÙØ©</div>
            <div id="distAmount" style="font-weight: bold;">0 ÙƒÙ…</div>
        </div>
    </div>

    <button class="btn-confirm" id="requestBtn">Ø§Ø·Ù„Ø¨ Ø¨Ù„ÙŠ Ø§Ù„Ø¢Ù†</button>
    <button class="btn-confirm" id="cancelBtn" style="background:#f4f4f4; color:red; margin-top:5px;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨</button>
</div>

<script>
// Firebase Config (Ø§Ø³ØªØ®Ø¯Ù… Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù‡Ù†Ø§)
const app = firebase.initializeApp({
  apiKey: "AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M",
  databaseURL: "https://taxi-15314-default-rtdb.firebaseio.com/"
});
const db = firebase.database();

let map = L.map('map', { zoomControl: false }).setView([33.3152, 44.3661], 13);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

let startPos = null, endPos = null;

// ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ø±Ø§ÙƒØ¨
navigator.geolocation.getCurrentPosition(pos => {
    startPos = [pos.coords.latitude, pos.coords.longitude];
    map.setView(startPos, 15);
    L.circleMarker(startPos, {radius: 8, color: '#007AFF', fillOpacity: 1}).addTo(map);
});

// Ù…Ø­Ø±Ùƒ Ø¨Ø­Ø« Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹
const destInput = document.getElementById('destinationInput');
const resultsList = document.getElementById('results');

destInput.addEventListener('input', async (e) => {
    if(e.target.value.length < 3) return;
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${e.target.value}, Iraq&limit=5`);
    const data = await res.json();
    resultsList.innerHTML = '';
    data.forEach(place => {
        let li = document.createElement('li');
        li.innerText = place.display_name;
        li.onclick = () => selectDestination(place.lat, place.lon, place.display_name);
        resultsList.appendChild(li);
    });
});

function selectDestination(lat, lon, name) {
    endPos = [parseFloat(lat), parseFloat(lon)];
    resultsList.innerHTML = '';
    destInput.value = name;
    
    L.marker(endPos).addTo(map);
    map.fitBounds([startPos, endPos], {padding: [50, 50]});

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© ÙˆØ§Ù„Ø³Ø¹Ø±
    const dist = (map.distance(startPos, endPos) / 1000).toFixed(1);
    const fare = Math.round(dist * 1500); 

    document.getElementById('fareCard').style.display = 'flex';
    document.getElementById('fareAmount').innerText = fare.toLocaleString() + " Ø¯.Ø¹";
    document.getElementById('distAmount').innerText = dist + " ÙƒÙ…";
    document.getElementById('requestBtn').style.display = 'block';
}

// Ø·Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø©
document.getElementById('requestBtn').onclick = function() {
    const id = Date.now();
    const phone = localStorage.getItem('phone');
    db.ref("rides/"+id).set({
        riderPhone: phone,
        start: startPos, end: endPos,
        status: "Ø¬Ø¯ÙŠØ¯Ø©", fare: document.getElementById('fareAmount').innerText
    });
    
    this.style.display = 'none';
    document.getElementById('searchView').style.display = 'none';
    document.getElementById('statusText').innerText = "ÙŠØªÙ… Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙƒØ§Ø¨ØªÙ†...";
    document.getElementById('cancelBtn').style.display = 'block';
    
    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø­Ø§Ù„Ø©
    db.ref("rides/"+id).on('value', snap => {
        const r = snap.val();
        if(r.status === "Ù…Ù‚Ø¨ÙˆÙ„Ø©") {
            document.getElementById('statusText').innerText = "Ø§Ù„ÙƒØ§Ø¨ØªÙ† ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø¥Ù„ÙŠÙƒ";
            document.getElementById('statusText').style.background = "#28a745";
        }
        if(r.status === "Ù…Ù†ØªÙ‡ÙŠØ©") { alert("ÙˆØµÙ„Øª Ø¨Ø§Ù„Ø³Ù„Ø§Ù…Ø©!"); location.reload(); }
    });
};
</script>
</body>
</html>
