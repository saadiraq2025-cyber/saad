<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ø§Ù„Ø±Ø§ÙƒØ¨ - ØªÙƒØ³ÙŠ Ø§Ù„Ø¹Ø±Ø§Ù‚ Ø§Ù„Ø´Ø§Ù…Ù„</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body,html{margin:0;padding:0;height:100%;font-family:Tahoma, sans-serif;overflow:hidden;background:#f4f4f4;}
#map{height:100vh;width:100%;position:relative; transition: padding-bottom 0.3s ease;} 

/* Ø¯Ø¨ÙˆØ³ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø«Ø§Ø¨Øª */
#map-center-pin { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -100%); z-index: 999; font-size: 40px; pointer-events: none; transition: 0.2s; }

/* Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø³ÙÙ„ÙŠØ© */
#panel{ 
    position:fixed; bottom:0; left:0; right:0; background:#fff; 
    padding:15px; box-shadow:0 -5px 15px rgba(0,0,0,0.1); 
    border-radius: 20px 20px 0 0; z-index: 1000;
}

.point-card { background: #f9f9f9; border: 1px solid #eee; border-radius: 12px; padding: 10px; margin-bottom: 10px; position: relative; }
.label { font-size: 11px; color: #f97316; font-weight: bold; margin-bottom: 3px; display: block; }
.value { font-size: 13px; color: #333; font-weight: bold; width: 80%; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.edit-btn { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #007bff; font-size: 12px; font-weight: bold; cursor: pointer; display: none; }

#costDisplay { background: #e8f5e9; color: #2e7d32; font-size: 1.1em; font-weight: bold; padding: 10px; text-align: center; border-radius: 10px; margin-bottom: 10px; display: none; }
#status { font-size: 0.9em; color: #555; background: #fff3e0; padding: 10px; border-radius: 8px; margin-bottom: 10px; display: none; border-right: 4px solid #f97316; }

button#mainActionBtn { background:#f97316; color:white; border:none; padding:15px; border-radius:12px; font-weight:bold; cursor:pointer; width:100%; font-size: 1.1em; transition: 0.2s; }
button#mainActionBtn:active { transform: scale(0.98); }

/* Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« */
#searchContainer { position: fixed; top: 15px; left: 15px; right: 15px; background: #fff; padding: 10px; z-index: 1001; display: flex; align-items: center; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
#search-input { flex-grow: 1; border: none; outline: none; text-align: right; padding: 5px; font-size: 15px; }
#searchResults { position: fixed; top: 70px; left: 15px; right: 15px; background: #fff; z-index: 1002; max-height: 40vh; overflow-y: auto; display: none; border-radius: 0 0 12px 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
.search-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; text-align: right; font-size: 13px; }

#logoutBtn { background:#607d8b; color:white; border:none; padding:8px; border-radius:8px; margin-top:10px; width:100%; font-size: 0.9em; opacity: 0.8; }
</style>
</head>
<body>

<div id="searchContainer">
    <span>ğŸ”</span>
    <input type="text" id="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…ÙƒØ§Ù† Ø£Ùˆ Ù…Ø¹Ù„Ù… Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ù…Ù†Ùƒ..." />
</div>
<div id="searchResults"></div>

<div id="map"></div>
<div id="map-center-pin">ğŸ“</div>

<div id="panel">
    <div id="status"></div>

    <div class="point-card" id="startCard">
        <span class="label">Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ (Ù…Ù†)</span>
        <span id="startPointValue" class="value">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ...</span>
        <button id="editStart" class="edit-btn" onclick="returnToStart()">ØªØ¹Ø¯ÙŠÙ„</button>
    </div>

    <div class="point-card" id="endCard" style="display:none;">
        <span class="label">ÙˆØ¬Ù‡Ø© Ø§Ù„ÙˆØµÙˆÙ„ (Ø¥Ù„Ù‰)</span>
        <span id="endPointValue" class="value">Ø§Ø³Ø­Ø¨ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ¬Ù‡Ø©</span>
        <button id="editEnd" class="edit-btn" onclick="returnToEnd()">ØªØ¹Ø¯ÙŠÙ„</button>
    </div>

    <div id="costDisplay">Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©: <span id="fareValue">0</span> Ø¯.Ø¹</div>

    <button id="mainActionBtn">ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</button>
    <button id="logoutBtn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</div>

<script>
// Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
const firebaseConfig = {
    apiKey: "AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M",
    authDomain: "taxi-15314.firebaseapp.com",
    databaseURL: "https://taxi-15314-default-rtdb.firebaseio.com/",
    projectId: "taxi-15314"
};
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ­ÙƒÙ…
let map = L.map('map', {zoomControl: false}).setView([33.3128, 44.3615], 14);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let startCoords = null, endCoords = null;
let startName = "", endName = "";
let currentStage = "settingStart"; // settingStart, settingEnd, confirmed, searching
let rideId = null;

const mainBtn = document.getElementById("mainActionBtn");
const statusDiv = document.getElementById("status");

// Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† ÙˆØ§Ù„Ù…Ø¹Ø§Ù„Ù… (Ø§Ù„Ù…Ø³Ø§Ø¬Ø¯ØŒ Ø§Ù„Ø£Ø³ÙˆØ§Ù‚ØŒ Ø§Ù„Ù…Ø±Ø§ÙƒØ²)
async function fetchDetailedAddress(lat, lon) {
    try {
        const r = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&addressdetails=1&accept-language=ar`);
        const d = await r.json();
        const a = d.address;
        
        let area = a.neighbourhood || a.suburb || a.city_district || a.quarter || "Ù…Ù†Ø·Ù‚Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©";
        let road = a.road || "";
        let landmark = a.amenity || a.mosque || a.hospital || a.school || a.commercial || a.building || "";

        let description = area;
        if(road) description += " - " + road;
        if(landmark) description += " (Ù‚Ø±Ø¨ " + landmark + ")";
        
        return description;
    } catch(e) { return "Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©"; }
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
async function updateUI() {
    if (currentStage === "settingStart") {
        document.getElementById("startCard").style.display = "block";
        document.getElementById("endCard").style.display = "none";
        document.getElementById("editStart").style.display = "none";
        document.getElementById("costDisplay").style.display = "none";
        document.getElementById("map-center-pin").style.display = "block";
        mainBtn.innerText = "ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚";
    } 
    else if (currentStage === "settingEnd") {
        document.getElementById("endCard").style.display = "block";
        document.getElementById("editStart").style.display = "block";
        document.getElementById("editEnd").style.display = "none";
        document.getElementById("map-center-pin").style.display = "block";
        mainBtn.innerText = "ØªØ«Ø¨ÙŠØª Ø§Ù„ÙˆØµÙˆÙ„";
    }
    else if (currentStage === "confirmed") {
        document.getElementById("editEnd").style.display = "block";
        document.getElementById("map-center-pin").style.display = "none";
        document.getElementById("costDisplay").style.display = "block";
        mainBtn.innerText = "Ø§Ø·Ù„Ø¨ Ø§Ù„ØªØ§ÙƒØ³ÙŠ Ø§Ù„Ø¢Ù† ğŸš•";
        calculateFare();
    }
}

function calculateFare() {
    if(!startCoords || !endCoords) return;
    const dist = map.distance(startCoords, endCoords) / 1000;
    const price = Math.max(3000, Math.round((dist * 700 + 2000) / 250) * 250);
    document.getElementById("fareValue").innerText = price.toLocaleString();
    return price;
}

// Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø±ÙƒØ© Ø§Ù„Ø®Ø±ÙŠØ·Ø©
map.on('moveend', async () => {
    if (currentStage === "confirmed" || currentStage === "searching") return;
    
    const center = map.getCenter();
    const addr = await fetchDetailedAddress(center.lat, center.lng);
    
    if (currentStage === "settingStart") {
        startCoords = [center.lat, center.lng];
        startName = addr;
        document.getElementById("startPointValue").innerText = addr;
    } else {
        endCoords = [center.lat, center.lng];
        endName = addr;
        document.getElementById("endPointValue").innerText = addr;
    }
});

// Ø¶ØºØ· Ø§Ù„Ø²Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
mainBtn.onclick = () => {
    if (currentStage === "settingStart") {
        currentStage = "settingEnd";
        updateUI();
    } else if (currentStage === "settingEnd") {
        currentStage = "confirmed";
        updateUI();
    } else if (currentStage === "confirmed") {
        sendOrder();
    }
};

function sendOrder() {
    const phone = localStorage.getItem('phone');
    if (!phone) { alert("Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ"); return; }

    mainBtn.disabled = true;
    mainBtn.innerText = "Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨...";
    statusDiv.style.display = "block";
    statusDiv.innerText = "ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ù‚Ø±Ø¨ Ø³Ø§Ø¦Ù‚ Ù…ØªØ§Ø­...";

    rideId = "R" + Date.now();
    const orderData = {
        riderPhone: phone,
        startLat: startCoords[0],
        startLng: startCoords[1],
        endLat: endCoords[0],
        endLng: endCoords[1],
        startArea: startName,
        endArea: endName,
        fare: calculateFare(),
        status: "waiting",
        time: Date.now()
    };

    db.ref('rides/' + rideId).set(orderData)
        .then(() => {
            localStorage.setItem('activeRideId', rideId);
            listenForDriver();
        })
        .catch(() => {
            alert("ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª");
            mainBtn.disabled = false;
        });
}

function listenForDriver() {
    db.ref('rides/' + rideId).on('value', snap => {
        const data = snap.val();
        if(!data) return;

        if (data.status === "accepted") {
            statusDiv.innerHTML = `âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨Ùƒ!<br>Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù‚Ø§Ø¯Ù… Ø¥Ù„ÙŠÙƒ: <a href="tel:${data.driverPhone}" style="color:red; font-weight:bold;">Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø§Ø¦Ù‚</a>`;
            mainBtn.innerText = "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©";
            mainBtn.disabled = false;
            mainBtn.style.background = "#d32f2f";
            mainBtn.onclick = () => {
                if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©ØŸ")) {
                    db.ref('rides/' + rideId).update({status: "cancelled_by_rider"});
                    location.reload();
                }
            };
        }
    });
}

// Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
function returnToStart() { currentStage = "settingStart"; updateUI(); map.setView(startCoords, 16); }
function returnToEnd() { currentStage = "settingEnd"; updateUI(); map.setView(endCoords || startCoords, 16); }

// Ø§Ù„Ø¨Ø­Ø«
const sInput = document.getElementById("search-input");
const sRes = document.getElementById("searchResults");
sInput.oninput = async () => {
    const q = sInput.value;
    if(q.length < 3) { sRes.style.display="none"; return; }
    const r = await fetch(`https://nominatim.openstreetmap.org/search?q=${q}&format=json&countrycodes=iq&limit=5&accept-language=ar`);
    const d = await r.json();
    sRes.innerHTML = ""; sRes.style.display="block";
    d.forEach(i => {
        const div = document.createElement("div");
        div.className = "search-item";
        div.innerText = i.display_name;
        div.onclick = () => {
            map.setView([i.lat, i.lon], 16);
            sRes.style.display = "none";
            sInput.value = "";
        };
        sRes.appendChild(div);
    });
};

function logout() { localStorage.clear(); window.location.href="index.html"; }

window.onload = () => {
    if(!localStorage.getItem('phone')) window.location.href="index.html";
    navigator.geolocation.getCurrentPosition(p => {
        map.setView([p.coords.latitude, p.coords.longitude], 16);
    });
    updateUI();
};
</script>
</body>
</html>
