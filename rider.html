<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø±Ø§ÙƒØ¨ - ØªÙƒØ³ÙŠ Ø§Ù„Ø¹Ø±Ø§Ù‚ Ø§Ù„Ø´Ø§Ù…Ù„</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#f97316"> 
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body,html{margin:0;padding:0;height:100%;font-family:Tahoma;}
/* ØªØ¹Ø¯ÙŠÙ„ padding-bottom Ù„ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ Ø¨ÙˆØ§Ø³Ø·Ø© JS */
#map{height:100vh;position:relative; padding-top: 55px; padding-bottom: 220px; transition: padding-bottom 0.3s ease;} 
/* ØªØ«Ø¨ÙŠØª Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙÙˆÙ‚ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø«Ø§Ø¨ØªØ© */
#panel{ 
    position:fixed; 
    bottom:0; 
    left:0; 
    right:0; 
    background:#fff; 
    text-align:center; 
    padding:10px 0 0; 
    box-shadow:0 -2px 10px rgba(0,0,0,0.3); 
    border-radius: 15px 15px 0 0; 
    z-index: 1000; 
    transition: bottom 0.3s ease; 
}

/* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø«Ø§Ø¨ØªØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
#fixedActions {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 5px 0 10px;
    background: #fff;
    z-index: 1005; 
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
}

button{ background:#f97316; color:white; border:none; padding:15px 10px; border-radius:10px; font-weight:bold; cursor:pointer; margin:5px 10px; width:calc(100% - 20px); font-size: 1.1em; }
button:disabled { background: #ccc; cursor: not-allowed; }

#panel p#status { font-size: 1.0em; margin: 10px; line-height: 1.4; color: #333; padding: 5px; background: #f0f0f0; border-radius: 8px; }
#costDisplay { background: #e0f2f1; color: #004d40; font-size: 1.2em; font-weight: bold; padding: 10px; margin: 10px; border-radius: 8px; display: none; }
#map-center-pin { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -100%); z-index: 999; font-size: 40px; pointer-events: none; display: none; }
#pointContainer { display: flex; flex-direction: column; padding: 0 10px; gap: 10px; text-align: right; }
.point-field { display: flex; justify-content: space-between; align-items: center; background: #f5f5f5; padding: 10px; border-radius: 10px; }
.point-value { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex-grow: 1; text-align: right; }
.point-action { background: none; color: #f97316; width: auto; padding: 0 5px; margin: 0; font-size: 1em; }
#searchContainer { position: fixed; top: 0; left: 0; right: 0; background: #fff; padding: 8px 10px; z-index: 1001; display: flex; align-items: center; }
#search-input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 8px; margin: 0 10px; text-align: right; }
#searchResults { position: fixed; top: 55px; left: 10px; right: 10px; background: #fff; z-index: 1002; max-height: 50vh; overflow-y: auto; display: none; border: 1px solid #ddd; }
.search-result-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; text-align: right; }

#logoutBtn{
    display:block; 
    background:#607d8b; 
    padding:10px 20px; 
    width:calc(100% - 20px); 
    margin: 5px 10px;
    font-size: 1em;
}

/* Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ */
.searching-status {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding: 10px;
}
.timer-container {
    width: 36px;
    height: 36px;
    position: relative;
    border-radius: 50%;
    margin-right: 10px;
    flex-shrink: 0;
}
#countdownProgress {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border-radius: 50%;
}
#countdownText {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 0.9em;
    font-weight: bold;
    color: #f97316;
    z-index: 10;
}
</style>
</head>
<body>

<div id="map"></div>
<div id="map-center-pin">ğŸ“</div>

<div id="searchContainer">
    <span>ğŸ”</span>
    <input type="text" id="search-input" placeholder="Ø£Ø¨Ø­Ø« Ø¹Ù† Ù…ÙƒØ§Ù†" />
</div>
<div id="searchResults"></div>

<div id="panel">
    <div id="pointContainer">
        <div class="point-field" id="startPointField">
            <span>Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</span>
            <span id="startPointValue" class="point-value">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</span>
            <button id="changeStartPointBtn" class="point-action" style="display:none;">ØªØºÙŠÙŠØ±</button>
        </div>
        <div class="point-field" id="endPointField" style="display:none;">
            <span>Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„</span>
            <span id="endPointValue" class="point-value">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</span>
            <button id="changeEndPointBtn" class="point-action" style="display:none;">ØªØºÙŠÙŠØ±</button>
        </div>
    </div>
    <div id="costDisplay">Ø§Ù„ØªÙƒÙ„ÙØ©: <strong><span id="fareValue">---</span> Ø¯.Ø¹</strong></div>
    <p id="status" style="display:none;"></p> 
</div>

<div id="fixedActions">
    <button id="mainActionBtn">ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</button> 
    <button id="logoutBtn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</div>

<script>
const app=firebase.initializeApp({apiKey:"AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M",authDomain:"taxi-15314.firebaseapp.com",databaseURL:"https://taxi-15314-default-rtdb.firebaseio.com/",projectId:"taxi-15314"});
const db=firebase.database();

let map=L.map('map').setView([33.3603, 44.5066],14); 
L.tileLayer("https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}&key=AIzaSyD7TtwniAdUtB8-pnTny4ZwE6gqX36SGUk",{maxZoom:20}).addTo(map);
map.whenReady(()=>map.invalidateSize());

let startCoords=null, endCoords=null, startAreaName="", endAreaName="";
let currentStage="settingStart", rideId=null, driverMarker=null, rideRef=null, driverRef=null;
let countdownInterval = null; 

const pin=document.getElementById("map-center-pin"), startVal=document.getElementById("startPointValue"), endVal=document.getElementById("endPointValue");
const mainBtn=document.getElementById("mainActionBtn"), logoutBtn=document.getElementById("logoutBtn");
const statusP=document.getElementById("status"), costDiv=document.getElementById("costDisplay"), fareVal=document.getElementById("fareValue");
const startF=document.getElementById("startPointField"), endF=document.getElementById("endPointField"), chStart=document.getElementById("changeStartPointBtn"), chEnd=document.getElementById("changeEndPointBtn");
const searchIn=document.getElementById("search-input"), searchRes=document.getElementById("searchResults");
const fixedActions = document.getElementById("fixedActions");
const panel = document.getElementById("panel");


function getShortName(a){if(!a)return"ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";if(a.length<50&&!a.includes(','))return a; const p=a.split(',').map(x=>x.trim()).filter(x=>!['Ù‚Ø¶Ø§Ø¡','Ù†Ø§Ø­ÙŠØ©','Ù…Ø±ÙƒØ²','Ø¨ØºØ¯Ø§Ø¯'].some(k=>x.includes(k))); return p.length?p[0]:a.split(',').pop();}
async function revGeo(lat,lon){try{const r=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=ar`);const d=await r.json();return d.display_name||`${lat},${lon}`;}catch{return`${lat},${lon}`;}}
function calcDist(l1,n1,l2,n2){const R=6371, dLat=(l2-l1)*Math.PI/180, dLon=(n2-n1)*Math.PI/180; const a=Math.sin(dLat/2)**2+Math.cos(l1*Math.PI/180)*Math.cos(l2*Math.PI/180)*Math.sin(dLon/2)**2; return parseFloat((R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))).toFixed(2));}


function updatePanelHeight() {
    const totalFixedBottomHeight = fixedActions.offsetHeight;
    panel.style.bottom = totalFixedBottomHeight + 'px';
    const panelContentHeight = panel.offsetHeight;
    const totalPanelHeight = panelContentHeight + totalFixedBottomHeight + 10;
    
    document.getElementById("map").style.paddingBottom = `${totalPanelHeight}px`;
    map.invalidateSize();
}

// --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ---

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù‚Ø¨Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø© (Ù…ØªØ³Ù„Ø³Ù„: Ø§Ù†Ø·Ù„Ø§Ù‚ -> ÙˆØµÙˆÙ„ -> ØªØ£ÙƒÙŠØ¯)
function preRideMainAction() {
    if(currentStage === "settingStart") {
        if(!startCoords) { alert("ÙŠØ±Ø¬Ù‰ ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚"); return; }
        currentStage = "settingEnd";
        // ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„ØªØ´Ø¬ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù„Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†Ù‚Ø·Ø© ÙˆØµÙˆÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù†ÙØ³ Ø§Ù„Ù…ÙƒØ§Ù†
        map.panBy([0, -50]); 
        updateUI();
    }
    else if(currentStage === "settingEnd") {
        if(!endCoords) { alert("ÙŠØ±Ø¬Ù‰ ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„"); return; }
        currentStage = "confirmed";
        updateUI();
    }
    else if(currentStage === "confirmed") {
        findDriver();
    }
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© (Ø¥Ù„ØºØ§Ø¡/Ø¥Ù†Ù‡Ø§Ø¡)
function activeRideMainAction(){
    if(rideId){ 
        if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡/Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ØŸ")) {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ "Ù…Ù„ØºØ§Ø©" Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø±Ø§ÙƒØ¨
            db.ref("rides/"+rideId).update({status:"Ù…Ù„ØºØ§Ø©", canceledBy:"rider"}); 
            // Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ (monitorRide) Ø¨Ø§ÙƒØªØ´Ø§Ù Ø§Ù„ØªØºÙŠÙŠØ± ÙˆØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        }
    }
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
async function updateUI(){
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
    pin.style.display='none'; 
    mainBtn.style.display='none'; 
    costDiv.style.display='none';
    chStart.style.display='none'; 
    chEnd.style.display='none'; 
    statusP.style.display='none';
    
    // Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù„Ù„Ø­Ø³Ø§Ø¨
    startF.style.display='flex';
    endF.style.display='flex'; 

    // --- Ø­Ø§Ù„Ø© ÙˆØ¬ÙˆØ¯ Ø±Ø­Ù„Ø© Ù†Ø´Ø·Ø© (Ø§Ù†ØªØ¸Ø§Ø± Ø£Ùˆ Ø±ÙƒÙˆØ¨) ---
    if(rideId){ 
        startF.style.display='none';
        endF.style.display='none';
        
        mainBtn.style.display='block';
        mainBtn.innerText="Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ / Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© âŒ"; 
        mainBtn.onclick = activeRideMainAction; 
        mainBtn.style.backgroundColor = '#E53935'; // Ø£Ø­Ù…Ø± Ù„Ù„Ø¥Ù„ØºØ§Ø¡
        
        logoutBtn.style.display='none'; 
        statusP.style.display='block';
        
        setTimeout(updatePanelHeight, 50); 
        return; 
    }

    // --- Ù…Ø±Ø§Ø­Ù„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ù‚Ø§Ø· (Ù‚Ø¨Ù„ Ø§Ù„Ø·Ù„Ø¨) ---
    mainBtn.onclick = preRideMainAction; 
    mainBtn.style.backgroundColor = '#f97316'; // Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ
    
    mainBtn.style.display='block';
    logoutBtn.style.display='block'; 
    
    if(currentStage === "settingStart"){
        // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚
        pin.style.display='block'; 
        mainBtn.innerText = "ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚"; 
        mainBtn.disabled = !startCoords;
        startVal.innerText = startAreaName ? getShortName(startAreaName) : 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...'; 
        endF.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚Ù„ Ø§Ù„ÙˆØµÙˆÙ„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø©
        
    } else if(currentStage === "settingEnd"){
        // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØµÙˆÙ„
        pin.style.display='block';
        mainBtn.innerText = "ØªØ«Ø¨ÙŠØª Ø§Ù„ÙˆØµÙˆÙ„"; 
        mainBtn.disabled = !endCoords;
        
        startVal.innerText = getShortName(startAreaName); 
        endVal.innerText = endAreaName ? getShortName(endAreaName) : 'Ø­Ø¯Ø¯ Ø§Ù„ÙˆØ¬Ù‡Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©';
        
        chStart.style.display = 'inline-block'; // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚
        
    } else if(currentStage === "confirmed"){
        // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ§Ù„Ø·Ù„Ø¨
        pin.style.display='none'; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¯Ø¨ÙˆØ³ Ù„Ø£Ù† Ø§Ù„Ù†Ù‚Ø§Ø· Ø«Ø¨ØªØª
        mainBtn.innerText = "Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ù‚Ø±Ø¨ Ø³Ø§Ø¦Ù‚ ğŸš•"; 
        mainBtn.disabled = false;
        
        chStart.style.display = 'inline-block'; 
        chEnd.style.display = 'inline-block';
        
        if(startCoords && endCoords){
            const dist = calcDist(startCoords[0], startCoords[1], endCoords[0], endCoords[1]);
            fareVal.innerText = Math.max(2000, Math.round(dist * 1000)).toLocaleString() + ' Ø¯.Ø¹'; 
            costDiv.style.display = 'block';
        }
    }
    
    setTimeout(updatePanelHeight, 50); 
}

// Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØºÙŠÙŠØ± Ø§Ù„ØµØºÙŠØ±Ø© Ù„Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø®Ù„Ù
chStart.onclick=async()=>{
    currentStage="settingStart"; 
    // Ø¹Ù†Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ØŒ Ù†ØµÙØ± Ø§Ù„ÙˆØµÙˆÙ„ Ø£ÙŠØ¶Ø§Ù‹ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ³Ù„Ø³Ù„
    endCoords=null; endAreaName=""; 
    if(startCoords) map.setView(startCoords, 14); 
    await updateUI();
};
chEnd.onclick=async()=>{
    currentStage="settingEnd"; 
    if(endCoords) map.setView(endCoords, 14); 
    await updateUI();
};

let geoTimer;
map.on('moveend',async()=>{
    if(rideId)return; // Ù„Ø§ ØªØ­Ø¯ÙŠØ« Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©
    if(currentStage === "confirmed") return; // Ù„Ø§ ØªØ­Ø¯ÙŠØ« Ø¥Ø°Ø§ ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯

    const c=map.getCenter();
    
    if(currentStage==="settingStart") {
        startCoords=[c.lat,c.lng];
    } else if(currentStage==="settingEnd") {
        endCoords=[c.lat,c.lng];
    }
    
    updateUI(); // ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±

    clearTimeout(geoTimer);
    geoTimer=setTimeout(async()=>{
        const n=await revGeo(c.lat,c.lng);
        if(currentStage==="settingStart") startAreaName=n; 
        else if(currentStage==="settingEnd") endAreaName=n;
        updateUI();
    },500);
});

let sTimer;
searchIn.addEventListener('input',()=>{
    clearTimeout(sTimer);
    const q=searchIn.value.trim();
    if(q.length<3){searchRes.innerHTML='';searchRes.style.display='none'; return;}
    sTimer=setTimeout(async()=>{
        const r=await fetch(`https://nominatim.openstreetmap.org/search?q=${q}&format=json&limit=5&countrycodes=iq&accept-language=ar`);
        const d=await r.json();
        searchRes.innerHTML=''; searchRes.style.display='block';
        if(!d.length) searchRes.innerHTML='<div class="search-result-item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
        d.forEach(i=>{
            const div=document.createElement('div'); div.className='search-result-item'; div.innerText=i.display_name;
            div.onclick=()=>{
                map.setView([i.lat,i.lon],16); searchRes.style.display='none'; searchIn.value='';
                if(currentStage==="settingStart") startCoords=[i.lat,i.lon]; 
                else if(currentStage==="settingEnd" || currentStage==="confirmed") {
                    // Ø¥Ø°Ø§ Ø¨Ø­Ø« ÙˆÙ‡Ùˆ ÙÙŠ Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ø£Ùˆ Ø§Ù„ØªØ£ÙƒÙŠØ¯ØŒ Ù†Ø­Ø¯Ø« Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
                    currentStage="settingEnd";
                    endCoords=[i.lat,i.lon];
                }
                updateUI();
            };
            searchRes.appendChild(div);
        });
    },700);
});

function findDriver(){
    if(!startCoords||!endCoords)return;
    mainBtn.disabled=true; mainBtn.innerText="Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø·Ù„Ø¨...";
    
    let targetDriversList = []; 

    db.ref("drivers").once("value",s=>{
        s.forEach(ds=>{
            const d=ds.val();
            if(d.status==="Ù…ØªØµÙ„"&&d.lat){
                const dst=calcDist(startCoords[0],startCoords[1],d.lat,d.lng);
                if(dst<=3.0){ 
                    targetDriversList.push(ds.key);
                }
            }
        });
        
        if(targetDriversList.length > 0){ 
            sendReq(targetDriversList); 
        }
        else{ 
            mainBtn.disabled=false; 
            mainBtn.innerText="Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ù‚Ø±Ø¨ Ø³Ø§Ø¦Ù‚ ğŸš•"; 
            alert("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø§Ø¦Ù‚ÙˆÙ† Ù…ØªØ§Ø­ÙˆÙ† Ø¶Ù…Ù† 3 ÙƒÙ… Ø­Ø§Ù„ÙŠØ§Ù‹.");
            updateUI(); 
        }
    });
}

function sendReq(targetDriversList){ 
    const ph=localStorage.getItem('phone');
    const dist=calcDist(startCoords[0],startCoords[1],endCoords[0],endCoords[1]);
    rideId=Date.now(); localStorage.setItem('activeRideId',rideId);
    
    db.ref("rides/"+rideId).set({
        riderPhone:ph, 
        targetDrivers: targetDriversList,
        startLat:startCoords[0], startLng:startCoords[1], endLat:endCoords[0], endLng:endCoords[1],
        startArea:startAreaName, endArea:endAreaName, distance:dist.toFixed(2), fare:Math.max(2000,Math.round(dist*1000)),
        status:"Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©"
    });
    monitorRide(rideId);
    updateUI();
}

function clearCountdown() {
    if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
    }
    statusP.classList.remove('searching-status');
}

function monitorRide(id){
    rideRef=db.ref("rides/"+id);
    clearCountdown(); 
    
    rideRef.on('value',s=>{
        const r=s.val();
        
        if(!r){ 
            cleanup(); 
            initGeo(); 
            return; 
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡
        updateUI(); 
        costDiv.style.display='block'; fareVal.innerText=r.fare.toLocaleString()+' Ø¯.Ø¹';

        if(r.status==="Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©"){
            
            if (!r.reviewTimer) {
                db.ref("rides/"+id+"/reviewTimer").set(Date.now());
                setTimeout(()=>{
                    db.ref("rides/"+id).once("value",check=>{
                        if(check.val()&&check.val().status==="Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©"){
                            db.ref("rides/"+id).update({status:"Ù…Ø±ÙÙˆØ¶Ø©", rejectionReason:"timeout"}); 
                        }
                    });
                }, 30000); 
            }
            
            if (!countdownInterval) {
                const startTime = r.reviewTimer || Date.now();
                const totalDuration = 30; 
                
                const circleHTML = `
                    <span style="flex-grow:1; text-align:right;">â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ (${totalDuration} Ø«Ø§Ù†ÙŠØ©)...</span>
                    <div id="countdownContainer" class="timer-container">
                        <div id="countdownProgress"></div>
                        <span id="countdownText">${totalDuration}</span>
                    </div>
                `;
                
                statusP.style.display = 'flex';
                statusP.classList.add('searching-status');
                statusP.innerHTML = circleHTML;
                
                const progressElement = document.getElementById('countdownProgress');
                const textElement = document.getElementById('countdownText');
                
                countdownInterval = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - startTime) / 1000);
                    const remaining = totalDuration - elapsed;
                    
                    if (remaining < 0) { 
                        clearCountdown();
                        statusP.innerHTML = "âš ï¸ Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø¨Ø­Ø«. Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù…...";
                        return;
                    }
                    
                    const percentage = Math.round((elapsed / totalDuration) * 100);
                    progressElement.style.background = `conic-gradient(#ddd 0%, #ddd ${percentage}%, #f97316 ${percentage}%, #f97316 100%)`;
                    progressElement.style.transform = `rotate(270deg)`;
                    textElement.innerText = remaining;

                }, 1000);
            }
            
        } else {
            clearCountdown();
            if(r.status==="Ù…Ù‚Ø¨ÙˆÙ„Ø©"){
                statusP.innerHTML=`ğŸš– Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù‚Ø§Ø¯Ù…! <br> Ø§Ù„Ù‡Ø§ØªÙ: <b><a href="tel:${r.driverPhone}">${r.driverPhone}</a></b>`;
                trackDriver(r.driverPhone);
            } else if(r.status==="Ø¨Ø¯Ø£Øª"){
                statusP.innerHTML=`ğŸš¦ Ø§Ù„Ø±Ø­Ù„Ø© Ø¬Ø§Ø±ÙŠØ©! <br> Ø§Ù„Ù‡Ø§ØªÙ: <b><a href="tel:${r.driverPhone}">${r.driverPhone}</a></b>`;
            } else if(r.status==="Ù…Ù†ØªÙ‡ÙŠØ©"){
                 alert(`âœ… ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­. Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ!`); 
                 cleanup(); 
                 initGeo();
            } else if(["Ù…Ù„ØºØ§Ø©","Ù…Ø±ÙÙˆØ¶Ø©"].includes(r.status)){
                const msg = r.status === "Ù…Ù„ØºØ§Ø©" ? "ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©" : "Ù†Ø¹ØªØ°Ø±ØŒ Ù„Ù… ÙŠÙ‚Ø¨Ù„ Ø£Ø­Ø¯ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ø§Ù„Ø·Ù„Ø¨";
                alert(msg); 
                cleanup(); 
                initGeo();
            } 
        }
    });
}

function trackDriver(ph){
    if(driverRef)driverRef.off();
    driverRef=db.ref("drivers/"+ph);
    driverRef.on('value',s=>{
        const d=s.val();
        if(d&&d.lat){
            if(driverMarker)map.removeLayer(driverMarker);
            driverMarker=L.marker([d.lat,d.lng],{icon:L.divIcon({html:'ğŸš•',className:'custom-icon',iconSize:[30,30]})}).addTo(map);
        }
    });
}

function cleanup(){ 
    clearCountdown(); 
    if(rideRef)rideRef.off(); 
    if(driverRef)driverRef.off(); 
    rideId=null; 
    if(driverMarker)map.removeLayer(driverMarker); 
    localStorage.removeItem('activeRideId'); 
    currentStage = "settingStart";
    startCoords = null; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù„Ù„Ø¥Ø¬Ø¨Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    endCoords = null;
    updateUI(); 
}

function initGeo(){
    navigator.geolocation.getCurrentPosition(p=>{
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§ØªØŒ Ù†Ø£Ø®Ø° Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
        if(!startCoords) {
            startCoords=[p.coords.latitude,p.coords.longitude]; 
            map.setView(startCoords,15);
            revGeo(startCoords[0],startCoords[1]).then(n=>{startAreaName=n; updateUI();});
        }
        
        const savedId=localStorage.getItem('activeRideId'); 
        if(savedId){
            rideId=savedId; 
            monitorRide(rideId);
        } else { 
            updateUI(); 
        }
    },()=>{ 
        startCoords=[33.3603, 44.5066]; startAreaName = "Ø¨ØºØ¯Ø§Ø¯ - Ù…ÙˆÙ‚Ø¹ Ø§ÙØªØ±Ø§Ø¶ÙŠ"; 
        const savedId=localStorage.getItem('activeRideId'); if(savedId){rideId=savedId; monitorRide(savedId);} else { updateUI(); }
    });
}

window.onload=()=>{
    if(!localStorage.getItem('phone')||localStorage.getItem('userType')!=="rider")window.location.href="index.html";
    initGeo();
    window.addEventListener('resize', updatePanelHeight);
};
function logout(){ cleanup(); localStorage.clear(); window.location.href="index.html"; }
</script>
</body>
</html>
