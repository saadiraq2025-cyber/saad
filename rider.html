<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¨Ù„ÙŠ - Ø§Ù„Ø±Ø§ÙƒØ¨ (ØªØ­Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        :root { --baly-yellow: #FFD200; --baly-black: #1A1A1A; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        .floating-panel { 
            position: absolute; bottom: 0; left: 0; right: 0; 
            background: white; border-radius: 25px 25px 0 0; 
            padding: 20px; z-index: 1000; box-shadow: 0 -10px 30px rgba(0,0,0,0.2); 
        }

        .status-header { text-align: center; font-weight: bold; margin-bottom: 15px; color: #333; }
        
        .location-info { background: #fdfdfd; border-radius: 15px; padding: 10px; margin-bottom: 10px; border: 1px solid #eee; }
        .loc-row { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
        .loc-row:last-child { border-bottom: none; }
        .address-text { font-size: 13px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .ride-stats { display: flex; justify-content: space-around; background: #FFF9E6; padding: 12px; border-radius: 12px; margin-top: 10px; border: 1px solid #FFE58F; }
        
        .btn-order { background: var(--baly-yellow); border: none; width: 100%; padding: 18px; border-radius: 15px; font-weight: bold; font-size: 18px; cursor: pointer; margin-top: 15px; box-shadow: 0 4px 10px rgba(255, 210, 0, 0.3); }
        .btn-cancel { background: #ff4757; color: white; border: none; width: 100%; padding: 12px; border-radius: 12px; margin-top: 10px; font-weight: bold; cursor: pointer; }
        
        .driver-card { background: var(--baly-black); color: white; padding: 15px; border-radius: 20px; margin-top: 15px; display: none; }
        
        /* Ø¹Ù„Ø§Ù…Ø§Øª Ù…Ø®ØµØµØ© */
        .m-icon { font-size: 24px; text-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div id="map"></div>

<div class="floating-panel" id="mainPanel">
    <div class="status-header" id="statusMsg">Ø§Ø³Ø­Ø¨ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø£Ùˆ Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹</div>
    
    <div id="bookingUI">
        <div class="location-info">
            <div class="loc-row">
                <span>ğŸŸ¢</span>
                <div class="address-text" id="startAddr">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚...</div>
            </div>
            <div class="loc-row">
                <span>ğŸ”´</span>
                <div class="address-text" id="endAddr">Ø§Ù†Ù‚Ø± Ù„ØªØ­Ø¯ÙŠØ¯ ÙˆØ¬Ù‡Ø© Ø§Ù„ÙˆØµÙˆÙ„</div>
            </div>
        </div>

        <div class="ride-stats" id="rideStats">
            <div>Ø§Ù„Ø£Ø¬Ø±Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠØ©: <b id="fareTxt">0</b> Ø¯.Ø¹</div>
            <div>Ø§Ù„Ù…Ø³Ø§ÙØ©: <b id="distTxt">0</b> ÙƒÙ…</div>
        </div>

        <button class="btn-order" id="orderBtn">Ø·Ù„Ø¨ ÙƒØ§Ø¨ØªÙ† Ø¨Ù„ÙŠ</button>
    </div>

    <div id="activeRideUI" style="display: none;">
        <div class="driver-card" id="driverCard">
            <div style="font-size: 14px; opacity: 0.8;">ÙƒØ§Ø¨ØªÙ† Ø¨Ù„ÙŠ ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø¥Ù„ÙŠÙƒ</div>
            <div style="font-size: 20px; font-weight: bold; margin: 5px 0;" id="dPhone">078XXXXXXXX</div>
            <a id="callBtn" style="display: inline-block; background: var(--baly-yellow); color: black; padding: 10px 20px; border-radius: 10px; text-decoration: none; font-weight: bold; margin-top: 10px;">ğŸ“ Ø§ØªØµÙ„ Ø¨Ø§Ù„ÙƒØ§Ø¨ØªÙ†</a>
        </div>
        <button class="btn-cancel" onclick="cancelRide()">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</button>
    </div>
</div>

<script>
// Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
const firebaseConfig = { apiKey: "AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M", databaseURL: "https://taxi-15314-default-rtdb.firebaseio.com/" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let map = L.map('map', { zoomControl: false }).setView([33.3152, 44.3661], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let startMarker, endMarker, currentRideId = null;
const riderPhone = localStorage.getItem("phone") || "07700000000";

// Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ù…Ø®ØµØµØ©
const startIcon = L.divIcon({ html: '<div class="m-icon">ğŸŸ¢</div>', className: 'none', iconSize: [30, 30], iconAnchor: [15, 30] });
const endIcon = L.divIcon({ html: '<div class="m-icon">ğŸ”´</div>', className: 'none', iconSize: [30, 30], iconAnchor: [15, 30] });

// ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
navigator.geolocation.getCurrentPosition(pos => {
    const latlng = [pos.coords.latitude, pos.coords.longitude];
    map.setView(latlng, 15);
    
    startMarker = L.marker(latlng, { draggable: true, icon: startIcon }).addTo(map);
    endMarker = L.marker([latlng[0] + 0.003, latlng[1] + 0.003], { draggable: true, icon: endIcon }).addTo(map);

    startMarker.on('dragend', updateRouteInfo);
    endMarker.on('dragend', updateRouteInfo);
    updateRouteInfo();
});

// Ø§Ù„Ù†Ù‚Ø± Ù„ØªØºÙŠÙŠØ± Ø§Ù„ÙˆØ¬Ù‡Ø©
map.on('click', (e) => {
    if (currentRideId) return;
    endMarker.setLatLng(e.latlng);
    updateRouteInfo();
});

async function updateRouteInfo() {
    if (currentRideId) return;
    
    const start = startMarker.getLatLng();
    const end = endMarker.getLatLng();
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© ÙˆØ§Ù„Ø£Ø¬Ø±Ø©
    const distance = (map.distance(start, end) / 1000).toFixed(1);
    const fare = Math.round(distance * 1500);

    document.getElementById('distTxt').innerText = distance;
    document.getElementById('fareTxt').innerText = fare.toLocaleString();

    // Ø¬Ù„Ø¨ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ (Reverse Geocoding)
    fetchAddress(start, 'startAddr');
    fetchAddress(end, 'endAddr');
}

async function fetchAddress(latlng, elementId) {
    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng.lat}&lon=${latlng.lng}&accept-language=ar`);
        const data = await response.json();
        document.getElementById(elementId).innerText = data.display_name.split(',').slice(0, 2).join(', ');
    } catch (e) {
        document.getElementById(elementId).innerText = "Ù…ÙˆÙ‚Ø¹ Ù…Ø®ØµØµ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©";
    }
}

document.getElementById('orderBtn').onclick = function() {
    currentRideId = Date.now();
    const rideData = {
        riderPhone: riderPhone,
        start: [startMarker.getLatLng().lat, startMarker.getLatLng().lng],
        end: [endMarker.getLatLng().lat, endMarker.getLatLng().lng],
        startAddr: document.getElementById('startAddr').innerText,
        endAddr: document.getElementById('endAddr').innerText,
        fare: document.getElementById('fareTxt').innerText,
        status: "Ø¬Ø¯ÙŠØ¯Ø©"
    };

    // Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù€ Firebase
    db.ref("rides/" + currentRideId).set(rideData);
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù„Ù„Ù…Ù†Ø¹ Ù…Ù† Ø·Ù„Ø¨ Ø¢Ø®Ø±
    document.getElementById('bookingUI').style.display = 'none';
    document.getElementById('activeRideUI').style.display = 'block';
    document.getElementById('statusMsg').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ù‚Ø±Ø¨ ÙƒØ§Ø¨ØªÙ†...";

    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
    db.ref("rides/" + currentRideId).on('value', snap => {
        const r = snap.val();
        if (!r) return;

        if (r.status === "Ù…Ù‚Ø¨ÙˆÙ„Ø©") {
            document.getElementById('statusMsg').innerText = "ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨Ùƒ!";
            document.getElementById('driverCard').style.display = 'block';
            document.getElementById('dPhone').innerText = "ÙƒØ§Ø¨ØªÙ†: " + r.driverPhone;
            document.getElementById('callBtn').href = "tel:" + r.driverPhone;
        } else if (r.status === "Ù…ÙƒØªÙ…Ù„Ø©" || r.status === "Ù…Ù„ØºÙŠØ©") {
            alert(r.status === "Ù…ÙƒØªÙ…Ù„Ø©" ? "ÙˆØµÙ„Øª Ø¥Ù„Ù‰ ÙˆØ¬Ù‡ØªÙƒØŒ Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ!" : "ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©.");
            location.reload(); // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù„Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
        }
    });
};

function cancelRide() {
    if (currentRideId) {
        db.ref("rides/" + currentRideId).update({ status: "Ù…Ù„ØºÙŠØ©" });
        location.reload();
    }
}
</script>
</body>
</html>
