<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¨Ù„ÙŠ - Ø§Ù„Ø±Ø§ÙƒØ¨</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    
    <style>
        :root { --baly-orange: #FF7E00; --text-gray: #757575; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, sans-serif; overflow: hidden; background: #eee; }
        #map { height: 100vh; width: 100%; z-index: 1; }

        /* Ø¯Ø¨ÙˆØ³ Ø§Ù„ØªØ«Ø¨ÙŠØª ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ */
        .center-pin {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -100%);
            z-index: 2000; pointer-events: none;
            transition: transform 0.2s;
        }
        .pin-shadow { width: 12px; height: 12px; background: rgba(0,0,0,0.2); border-radius: 50%; margin: 5px auto; }

        /* Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© */
        .bottom-ui {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: white; border-radius: 20px 20px 0 0;
            padding: 20px; z-index: 3000; box-shadow: 0 -5px 25px rgba(0,0,0,0.15);
            text-align: center; transition: bottom 0.3s;
        }

        /* Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† */
        .address-box {
            background: #f8f9fa; border-radius: 12px;
            padding: 15px; margin-bottom: 15px;
            display: flex; align-items: center; justify-content: space-between;
            border: 1px solid #eee;
        }
        .address-box span { color: #333; font-size: 15px; flex-grow: 1; text-align: right; font-weight: 500; }
        .address-label { background: #eee; padding: 4px 10px; border-radius: 6px; font-size: 12px; margin-left: 10px; color: #666; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        .btn-confirm {
            background: var(--baly-orange); color: white; border: none;
            width: 100%; padding: 16px; border-radius: 12px;
            font-weight: bold; font-size: 18px; cursor: pointer;
            box-shadow: 0 4px 10px rgba(255, 126, 0, 0.3);
        }
        .btn-confirm:active { transform: scale(0.98); }

        /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ */
        .driver-panel {
            display: none; text-align: right;
            background: #fff; padding: 5px;
        }
        .driver-info {
            display: flex; align-items: center; justify-content: space-between;
            background: #f9f9f9; padding: 15px; border-radius: 12px; margin-bottom: 10px;
        }
        .driver-details div { font-size: 14px; color: #666; }
        .driver-details b { font-size: 18px; color: #333; }
        
        .btn-call {
            background: #4CAF50; color: white; text-decoration: none;
            padding: 10px 20px; border-radius: 8px; font-weight: bold;
            display: flex; align-items: center; gap: 5px;
        }

        .status-badge {
            display: inline-block; padding: 5px 15px; background: #e3f2fd;
            color: #1976d2; border-radius: 20px; font-size: 14px; margin-bottom: 15px; font-weight: bold;
        }

        /* Ø²Ø± Ù…ÙˆÙ‚Ø¹ÙŠ */
        .myloc-btn {
            position: absolute; bottom: 300px; right: 20px;
            background: white; width: 45px; height: 45px;
            border-radius: 50%; display: flex; align-items: center;
            justify-content: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000; cursor: pointer;
        }
        
        /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø³ÙŠØ§Ø±Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ */
        .car-icon { font-size: 30px; line-height: 1; text-shadow: 0 2px 5px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

<div id="map"></div>

<div class="center-pin" id="pin">
    <img src="https://cdn-icons-png.flaticon.com/512/684/684908.png" width="45">
    <div class="pin-shadow"></div>
</div>

<div class="myloc-btn" onclick="goToMyLoc()">ğŸ“</div>

<div class="bottom-ui">
    <div id="step1">
        <div class="address-box">
            <span id="startText">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...</span>
            <div class="address-label">Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</div>
        </div>
        <button class="btn-confirm" onclick="confirmStart()">ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</button>
    </div>

    <div id="step2" style="display:none;">
        <div class="address-box" style="opacity: 0.7; background: #f0f0f0;">
            <span id="fixedStart"></span>
            <div class="address-label">Ù…Ù†</div>
        </div>
        <div class="address-box">
            <span id="destText">Ø­Ø±Ùƒ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ¬Ù‡Ø©</span>
            <div class="address-label">Ø§Ù„ÙˆØµÙˆÙ„</div>
        </div>
        <button class="btn-confirm" onclick="confirmDest()">ØªØ«Ø¨ÙŠØª Ø§Ù„ÙˆØµÙˆÙ„</button>
    </div>

    <div id="step3" style="display:none;">
        <h3 style="margin: 0 0 15px 0; color: #333;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø©</h3>
        <div style="display: flex; justify-content: space-between; margin-bottom: 20px; font-weight: bold;">
            <div>ğŸ’° <span id="fareShow">0</span> Ø¯.Ø¹</div>
            <div>ğŸ“ <span id="distShow">0</span> ÙƒÙ…</div>
        </div>
        <button class="btn-confirm" id="orderBtn">Ø·Ù„Ø¨ Ø¨Ù„ÙŠ Ø§Ù„Ø¢Ù†</button>
        <button onclick="location.reload()" style="background:none; border:none; color:#999; margin-top:15px; width:100%;">Ø¥Ù„ØºØ§Ø¡</button>
    </div>

    <div id="step4" style="display:none;">
        <div class="status-badge" id="statusMsg">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙƒØ§Ø¨ØªÙ†...</div>
        
        <div class="driver-panel" id="driverPanel">
            <div class="driver-info">
                <div class="driver-details">
                    <div>Ø§Ù„ÙƒØ§Ø¨ØªÙ†</div>
                    <b id="dPhone">07XXXXXXXX</b>
                </div>
                <a href="#" id="callBtn" class="btn-call">ğŸ“ Ø§ØªØµØ§Ù„</a>
            </div>
            <button onclick="cancelRide()" style="color: #ff4444; background: none; border: none; padding: 10px; width: 100%; font-weight: bold;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>
        </div>
        
        <button id="cancelSearchBtn" onclick="cancelRide()" style="width:100%; padding:15px; border:1px solid #ddd; background:white; border-radius:10px; color:red;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¨Ø­Ø«</button>
    </div>
</div>

<script>
// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
const firebaseConfig = { apiKey: "AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M", databaseURL: "https://taxi-15314-default-rtdb.firebaseio.com/" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
let map = L.map('map', {zoomControl: false}).setView([33.3152, 44.3661], 14);
L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);

let startCoords, endCoords, currentRideId;
let driverMarker = null;
let driverListener = null;

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¹Ù†Ø¯ ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
map.on('moveend', function() {
    let center = map.getCenter();
    updateAddress(center.lat, center.lng);
});

async function updateAddress(lat, lng) {
    try {
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
        const data = await res.json();
        const name = data.display_name.split(',').slice(0, 2).join('ØŒ ');
        
        if(document.getElementById('step1').style.display !== 'none') {
            document.getElementById('startText').innerText = name;
        } else if(document.getElementById('step2').style.display !== 'none') {
            document.getElementById('destText').innerText = name;
        }
    } catch(e) {}
}

// Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø·Ù„Ø¨
function confirmStart() {
    startCoords = map.getCenter();
    document.getElementById('fixedStart').innerText = document.getElementById('startText').innerText;
    document.getElementById('step1').style.display = 'none';
    document.getElementById('step2').style.display = 'block';
    // Ø­Ø±ÙƒØ© Ø¨Ø³ÙŠØ·Ø© Ù„Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªÙˆØ¶ÙŠØ­ Ø§Ù„ØªØºÙŠÙŠØ±
    map.panBy([0, 100]);
}

function confirmDest() {
    endCoords = map.getCenter();
    const dist = (map.distance(startCoords, endCoords) / 1000).toFixed(1);
    const fare = Math.round(dist * 1500 + 1000); // Ù…Ø¹Ø§Ø¯Ù„Ø© Ø§Ù„Ø³Ø¹Ø±
    
    document.getElementById('fareShow').innerText = fare.toLocaleString();
    document.getElementById('distShow').innerText = dist;
    
    document.getElementById('step2').style.display = 'none';
    document.getElementById('step3').style.display = 'block';
    document.getElementById('pin').style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¯Ø¨ÙˆØ³
    
    // Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± (Ø®Ø· ÙˆÙ‡Ù…ÙŠ)
    L.polyline([startCoords, endCoords], {color: 'var(--baly-orange)', dashArray: '5, 10'}).addTo(map);
    map.fitBounds([startCoords, endCoords], {padding: [50, 50]});
}

// Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
document.getElementById('orderBtn').onclick = function() {
    currentRideId = Date.now();
    const rideData = {
        riderPhone: localStorage.getItem("phone") || "07700000000",
        start: [startCoords.lat, startCoords.lng],
        end: [endCoords.lat, endCoords.lng],
        startName: document.getElementById('fixedStart').innerText,
        endName: document.getElementById('destText').innerText,
        fare: document.getElementById('fareShow').innerText,
        status: "Ø¬Ø¯ÙŠØ¯Ø©"
    };

    db.ref("rides/" + currentRideId).set(rideData);

    document.getElementById('step3').style.display = 'none';
    document.getElementById('step4').style.display = 'block';

    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
    db.ref("rides/" + currentRideId).on('value', snap => {
        const r = snap.val();
        if(!r) return;

        if(r.status === "Ù…Ù‚Ø¨ÙˆÙ„Ø©") {
            document.getElementById('statusMsg').innerText = "ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©! Ø§Ù„ÙƒØ§Ø¨ØªÙ† ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚";
            document.getElementById('statusMsg').style.background = "#e8f5e9";
            document.getElementById('statusMsg').style.color = "#2e7d32";
            
            document.getElementById('cancelSearchBtn').style.display = 'none';
            document.getElementById('driverPanel').style.display = 'block';
            
            document.getElementById('dPhone').innerText = r.driverPhone;
            document.getElementById('callBtn').href = "tel:" + r.driverPhone;

            // Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚
            trackDriver(r.driverPhone);
        } 
        else if(r.status === "Ù…Ù†ØªÙ‡ÙŠØ©" || r.status === "Ù…Ù„ØºÙŠØ©") {
            alert("Ø§Ù„Ø±Ø­Ù„Ø© " + r.status);
            stopTracking();
            location.reload();
        }
    });
};

// Ø¯Ø§Ù„Ø© Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚
function trackDriver(driverPhone) {
    if(driverListener) return; // Ù…Ø±Ø§Ù‚Ø¨Ø© Ù†Ø´Ø·Ø© Ø¨Ø§Ù„ÙØ¹Ù„
    
    driverListener = db.ref("drivers/" + driverPhone);
    driverListener.on('value', snap => {
        const loc = snap.val();
        if(loc && loc.lat && loc.lng) {
            const pos = [loc.lat, loc.lng];
            
            if(!driverMarker) {
                // Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©
                const carIcon = L.divIcon({
                    className: 'car-icon',
                    html: 'ğŸš–',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });
                driverMarker = L.marker(pos, {icon: carIcon}).addTo(map);
            } else {
                // ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø³ÙŠØ§Ø±Ø©
                driverMarker.setLatLng(pos);
            }
        }
    });
}

function stopTracking() {
    if(driverListener) driverListener.off();
    if(driverMarker) map.removeLayer(driverMarker);
}

function cancelRide() {
    if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©ØŸ")) {
        if(currentRideId) db.ref("rides/" + currentRideId).update({status: "Ù…Ù„ØºÙŠØ©"});
        stopTracking();
        location.reload();
    }
}

function goToMyLoc() {
    navigator.geolocation.getCurrentPosition(pos => {
        const p = [pos.coords.latitude, pos.coords.longitude];
        map.flyTo(p, 16);
    });
}

// Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
goToMyLoc();
</script>
</body>
</html>
