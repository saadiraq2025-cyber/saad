<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¨Ù„ÙŠ - Ø§Ù„Ø±Ø§ÙƒØ¨</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        :root { --primary-color: #FFD200; --dark-bg: #1A1A1A; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f4f4; overflow: hidden; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© */
        #panel {
            position: absolute; bottom: 0; left: 0; right: 0; 
            background: white; padding: 20px; border-radius: 25px 25px 0 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.15); z-index: 1000;
            transition: transform 0.3s ease;
        }

        .search-card {
            background: #f8f8f8; border-radius: 12px; padding: 5px 15px;
            display: flex; align-items: center; margin-bottom: 15px; border: 1px solid #eee;
        }

        #searchInput {
            width: 100%; border: none; background: transparent; padding: 12px;
            font-size: 16px; outline: none; text-align: right;
        }

        #searchResults {
            list-style: none; padding: 0; margin: 0; max-height: 200px; overflow-y: auto;
            border-top: 1px solid #eee; display: none;
        }

        #searchResults li {
            padding: 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; font-size: 14px;
        }

        .btn-main {
            background: var(--primary-color); color: black; border: none;
            width: 100%; padding: 15px; border-radius: 12px; font-weight: bold;
            font-size: 18px; cursor: pointer; transition: 0.2s;
        }

        .btn-main:disabled { background: #ccc; }

        #status { font-size: 14px; color: #666; margin: 10px 0; text-align: center; }
        
        .ride-info-box {
            display: flex; justify-content: space-between; align-items: center;
            background: #fff9db; padding: 15px; border-radius: 12px; margin-bottom: 15px;
        }

        .fare-text { font-size: 20px; font-weight: 900; color: #000; }
        
        #logoutBtn { position: absolute; top: 20px; right: 20px; z-index: 1001; background: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); border: none; cursor: pointer; }
    </style>
</head>
<body>

<button id="logoutBtn" onclick="logout()">âœ•</button>
<div id="map"></div>

<div id="panel">
    <div id="searchContainer">
        <div class="search-card">
            <span>ğŸ”</span>
            <input type="text" id="searchInput" placeholder="Ø¥Ù„Ù‰ Ø£ÙŠÙ† ØªØ±ÙŠØ¯ Ø§Ù„Ø°Ù‡Ø§Ø¨ØŸ">
        </div>
        <ul id="searchResults"></ul>
    </div>

    <div id="rideSummary" style="display:none;">
        <div class="ride-info-box">
            <div>
                <div style="font-size: 12px; color: #888;">Ø§Ù„Ø£Ø¬Ø±Ø© Ø§Ù„Ù…Ù‚Ø¯Ø±Ø©</div>
                <div id="fareDisplay" class="fare-text">0 Ø¯.Ø¹</div>
            </div>
            <div style="text-align: left;">
                <div style="font-size: 12px; color: #888;">Ø§Ù„Ù…Ø³Ø§ÙØ©</div>
                <div id="distDisplay" style="font-weight: bold;">0 ÙƒÙ…</div>
            </div>
        </div>
    </div>

    <p id="status">ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ...</p>
    
    <button id="sendRide" class="btn-main" disabled>Ø§Ø·Ù„Ø¨ Ø¨Ù„ÙŠ</button>
    <button id="cancelRideBtn" class="btn-main" style="display:none; background:#eee; color: #e53935;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>
</div>

<script>
// Firebase Config (Ù†ÙØ³ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©)
const app=firebase.initializeApp({
  apiKey:"AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M",
  authDomain:"taxi-15314.firebaseapp.com",
  databaseURL:"https://taxi-15314-default-rtdb.firebaseio.com/",
  projectId:"taxi-15314"
});
const db=firebase.database();

let map=L.map('map', {zoomControl: false}).setView([33.3152,44.3661],13);
L.tileLayer("https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}&key=AIzaSyD7TtwniAdUtB8-pnTny4ZwE6gqX36SGUk").addTo(map);

let startCoords=null, endCoords=null, rideId=null;
let startAreaName="", endAreaName="";

// ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹
navigator.geolocation.getCurrentPosition(async pos=>{
  startCoords=[pos.coords.latitude,pos.coords.longitude];
  L.marker(startCoords, {icon: L.divIcon({className: 'start-dot', html: '<div style="background:#007bff; width:12px; height:12px; border-radius:50%; border:2px solid white;"></div>'})}).addTo(map);
  map.setView(startCoords,15);
  document.getElementById("status").innerText = "ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙƒØŒ Ø­Ø¯Ø¯ ÙˆØ¬Ù‡ØªÙƒ Ø§Ù„Ø¢Ù†";
});

// Ø¨Ø­Ø« Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹
const searchInput = document.getElementById('searchInput');
const resultsUl = document.getElementById('searchResults');

searchInput.addEventListener('input', e => {
    const q = e.target.value;
    if(q.length < 3) return;
    fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(q+", Ø§Ù„Ø¹Ø±Ø§Ù‚")}&format=json&limit=5&accept-language=ar`)
    .then(r => r.json()).then(data => {
        resultsUl.innerHTML = '';
        resultsUl.style.display = 'block';
        data.forEach(item => {
            let li = document.createElement('li');
            li.innerText = item.display_name;
            li.onclick = () => {
                selectLocation(item.lat, item.lon, item.display_name);
            };
            resultsUl.appendChild(li);
        });
    });
});

function selectLocation(lat, lon, name) {
    endCoords = [parseFloat(lat), parseFloat(lon)];
    endAreaName = name;
    resultsUl.style.display = 'none';
    searchInput.value = name;
    
    // Ø±Ø³Ù… Ø§Ù„Ø¹Ù„Ø§Ù…Ø©
    L.marker(endCoords).addTo(map);
    map.flyTo(endCoords, 14);
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ø¨Ø¯Ø§Ø¦ÙŠØ© (Ø¬ÙˆÙŠ)
    const dist = (map.distance(startCoords, endCoords) / 1000).toFixed(1);
    const fare = Math.round(dist * 1500); // ØªØ³Ø¹ÙŠØ±Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    
    document.getElementById('rideSummary').style.display = 'block';
    document.getElementById('fareDisplay').innerText = fare.toLocaleString() + " Ø¯.Ø¹";
    document.getElementById('distDisplay').innerText = dist + " ÙƒÙ…";
    document.getElementById('sendRide').disabled = false;
    document.getElementById("status").innerText = "Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ù†Ø·Ù„Ø§Ù‚";
}

document.getElementById('sendRide').onclick = function() {
    rideId = Date.now();
    const phone = localStorage.getItem('phone');
    db.ref("rides/"+rideId).set({
        riderPhone: phone,
        startLat: startCoords[0], startLng: startCoords[1],
        endLat: endCoords[0], endLng: endCoords[1],
        status: "Ø¬Ø¯ÙŠØ¯Ø©", fare: Math.round((map.distance(startCoords, endCoords)/1000)*1500),
        distance: (map.distance(startCoords, endCoords)/1000).toFixed(1)
    });
    
    this.style.display = 'none';
    document.getElementById('searchContainer').style.display = 'none';
    document.getElementById('cancelRideBtn').style.display = 'block';
    document.getElementById("status").innerText = "ÙŠØªÙ… Ø§Ù„Ø¢Ù† Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ù‚Ø±Ø¨ ÙƒØ§Ø¨ØªÙ†...";
    monitorRide(rideId);
};

function monitorRide(id) {
    db.ref("rides/"+id).on('value', snap => {
        const r = snap.val();
        if(r.status === "Ù…Ù‚Ø¨ÙˆÙ„Ø©") {
            document.getElementById("status").innerHTML = `<b>ÙƒØ§Ø¨ØªÙ† Ø¨Ù„ÙŠ ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø¥Ù„ÙŠÙƒ!</b><br>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: ${r.driverPhone}`;
        } else if(r.status === "Ø¨Ø¯Ø£Øª") {
            document.getElementById("status").innerText = "Ø§Ù„Ø±Ø­Ù„Ø© Ø¨Ø¯Ø£ØªØŒ Ù†ØªÙ…Ù†Ù‰ Ù„Ùƒ Ø±Ø­Ù„Ø© Ø³Ø¹ÙŠØ¯Ø©";
        } else if(r.status === "Ù…Ù†ØªÙ‡ÙŠØ©") {
            alert("ÙˆØµÙ„Øª Ù„ÙˆØ¬Ù‡ØªÙƒØŒ Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ù„ÙŠ");
            location.reload();
        }
    });
}

function logout() { localStorage.clear(); location.href="index.html"; }
</script>
</body>
</html>
