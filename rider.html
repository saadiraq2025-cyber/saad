<script>
// Ù…Ù†Ø¹ Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… â€” ÙŠØ¨Ù‚Ù‰ Ù…Ø³Ø¬Ù„ Ø­ØªÙ‰ Ù„Ùˆ ØºÙ„Ù‚ Ø§Ù„Ù…ØªØµÙØ­
window.onload = function () {
    let phone = localStorage.getItem("phone");
    let userType = localStorage.getItem("userType");

    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ±Ø¬Ø¹ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
    if (!phone || !userType) {
        window.location.href = "index.html"; // ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        return;
    }

    // ØªÙˆØ¬ÙŠÙ‡ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    if (userType === "driver" && window.location.pathname.indexOf("driver") === -1) {
        window.location.href = "driver.html";
    }

    if (userType === "rider" && window.location.pathname.indexOf("rider") === -1) {
        window.location.href = "rider.html";
    }
}
</script>
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø±Ø§ÙƒØ¨ - ØªÙƒØ³ÙŠ Ø§Ù„Ø¹Ø±Ø§Ù‚ Ø§Ù„Ø´Ø§Ù…Ù„</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2e7d32">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="/icons/icon-192x192.png">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<style>
body,html{margin:0;padding:0;height:100%;font-family:Tahoma;}
#map{height:60vh;}
#panel{background:#fff;text-align:center;padding:10px;box-shadow:0 -2px 5px rgba(0,0,0,0.2);}
button{background:#ffca28;border:none;padding:10px 20px;border-radius:8px;font-weight:bold;cursor:pointer; margin: 5px;}

/* ğŸ†• ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø£Ù…Ø§ÙƒÙ† */
#searchContainer {
    margin: 10px 0;
    padding: 0 10px;
}
#searchInput {
    width: 100%;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 16px;
    box-sizing: border-box; /* Ù„Ø¶Ù…Ø§Ù† Ø£Ù† Ø§Ù„Ø¹Ø±Ø¶ ÙŠØ´Ù…Ù„ Ø§Ù„Ù€ padding ÙˆØ§Ù„Ù€ border */
    direction: rtl;
}
#searchResults {
    list-style: none;
    padding: 0;
    margin: 5px 0 0 0;
    max-height: 150px;
    overflow-y: auto;
    border: 1px solid #eee;
    border-radius: 5px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    display: none; /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
    text-align: right; /* Ù…Ø­Ø§Ø°Ø§Ø© Ø§Ù„Ù†Øµ Ù„Ù„ÙŠÙ…ÙŠÙ† */
}
#searchResults li {
    padding: 10px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    font-size: 15px;
    background: #fff;
}
#searchResults li:hover {
    background: #f0f0f0;
}
#searchResults li:last-child {
    border-bottom: none;
}
/* â¬…ï¸ Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ */
#logoutBtn { background: #607d8b; color: white; margin-top: 10px; width: 95%; }
</style>
</head>
<body>
<div id="map"></div>
<div id="panel">
  <h3>ğŸš– Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
  
  <div id="searchContainer">
      <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© (Ù…Ù†Ø·Ù‚Ø©ØŒ Ø´Ø§Ø±Ø¹...)">
      <ul id="searchResults"></ul>
  </div>
  <p id="status">ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø§Ù„Ø¢Ù†...</p>
  <button id="sendRide" disabled>Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
  <button id="cancelRideBtn" style="display:none; background:#E53935; color:white;">âŒ Ø¥Ù†Ù‡Ø§Ø¡/Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>
  
  
  <button id="logoutBtn" onclick="window.logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </div>

<script type="module" src="app.js"></script>

<script>
// ** â¬…ï¸ Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ **
window.logout = function() {
    localStorage.removeItem('phone');
    localStorage.removeItem('userType');
    // **Ø§Ù„ØªØ¹Ø¯ÙŠÙ„:** Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø±Ø­Ù„Ø© Ù†Ø´Ø·Ø© Ù‚Ø¨Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    localStorage.removeItem('activeRideId');
    window.location.href = "index.html";
};
// ----------------------------------------

// ğŸš¨ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ù„Ø³Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙˆÙ„ Ø´ÙŠØ¡)
const userPhone = localStorage.getItem('phone');
const userType = localStorage.getItem('userType');

if (!userPhone || userType !== 'rider') {
    alert("âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ±Ø§ÙƒØ¨ Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©.");
    window.location.href = "index.html";
}
// ----------------------------------------

// ØªÙ‡ÙŠØ¦Ø© Firebase
const app=firebase.initializeApp({
  apiKey:"AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M",
  authDomain:"taxi-15314.firebaseapp.com",
  databaseURL:"https://taxi-15314-default-rtdb.firebaseio.com/",
  projectId:"taxi-15314"
});
const db=firebase.database();

let map=L.map('map').setView([33.3152,44.3661],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
// ğŸ’¡ Ø§Ù„Ø­Ù„ Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙÙŠ Ù…ØªØµÙØ­Ø§Øª iOS (ÙŠØ¶Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ø¬ÙŠÙ…Ù‡Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©)
map.whenReady(function() { 
    map.invalidateSize(); 
});


let startCoords=null,endCoords=null;
let startMarker=null,endMarker=null;
let rideId=null;

// ğŸ†• Ù…ØªØºÙŠØ±Ø§Øª Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚
let startAreaName = "Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ (ØºÙŠØ± Ù…Ø­Ø¯Ø¯)";
let endAreaName = "Ø§Ù„ÙˆØ¬Ù‡Ø© (ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©)";
// ------------------------------------------

// ** ğŸ†• Ù…ØªØºÙŠØ±Ø§Øª Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ (ØªØ¹Ø¯ÙŠÙ„ Ø¬Ø¯ÙŠØ¯) **
let driverMarker = null; // Ø¹Ù„Ø§Ù…Ø© Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚
let driverLocationRef = null; // Ù…Ø±Ø¬Ø¹ Firebase Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚
// ------------------------------------------
// ğŸ†• Ù…ØªØºÙŠØ± Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚ (30 Ø«Ø§Ù†ÙŠØ©)
let searchTimerInterval = null; 

// Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
const sendBtn = document.getElementById("sendRide");
const endBtn = document.getElementById("cancelRideBtn");

// ğŸ†• Ø¹Ù†Ø§ØµØ± ÙˆÙ…Ù†Ø·Ù‚ Ø§Ù„Ø¨Ø­Ø«
const searchInput = document.getElementById('searchInput');
const searchResultsUl = document.getElementById('searchResults');
const searchContainer = document.getElementById('searchContainer'); // Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§ÙˆÙŠØ©
const SEARCH_DELAY = 500; // ØªØ£Ø®ÙŠØ± Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©
let searchInputTimer = null; 

// ******************************************************
// ğŸ†• Ø¯Ø§Ù„Ø© Ø§Ù„Ø¹Ù†ÙˆÙ†Ø© Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ© Ø§Ù„Ø¹ÙƒØ³ÙŠØ© (Reverse Geocoding)
// ******************************************************
async function reverseGeocode(lat, lon) {
    const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=ar`;
    try {
        const response = await fetch(url);
        const data = await response.json();
        if (data && data.display_name) {
            // ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø§Ø³Ù… ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙÙ‚Ø· (Ù…Ø«Ù„Ø§Ù‹: Ø§Ù„Ø­ÙŠØŒ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©ØŒ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©)
            return data.display_name.split(',').slice(0, 3).reverse().join(', ');
        }
        return `Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª: ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
    } catch (error) {
        console.error('Reverse Geocoding Error:', error);
        return `Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª: ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
    }
}


// ğŸ†• Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Nominatim (ØªØ³ØªØ®Ø¯Ù… OpenStreetMap)
function searchLocation(query) {
    if (query.length < 3) {
        searchResultsUl.innerHTML = '';
        searchResultsUl.style.display = 'none';
        return;
    }
    
    // ğŸ’¡ Ø¥Ø¶Ø§ÙØ© 'Ø¨ØºØ¯Ø§Ø¯, Ø§Ù„Ø¹Ø±Ø§Ù‚' ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠ Ù„ØªØ­Ø³ÙŠÙ† Ø¯Ù‚Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    const fullQuery = `${query}, Ø¨ØºØ¯Ø§Ø¯, Ø§Ù„Ø¹Ø±Ø§Ù‚`; 
    const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(fullQuery)}&format=json&limit=5&addressdetails=1&accept-language=ar`;

    fetch(url)
        .then(response => response.json())
        .then(data => {
            searchResultsUl.innerHTML = '';
            if (data.length > 0) {
                data.forEach(item => {
                    const li = document.createElement('li');
                    // Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù† Ù…Ø¹ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø£Ùˆ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø£Ù‡Ù…
                    const areaName = item.display_name.split(',').slice(0, 3).reverse().join(', ');
                    li.innerText = areaName;
                    li.setAttribute('data-lat', item.lat);
                    li.setAttribute('data-lng', item.lon);
                    li.setAttribute('data-name', areaName); // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø§Ø³Ù… Ù„Ù„Ø¹Ø±Ø¶
                    li.onclick = () => selectSearchResult(item.lat, item.lon, areaName);
                    searchResultsUl.appendChild(li);
                });
                searchResultsUl.style.display = 'block';
            } else {
                searchResultsUl.innerHTML = '<li>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©.</li>';
                searchResultsUl.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Search error:', error);
            searchResultsUl.innerHTML = '<li>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«.</li>';
            searchResultsUl.style.display = 'block';
        });
}

// ğŸ†• Ø¯Ø§Ù„Ø© Ø§Ø®ØªÙŠØ§Ø± Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¨Ø­Ø«
function selectSearchResult(lat, lng, name) {
    // 1. Ø¥Ø®ÙØ§Ø¡ ÙˆØ¥ÙØ±Ø§Øº Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    searchResultsUl.innerHTML = '';
    searchResultsUl.style.display = 'none';
    searchInput.value = name; // ØªØ­Ø¯ÙŠØ« Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«
    endAreaName = name; // ğŸ†• ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙˆØµÙˆÙ„

    // 2. ØªØ­Ø¯ÙŠØ« Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    const latlng = L.latLng(parseFloat(lat), parseFloat(lng));
    if(endMarker){map.removeLayer(endMarker);}
    endCoords = [latlng.lat, latlng.lng];
    endMarker = L.marker(endCoords).addTo(map).bindPopup(`ğŸ Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ©: ${name}`).openPopup();
    map.setView(endCoords, 15); // Ù†Ù‚Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©

    // 3. ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù€ panel
    if (!rideId) { 
        document.getElementById("status").innerHTML = `ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©: <b>${endAreaName}</b>. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨.`;
        sendBtn.disabled=false;
    } else {
        document.getElementById("status").innerText="Ù„Ø¯ÙŠÙƒ Ø±Ø­Ù„Ø© Ù†Ø´Ø·Ø© Ø¨Ø§Ù„ÙØ¹Ù„. Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©.";
        sendBtn.disabled=true;
    }
}

// ğŸ†• Ø±Ø¨Ø· Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¯Ø§Ù„Ø© Ù…Ø¹ Ø®Ø§ØµÙŠØ© Ø§Ù„ØªØ£Ø®ÙŠØ±
searchInput.addEventListener('input', (e) => {
    clearTimeout(searchInputTimer);
    searchInputTimer = setTimeout(() => {
        searchLocation(e.target.value.trim());
    }, SEARCH_DELAY);
});

// ğŸ†• Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
document.addEventListener('click', (e) => {
    if (!searchContainer.contains(e.target) && searchResultsUl.style.display === 'block') {
        searchResultsUl.style.display = 'none';
    }
});
// ----------------------------------------


// ** ğŸ†• Ø¯Ø§Ù„Ø© ÙØ­Øµ Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© **
function checkActiveRide() {
    const storedRideId = localStorage.getItem('activeRideId');
    if (storedRideId) {
        rideId = storedRideId;
        document.getElementById("status").innerHTML = "Ù„Ø¯ÙŠÙƒ Ø±Ø­Ù„Ø© Ù†Ø´Ø·Ø© Ù‚ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©. ÙŠØªÙ… Ø¬Ù„Ø¨ Ø­Ø§Ù„ØªÙ‡Ø§...";
        sendBtn.disabled = true; // ØªØ¹Ø·ÙŠÙ„ Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø±Ù‚Ù… Ø±Ø­Ù„Ø© Ù…Ø®Ø²Ù‘Ù†
        
        endBtn.style.display = 'inline-block'; // ğŸ†• Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡
        endBtn.onclick = cancelRide; // ğŸ†• Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ø¨Ø§Ù„Ø¯Ø§Ù„Ø©

        listenForUpdates();
    } else {
        sendBtn.disabled = true; // ÙŠØ¨Ù‚Ù‰ Ù…Ø¹Ø·Ù‘Ù„Ø§Ù‹ Ø­ØªÙ‰ ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© 
    }
}
// ----------------------------------------

// ******************************************************
// ğŸ†• Ø¯Ø§Ù„Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚ (30 Ø«Ø§Ù†ÙŠØ©)
// ******************************************************
function startSearchCountdown() {
    if (searchTimerInterval) clearInterval(searchTimerInterval);
    
    let timeLeft = 30; // 30 Ø«Ø§Ù†ÙŠØ© Ù„Ù„Ø¨Ø­Ø«
    
    // ØªØ­Ø¯ÙŠØ« Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
    const initialStatus = document.getElementById("status").innerHTML;
    document.getElementById("status").innerHTML = initialStatus + `<br><b>(Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${timeLeft} Ø«Ø§Ù†ÙŠØ©)</b>`;
    
    searchTimerInterval = setInterval(() => {
        timeLeft--;

        if (timeLeft < 0) {
            clearInterval(searchTimerInterval);
            searchTimerInterval = null;
            
            // ğŸš¨ Ø¥Ø¬Ø±Ø§Ø¡: Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ ÙˆÙ‚Øª Ø§Ù„Ø¨Ø­Ø«
            if (rideId) {
                // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ù‚Ø¯ÙŠÙ…
                firebase.database().ref("rides/" + rideId).off("value"); 
                
                firebase.database().ref("rides/" + rideId).update({
                    status: "Ù…Ù„ØºØ§Ø© - Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª",
                    notification: "âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ ÙˆÙ‚Øª Ø§Ù„Ø¨Ø­Ø« (30 Ø«Ø§Ù†ÙŠØ©)"
                }).then(() => {
                    document.getElementById("status").innerHTML = `
                        âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø§Ø¦Ù‚ Ø®Ù„Ø§Ù„ 30 Ø«Ø§Ù†ÙŠØ©.<br>
                        ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¬Ø¯Ø¯Ø§Ù‹.
                    `;
                    resetRiderState();
                });
            } else {
                resetRiderState();
            }
            return;
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const currentHtml = document.getElementById("status").innerHTML;
        const newHtml = currentHtml.replace(/\(Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: \d+ Ø«Ø§Ù†ÙŠØ©\)/, `(Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${timeLeft} Ø«Ø§Ù†ÙŠØ©)`);
        document.getElementById("status").innerHTML = newHtml;

    }, 1000);
}
// ******************************************************


// ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ - ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø±Ø§Øª Ù‚ÙˆÙŠØ© Ù„Ù€ iOS
navigator.geolocation.getCurrentPosition(async pos=>{ // â¬…ï¸ Ø¥Ø¶Ø§ÙØ© async
  startCoords=[pos.coords.latitude,pos.coords.longitude];
  startMarker=L.marker(startCoords).addTo(map).bindPopup("ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ").openPopup();
  map.setView(startCoords,15);
  
  // **************************************************
  // ğŸ†• Ø¬Ù„Ø¨ Ø§Ø³Ù… Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ ÙˆØªØ®Ø²ÙŠÙ†Ù‡Ø§
  startAreaName = await reverseGeocode(startCoords[0], startCoords[1]);
  document.getElementById("status").innerHTML=`ğŸ“ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚: <b>${startAreaName}</b><br>ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ©.`;
  // **************************************************
  
  // **Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯:** ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø­Ù„Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹
  checkActiveRide(); 
  
},err=>{
  document.getElementById("status").innerText="âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠØŒ ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø² ÙˆØ§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡ (Ø®Ø§ØµØ© ÙÙŠ Ù…ØªØµÙØ­ ÙƒØ±ÙˆÙ… Ø¹Ù„Ù‰ iOS).";
},{enableHighAccuracy:true,timeout:10000,maximumAge:0}); // Ø®ÙŠØ§Ø±Ø§Øª Ù‚ÙˆÙŠØ©

// ** ğŸ—ºï¸ Ù…Ù†Ø·Ù‚ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„ **
map.on('click',async function(e){ // â¬…ï¸ Ø¥Ø¶Ø§ÙØ© async
  // ğŸ†• Ø¥ÙØ±Ø§Øº Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
  searchInput.value = ''; 
  searchResultsUl.innerHTML = '';
  searchResultsUl.style.display = 'none';
    
  if(endMarker){map.removeLayer(endMarker);}
  endCoords=[e.latlng.lat,e.latlng.lng];
  endMarker=L.marker(endCoords).addTo(map).bindPopup("ğŸ Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ©").openPopup();
  
  // **************************************************
  // ğŸ†• Ø¬Ù„Ø¨ Ø§Ø³Ù… Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙˆØµÙˆÙ„ ÙˆØªØ®Ø²ÙŠÙ†Ù‡Ø§
  endAreaName = await reverseGeocode(endCoords[0], endCoords[1]);
  // **************************************************
  
  // **Ø§Ù„ØªØ¹Ø¯ÙŠÙ„:** ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ø²Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø±Ù‚Ù… Ø±Ø­Ù„Ø© Ù†Ø´Ø· 
  if (!rideId) { 
    document.getElementById("status").innerHTML=`ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©: <b>${endAreaName}</b> Ø¨Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨.`;
    sendBtn.disabled=false;
  } else {
    document.getElementById("status").innerText="Ù„Ø¯ÙŠÙƒ Ø±Ø­Ù„Ø© Ù†Ø´Ø·Ø© Ø¨Ø§Ù„ÙØ¹Ù„. Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©.";
    sendBtn.disabled=true;
  }
});


// ** ğŸ†• Ø¯Ø§Ù„Ø© Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© (Ù‚Ø¨Ù„ Ø£Ùˆ Ø¨Ø¹Ø¯ Ø§Ù„Ù‚Ø¨ÙˆÙ„) **
function cancelRide() {
    if (!rideId) {
        resetRiderState();
        document.getElementById("status").innerText = "ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨. ÙŠÙ…ÙƒÙ†Ùƒ Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©.";
        return;
    }
    
    if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©ØŸ")) {
        // ** Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ: ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø­Ù„Ø© Ø¥Ù„Ù‰ "Ù…Ù„ØºØ§Ø© Ù…Ù† Ø§Ù„Ø±Ø§ÙƒØ¨" **
        firebase.database().ref("rides/" + rideId).update({
            status: "Ù…Ù„ØºØ§Ø© Ù…Ù† Ø§Ù„Ø±Ø§ÙƒØ¨",
            notification: "âŒ Ø§Ù„Ø±Ø§ÙƒØ¨ Ø£Ù„ØºÙ‰ Ø§Ù„Ø±Ø­Ù„Ø©"
        }).then(() => {
            alert("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­.");
            document.getElementById("status").innerText = "ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨. ÙŠÙ…ÙƒÙ†Ùƒ Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©.";
            resetRiderState();
        }).catch(err => {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ù„ØºØ§Ø¡:", err);
            alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
        });
    }
}
// ----------------------------------------


sendBtn.onclick=function(){
  if(!startCoords || !endCoords){alert("âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©.");return;}
  // **Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©:** Ù…Ù†Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø±Ù‚Ù… Ø±Ø­Ù„Ø© Ù†Ø´Ø· Ø¨Ø§Ù„ÙØ¹Ù„
  if(rideId){alert("âš ï¸ Ù„Ø¯ÙŠÙƒ Ø±Ø­Ù„Ø© Ù†Ø´Ø·Ø© Ø¨Ø§Ù„ÙØ¹Ù„ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ù‡Ø§Ø¦Ù‡Ø§ Ù‚Ø¨Ù„ Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©.");return;} 
  
  const phone=userPhone||"ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";

  const R=6371;
  const dLat=(endCoords[0]-startCoords[0])*Math.PI/180;
  const dLon=(endCoords[1]-startCoords[1])*Math.PI/180;
  const a=Math.sin(dLat/2)*Math.sin(dLat/2)+
           Math.cos(startCoords[0]*Math.PI/180)*Math.cos(endCoords[0]*Math.PI/180)*
           Math.sin(dLon/2)*Math.sin(dLon/2);
  const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  const distance=(R*c).toFixed(2);
  const fare=Math.round(distance*1000);

  rideId=Date.now();
  // **Ø§Ù„ØªØ¹Ø¯ÙŠÙ„:** Ø­ÙØ¸ Ø±Ù‚Ù… Ø§Ù„Ø±Ø­Ù„Ø© ÙÙŠ LocalStorage
  localStorage.setItem('activeRideId', rideId); 
  
  // ğŸ†• Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡ ÙˆØ±Ø¨Ø·Ù‡ Ø¨Ø§Ù„Ø¯Ø§Ù„Ø©
  endBtn.style.display = 'inline-block';
  endBtn.onclick = cancelRide;

  firebase.database().ref("rides/"+rideId).set({
    riderPhone:phone,
    start:startCoords,
    end:endCoords,
    startArea: startAreaName, // ğŸ†• Ø­ÙØ¸ Ø§Ø³Ù… Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚
    endArea: endAreaName, // ğŸ†• Ø­ÙØ¸ Ø§Ø³Ù… Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙˆØµÙˆÙ„
    distance:distance,
    fare:fare,
    status:"Ø¬Ø¯ÙŠØ¯Ø©"
  }).then(()=>{
    document.getElementById("status").innerHTML=
      `âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨<br>Ø§Ù„Ù…Ø³Ø§ÙØ©: <b>${distance}</b> ÙƒÙ… â€” Ø§Ù„Ø£Ø¬Ø±Ø©: <b>${fare}</b> Ø¯.Ø¹<br>Ø¨Ø¥Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø³Ø§Ø¦Ù‚...`;
    sendBtn.disabled = true; // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± ÙÙˆØ± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    startSearchCountdown(); // ğŸ†• Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
    listenForUpdates();
  }).catch(err=>{
    document.getElementById("status").innerText="âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: "+err;
  });
};

// ğŸ”¹ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
function listenForUpdates(){
  if(!rideId) return;
  // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ Ø§Ø³ØªÙ…Ø§Ø¹ Ø³Ø§Ø¨Ù‚
  firebase.database().ref("rides/"+rideId).off("value");

  firebase.database().ref("rides/"+rideId).on("value",snapshot=>{
    const ride=snapshot.val();
    if(!ride) {
        document.getElementById("status").innerHTML = `âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©. ÙŠÙ…ÙƒÙ†Ùƒ Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©.`;
        resetRiderState();
        return;
    }

    // **Ø§Ù„ØªØ¹Ø¯ÙŠÙ„:** Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± Ø·Ø§Ù„Ù…Ø§ Ø§Ù„Ø±Ø­Ù„Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„/Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
    sendBtn.disabled = true; 
    
    if(ride.status==="Ù…Ù‚Ø¨ÙˆÙ„Ø©"){
      // ğŸ†• Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù„Ù„Ø¨Ø­Ø« ÙÙˆØ± Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©
      if (searchTimerInterval) {
          clearInterval(searchTimerInterval);
          searchTimerInterval = null;
      }
      
      const driverPhoneNumber = ride.driverPhone || ride.assignedDriver || "ØºÙŠØ± Ù…ØªÙˆÙØ±";
      
      // *** Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø¸Ù‡Ø§Ø± Ø±Ù‚Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø²Ø± Ø§Ù„Ø§ØªØµØ§Ù„ ***
      document.getElementById("status").innerHTML=`
        ğŸš• Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø¥Ù„ÙŠÙƒ...<br>Ø§Ù„Ù…Ø³Ø§ÙØ©: ${ride.distance} ÙƒÙ…<br>Ø§Ù„Ø£Ø¬Ø±Ø©: ${ride.fare} Ø¯.Ø¹<br>
        Ø±Ù‚Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚: <b><a href="tel:${driverPhoneNumber}">${driverPhoneNumber}</a></b>
      `;
      // ******************************************************
      
      // âš ï¸ Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ù‡Ùˆ Ù†ÙØ³Ù‡ØŒ ÙˆÙ‡Ùˆ Ù…Ø±Ø¨ÙˆØ· Ø¨Ø¯Ø§Ù„Ø© cancelRide() Ø¨Ø§Ù„ÙØ¹Ù„.
      endBtn.style.display = 'inline-block'; 
      
      // ** ğŸ—ºï¸ Ù…Ù†Ø·Ù‚ Ù…ØªØ§Ø¨Ø¹Ø© Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ (Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯) **
      const driverId = ride.assignedDriver; 
      if (driverId && !driverLocationRef) {
          driverLocationRef = db.ref(`driverLocations/${driverId}/location`);
          
          driverLocationRef.on('value', (locSnapshot) => {
              const location = locSnapshot.val();
              if (location && Array.isArray(location) && location.length === 2) {
                  const [lat, lng] = location;
                  
                  if (driverMarker) {
                      driverMarker.setLatLng([lat, lng]);
                  } else {
                      const driverIcon = L.icon({
                          iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png',
                          shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                          iconSize: [25, 41],
                          iconAnchor: [12, 41],
                          popupAnchor: [1, -34],
                          shadowSize: [41, 41]
                      });
                      driverMarker = L.marker([lat, lng], { icon: driverIcon }).addTo(map)
                          .bindPopup("ğŸš• Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ø­Ø§Ù„ÙŠ").openPopup();
                  }
              }
          });
      }
      // *********************************************************

      
    } else if (ride.status === "Ù…Ù†ØªÙ‡ÙŠØ©" || ride.status === "Ù…Ù„ØºØ§Ø© Ù…Ù† Ø§Ù„Ø±Ø§ÙƒØ¨" || ride.status === "Ù…Ø±ÙÙˆØ¶Ø©" || ride.status === "Ù…Ù„ØºØ§Ø© - Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª") {
        let msg = '';
        if(ride.status === "Ù…Ù†ØªÙ‡ÙŠØ©") msg = 'ğŸš— ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© â€” Ø´ÙƒØ±Ù‹Ø§ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ùƒ ØªÙƒØ³ÙŠ Ø§Ù„Ø¹Ø±Ø§Ù‚ Ø§Ù„Ø´Ø§Ù…Ù„';
        if(ride.status === "Ù…Ù„ØºØ§Ø© Ù…Ù† Ø§Ù„Ø±Ø§ÙƒØ¨") msg = 'âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© Ø¨ÙˆØ§Ø³Ø·ØªÙƒ.';
        if(ride.status === "Ù…Ø±ÙÙˆØ¶Ø©") msg = 'âŒ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø±ÙØ¶ Ø§Ù„Ø±Ø­Ù„Ø©. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¬Ø¯Ø¯Ø§Ù‹.';
        if(ride.status === "Ù…Ù„ØºØ§Ø© - Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª") msg = 'âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ ÙˆÙ‚Øª Ø§Ù„Ø¨Ø­Ø«.';
        
        document.getElementById("status").innerHTML = msg;
        if(ride.status === "Ù…Ù†ØªÙ‡ÙŠØ©") alert("ğŸš— ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!");
        
        resetRiderState(); // Ø³ØªØ¹ÙŠØ¯ ØªÙ…ÙƒÙŠÙ† Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    }
  });
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø§ÙƒØ¨
function resetRiderState() {
    endBtn.style.display = 'none';
    sendBtn.disabled = false; // ** ğŸ¯ ØªÙ…ÙƒÙŠÙ† Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© **
    
    // ** ğŸ›‘ Ø¥ÙŠÙ‚Ø§Ù Ù…ØªØ§Ø¨Ø¹Ø© Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ (Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯) **
    if(driverLocationRef) driverLocationRef.off();
    if(driverMarker) map.removeLayer(driverMarker);
    driverLocationRef = null;
    driverMarker = null;
    // -------------------
    
    // ğŸ†• Ø¥ÙŠÙ‚Ø§Ù ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨Ø­Ø«
    if (searchTimerInterval) clearInterval(searchTimerInterval);
    searchTimerInterval = null;
    // -------------------
    
    // **Ø§Ù„ØªØ¹Ø¯ÙŠÙ„:** Ø¥Ø²Ø§Ù„Ø© Ø±Ù‚Ù… Ø§Ù„Ø±Ø­Ù„Ø© Ù…Ù† LocalStorage
    localStorage.removeItem('activeRideId');

    rideId = null; 
    
    // ØªÙ†Ø¸ÙŠÙ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨Ø­Ø«
    searchInput.value = '';
    searchResultsUl.innerHTML = '';
    searchResultsUl.style.display = 'none';
}

// ============================================
// ğŸ“£ Ù‚Ø³Ù… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù†
// ============================================
// Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† db Ùˆ userPhone ØªÙ… ØªØ¹Ø±ÙŠÙÙ‡Ù…Ø§ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰
if(userPhone) {
    db.ref("notifications/" + userPhone).on("value", snap => {
        const data = snap.val();
        if (data && data.message) {
            // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
            alert("ğŸ“£ Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©:\n\n" + data.message);
            
            // Ø­Ø°Ù Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù„Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø¸Ù‡ÙˆØ±Ù‡ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
            db.ref("notifications/" + userPhone).remove();
        }
    });
}
// ============================================

</script>
</body>
</html>
