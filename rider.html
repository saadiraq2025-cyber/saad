<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ø§Ù„Ø±Ø§ÙƒØ¨ - ØªÙƒØ³ÙŠ Ø§Ù„Ø¹Ø±Ø§Ù‚</title>
<meta name="theme-color" content="#f97316">
<meta name="apple-mobile-web-app-capable" content="yes">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
    /* --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ© --- */
    body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #eee; overflow: hidden; }
    
    #map { height: 100vh; width: 100%; z-index: 1; }

    /* --- Ø¯Ø¨ÙˆØ³ Ø§Ù„Ù…Ù†ØªØµÙ --- */
    #map-center-pin {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -100%); /* Ø§Ù„Ø±Ø£Ø³ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±ÙƒØ² ØªÙ…Ø§Ù…Ø§Ù‹ */
        z-index: 1000;
        pointer-events: none;
        display: none; 
    }
    /* ØªØ£Ø«ÙŠØ± Ù†Ø¨Ø¶ Ø¨Ø³ÙŠØ· Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ø±Ùƒ */
    #map-center-pin.moving {
        transform: translate(-50%, -120%);
        transition: transform 0.2s ease-in-out;
    }

    /* --- Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© --- */
    #panel {
        position: fixed;
        bottom: 20px; /* Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„ Ù…Ø«Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ */
        left: 15px;
        right: 15px;
        z-index: 2000;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    /* --- ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Input Box) --- */
    .location-box {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        padding: 0 15px;
        height: 60px;
        display: flex;
        align-items: center;
        position: relative;
        transition: all 0.3s ease;
    }

    /* Ø§Ù„ØªØ³Ù…ÙŠØ© Ø§Ù„ØµØºÙŠØ±Ø© (Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚) */
    .location-label {
        font-size: 0.75em;
        color: #f97316; /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ */
        font-weight: bold;
        position: absolute;
        top: 8px;
        right: 15px;
    }

    /* Ù†Øµ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
    .location-value {
        font-size: 1.0em;
        font-weight: 600;
        color: #333;
        width: 100%;
        margin-top: 12px; /* Ù„Ø¥ÙØ³Ø§Ø­ Ø§Ù„Ù…Ø¬Ø§Ù„ Ù„Ù„ØªØ³Ù…ÙŠØ© */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: right;
        direction: rtl;
    }
    
    .loading-text {
        color: #999;
    }

    /* Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ù…Ø¤Ø´Ø± Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
    .indicator-dot {
        width: 8px;
        height: 8px;
        background: #f97316;
        border-radius: 50%;
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
    }
    .indicator-dot.end { background: #333; }

    /* --- Ø§Ù„Ø²Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ --- */
    #main-action-btn {
        background: #f97316;
        color: white;
        border: none;
        height: 55px;
        border-radius: 12px;
        font-size: 1.2em;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(249, 115, 22, 0.4);
        width: 100%;
        transition: transform 0.1s;
    }
    #main-action-btn:active { transform: scale(0.98); }
    #main-action-btn:disabled { background: #ccc; box-shadow: none; color: #fff; }

    /* --- ØµÙ Ø§Ù„ØªÙƒÙ„ÙØ© ÙˆØ²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©) --- */
    #final-row {
        display: none;
        gap: 10px;
    }
    .cost-display {
        background: #fff;
        border: 2px solid #3b82f6; /* Ø£Ø²Ø±Ù‚ */
        border-radius: 12px;
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: #3b82f6;
    }
    .cost-title { font-size: 0.7em; font-weight: bold; }
    .cost-amount { font-size: 1.1em; font-weight: 900; }

    #confirm-send-btn {
        flex: 2;
        background: #f97316;
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: bold;
        font-size: 1.2em;
        box-shadow: 0 4px 10px rgba(249, 115, 22, 0.3);
    }

    /* --- Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« / Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ù„ÙˆÙŠ --- */
    #top-bar {
        position: fixed;
        top: 15px;
        left: 15px;
        right: 15px;
        z-index: 1500;
        display: flex;
        gap: 10px;
    }
    #search-input {
        flex: 1;
        background: white;
        border: none;
        height: 45px;
        border-radius: 25px;
        padding: 0 40px 0 15px; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© */
        font-size: 1em;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        text-align: right;
        font-family: inherit;
    }
    .search-icon {
        position: absolute;
        right: 25px;
        top: 12px;
        color: #999;
    }
    #back-btn {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: white;
        border: none;
        font-size: 1.5em;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        cursor: pointer;
        color: #333;
    }

    /* --- Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø© --- */
    #active-ride-panel {
        display: none;
        background: #fff;
        padding: 15px;
        border-radius: 12px;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        text-align: center;
    }
    .driver-info {
        background: #e0f7fa;
        padding: 10px;
        border-radius: 8px;
        margin: 10px 0;
        border: 1px solid #006064;
    }
    .driver-phone {
        font-size: 1.4em;
        font-weight: bold;
        color: #006064;
        text-decoration: none;
        display: block;
        margin-top: 5px;
    }
    #cancel-btn {
        background: #ef5350;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        width: 100%;
        font-weight: bold;
        margin-top: 5px;
    }

    /* Ø¥Ø®ÙØ§Ø¡ Ø´Ø¹Ø§Ø± Leaflet */
    .leaflet-control-attribution { display: none; }
</style>
</head>
<body>

    <div id="top-bar">
        <button id="back-btn" onclick="goBack()">&#x2039;</button>
        <div style="flex:1; position:relative;">
            <span class="search-icon">ğŸ”</span>
            <input type="text" id="search-input" placeholder="Ø£Ø¨Ø­Ø« Ø¹Ù† Ù…ÙƒØ§Ù†" readonly onclick="alert('Ø§Ù„Ø¨Ø­Ø« ØºÙŠØ± Ù…ÙØ¹Ù„ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶')">
        </div>
    </div>

    <div id="map"></div>

    <div id="map-center-pin">
        <svg width="46" height="46" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="filter: drop-shadow(0 2px 3px rgba(0,0,0,0.3));">
            <path d="M12 0C7.58 0 4 3.58 4 8C4 13.5 12 24 12 24C12 24 20 13.5 20 8C20 3.58 16.42 0 12 0ZM12 11C10.34 11 9 9.66 9 8C9 6.34 10.34 5 12 5C13.66 5 15 6.34 15 8C15 9.66 13.66 11 12 11Z" fill="#E53935"/>
            <circle cx="12" cy="8" r="3.5" fill="white"/>
            <path d="M12 6.5L13.5 8L12 9.5L10.5 8L12 6.5Z" fill="#E53935"/> 
        </svg>
    </div>

    <div id="panel">
        
        <div class="location-box" id="location-display-box">
            <span class="location-label" id="loc-label">Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</span>
            <div class="location-value loading-text" id="loc-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù†Ø·Ù‚Ø©...</div>
            <div class="indicator-dot" id="loc-dot"></div>
        </div>

        <button id="main-action-btn" onclick="handleMainAction()">ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</button>

        <div id="final-row">
            <div class="cost-display">
                <span class="cost-title">Ø§Ù„ØªÙƒÙ„ÙØ©</span>
                <span class="cost-amount" id="fare-amount">---</span>
            </div>
            <button id="confirm-send-btn" onclick="sendRequest()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
        </div>

        <div id="active-ride-panel">
            <div id="ride-status-msg" style="font-weight:bold; margin-bottom:5px;">Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø­Ù„Ø©</div>
            <div class="driver-info" id="driver-details" style="display:none;">
                Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù‚Ø§Ø¯Ù… Ø¥Ù„ÙŠÙƒ
                <a href="#" class="driver-phone" id="driver-phone-link">---</a>
            </div>
            <button id="cancel-btn" onclick="cancelRide()">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>
        </div>

    </div>

<script>
    // --- ØªÙ‡ÙŠØ¦Ø© Firebase ---
    const firebaseConfig = {
        apiKey: "AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M",
        authDomain: "taxi-15314.firebaseapp.com",
        databaseURL: "https://taxi-15314-default-rtdb.firebaseio.com/",
        projectId: "taxi-15314"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© ---
    let map;
    let currentStage = 'pick_start'; // pick_start, pick_end, confirm, active
    let startCoords = null, endCoords = null;
    let startAddress = "", endAddress = "";
    let rideId = null;
    let rideListener = null;
    let driverMarker = null;

    // --- Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ---
    const locText = document.getElementById('loc-text');
    const locLabel = document.getElementById('loc-label');
    const locDot = document.getElementById('loc-dot');
    const mainBtn = document.getElementById('main-action-btn');
    const pin = document.getElementById('map-center-pin');
    const locationBox = document.getElementById('location-display-box');
    const finalRow = document.getElementById('final-row');
    const activePanel = document.getElementById('active-ride-panel');

    // --- ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© ---
    function initMap() {
        map = L.map('map', { zoomControl: false }).setView([33.3128, 44.3615], 15); // Ø¨ØºØ¯Ø§Ø¯ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
        L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}&key=AIzaSyD7TtwniAdUtB8-pnTny4ZwE6gqX36SGUk', {
            maxZoom: 20
        }).addTo(map);

        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø­Ø±ÙƒØ© Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        map.on('movestart', () => {
            if (currentStage === 'active') return;
            pin.classList.add('moving');
            locText.innerHTML = '<span class="loading-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù†Ø·Ù‚Ø©...</span>';
            mainBtn.disabled = true;
        });

        let moveTimer;
        map.on('moveend', () => {
            if (currentStage === 'active') return;
            pin.classList.remove('moving');
            clearTimeout(moveTimer);
            moveTimer = setTimeout(updateLocationFromCenter, 600); // ØªØ£Ø®ÙŠØ± Ù„Ø¹Ø¯Ù… Ø§Ù„ØªÙƒØ±Ø§Ø±
        });

        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                const { latitude, longitude } = pos.coords;
                map.setView([latitude, longitude], 16);
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø±Ø­Ù„Ø© Ù†Ø´Ø·Ø© Ù…Ø®Ø²Ù†Ø©
                const savedRide = localStorage.getItem('activeRideId');
                if (savedRide) restoreActiveRide(savedRide);
            }, err => console.log(err), { enableHighAccuracy: true });
        }
    }

    // --- Ø¯Ø§Ù„Ø© Reverse Geocoding Ø§Ù„Ø°ÙƒÙŠØ© (ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†) ---
    async function updateLocationFromCenter() {
        const center = map.getCenter();
        const lat = center.lat;
        const lng = center.lng;

        try {
            const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&accept-language=ar&addressdetails=1`;
            const response = await fetch(url);
            const data = await response.json();

            let formattedAddress = "Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";

            if (data && data.address) {
                const a = data.address;
                
                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ù„ØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                // Ø§Ù„ØªØ±ØªÙŠØ¨: Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© - Ø§Ù„Ø­ÙŠ/Ø§Ù„Ù…Ù†Ø·Ù‚Ø© - Ø§Ù„Ø´Ø§Ø±Ø¹/Ø§Ù„Ù…Ø¹Ù„Ù…/Ø§Ù„Ù‚Ø·Ø§Ø¹
                
                let city = a.city || a.town || a.state || ""; // Ø¨ØºØ¯Ø§Ø¯
                let district = a.suburb || a.neighbourhood || a.quarter || a.district || ""; // Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„ØµØ¯Ø±
                let detail = a.road || a.residential || a.pedestrian || ""; // Ø´Ø§Ø±Ø¹ Ø£Ùˆ Ù‚Ø·Ø§Ø¹
                let poi = a.amenity || a.shop || a.building || a.historic || ""; // Ù…Ø¹Ù„Ù… Ø¨Ø§Ø±Ø²

                // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ (Ø¥Ø²Ø§Ù„Ø© ÙƒÙ„Ù…Ø© "Ù…Ø­Ø§ÙØ¸Ø©" ÙˆØºÙŠØ±Ù‡Ø§)
                city = city.replace("Ù…Ø­Ø§ÙØ¸Ø© ", "").replace("Ù…Ø¯ÙŠÙ†Ø© ", "");

                // Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ¬Ù…ÙŠØ¹
                let parts = [];

                // 1. Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
                if (city) parts.push(city);

                // 2. Ø§Ù„Ù…Ù†Ø·Ù‚Ø©/Ø§Ù„Ø­ÙŠ
                if (district && district !== city) {
                    parts.push(district);
                }

                // 3. Ø§Ù„ØªÙØ§ØµÙŠÙ„ (Ø´Ø§Ø±Ø¹ Ø£Ùˆ Ù…Ø¹Ù„Ù… Ø£Ùˆ Ù‚Ø·Ø§Ø¹)
                // Ù†Ø­Ø§ÙˆÙ„ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… Ù‚Ø·Ø§Ø¹Ø§Øª ÙÙŠ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„
                const fullDisplayName = data.display_name || "";
                const sectorMatch = fullDisplayName.match(/Ù‚Ø·Ø§Ø¹\s*\d+/); // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙƒÙ„Ù…Ø© Ù‚Ø·Ø§Ø¹ ÙˆØ±Ù‚Ù…
                
                if (sectorMatch) {
                    parts.push(sectorMatch[0]); // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø·Ø§Ø¹ Ø¥Ø°Ø§ ÙˆØ¬Ø¯
                } else if (poi) {
                    parts.push(poi);
                } else if (detail) {
                    parts.push(detail);
                }

                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… Ø§Ù„ØªÙƒØ±Ø§Ø± ÙˆØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù†Øµ
                formattedAddress = parts.join(" - ");
            }

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            locText.innerText = formattedAddress;
            locText.style.color = "#333";
            mainBtn.disabled = false;

            // Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ…Ø© Ù…Ø¤Ù‚ØªØ§Ù‹
            if (currentStage === 'pick_start') {
                startCoords = [lat, lng];
                startAddress = formattedAddress;
            } else if (currentStage === 'pick_end') {
                endCoords = [lat, lng];
                endAddress = formattedAddress;
            }

        } catch (error) {
            console.error(error);
            locText.innerText = "ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†";
            mainBtn.disabled = false; // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„ Ø§Ù„Ø§Ø³Ù…
        }
    }

    // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ ÙˆØ§Ù„Ø®Ø·ÙˆØ§Øª ---
    function handleMainAction() {
        if (currentStage === 'pick_start') {
            // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØµÙˆÙ„
            currentStage = 'pick_end';
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨ØµØ±ÙŠØ§Ù‹
            locLabel.innerText = "Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„";
            locLabel.style.color = "#333"; // ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„ØªØ³Ù…ÙŠØ© Ù„ØªÙ…ÙŠÙŠØ²Ù‡Ø§
            locText.innerText = "Ø­Ø¯Ø¯ Ø§Ù„ÙˆØ¬Ù‡Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©...";
            locDot.classList.add('end'); // ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ù†Ù‚Ø·Ø© Ù„Ù„Ø£Ø³ÙˆØ¯
            mainBtn.innerText = "ØªØ«Ø¨ÙŠØª Ø§Ù„ÙˆØµÙˆÙ„";
            
            // ØªØ­Ø±ÙŠÙƒ Ø¨Ø³ÙŠØ· Ù„Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ´Ø¬ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            map.panBy([0, -50]); 
            
        } else if (currentStage === 'pick_end') {
            // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØªØ£ÙƒÙŠØ¯
            currentStage = 'confirm';
            showConfirmationUI();
        }
    }

    function showConfirmationUI() {
        // Ø¥Ø®ÙØ§Ø¡ Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­Ø¯ÙŠØ¯ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ù…Ù„Ø®Øµ Ø§Ù„Ø³Ø¹Ø±
        pin.style.display = 'none';
        mainBtn.style.display = 'none';
        finalRow.style.display = 'flex';
        locationBox.style.display = 'none'; // Ù†Ø®ÙÙŠ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ø¤Ù‚ØªØ§Ù‹ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø©

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠ
        const dist = calculateDistance(startCoords, endCoords);
        const price = Math.round(dist * 750); // 750 Ø¯ÙŠÙ†Ø§Ø± Ù„ÙƒÙ„ ÙƒÙ…
        const finalPrice = price < 2000 ? 2000 : price; // Ø­Ø¯ Ø£Ø¯Ù†Ù‰
        
        document.getElementById('fare-amount').innerText = `IQD ${finalPrice.toLocaleString()}`;
        
        // Ø±Ø³Ù… Ø®Ø· Ø¨ÙŠÙ† Ø§Ù„Ù†Ù‚Ø·ØªÙŠÙ† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        L.polyline([startCoords, endCoords], {color: 'blue', dashArray: '5, 10'}).addTo(map);
        map.fitBounds([startCoords, endCoords], {padding: [50, 50]});
    }

    function sendRequest() {
        const phone = localStorage.getItem('phone');
        if (!phone) { alert("Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"); window.location.href='index.html'; return; }

        rideId = Date.now().toString();
        localStorage.setItem('activeRideId', rideId);

        const requestData = {
            riderPhone: phone,
            startLat: startCoords[0], startLng: startCoords[1],
            endLat: endCoords[0], endLng: endCoords[1],
            startArea: startAddress,
            endArea: endAddress,
            fare: document.getElementById('fare-amount').innerText,
            status: "Ø¬Ø¯ÙŠØ¯Ø©",
            timestamp: firebase.database.ServerValue.TIMESTAMP
        };

        db.ref('rides/' + rideId).set(requestData);
        startMonitoringRide(rideId);
    }

    // --- Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø±Ø­Ù„Ø© ---
    function startMonitoringRide(id) {
        currentStage = 'active';
        finalRow.style.display = 'none';
        activePanel.style.display = 'block';
        document.getElementById('ride-status-msg').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚...";

        const rideRef = db.ref('rides/' + id);
        rideListener = rideRef.on('value', snapshot => {
            const val = snapshot.val();
            if (!val) {
                alert("ØªÙ… Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© Ø£Ùˆ Ø¥Ù„ØºØ§Ø¤Ù‡Ø§");
                resetApp();
                return;
            }

            // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª
            if (val.status === "Ù…Ù‚Ø¨ÙˆÙ„Ø©") {
                document.getElementById('ride-status-msg').innerHTML = `<span style="color:green">âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©</span>`;
                document.getElementById('driver-details').style.display = 'block';
                const phoneLink = document.getElementById('driver-phone-link');
                phoneLink.innerText = `ğŸ“ ${val.driverPhone}`;
                phoneLink.href = `tel:${val.driverPhone}`;
                
                // Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚
                if (val.driverPhone) monitorDriver(val.driverPhone);

            } else if (val.status === "Ø¨Ø¯Ø£Øª") {
                document.getElementById('ride-status-msg').innerText = "ğŸš€ Ø§Ù„Ø±Ø­Ù„Ø© Ø¬Ø§Ø±ÙŠØ©...";
                document.getElementById('cancel-btn').style.display = 'none'; // Ù…Ù†Ø¹ Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ø¨Ø¹Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
            } else if (val.status === "Ù…Ù†ØªÙ‡ÙŠØ©") {
                alert("ÙˆØµÙ„Øª Ø¨Ø³Ù„Ø§Ù…Ø©! Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ùƒ ØªÙƒØ³ÙŠ Ø§Ù„Ø¹Ø±Ø§Ù‚.");
                resetApp();
            } else if (val.status === "Ù…Ù„ØºØ§Ø©") {
                alert("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©.");
                resetApp();
            }
        });
    }

    function monitorDriver(driverPhone) {
        db.ref('drivers/' + driverPhone).on('value', snap => {
            const d = snap.val();
            if (d && d.lat && d.lng) {
                if (driverMarker) map.removeLayer(driverMarker);
                const carIcon = L.divIcon({ html: 'ğŸš–', className: '', iconSize: [30,30] });
                driverMarker = L.marker([d.lat, d.lng], {icon: carIcon}).addTo(map);
            }
        });
    }

    function cancelRide() {
        if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ØŸ")) {
            db.ref('rides/' + rideId).update({ status: "Ù…Ù„ØºØ§Ø©", canceledBy: "rider" });
        }
    }

    function restoreActiveRide(id) {
        rideId = id;
        pin.style.display = 'none';
        locationBox.style.display = 'none';
        mainBtn.style.display = 'none';
        startMonitoringRide(id);
    }

    // --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ---
    function goBack() {
        if (currentStage === 'pick_end') {
            // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚
            currentStage = 'pick_start';
            locLabel.innerText = "Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚";
            locLabel.style.color = "#f97316";
            locDot.classList.remove('end');
            mainBtn.innerText = "ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚";
            locText.innerText = startAddress;
            map.setView(startCoords, 16);
        } else if (currentStage === 'confirm') {
            // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØµÙˆÙ„
            currentStage = 'pick_end';
            finalRow.style.display = 'none';
            mainBtn.style.display = 'block';
            locationBox.style.display = 'flex';
            pin.style.display = 'block';
            map.setView(endCoords, 16);
        } else {
            history.back();
        }
    }

    function resetApp() {
        localStorage.removeItem('activeRideId');
        location.reload();
    }

    function calculateDistance(c1, c2) {
        const R = 6371; 
        const dLat = (c2[0]-c1[0]) * Math.PI/180;
        const dLon = (c2[1]-c1[1]) * Math.PI/180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(c1[0]*Math.PI/180) * Math.cos(c2[0]*Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    // Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    window.onload = function() {
        const phone = localStorage.getItem('phone');
        if (!phone) window.location.href = 'index.html';
        initMap();
        pin.style.display = 'block'; // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¯Ø¨ÙˆØ³
    };

</script>
</body>
</html>
