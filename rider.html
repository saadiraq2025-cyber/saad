<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>الراكب - تكسي العراق الشامل</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<style>
body,html{margin:0;padding:0;height:100%;font-family:Tahoma;}
#map{height:80vh;}
#panel{background:#fff;text-align:center;padding:10px;box-shadow:0 -2px 5px rgba(0,0,0,0.2);}
button{background:#ffca28;border:none;padding:10px 20px;border-radius:8px;font-weight:bold;cursor:pointer;}
</style>
</head>
<body>
<div id="map"></div>
<div id="panel">
  <h3>🚖 طلب رحلة جديدة</h3>
  <p id="status">يتم تحديد موقعك الحالي الآن...</p>
  <button id="sendRide" disabled>إرسال الطلب</button>
</div>

<script>
const app=firebase.initializeApp({
  apiKey:"AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M",
  authDomain:"taxi-15314.firebaseapp.com",
  databaseURL:"https://taxi-15314-default-rtdb.firebaseio.com/",
  projectId:"taxi-15314"
});
const db=firebase.database();

let map=L.map('map').setView([33.3152,44.3661],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

let startCoords=null,endCoords=null;
let startMarker=null,endMarker=null;
let rideId=null;

navigator.geolocation.getCurrentPosition(pos=>{
  startCoords=[pos.coords.latitude,pos.coords.longitude];
  startMarker=L.marker(startCoords).addTo(map).bindPopup("📍 موقعك الحالي").openPopup();
  map.setView(startCoords,15);
  document.getElementById("status").innerText="انقر على الخريطة لتحديد نقطة النهاية.";
},err=>{
  document.getElementById("status").innerText="⚠️ لم يتم تحديد الموقع الحالي، استخدم الخريطة لتحديد النهاية فقط.";
});

map.on('click',function(e){
  if(endMarker){map.removeLayer(endMarker);}
  endCoords=[e.latlng.lat,e.latlng.lng];
  endMarker=L.marker(endCoords).addTo(map).bindPopup("🏁 نقطة النهاية").openPopup();
  document.getElementById("status").innerText="تم تحديد النهاية. يمكنك الآن إرسال الطلب.";
  document.getElementById("sendRide").disabled=false;
});

document.getElementById("sendRide").onclick=function(){
  if(!startCoords || !endCoords){alert("⚠️ يرجى تحديد الموقع والنهاية.");return;}
  const phone=localStorage.getItem('phone')||"غير معروف";

  const R=6371;
  const dLat=(endCoords[0]-startCoords[0])*Math.PI/180;
  const dLon=(endCoords[1]-startCoords[1])*Math.PI/180;
  const a=Math.sin(dLat/2)*Math.sin(dLat/2)+
           Math.cos(startCoords[0]*Math.PI/180)*Math.cos(endCoords[0]*Math.PI/180)*
           Math.sin(dLon/2)*Math.sin(dLon/2);
  const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  const distance=(R*c).toFixed(2);
  const fare=Math.round(distance*1000);

  rideId=Date.now();
  firebase.database().ref("rides/"+rideId).set({
    riderPhone:phone,
    start:startCoords,
    end:endCoords,
    distance:distance,
    fare:fare,
    status:"جديدة"
  }).then(()=>{
    document.getElementById("status").innerHTML=
      `✅ تم إرسال الطلب<br>المسافة: <b>${distance}</b> كم — الأجرة: <b>${fare}</b> د.ع<br>بإنتظار السائق...`;
    listenForUpdates();
  }).catch(err=>{
    document.getElementById("status").innerText="❌ حدث خطأ أثناء الإرسال: "+err;
  });
};

// 🔹 مراقبة التحديثات
function listenForUpdates(){
  if(!rideId) return;
  firebase.database().ref("rides/"+rideId).on("value",snapshot=>{
    const ride=snapshot.val();
    if(!ride) return;

    if(ride.notification){
      alert(ride.notification);
      document.getElementById("status").innerHTML=ride.notification;
    }

    if(ride.status==="مقبولة"){
      document.getElementById("status").innerHTML=`🚕 السائق في الطريق إليك...<br>المسافة: ${ride.distance} كم<br>الأجرة: ${ride.fare} د.ع`;
    }

    if(ride.status==="منتهية"){
      document.getElementById("status").innerHTML=`🚗 تم إنهاء الرحلة — شكرًا لاستخدامك تكسي العراق الشامل`;
      alert("🚗 تم إنهاء الرحلة بنجاح!");
    }
  });
}
</script>
</body>
</html>
