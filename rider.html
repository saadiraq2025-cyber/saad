<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø±Ø§ÙƒØ¨ - ØªÙƒØ³ÙŠ Ø§Ù„Ø¹Ø±Ø§Ù‚</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
    body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; background: #f4f4f4; }
    #map { height: 100vh; width: 100%; position: relative; }
    
    /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« */
    #searchContainer { position: fixed; top: 15px; left: 15px; right: 15px; background: #fff; padding: 12px; z-index: 1100; display: flex; align-items: center; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    #search-input { flex-grow: 1; border: none; outline: none; text-align: right; font-size: 16px; margin-right: 10px; }
    
    /* Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… */
    #panel { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; z-index: 1000; border-radius: 25px 25px 0 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.15); padding: 20px; transition: all 0.3s ease; }
    
    .point-box { background: #f8f9fa; border: 1px solid #eee; border-radius: 12px; padding: 12px; margin-bottom: 10px; position: relative; }
    .point-title { font-size: 12px; color: #888; display: block; margin-bottom: 4px; }
    .point-text { font-size: 14px; color: #222; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; width: 85%; }
    .edit-btn { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #f97316; font-size: 13px; font-weight: bold; cursor: pointer; border: none; background: none; }

    #costDisplay { background: #fff3e0; color: #e65100; text-align: center; padding: 12px; border-radius: 10px; font-weight: bold; font-size: 18px; margin: 10px 0; display: none; }
    
    #mainActionBtn { width: 100%; background: #f97316; color: white; border: none; padding: 16px; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.2s; }
    #mainActionBtn:active { transform: scale(0.98); }
    #mainActionBtn:disabled { background: #ccc; }

    #map-center-pin { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -100%); z-index: 999; font-size: 40px; pointer-events: none; }
    
    #searchResults { position: fixed; top: 75px; left: 15px; right: 15px; background: #fff; z-index: 1101; max-height: 40vh; overflow-y: auto; display: none; border-radius: 0 0 12px 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .result-item { padding: 15px; border-bottom: 1px solid #eee; text-align: right; cursor: pointer; }
    
    #statusOverlay { font-size: 14px; color: #555; text-align: center; margin-bottom: 10px; display: none; }
</style>
</head>
<body>

<div id="searchContainer">
    <input type="text" id="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†Ø·Ù‚Ø©ØŒ Ø¬Ø§Ù…Ø¹ØŒ Ø£Ùˆ Ù…Ø±ÙƒØ² Ø·Ø¨ÙŠ..." />
    <span>ğŸ”</span>
</div>
<div id="searchResults"></div>

<div id="map"></div>
<div id="map-center-pin">ğŸ“</div>

<div id="panel">
    <div id="statusOverlay"></div>
    
    <div class="point-box" id="startBox">
        <span class="point-title">Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</span>
        <span id="startPointText" class="point-text">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...</span>
        <button class="edit-btn" id="editStart" style="display:none;">ØªØ¹Ø¯ÙŠÙ„</button>
    </div>

    <div class="point-box" id="endBox" style="display:none;">
        <span class="point-title">ÙˆØ¬Ù‡Ø© Ø§Ù„ÙˆØµÙˆÙ„</span>
        <span id="endPointText" class="point-text">Ø§Ø³Ø­Ø¨ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ¬Ù‡Ø©...</span>
        <button class="edit-btn" id="editEnd" style="display:none;">ØªØ¹Ø¯ÙŠÙ„</button>
    </div>

    <div id="costDisplay">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠ: <span id="fareValue">0</span> Ø¯.Ø¹</div>
    
    <button id="mainActionBtn">ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</button>
</div>

<script>
// Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
const firebaseConfig = {
    apiKey: "AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M",
    authDomain: "taxi-15314.firebaseapp.com",
    databaseURL: "https://taxi-15314-default-rtdb.firebaseio.com/",
    projectId: "taxi-15314"
};
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ù„Ø·Ù„Ø¨
let map = L.map('map', { zoomControl: false }).setView([33.3128, 44.3615], 14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let startCoords = null, endCoords = null;
let startName = "", endName = "";
let currentStage = "SET_START"; // SET_START, SET_END, READY, SEARCHING
let rideId = null;

// Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
const mainBtn = document.getElementById("mainActionBtn");
const startText = document.getElementById("startPointText");
const endText = document.getElementById("endPointText");
const endBox = document.getElementById("endBox");
const costDisp = document.getElementById("costDisplay");
const statusDiv = document.getElementById("statusOverlay");
const pin = document.getElementById("map-center-pin");

// Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ø¹ Ø§Ù„Ù…Ø¹Ø§Ù„Ù…
async function fetchAddress(lat, lon) {
    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&addressdetails=1&accept-language=ar`);
        const data = await response.json();
        const addr = data.address;
        
        let landmark = addr.amenity || addr.landmark || addr.building || addr.mosque || addr.hospital || addr.school || addr.mall || "";
        let neighbourhood = addr.neighbourhood || addr.suburb || addr.city_district || "";
        let road = addr.road || "";

        let result = neighbourhood;
        if (road) result += " - " + road;
        if (landmark) result += " (Ù‚Ø±Ø¨ " + landmark + ")";
        
        return result || data.display_name.split(',')[0];
    } catch (e) { return "Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"; }
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±Ø­Ù„Ø©
async function updateUI() {
    if (currentStage === "SET_START") {
        pin.style.display = "block";
        endBox.style.display = "none";
        costDisp.style.display = "none";
        document.getElementById("editStart").style.display = "none";
        mainBtn.innerText = "ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚";
        mainBtn.disabled = false;
    } 
    else if (currentStage === "SET_END") {
        pin.style.display = "block";
        endBox.style.display = "block";
        document.getElementById("editStart").style.display = "block";
        document.getElementById("editEnd").style.display = "none";
        mainBtn.innerText = "ØªØ«Ø¨ÙŠØª Ø§Ù„ÙˆØµÙˆÙ„";
    }
    else if (currentStage === "READY") {
        pin.style.display = "none";
        document.getElementById("editEnd").style.display = "block";
        costDisp.style.display = "block";
        mainBtn.innerText = "Ø§Ø·Ù„Ø¨ Ø§Ù„ØªØ§ÙƒØ³ÙŠ Ø§Ù„Ø¢Ù† ğŸš•";
        calculateFare();
    }
}

function calculateFare() {
    if (!startCoords || !endCoords) return;
    const dist = map.distance(startCoords, endCoords) / 1000;
    const price = Math.max(3000, Math.round((dist * 750 + 2000) / 250) * 250);
    document.getElementById("fareValue").innerText = price.toLocaleString();
    return price;
}

// Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø®Ø±ÙŠØ·Ø©
map.on('moveend', async () => {
    if (currentStage === "READY" || currentStage === "SEARCHING") return;
    
    const center = map.getCenter();
    const addr = await fetchAddress(center.lat, center.lng);
    
    if (currentStage === "SET_START") {
        startCoords = [center.lat, center.lng];
        startName = addr;
        startText.innerText = addr;
    } else {
        endCoords = [center.lat, center.lng];
        endName = addr;
        endText.innerText = addr;
    }
});

// Ø¶ØºØ·Ø© Ø§Ù„Ø²Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
mainBtn.onclick = () => {
    if (currentStage === "SET_START") {
        currentStage = "SET_END";
        updateUI();
    } else if (currentStage === "SET_END") {
        currentStage = "READY";
        updateUI();
    } else if (currentStage === "READY") {
        sendOrder();
    }
};

// Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
function sendOrder() {
    const phone = localStorage.getItem('phone');
    if (!phone) { alert("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹"); return; }

    currentStage = "SEARCHING";
    mainBtn.disabled = true;
    mainBtn.innerText = "... Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨";
    statusDiv.style.display = "block";
    statusDiv.innerText = "ÙŠØªÙ… Ø§Ù„Ø¢Ù† ØªØ¹Ù…ÙŠÙ… Ø·Ù„Ø¨Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ø§Ù„Ù‚Ø±ÙŠØ¨ÙŠÙ†";

    rideId = "R" + Date.now();
    const orderData = {
        riderPhone: phone,
        startLat: startCoords[0],
        startLng: startCoords[1],
        endLat: endCoords[0],
        endLng: endCoords[1],
        startArea: startName,
        endArea: endName,
        fare: calculateFare(),
        status: "waiting",
        timestamp: ServerValue.TIMESTAMP
    };

    db.ref('rides/' + rideId).set(orderData)
        .then(() => {
            listenToRideStatus(rideId);
        })
        .catch(err => {
            alert("ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª");
            currentStage = "READY";
            updateUI();
        });
}

function listenToRideStatus(id) {
    db.ref('rides/' + id).on('value', snapshot => {
        const data = snapshot.val();
        if (!data) return;

        if (data.status === "accepted") {
            statusDiv.innerHTML = `âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨Ùƒ!<br>Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙŠØªØ¬Ù‡ Ø¥Ù„ÙŠÙƒ Ø§Ù„Ø¢Ù†: <a href="tel:${data.driverPhone}">${data.driverPhone}</a>`;
            mainBtn.innerText = "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©";
            mainBtn.disabled = false;
            mainBtn.style.background = "#d32f2f";
            mainBtn.onclick = cancelRide;
        }
    });
}

function cancelRide() {
    if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ØŸ")) {
        db.ref('rides/' + rideId).update({ status: "cancelled_by_rider" });
        location.reload();
    }
}

// Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
document.getElementById("editStart").onclick = () => {
    currentStage = "SET_START";
    map.setView(startCoords, 16);
    updateUI();
};
document.getElementById("editEnd").onclick = () => {
    currentStage = "SET_END";
    map.setView(endCoords, 16);
    updateUI();
};

// Ø§Ù„Ø¨Ø­Ø«
const searchIn = document.getElementById("search-input");
const searchRes = document.getElementById("searchResults");

searchIn.oninput = async () => {
    const q = searchIn.value;
    if (q.length < 3) { searchRes.style.display = "none"; return; }
    
    const r = await fetch(`https://nominatim.openstreetmap.org/search?q=${q}&format=json&countrycodes=iq&limit=5&accept-language=ar`);
    const d = await r.json();
    
    searchRes.innerHTML = "";
    searchRes.style.display = "block";
    d.forEach(item => {
        const div = document.createElement("div");
        div.className = "result-item";
        div.innerText = item.display_name;
        div.onclick = () => {
            map.setView([item.lat, item.lon], 16);
            searchRes.style.display = "none";
            searchIn.value = "";
        };
        searchRes.appendChild(div);
    });
};

const ServerValue = firebase.database.ServerValue;

window.onload = () => {
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
    navigator.geolocation.getCurrentPosition(pos => {
        map.setView([pos.coords.latitude, pos.coords.longitude], 16);
    });
    updateUI();
};
</script>

</body>
</html>
