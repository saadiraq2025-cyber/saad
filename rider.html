<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø±Ø§ÙƒØ¨ - ØªÙƒØ³ÙŠ Ø§Ù„Ø¹Ø±Ø§Ù‚ Ø§Ù„Ø´Ø§Ù…Ù„</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body,html{margin:0;padding:0;height:100%;font-family:Tahoma;}
#map{height:100vh;}

#panel{
    position:fixed;
    bottom:0;left:0;right:0;
    background:#fff;
    padding:10px;
    box-shadow:0 -2px 10px rgba(0,0,0,.3);
    border-top-left-radius:15px;
    border-top-right-radius:15px;
    z-index:1000;
}

button{
    background:#f97316;
    color:#fff;
    border:none;
    padding:14px;
    border-radius:10px;
    font-size:1.1em;
    width:100%;
    margin-top:6px;
    cursor:pointer;
}

#cancelRideBtn{background:#E53935;display:none}

/* ğŸ‘‡ Ø¥Ø¶Ø§ÙØ© Ø¹Ø±Ø¶ Ø±Ù‚Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ */
#driverPhoneBox{
    display:none;
    background:#e8f5e9;
    padding:10px;
    border-radius:10px;
    margin-top:8px;
    text-align:center;
}
#driverPhoneBox a{
    display:block;
    margin-top:6px;
    background:#2e7d32;
    color:#fff;
    padding:10px;
    border-radius:8px;
    text-decoration:none;
    font-weight:bold;
}
</style>
</head>

<body>

<div id="map"></div>

<div id="panel">
    <p id="status"></p>

    <!-- ğŸ‘‡ ØµÙ†Ø¯ÙˆÙ‚ Ø±Ù‚Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ -->
    <div id="driverPhoneBox">
        <div>ğŸ“ Ø±Ù‚Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚:</div>
        <strong id="driverPhoneText"></strong>
        <a id="callDriverBtn" href="#">Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³Ø§Ø¦Ù‚</a>
    </div>

    <button id="mainActionBtn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
    <button id="cancelRideBtn">âŒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>
</div>

<script>
const app=firebase.initializeApp({
  apiKey:"AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M",
  databaseURL:"https://taxi-15314-default-rtdb.firebaseio.com/",
  projectId:"taxi-15314"
});
const db=firebase.database();

let map=L.map('map').setView([33.3,44.4],14);
L.tileLayer("https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}",{maxZoom:20}).addTo(map);

let rideId=null;
let rideRef=null;

const mainActionBtn=document.getElementById("mainActionBtn");
const cancelRideBtn=document.getElementById("cancelRideBtn");
const statusP=document.getElementById("status");

const driverPhoneBox=document.getElementById("driverPhoneBox");
const driverPhoneText=document.getElementById("driverPhoneText");
const callDriverBtn=document.getElementById("callDriverBtn");

mainActionBtn.onclick=function(){
    rideId=Date.now();
    localStorage.setItem("activeRideId",rideId);
    db.ref("rides/"+rideId).set({status:"Ø¬Ø¯ÙŠØ¯Ø©"});
    startMonitoringRide(rideId);
};

cancelRideBtn.onclick=function(){
    if(!rideId)return;
    db.ref("rides/"+rideId).update({status:"Ù…Ù„ØºØ§Ø©"});
};

function startMonitoringRide(id){
    rideRef=db.ref("rides/"+id);
    cancelRideBtn.style.display="block";

    rideRef.on("value",snap=>{
        const r=snap.val();
        if(!r)return;

        statusP.innerText="Ø§Ù„Ø­Ø§Ù„Ø©: "+r.status;

        if((r.status==="Ù…Ù‚Ø¨ÙˆÙ„Ø©" || r.status==="Ø¨Ø¯Ø£Øª") && r.driverPhone){
            driverPhoneBox.style.display="block";
            driverPhoneText.innerText=r.driverPhone;
            callDriverBtn.href="tel:"+r.driverPhone;
        }else{
            driverPhoneBox.style.display="none";
        }

        if(r.status==="Ù…Ù†ØªÙ‡ÙŠØ©" || r.status==="Ù…Ù„ØºØ§Ø©"){
            cleanup();
        }
    });
}

function cleanup(){
    if(rideRef)rideRef.off();
    rideRef=null;
    rideId=null;
    localStorage.removeItem("activeRideId");
    cancelRideBtn.style.display="none";
    driverPhoneBox.style.display="none";
    statusP.innerText="";
}

window.onload=function(){
    const saved=localStorage.getItem("activeRideId");
    if(saved){
        rideId=saved;
        startMonitoringRide(saved);
    }
};
</script>

</body>
</html>