<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¨Ù„ÙŠ - Ø§Ù„Ø±Ø§ÙƒØ¨</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        :root { --baly-orange: #FF7E00; --text-gray: #757575; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; z-index: 1; }

        /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ«Ø¨ÙŠØª ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
        .center-pin {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -100%);
            z-index: 2000; pointer-events: none;
        }
        .pin-shadow { width: 10px; height: 10px; background: rgba(0,0,0,0.2); border-radius: 50%; margin: 5px auto; }

        /* Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø³ÙÙ„ÙŠØ© */
        .bottom-ui {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: white; border-radius: 20px 20px 0 0;
            padding: 20px; z-index: 3000; box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .address-box {
            background: #f1f1f1; border-radius: 10px;
            padding: 12px; margin-bottom: 15px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .address-box span { color: var(--text-gray); font-size: 14px; flex-grow: 1; text-align: right; }
        .address-label { background: #eee; padding: 2px 8px; border-radius: 5px; font-size: 11px; margin-left: 10px; }

        .btn-confirm {
            background: var(--baly-orange); color: white; border: none;
            width: 100%; padding: 18px; border-radius: 12px;
            font-weight: bold; font-size: 20px; cursor: pointer;
        }

        .secondary-ui { display: none; margin-top: 10px; }
        .cost-badge {
            background: #e1f5fe; color: #0288d1;
            padding: 10px; border-radius: 8px; font-weight: bold;
            display: inline-block; margin-bottom: 10px; width: 100%;
        }

        /* Ø²Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ */
        .myloc-btn {
            position: absolute; bottom: 250px; right: 20px;
            background: white; width: 45px; height: 45px;
            border-radius: 50%; display: flex; align-items: center;
            justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 1000;
        }
    </style>
</head>
<body>

<div id="map"></div>

<div class="center-pin">
    <img src="https://cdn-icons-png.flaticon.com/512/684/684908.png" width="40">
    <div class="pin-shadow"></div>
</div>

<div class="myloc-btn" onclick="goToMyLoc()">ğŸŒ</div>

<div class="bottom-ui">
    <div id="step1">
        <div class="address-box">
            <span id="startText">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...</span>
            <div class="address-label">Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</div>
        </div>
        <button class="btn-confirm" onclick="confirmStart()">ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</button>
    </div>

    <div id="step2" style="display:none;">
        <div class="address-box" style="opacity:0.6; margin-bottom:5px;">
            <span id="fixedStart"></span>
            <div class="address-label">Ù…Ù†</div>
        </div>
        <div class="address-box">
            <span id="destText">Ø­Ø¯Ø¯ ÙˆØ¬Ù‡ØªÙƒ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</span>
            <div class="address-label">Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„</div>
        </div>
        <button class="btn-confirm" onclick="confirmDest()">ØªØ«Ø¨ÙŠØª Ø§Ù„ÙˆØµÙˆÙ„</button>
    </div>

    <div id="step3" style="display:none;">
        <div class="cost-badge">Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©: <span id="fareShow">0</span> Ø¯.Ø¹</div>
        <button class="btn-confirm" id="orderBtn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
        <button onclick="location.reload()" style="background:none; border:none; color:gray; margin-top:10px;">ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø±</button>
    </div>

    <div id="step4" style="display:none;">
        <h3 id="statusMsg">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙƒØ§Ø¨ØªÙ†...</h3>
        <div id="driverCard" style="background:#f9f9f9; padding:15px; border-radius:10px; display:none;">
            <p>Ø§Ù„ÙƒØ§Ø¨ØªÙ†: <b id="dPhone"></b></p>
            <button onclick="cancelRide()" style="color:red; border:none; background:none;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>
        </div>
    </div>
</div>

<script>
const firebaseConfig = { apiKey: "AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M", databaseURL: "https://taxi-15314-default-rtdb.firebaseio.com/" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let map = L.map('map', {zoomControl: false}).setView([33.3152, 44.3661], 14);
L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);

let startCoords, endCoords, currentRideId;

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø±ÙƒØ² Ø§Ù„Ø®Ø±ÙŠØ·Ø©
map.on('move', function() {
    let center = map.getCenter();
    updateAddress(center.lat, center.lng);
});

async function updateAddress(lat, lng) {
    try {
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
        const data = await res.json();
        const name = data.display_name.split(',').slice(0,2).join(', ');
        if(document.getElementById('step1').style.display !== 'none') {
            document.getElementById('startText').innerText = name;
        } else {
            document.getElementById('destText').innerText = name;
        }
    } catch(e) {}
}

function confirmStart() {
    startCoords = map.getCenter();
    document.getElementById('fixedStart').innerText = document.getElementById('startText').innerText;
    document.getElementById('step1').style.display = 'none';
    document.getElementById('step2').style.display = 'block';
}

function confirmDest() {
    endCoords = map.getCenter();
    const dist = (map.distance(startCoords, endCoords) / 1000).toFixed(1);
    const fare = Math.round(dist * 1500 + 1000);
    
    document.getElementById('fareShow').innerText = fare.toLocaleString();
    document.getElementById('step2').style.display = 'none';
    document.getElementById('step3').style.display = 'block';
}

document.getElementById('orderBtn').onclick = function() {
    currentRideId = Date.now();
    db.ref("rides/" + currentRideId).set({
        riderPhone: localStorage.getItem("phone") || "077xxxx",
        start: [startCoords.lat, startCoords.lng],
        end: [endCoords.lat, endCoords.lng],
        startName: document.getElementById('fixedStart').innerText,
        endName: document.getElementById('destText').innerText,
        fare: document.getElementById('fareShow').innerText,
        status: "Ø¬Ø¯ÙŠØ¯Ø©"
    });

    document.getElementById('step3').style.display = 'none';
    document.getElementById('step4').style.display = 'block';
    
    db.ref("rides/" + currentRideId).on('value', snap => {
        const r = snap.val();
        if(r && r.status === "Ù…Ù‚Ø¨ÙˆÙ„Ø©") {
            document.getElementById('statusMsg').innerText = "ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©!";
            document.getElementById('driverCard').style.display = 'block';
            document.getElementById('dPhone').innerText = r.driverPhone;
        } else if(r && (r.status === "Ù…Ù†ØªÙ‡ÙŠØ©" || r.status === "Ù…Ù„ØºÙŠØ©")) {
            alert("Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù†ØªÙ‡Øª Ø£Ùˆ Ø£Ù„ØºÙŠØª");
            location.reload();
        }
    });
};

function cancelRide() {
    db.ref("rides/" + currentRideId).update({status: "Ù…Ù„ØºÙŠØ©"});
    location.reload();
}

function goToMyLoc() {
    navigator.geolocation.getCurrentPosition(pos => {
        map.flyTo([pos.coords.latitude, pos.coords.longitude], 16);
    });
}

// Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
goToMyLoc();
</script>
</body>
</html>
