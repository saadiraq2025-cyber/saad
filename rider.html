<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø±Ø§ÙƒØ¨ - ØªÙƒØ³ÙŠ Ø§Ù„Ø¹Ø±Ø§Ù‚ Ø§Ù„Ø´Ø§Ù…Ù„</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#f97316"> 
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body,html{margin:0;padding:0;height:100%;font-family:Tahoma, sans-serif;}

/* Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
#map {
    height: 100vh;
    width: 100%;
    position: absolute;
    top: 0;
    left: 0;
    z-index: 1;
}

/* Ø§Ù„Ø¯Ø¨ÙˆØ³ Ø§Ù„Ø«Ø§Ø¨Øª ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ */
#map-center-pin {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -100%); /* ÙŠØ±ØªÙƒØ² Ø³Ù† Ø§Ù„Ø¯Ø¨ÙˆØ³ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±ÙƒØ² */
    z-index: 5000; /* Ø·Ø¨Ù‚Ø© Ø¹Ø§Ù„ÙŠØ© Ø¬Ø¯Ø§Ù‹ Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ±Ù‡ */
    font-size: 50px;
    pointer-events: none; /* ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ØªØ­ØªÙ‡ */
    text-shadow: 0 4px 8px rgba(0,0,0,0.3);
    display: none; /* ÙŠØªØ­ÙƒÙ… JS ÙÙŠ Ø¥Ø¸Ù‡Ø§Ø±Ù‡ */
}

/* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¨Ø­Ø« */
#searchContainer {
    position: fixed;
    top: 10px;
    left: 10px;
    right: 10px;
    background: #fff;
    padding: 5px;
    z-index: 2000;
    display: flex;
    align-items: center;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
#search-input {
    flex-grow: 1;
    padding: 10px;
    border: none;
    outline: none;
    text-align: right;
    font-size: 16px;
}
#searchResults {
    position: fixed;
    top: 60px;
    left: 10px;
    right: 10px;
    background: #fff;
    z-index: 2001;
    max-height: 40vh;
    overflow-y: auto;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    display: none;
}
.search-result-item {
    padding: 12px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    text-align: right;
}

/* Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© */
#panel-container {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 2000;
    background: #fff;
    border-radius: 20px 20px 0 0;
    box-shadow: 0 -4px 15px rgba(0,0,0,0.2);
    display: flex;
    flex-direction: column;
    padding-bottom: 20px;
    transition: transform 0.3s ease;
}

#info-content {
    padding: 15px 15px 5px;
}

.point-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f9f9f9;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 8px;
    border-right: 4px solid #ddd;
}
.point-row.active { border-right-color: #f97316; background: #fff3e0; }

.point-label { font-weight: bold; font-size: 0.9em; color: #555; margin-left: 10px;}
.point-val { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: right; font-size: 1em;}
.change-btn { background: none; color: #f97316; padding: 0 5px; font-size: 0.9em; cursor: pointer; border: 1px solid #f97316; border-radius: 4px; margin-right: 5px;}

#costDisplay {
    text-align: center;
    background: #e0f2f1;
    color: #00695c;
    padding: 10px;
    border-radius: 8px;
    margin: 5px 15px;
    font-weight: bold;
    display: none;
}

#statusArea {
    margin: 10px 15px;
    padding: 10px;
    background: #fff8e1;
    border: 1px solid #ffe082;
    border-radius: 8px;
    text-align: center;
    font-size: 0.95em;
    display: none;
}

/* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
#action-buttons {
    padding: 5px 15px;
}
.main-btn {
    width: 100%;
    padding: 14px;
    border: none;
    border-radius: 10px;
    font-size: 1.1em;
    font-weight: bold;
    color: white;
    cursor: pointer;
    margin-bottom: 10px;
    transition: background 0.3s;
}
.btn-next { background: #f97316; }
.btn-next:disabled { background: #ccc; cursor: not-allowed; }
.btn-cancel { background: #d32f2f; }
.btn-logout { background: #607d8b; font-size: 1em; padding: 10px;}

</style>
</head>
<body>

<div id="map"></div>

<div id="map-center-pin">ğŸ“</div>

<div id="searchContainer">
    <span>ğŸ”</span>
    <input type="text" id="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†Ø·Ù‚Ø©..." />
</div>
<div id="searchResults"></div>

<div id="panel-container">
    
    <div id="info-content">
        <div class="point-row" id="row-start">
            <span class="point-label">Ù…Ù†:</span>
            <span class="point-val" id="val-start">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ¯...</span>
            <button class="change-btn" id="btn-ch-start" style="display:none">ØªØºÙŠÙŠØ±</button>
        </div>

        <div class="point-row" id="row-end" style="display:none">
            <span class="point-label">Ø¥Ù„Ù‰:</span>
            <span class="point-val" id="val-end">--</span>
            <button class="change-btn" id="btn-ch-end" style="display:none">ØªØºÙŠÙŠØ±</button>
        </div>

        <div id="costDisplay">Ø§Ù„Ø£Ø¬Ø±Ø© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ©: <span id="fareVal">0</span> Ø¯.Ø¹</div>
        <div id="statusArea"></div>
    </div>

    <div id="action-buttons">
        <button id="mainBtn" class="main-btn btn-next">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©...</button>
        <button id="logoutBtn" class="main-btn btn-logout" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>
</div>

<script>
// ØªÙ‡ÙŠØ¦Ø© ÙØ§ÙŠØ±Ø¨ÙŠØ³
const app=firebase.initializeApp({apiKey:"AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M",authDomain:"taxi-15314.firebaseapp.com",databaseURL:"https://taxi-15314-default-rtdb.firebaseio.com/",projectId:"taxi-15314"});
const db=firebase.database();

// Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
let map, startCoords = null, endCoords = null, startName = "", endName = "";
let currentStage = "settingStart"; // Ø§Ù„Ù…Ø±Ø§Ø­Ù„: settingStart, settingEnd, confirmed, activeRide
let rideId = null;
let driverMarker = null;
let rideListener = null;
let driverListener = null;

// Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
const pinEl = document.getElementById('map-center-pin');
const valStart = document.getElementById('val-start');
const valEnd = document.getElementById('val-end');
const rowStart = document.getElementById('row-start');
const rowEnd = document.getElementById('row-end');
const btnChStart = document.getElementById('btn-ch-start');
const btnChEnd = document.getElementById('btn-ch-end');
const mainBtn = document.getElementById('mainBtn');
const logoutBtn = document.getElementById('logoutBtn');
const costDiv = document.getElementById('costDisplay');
const statusArea = document.getElementById('statusArea');
const searchIn = document.getElementById('search-input');
const searchRes = document.getElementById('searchResults');

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
function initMap() {
    map = L.map('map', {zoomControl: false}).setView([33.3128, 44.3615], 13); // Ø¨ØºØ¯Ø§Ø¯ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
    L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
        maxZoom: 20,
        subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
    }).addTo(map);

    // Ø¹Ù†Ø¯ ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    map.on('move', () => {
        if(currentStage === 'settingStart' || currentStage === 'settingEnd') {
            // Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø±ÙŠÙƒ ÙŠÙ…ÙƒÙ† Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Øµ "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ¯" Ù…Ø¤Ù‚ØªØ§Ù‹ Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª
        }
    });

    map.on('moveend', handleMapMoveEnd);
    
    // Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
    navigator.geolocation.getCurrentPosition(
        pos => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            map.setView([lat, lng], 16);
            if(currentStage === 'settingStart') {
                startCoords = [lat, lng];
                getAddress(lat, lng, 'start');
            }
        },
        err => { console.log("GPS Error", err); }
    );
}

// Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ ØªÙˆÙ‚Ù Ø­Ø±ÙƒØ© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
let geoTimer;
function handleMapMoveEnd() {
    if (rideId) return; // Ù„Ø§ Ù†Ø­Ø¯Ø« Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©

    const center = map.getCenter();
    const lat = center.lat;
    const lng = center.lng;

    if (currentStage === 'settingStart') {
        startCoords = [lat, lng];
        valStart.innerText = "Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†...";
        clearTimeout(geoTimer);
        geoTimer = setTimeout(() => getAddress(lat, lng, 'start'), 600);
    } 
    else if (currentStage === 'settingEnd') {
        endCoords = [lat, lng];
        valEnd.innerText = "Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†...";
        clearTimeout(geoTimer);
        geoTimer = setTimeout(() => getAddress(lat, lng, 'end'), 600);
    }
}

// Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ù† Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª
async function getAddress(lat, lng, type) {
    try {
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=ar`);
        const data = await res.json();
        const name = formatAddress(data.display_name || "Ù…ÙˆÙ‚Ø¹ Ù…Ø­Ø¯Ø¯");
        
        if (type === 'start') {
            startName = name;
            valStart.innerText = name;
            updateButtonState();
        } else {
            endName = name;
            valEnd.innerText = name;
            updateButtonState();
        }
    } catch (e) {
        const backupName = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
        if (type === 'start') { startName = backupName; valStart.innerText = backupName; }
        else { endName = backupName; valEnd.innerText = backupName; }
        updateButtonState();
    }
}

function formatAddress(addr) {
    // ØªØ¨Ø³ÙŠØ· Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
    const parts = addr.split(',');
    return parts[0] + (parts[1] ? ', ' + parts[1] : '');
}

// --- Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ø²Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ---

function updateUI() {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø±Ø­Ù„Ø© Ù†Ø´Ø·Ø© Ø£ÙˆÙ„Ø§Ù‹
    const savedRide = localStorage.getItem('activeRideId');
    if (savedRide) {
        rideId = savedRide;
        currentStage = 'activeRide';
    }

    // Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±Ø­Ù„Ø©
    if (currentStage === 'settingStart') {
        pinEl.style.display = 'block';
        pinEl.innerText = 'ğŸ“'; // Ø¯Ø¨ÙˆØ³ Ø£Ø®Ø¶Ø± Ø£Ùˆ Ø¹Ø§Ø¯ÙŠ
        pinEl.style.filter = 'hue-rotate(0deg)'; // Ù„ÙˆÙ† Ø§ÙØªØ±Ø§Ø¶ÙŠ
        
        rowStart.classList.add('active');
        rowEnd.classList.remove('active');
        rowEnd.style.display = 'none';
        
        btnChStart.style.display = 'none';
        
        mainBtn.className = 'main-btn btn-next';
        mainBtn.innerText = 'ØªØ«Ø¨ÙŠØª Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚';
        mainBtn.onclick = confirmStart;
        
        logoutBtn.style.display = 'block';
        costDiv.style.display = 'none';
        statusArea.style.display = 'none';
    } 
    else if (currentStage === 'settingEnd') {
        pinEl.style.display = 'block';
        pinEl.innerText = 'ğŸ“'; 
        pinEl.style.filter = 'hue-rotate(140deg)'; // ØªØºÙŠÙŠØ± Ø§Ù„Ù„ÙˆÙ† (Ù…Ø«Ù„Ø§Ù‹ Ù„Ù„Ø£Ø²Ø±Ù‚/Ø§Ù„Ø£Ø­Ù…Ø±) Ù„ØªÙ…ÙŠÙŠØ²Ù‡
        
        rowStart.classList.remove('active');
        rowEnd.classList.add('active');
        rowEnd.style.display = 'flex';
        
        btnChStart.style.display = 'inline-block';
        btnChEnd.style.display = 'none';
        
        mainBtn.className = 'main-btn btn-next';
        mainBtn.innerText = 'ØªØ«Ø¨ÙŠØª Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„';
        mainBtn.onclick = confirmEnd;
    }
    else if (currentStage === 'confirmed') {
        pinEl.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¯Ø¨ÙˆØ³
        
        rowStart.classList.remove('active');
        rowEnd.classList.remove('active');
        
        btnChStart.style.display = 'inline-block';
        btnChEnd.style.display = 'inline-block';
        
        mainBtn.className = 'main-btn btn-next';
        mainBtn.innerText = 'Ø·Ù„Ø¨ Ø³ÙŠØ§Ø±Ø© Ø§Ù„Ø¢Ù† ğŸš•';
        mainBtn.onclick = requestRide;
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø±
        const dist = calcDist(startCoords[0], startCoords[1], endCoords[0], endCoords[1]);
        const price = Math.max(2000, Math.round(dist * 1000));
        document.getElementById('fareVal').innerText = price.toLocaleString();
        costDiv.style.display = 'block';
    }
    else if (currentStage === 'activeRide') {
        pinEl.style.display = 'none';
        rowStart.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø­Ø©
        rowEnd.style.display = 'none';
        costDiv.style.display = 'block';
        
        statusArea.style.display = 'block';
        
        mainBtn.className = 'main-btn btn-cancel';
        mainBtn.innerText = 'Ø¥Ù„ØºØ§Ø¡ / Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© âŒ';
        mainBtn.onclick = cancelRide; // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        
        logoutBtn.style.display = 'none';
        
        if (!rideListener) monitorRide();
    }
    
    updateButtonState();
}

function updateButtonState() {
    if (currentStage === 'settingStart') {
        mainBtn.disabled = !startCoords;
    } else if (currentStage === 'settingEnd') {
        mainBtn.disabled = !endCoords;
    } else {
        mainBtn.disabled = false;
    }
}

// --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ---

function confirmStart() {
    if (!startCoords) return;
    currentStage = 'settingEnd';
    // ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù‚Ù„ÙŠÙ„Ø§Ù‹
    map.panBy([0, -50]);
    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù†Ù‡Ø§ÙŠØ©ØŒ Ù†Ø¶Ø¹Ù‡Ø§ ÙÙŠ Ù…Ø±ÙƒØ² Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯
    const c = map.getCenter();
    endCoords = [c.lat, c.lng];
    getAddress(c.lat, c.lng, 'end');
    updateUI();
}

function confirmEnd() {
    if (!endCoords) return;
    currentStage = 'confirmed';
    updateUI();
}

// Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø®Ù„Ù
btnChStart.onclick = () => {
    currentStage = 'settingStart';
    map.setView(startCoords, 16);
    updateUI();
};
btnChEnd.onclick = () => {
    currentStage = 'settingEnd';
    map.setView(endCoords, 16);
    updateUI();
};

// --- Ø·Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø© ÙˆØ¥Ù„ØºØ§Ø¤Ù‡Ø§ ---

function requestRide() {
    mainBtn.disabled = true;
    mainBtn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚...";
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚ÙŠÙ† (Ù…Ø­Ø§ÙƒØ§Ø© Ø£Ùˆ Ø­Ù‚ÙŠÙ‚ÙŠ)
    db.ref("drivers").once("value", snap => {
        let drivers = [];
        snap.forEach(d => {
            const val = d.val();
            if(val.status === 'Ù…ØªØµÙ„' && val.lat) {
                const dist = calcDist(startCoords[0], startCoords[1], val.lat, val.lng);
                if (dist < 5) drivers.push(d.key); // Ø¶Ù…Ù† 5 ÙƒÙ…
            }
        });

        if (drivers.length === 0) {
            alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø§Ø¦Ù‚ÙŠÙ† Ù…ØªØ§Ø­ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹.");
            mainBtn.disabled = false;
            mainBtn.innerText = 'Ø·Ù„Ø¨ Ø³ÙŠØ§Ø±Ø© Ø§Ù„Ø¢Ù† ğŸš•';
            return;
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©
        const newRideId = Date.now().toString();
        const dist = calcDist(startCoords[0], startCoords[1], endCoords[0], endCoords[1]);
        const price = Math.max(2000, Math.round(dist * 1000));
        
        const rideData = {
            riderPhone: localStorage.getItem('phone'),
            startLat: startCoords[0],
            startLng: startCoords[1],
            endLat: endCoords[0],
            endLng: endCoords[1],
            startArea: startName,
            endArea: endName,
            fare: price,
            status: "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©",
            targetDrivers: drivers,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        };

        db.ref("rides/" + newRideId).set(rideData).then(() => {
            localStorage.setItem('activeRideId', newRideId);
            rideId = newRideId;
            currentStage = 'activeRide';
            updateUI();
        });
    });
}

// ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¥Ù„ØºØ§Ø¡ (Ø§Ù„Ù…ØµØ­Ø­Ø©)
function cancelRide() {
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¹Ø±Ù Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ± Ø£Ùˆ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
    const activeId = rideId || localStorage.getItem('activeRideId');
    
    if (!activeId) {
        alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø­Ù„Ø© Ù†Ø´Ø·Ø© Ù„Ù„Ø¥Ù„ØºØ§Ø¡.");
        resetApp();
        return;
    }

    if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©ØŸ")) {
        mainBtn.disabled = true;
        mainBtn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù„ØºØ§Ø¡...";
        
        // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        db.ref("rides/" + activeId).update({
            status: "Ù…Ù„ØºØ§Ø©",
            canceledBy: "rider"
        }).then(() => {
            alert("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©.");
            resetApp();
        }).catch(err => {
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ù„ØºØ§Ø¡ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©: " + err.message);
            mainBtn.disabled = false;
        });
    }
}

// Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø±Ø­Ù„Ø©
function monitorRide() {
    if (!rideId) return;
    const rRef = db.ref("rides/" + rideId);
    
    rideListener = rRef.on('value', snap => {
        const r = snap.val();
        if (!r) {
            resetApp(); // Ø§Ù„Ø±Ø­Ù„Ø© Ø­Ø°ÙØª
            return;
        }

        let statusText = "";
        if (r.status === "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©") {
            statusText = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚...";
        } else if (r.status === "Ù…Ù‚Ø¨ÙˆÙ„Ø©") {
            statusText = `ğŸš– Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù‚Ø§Ø¯Ù…!<br>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: <a href="tel:${r.driverPhone}">${r.driverPhone}</a>`;
            trackDriver(r.driverPhone);
        } else if (r.status === "Ø¨Ø¯Ø£Øª") {
            statusText = "ğŸš¦ Ø§Ù„Ø±Ø­Ù„Ø© Ø¨Ø¯Ø£Øª! Ù†ØªÙ…Ù†Ù‰ Ù„Ùƒ Ø³Ù„Ø§Ù…Ø© Ø§Ù„ÙˆØµÙˆÙ„.";
        } else if (r.status === "Ù…Ù†ØªÙ‡ÙŠØ©") {
            alert("ÙˆØµÙ„Øª Ù„ÙˆØ¬Ù‡ØªÙƒ! Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ùƒ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.");
            resetApp();
            return;
        } else if (r.status === "Ù…Ù„ØºØ§Ø©" || r.status === "Ù…Ø±ÙÙˆØ¶Ø©") {
            alert(`ØªÙ… ${r.status} Ø§Ù„Ø±Ø­Ù„Ø©.`);
            resetApp();
            return;
        }
        
        statusArea.innerHTML = statusText;
    });
}

function trackDriver(driverPhone) {
    if (driverListener) db.ref("drivers/" + driverPhone).off();
    
    driverListener = db.ref("drivers/" + driverPhone).on('value', s => {
        const d = s.val();
        if (d && d.lat) {
            if (driverMarker) map.removeLayer(driverMarker);
            driverMarker = L.marker([d.lat, d.lng], {
                icon: L.divIcon({html: 'ğŸš–', className: '', iconSize: [30, 30]})
            }).addTo(map);
        }
    });
}

function resetApp() {
    if (rideId) db.ref("rides/" + rideId).off();
    if (driverListener) { /* need phone logic if strictly separated, generally ok to ignore or store ref */ }
    
    localStorage.removeItem('activeRideId');
    rideId = null;
    currentStage = 'settingStart';
    startCoords = null; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù„ÙØ±Ø¶ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    endCoords = null;
    valStart.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ¯...";
    valEnd.innerText = "--";
    statusArea.innerHTML = "";
    if (driverMarker) map.removeLayer(driverMarker);
    
    initMapLogic(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
    updateUI();
}

function initMapLogic() {
    navigator.geolocation.getCurrentPosition(p => {
        const lat = p.coords.latitude;
        const lng = p.coords.longitude;
        map.setView([lat, lng], 16);
        startCoords = [lat, lng];
        getAddress(lat, lng, 'start');
    });
}

// Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©
function calcDist(lat1, lon1, lat2, lon2) {
    const R = 6371; 
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

// Ø§Ù„Ø¨Ø­Ø«
let sTimer;
searchIn.addEventListener('input', (e) => {
    clearTimeout(sTimer);
    const q = e.target.value;
    if (q.length < 3) { searchRes.style.display = 'none'; return; }
    
    sTimer = setTimeout(async () => {
        const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${q}&format=json&countrycodes=iq&limit=5`);
        const data = await res.json();
        searchRes.innerHTML = '';
        searchRes.style.display = 'block';
        data.forEach(item => {
            const div = document.createElement('div');
            div.className = 'search-result-item';
            div.innerText = item.display_name;
            div.onclick = () => {
                const lat = parseFloat(item.lat);
                const lng = parseFloat(item.lon);
                map.setView([lat, lng], 16);
                searchRes.style.display = 'none';
                searchIn.value = '';
                
                if (currentStage === 'settingStart') {
                    startCoords = [lat, lng];
                    getAddress(lat, lng, 'start');
                } else if (currentStage === 'settingEnd') {
                    endCoords = [lat, lng];
                    getAddress(lat, lng, 'end');
                }
            };
            searchRes.appendChild(div);
        });
    }, 800);
});

function logout() {
    localStorage.clear();
    window.location.href = "index.html";
}

window.onload = () => {
    if (!localStorage.getItem('phone')) window.location.href = 'index.html';
    initMap();
    updateUI();
};
</script>
</body>
</html>
