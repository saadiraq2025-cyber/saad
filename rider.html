<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø±Ø§ÙƒØ¨ - ØªÙƒØ³ÙŠ Ø§Ù„Ø¹Ø±Ø§Ù‚ Ø§Ù„Ø´Ø§Ù…Ù„</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2e7d32">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="/icons/icon-192x192.png">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body,html{margin:0;padding:0;height:100%;font-family:Tahoma, Arial, sans-serif; background-color: #f4f4f4;}
#map{height:55vh; width: 100%;}
#panel{background:#fff;text-align:center;padding:15px;box-shadow:0 -3px 10px rgba(0,0,0,0.1); border-top-left-radius: 20px; border-top-right-radius: 20px; position: relative; z-index: 1000; margin-top: -20px;}
button{background:#ffca28;border:none;padding:12px 25px;border-radius:10px;font-weight:bold;cursor:pointer;margin:5px; transition: 0.3s;}
button:disabled{background: #ccc; cursor: not-allowed;}
button:hover:not(:disabled){background: #ffd54f;}

#panel p#status {
    font-size: 1.1em;
    font-weight: bold;
    margin: 10px 0;
    line-height: 1.5;
    color: #333;
}

#searchContainer{margin:10px 0;padding:0 5px;}
#searchInput{
    width:100%;padding:12px;border:2px solid #eee;border-radius:10px;
    font-size:16px;box-sizing:border-box;direction:rtl; outline: none;
}
#searchInput:focus{border-color: #ffca28;}

#searchResults{
    list-style:none;padding:0;margin:5px 0 0;max-height:200px;overflow-y:auto;
    border:1px solid #eee;border-radius:10px;box-shadow:0 4px 6px rgba(0,0,0,0.1);
    display:none;text-align:right;background:#fff;
}
#searchResults li{
    padding:12px;border-bottom:1px solid #f9f9f9;cursor:pointer;font-size:15px;
}
#searchResults li:hover{background:#fff9c4;}

#logoutBtn{background:#f44336;color:white;margin-top:15px;width:100%; max-width: 300px; border-radius: 8px;}

#driverInfo{
    font-size: 1.1em;
    color: #2e7d32;
    font-weight: bold;
    margin: 10px 0;
    display:none;
    padding: 10px;
    background: #e8f5e9;
    border-radius: 10px;
}
.phone-link {
    color: #1976d2;
    text-decoration: none;
    font-weight: bold;
    display: inline-block;
    margin-top: 8px;
    border: 1px solid #1976d2;
    padding: 5px 15px;
    border-radius: 20px;
}
.fare-box { font-size: 1.2em; font-weight: bold; color: #d32f2f; }
.dist-box { font-size: 1.1em; font-weight: bold; color: #455a64; }

/* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ù…Ø®ØµØµØ© */
.custom-driver-icon {
    font-size: 24px;
    text-shadow: 0 0 3px #000;
}
</style>
</head>
<body>

<div id="map"></div>

<div id="panel">
  <h3>ğŸš– Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>

  <div id="searchContainer">
      <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ÙˆØ¬Ù‡ØªÙƒ (Ù…Ø«Ù„Ø§Ù‹: Ø§Ù„Ù…Ù†ØµÙˆØ±ØŒ Ø§Ù„ÙƒØ±Ø§Ø¯Ø©...)">
      <ul id="searchResults"></ul>
  </div>

  <p id="status">ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø§Ù„Ø¢Ù†...</p>
  <div id="driverInfo"></div> 
  
  <button id="sendRide" disabled>Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
  <button id="cancelRideBtn" style="display:none;background:#d32f2f;color:white;">âŒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨</button>

  <button id="logoutBtn" onclick="window.logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</div>

<script>
// ØªÙ‡ÙŠØ¦Ø© Firebase
const firebaseConfig = {
  apiKey:"AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M",
  authDomain:"taxi-15314.firebaseapp.com",
  databaseURL:"https://taxi-15314-default-rtdb.firebaseio.com/",
  projectId:"taxi-15314"
};
const app=firebase.initializeApp(firebaseConfig);
const db=firebase.database();

// Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
let map=L.map('map').setView([33.3152,44.3661],13);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: 'Â© OpenStreetMap'
}).addTo(map);

// Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
let startCoords=null, endCoords=null;
let startMarker=null, endMarker=null, driverMarker=null, driverRoute=null;
let rideId=null, rideRef=null, driverRef=null, currentDriverPhone=null;
let startAreaName="Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ", endAreaName="Ø§Ù„ÙˆØ¬Ù‡Ø©";

const sendBtn=document.getElementById("sendRide");
const endBtn=document.getElementById("cancelRideBtn");
const searchInput=document.getElementById('searchInput');
const searchResultsUl=document.getElementById('searchResults');
const driverInfoDiv=document.getElementById('driverInfo');
const logoutBtn=document.getElementById('logoutBtn');
const statusP=document.getElementById("status");

// Ø¯Ø§Ù„Ø© Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø©
function getShortAreaName(fullArea) {
    if (!fullArea) return "Ù…Ù†Ø·Ù‚Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©";
    const parts = fullArea.split(',').map(p => p.trim());
    const filters = ["Ù‚Ø¶Ø§Ø¡", "Ù†Ø§Ø­ÙŠØ©", "Ù…Ø±ÙƒØ²", "Ø¨ØºØ¯Ø§Ø¯", "Ø§Ù„Ø¹Ø±Ø§Ù‚", "Ù…Ø­Ø§ÙØ¸Ø©"];
    const relevant = parts.filter(p => !filters.some(f => p.includes(f)));
    return relevant.length > 0 ? relevant[0] : parts[0];
}

function clearRideMarkers(){
    if(driverMarker) map.removeLayer(driverMarker);
    if(driverRoute) map.removeLayer(driverRoute);
    driverMarker = null;
    driverRoute = null;
}

// Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… OSRM
async function drawStreetRoute(lat1, lng1, lat2, lng2, color, dash = '') {
    const url = `https://router.project-osrm.org/route/v1/driving/${lng1},${lat1};${lng2},${lat2}?geometries=geojson`;
    try {
        const response = await fetch(url);
        const data = await response.json();
        if (data.code === 'Ok') {
            const coords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
            if(driverRoute) map.removeLayer(driverRoute);
            driverRoute = L.polyline(coords, {color: color, weight: 5, dashArray: dash}).addTo(map);
            map.fitBounds(driverRoute.getBounds(), {padding: [50, 50]});
        }
    } catch (e) { console.error("Route error:", e); }
}

function cleanupRide(){
    if(rideRef) rideRef.off();
    if(driverRef) driverRef.off();
    rideRef = null; driverRef = null; currentDriverPhone = null;
    localStorage.removeItem('activeRideId');
    clearRideMarkers();
    endBtn.style.display='none';
    sendBtn.style.display='inline-block';
    document.getElementById("searchContainer").style.display='block';
    driverInfoDiv.style.display='none';
    logoutBtn.style.display='inline-block';
}

function startMonitoringRide(id){
    rideId = id;
    rideRef = db.ref("rides/"+id);
    endBtn.style.display='inline-block';
    sendBtn.style.display='none';
    document.getElementById("searchContainer").style.display='none';

    rideRef.on('value', snap => {
        const r = snap.val();
        if(!r) { cleanupRide(); statusP.innerHTML="âš ï¸ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©."; return; }

        const fare = r.fare ? r.fare.toLocaleString('ar-IQ') : '---';
        const dist = r.distance || '0';
        let statusHtml = `Ø§Ù„Ù…Ø³Ø§ÙØ©: <span class="dist-box">${dist} ÙƒÙ…</span> | Ø§Ù„Ø£Ø¬Ø±Ø©: <span class="fare-box">${fare} Ø¯.Ø¹</span>`;

        if (r.status === "Ø¬Ø¯ÙŠØ¯Ø©") {
            statusP.innerHTML = `â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚...<br>${statusHtml}`;
            logoutBtn.style.display='inline-block';
        } 
        else if ((r.status === "Ù…Ù‚Ø¨ÙˆÙ„Ø©" || r.status === "Ø¨Ø¯Ø£Øª") && r.driverPhone) {
            logoutBtn.style.display='none';
            const callHtml = `<br><a href="tel:${r.driverPhone}" class="phone-link">ğŸ“ Ø§ØªØµÙ„ Ø¨Ø§Ù„Ø³Ø§Ø¦Ù‚ (${r.driverPhone})</a>`;
            const actionMsg = r.status === "Ù…Ù‚Ø¨ÙˆÙ„Ø©" ? "Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙÙŠ Ø·Ø±ÙŠÙ‚Ù‡ Ø¥Ù„ÙŠÙƒ" : "Ø£Ù†Øª Ø§Ù„Ø¢Ù† ÙÙŠ Ø§Ù„Ø±Ø­Ù„Ø©";
            statusP.innerHTML = `ğŸš– ${actionMsg}<br>${statusHtml}${callHtml}`;
            
            if (currentDriverPhone !== r.driverPhone) {
                currentDriverPhone = r.driverPhone;
                trackDriver(r.driverPhone, r.startLat, r.startLng, r.endLat, r.endLng, r.status);
            }
        } 
        else if (["Ù…Ù†ØªÙ‡ÙŠØ©", "Ù…Ù„ØºØ§Ø©", "Ù…Ø±ÙÙˆØ¶Ø©"].includes(r.status)) {
            statusP.innerHTML = `ğŸ Ø§Ù„Ø±Ø­Ù„Ø© ${r.status}.`;
            cleanupRide();
        }
    });
}

function trackDriver(phone, sLat, sLng, eLat, eLng, status) {
    if(driverRef) driverRef.off();
    driverRef = db.ref("drivers/" + phone);
    driverRef.on('value', snap => {
        const d = snap.val();
        if(!d || !d.lat) return;

        if(driverMarker) map.removeLayer(driverMarker);
        driverMarker = L.marker([d.lat, d.lng], {
            icon: L.divIcon({className: 'custom-driver-icon', html: 'ğŸš•', iconSize: [30, 30]})
        }).addTo(map).bindPopup("Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚").openPopup();

        if(status === "Ù…Ù‚Ø¨ÙˆÙ„Ø©") drawStreetRoute(d.lat, d.lng, sLat, sLng, '#4CAF50', '10, 10');
        else drawStreetRoute(d.lat, d.lng, eLat, eLng, '#1E90FF');
    });
}

// Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
navigator.geolocation.getCurrentPosition(async pos => {
    startCoords = [pos.coords.latitude, pos.coords.longitude];
    map.setView(startCoords, 15);
    if(startMarker) map.removeLayer(startMarker);
    startMarker = L.marker(startCoords).addTo(map).bindPopup("ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ").openPopup();
    
    // Reverse Geocoding Ù…Ø¨Ø³Ø·
    try {
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${startCoords[0]}&lon=${startCoords[1]}&format=json&accept-language=ar`);
        const data = await res.json();
        startAreaName = data.display_name;
        statusP.innerHTML = `ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ: <b>${getShortAreaName(startAreaName)}</b><br>Ø­Ø¯Ø¯ ÙˆØ¬Ù‡ØªÙƒ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø·Ù„Ø¨.`;
    } catch(e) { statusP.innerText = "ğŸ“ ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ. Ø­Ø¯Ø¯ Ø§Ù„ÙˆØ¬Ù‡Ø©."; }

    const activeId = localStorage.getItem('activeRideId');
    if(activeId) startMonitoringRide(activeId);
}, () => { statusP.innerText = "âš ï¸ ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ GPS."; });

// Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØ¬Ù‡Ø© Ø¨Ø§Ù„Ø®Ø±ÙŠØ·Ø©
map.on('click', async e => {
    if(rideId && !["Ù…Ù†ØªÙ‡ÙŠØ©", "Ù…Ù„ØºØ§Ø©"].includes(rideId.status)) return;
    endCoords = [e.latlng.lat, e.latlng.lng];
    if(endMarker) map.removeLayer(endMarker);
    endMarker = L.marker(endCoords).addTo(map).bindPopup("ğŸ Ø§Ù„ÙˆØ¬Ù‡Ø©").openPopup();
    
    sendBtn.disabled = false;
    try {
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${endCoords[0]}&lon=${endCoords[1]}&format=json&accept-language=ar`);
        const data = await res.json();
        endAreaName = data.display_name;
        statusP.innerHTML = `ğŸ Ø§Ù„ÙˆØ¬Ù‡Ø©: <b>${getShortAreaName(endAreaName)}</b>`;
    } catch(e) {}
});

// Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…ÙƒØ§Ù†
searchInput.addEventListener('input', () => {
    const q = searchInput.value;
    if(q.length < 3) { searchResultsUl.style.display='none'; return; }
    
    fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(q + " Ø¨ØºØ¯Ø§Ø¯")}&format=json&limit=5&accept-language=ar`)
    .then(r => r.json()).then(data => {
        searchResultsUl.innerHTML = '';
        if(data.length > 0) {
            data.forEach(item => {
                const li = document.createElement('li');
                li.innerText = getShortAreaName(item.display_name);
                li.onclick = () => {
                    endCoords = [parseFloat(item.lat), parseFloat(item.lon)];
                    endAreaName = item.display_name;
                    map.setView(endCoords, 15);
                    if(endMarker) map.removeLayer(endMarker);
                    endMarker = L.marker(endCoords).addTo(map).bindPopup(li.innerText).openPopup();
                    sendBtn.disabled = false;
                    searchResultsUl.style.display='none';
                    searchInput.value = li.innerText;
                };
                searchResultsUl.appendChild(li);
            });
            searchResultsUl.style.display='block';
        }
    });
});

// Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
sendBtn.onclick = () => {
    const phone = localStorage.getItem('phone');
    const R = 6371;
    const dLat = (endCoords[0]-startCoords[0]) * Math.PI/180;
    const dLon = (endCoords[1]-startCoords[1]) * Math.PI/180;
    const a = Math.sin(dLat/2)**2 + Math.cos(startCoords[0]*Math.PI/180)*Math.cos(endCoords[0]*Math.PI/180)*Math.sin(dLon/2)**2;
    const distance = (R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))).toFixed(1);
    const fare = Math.round(distance * 1000);

    const newRideId = Date.now();
    db.ref("rides/" + newRideId).set({
        riderPhone: phone,
        startLat: startCoords[0], startLng: startCoords[1],
        endLat: endCoords[0], endLng: endCoords[1],
        startArea: startAreaName, endArea: endAreaName,
        distance: distance, fare: fare, status: "Ø¬Ø¯ÙŠØ¯Ø©"
    });
    localStorage.setItem('activeRideId', newRideId);
    startMonitoringRide(newRideId);
};

// Ø¥Ù„ØºØ§Ø¡
endBtn.onclick = () => {
    if(rideId) {
        db.ref("rides/"+rideId).update({status: "Ù…Ù„ØºØ§Ø©", canceledBy: "rider"});
        cleanupRide();
    }
};

window.logout = () => {
    localStorage.clear();
    window.location.href="index.html";
};

// Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø©
window.onload = () => {
    if(!localStorage.getItem("phone")) window.location.href="index.html";
};
</script>

</body>
</html>
