<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¨Ù„ÙŠ - Ø§Ù„Ø±Ø§ÙƒØ¨</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        :root { --baly-yellow: #FFD200; --baly-black: #1A1A1A; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, sans-serif; background: #fff; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        .bottom-sheet {
            position: absolute; bottom: 0; left: 0; right: 0; 
            background: white; border-radius: 24px 24px 0 0;
            padding: 20px; z-index: 1000; box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
        }
        .search-box { background: #f5f5f5; border-radius: 12px; padding: 12px; margin-bottom: 10px; display: flex; align-items: center; }
        #destInput { border: none; background: transparent; width: 100%; outline: none; font-size: 16px; }
        .btn-order { background: var(--baly-yellow); color: black; border: none; width: 100%; padding: 16px; border-radius: 12px; font-weight: bold; font-size: 18px; cursor: pointer; display: none; }
        .contact-info { background: #e3f2fd; padding: 15px; border-radius: 12px; margin-top: 10px; display: none; border: 1px solid #90caf9; }
        #results { list-style: none; padding: 0; margin: 0; max-height: 150px; overflow-y: auto; }
        #results li { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="bottom-sheet">
    <div id="statusHeader" style="font-weight: bold; margin-bottom: 10px;">Ø£ÙŠÙ† ÙˆØ¬Ù‡ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ</div>
    
    <div id="searchSection">
        <div class="search-box">ğŸ” <input type="text" id="destInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø©..."></div>
        <ul id="results"></ul>
    </div>

    <div id="rideDetails" style="display:none; margin-bottom: 15px;">
        <div style="display: flex; justify-content: space-between; background: #fffde7; padding: 10px; border-radius: 8px;">
            <span>Ø§Ù„Ø£Ø¬Ø±Ø©: <b id="fare">0</b> Ø¯.Ø¹</span>
            <span>Ø§Ù„Ù…Ø³Ø§ÙØ©: <b id="dist">0</b> ÙƒÙ…</span>
        </div>
    </div>

    <div class="contact-info" id="driverContact">
        <div style="font-size: 14px; color: #555;">ÙƒØ§Ø¨ØªÙ† Ø¨Ù„ÙŠ ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚:</div>
        <div id="driverPhoneNum" style="font-size: 20px; font-weight: 900; color: #000; margin-top: 5px;"></div>
        <a id="callDriver" style="display:inline-block; margin-top:10px; color:#007bff; text-decoration:none; font-weight:bold;">ğŸ“ Ø§ØªØµÙ„ Ø¨Ø§Ù„ÙƒØ§Ø¨ØªÙ†</a>
    </div>

    <button class="btn-order" id="sendBtn">Ø§Ø·Ù„Ø¨ Ø¨Ù„ÙŠ</button>
</div>

<script>
const firebaseConfig = { apiKey: "AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M", databaseURL: "https://taxi-15314-default-rtdb.firebaseio.com/" };
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Ø®Ø±ÙŠØ·Ø© Ù†Ù‡Ø§Ø±ÙŠØ© (Day Map)
let map = L.map('map', {zoomControl: false}).setView([33.3152, 44.3661], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let startPos, endPos, rideId;
const riderPhone = localStorage.getItem("phone") || "07700000000";

navigator.geolocation.getCurrentPosition(pos => {
    startPos = [pos.coords.latitude, pos.coords.longitude];
    map.setView(startPos, 15);
    L.marker(startPos, {icon: L.divIcon({className: 'start', html: 'ğŸ“'})}).addTo(map);
});

document.getElementById('destInput').addEventListener('input', async (e) => {
    if(e.target.value.length < 3) return;
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${e.target.value}, Iraq&limit=5`);
    const data = await res.json();
    const list = document.getElementById('results');
    list.innerHTML = '';
    data.forEach(p => {
        let li = document.createElement('li');
        li.innerText = p.display_name;
        li.onclick = () => {
            endPos = [parseFloat(p.lat), parseFloat(p.lon)];
            document.getElementById('destInput').value = p.display_name;
            list.innerHTML = '';
            showPrice();
        };
        list.appendChild(li);
    });
});

function showPrice() {
    const d = (map.distance(startPos, endPos)/1000).toFixed(1);
    const f = Math.round(d * 1500);
    document.getElementById('fare').innerText = f.toLocaleString();
    document.getElementById('dist').innerText = d;
    document.getElementById('rideDetails').style.display = 'block';
    document.getElementById('sendBtn').style.display = 'block';
    L.marker(endPos).addTo(map);
}

document.getElementById('sendBtn').onclick = function() {
    rideId = Date.now();
    db.ref("rides/"+rideId).set({
        riderPhone, start: startPos, end: endPos,
        fare: document.getElementById('fare').innerText, status: "Ø¬Ø¯ÙŠØ¯Ø©"
    });
    this.style.display = 'none';
    document.getElementById('searchSection').style.display = 'none';
    document.getElementById('statusHeader').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙƒØ§Ø¨ØªÙ†...";
    
    db.ref("rides/"+rideId).on('value', snap => {
        const r = snap.val();
        if(r.status === "Ù…Ù‚Ø¨ÙˆÙ„Ø©") {
            document.getElementById('statusHeader').innerText = "ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨Ùƒ!";
            document.getElementById('driverContact').style.display = 'block';
            document.getElementById('driverPhoneNum').innerText = r.driverPhone;
            document.getElementById('callDriver').href = "tel:" + r.driverPhone;
        }
    });
};
</script>
</body>
</html>
