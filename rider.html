<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø±Ø§ÙƒØ¨ - ØªÙƒØ³ÙŠ Ø§Ù„Ø¹Ø±Ø§Ù‚ Ø§Ù„Ø´Ø§Ù…Ù„</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#f97316"> 
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body,html{margin:0;padding:0;height:100%;font-family:Tahoma;overflow:hidden;background:#f4f4f4;}
#map{height:100vh;position:relative; padding-top: 55px; padding-bottom: 220px; transition: padding-bottom 0.3s ease;} 
#panel{ 
    position:fixed; 
    bottom:0; 
    left:0; 
    right:0; 
    background:#fff; 
    text-align:center; 
    padding:10px 0 0; 
    box-shadow:0 -2px 15px rgba(0,0,0,0.2); 
    border-radius: 20px 20px 0 0; 
    z-index: 1000; 
    transition: bottom 0.3s ease;
}
#fixedActions {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 10px 0;
    background: #fff;
    z-index: 1005; 
    display: flex;
    flex-direction: column;
    align-items: center;
}
button{ background:#f97316; color:white; border:none; padding:15px; border-radius:12px; font-weight:bold; cursor:pointer; width:90%; font-size: 1.1em; margin-bottom: 5px;}
#status { font-size: 1em; margin: 10px; color: #333; padding: 8px; background: #fff3e0; border-radius: 8px; border: 1px solid #ffe0b2; }
#costDisplay { background: #e8f5e9; color: #2e7d32; font-size: 1.2em; font-weight: bold; padding: 10px; margin: 10px; border-radius: 10px; display: none; }
#map-center-pin { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -100%); z-index: 999; font-size: 45px; pointer-events: none; text-shadow: 0 2px 5px rgba(0,0,0,0.3); }
#pointContainer { display: flex; flex-direction: column; padding: 0 15px; gap: 8px; }
.point-field { display: flex; flex-direction: column; align-items: flex-start; background: #f9f9f9; padding: 12px; border-radius: 12px; border: 1px solid #eee; position: relative;}
.point-label { font-size: 0.8em; color: #777; margin-bottom: 4px; }
.point-value { font-size: 0.95em; color: #222; font-weight: bold; text-align: right; width: 100%; display: block; overflow: hidden; text-overflow: ellipsis; }
.point-action { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); background: #fff; color: #f97316; width: auto; padding: 5px 10px; border: 1px solid #f97316; font-size: 0.8em; }
#searchContainer { position: fixed; top: 10px; left: 10px; right: 10px; background: #fff; padding: 5px 15px; z-index: 1001; display: flex; align-items: center; border-radius: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
#search-input { flex-grow: 1; padding: 10px; border: none; outline: none; text-align: right; font-size: 1em; }
#searchResults { position: fixed; top: 65px; left: 15px; right: 15px; background: #fff; z-index: 1002; max-height: 40vh; overflow-y: auto; display: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
.search-result-item { padding: 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; text-align: right; font-size: 0.9em; }
#logoutBtn{ background:#f5f5f5; color:#666; font-size: 0.9em; margin-top: 5px; border: 1px solid #ddd;}
</style>
</head>
<body>

<div id="map"></div>
<div id="map-center-pin">ğŸ“</div>

<div id="searchContainer">
    <span>ğŸ”</span>
    <input type="text" id="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†Ø·Ù‚Ø©ØŒ Ø´Ø§Ø±Ø¹ØŒ Ø£Ùˆ Ù…Ø¹Ù„Ù…..." />
</div>
<div id="searchResults"></div>

<div id="panel">
    <div id="pointContainer">
        <div class="point-field" id="startPointField">
            <span class="point-label">Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚:</span>
            <span id="startPointValue" class="point-value">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...</span>
            <button id="changeStartPointBtn" class="point-action" style="display:none;">ØªØºÙŠÙŠØ±</button>
        </div>
        <div class="point-field" id="endPointField" style="display:none;">
            <span class="point-label">ÙˆØ¬Ù‡Ø© Ø§Ù„ÙˆØµÙˆÙ„:</span>
            <span id="endPointValue" class="point-value">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ¬Ù‡Ø©...</span>
            <button id="changeEndPointBtn" class="point-action" style="display:none;">ØªØºÙŠÙŠØ±</button>
        </div>
    </div>
    <div id="costDisplay">Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠØ©: <strong><span id="fareValue">---</span> Ø¯.Ø¹</strong></div>
    <p id="status" style="display:none;"></p> 
</div>

<div id="fixedActions">
    <button id="mainActionBtn">ØªØ«Ø¨ÙŠØª Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</button> 
    <button id="logoutBtn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</div>

<script>
const app=firebase.initializeApp({apiKey:"AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M",authDomain:"taxi-15314.firebaseapp.com",databaseURL:"https://taxi-15314-default-rtdb.firebaseio.com/",projectId:"taxi-15314"});
const db=firebase.database();

let map=L.map('map', {zoomControl: false}).setView([33.3152, 44.3661], 14); 
L.tileLayer("https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}",{maxZoom:20}).addTo(map);

let startCoords=null, endCoords=null, startAreaName="", endAreaName="";
let currentStage="settingStart", rideId=null, driverMarker=null, rideRef=null, driverRef=null;

const pin=document.getElementById("map-center-pin");
const startVal=document.getElementById("startPointValue"), endVal=document.getElementById("endPointValue");
const mainBtn=document.getElementById("mainActionBtn"), logoutBtn=document.getElementById("logoutBtn");
const statusP=document.getElementById("status"), costDiv=document.getElementById("costDisplay"), fareVal=document.getElementById("fareValue");
const startF=document.getElementById("startPointField"), endF=document.getElementById("endPointField"), chStart=document.getElementById("changeStartPointBtn"), chEnd=document.getElementById("changeEndPointBtn");
const searchIn=document.getElementById("search-input"), searchRes=document.getElementById("searchResults");
const panel = document.getElementById("panel");

// Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ø¹ Ø§Ù„Ù…Ø¹Ø§Ù„Ù… Ø§Ù„Ù‚Ø±ÙŠØ¨Ø©
async function revGeo(lat, lon) {
    try {
        const r = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&addressdetails=1&accept-language=ar`);
        const d = await r.json();
        const addr = d.address;
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù‚Ø±ÙŠØ¨ (Ø¬Ø§Ù…Ø¹ØŒ Ù…Ø³ØªØ´ÙÙ‰ØŒ Ø³ÙˆÙ‚ØŒ Ø¥Ù„Ø®)
        let landmark = addr.amenity || addr.landmark || addr.building || addr.historic || addr.tourism || addr.shop || "";
        let neighborhood = addr.neighbourhood || addr.suburb || addr.quarter || "";
        let road = addr.road || "";
        
        let fullDesc = "";
        if(neighborhood) fullDesc += neighborhood;
        if(road) fullDesc += (fullDesc ? " - " : "") + road;
        if(landmark) fullDesc += " (Ù‚Ø±Ø¨ " + landmark + ")";
        
        return fullDesc || d.display_name.split(',').slice(0,2).join(',') || "Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…Ø³Ù…Ù‰";
    } catch {
        return "ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†";
    }
}

function calcDist(l1,n1,l2,n2){
    const R=6371, dLat=(l2-l1)*Math.PI/180, dLon=(n2-n1)*Math.PI/180;
    const a=Math.sin(dLat/2)**2+Math.cos(l1*Math.PI/180)*Math.cos(l2*Math.PI/180)*Math.sin(dLon/2)**2;
    return (R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
}

function updatePanelHeight() {
    const totalPanelHeight = panel.offsetHeight + 10;
    document.getElementById("map").style.paddingBottom = `${totalPanelHeight}px`;
    map.invalidateSize();
}

function preRideMainAction() {
    if(currentStage==="settingStart" && startCoords){ currentStage="settingEnd"; updateUI(); }
    else if(currentStage==="settingEnd" && endCoords){ currentStage="confirmed"; updateUI(); }
    else if(currentStage==="confirmed"){ findDriver(); }
}

async function updateUI(){
    pin.style.display='block'; 
    mainBtn.style.display='block'; 
    mainBtn.disabled = false;
    mainBtn.style.backgroundColor = '#f97316';
    costDiv.style.display='none';
    chStart.style.display='none'; 
    chEnd.style.display='none'; 
    statusP.style.display='none';
    startF.style.display='flex';
    endF.style.display='flex';
    logoutBtn.style.display='block';

    if(rideId){ 
        pin.style.display='none';
        startF.style.display='none';
        endF.style.display='none';
        mainBtn.innerText="Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ âŒ"; 
        mainBtn.style.backgroundColor = '#E53935'; 
        mainBtn.onclick = activeRideMainAction; 
        logoutBtn.style.display='none'; 
        statusP.style.display='block';
        setTimeout(updatePanelHeight, 50); 
        return; 
    }

    mainBtn.onclick = preRideMainAction;

    if(currentStage==="settingStart"){
        mainBtn.innerText="ØªØ«Ø¨ÙŠØª Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚"; 
        startVal.innerText=startAreaName || 'Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†...'; 
        endF.style.display='none';
    } else if(currentStage==="settingEnd"){
        mainBtn.innerText="ØªØ«Ø¨ÙŠØª ÙˆØ¬Ù‡Ø© Ø§Ù„ÙˆØµÙˆÙ„"; 
        startVal.innerText=startAreaName; 
        endVal.innerText=endAreaName || 'Ø§Ø³Ø­Ø¨ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ¬Ù‡Ø©...'; 
        chStart.style.display='inline-block';
    } else if(currentStage==="confirmed"){
        mainBtn.innerText="Ø§Ø·Ù„Ø¨ Ø§Ù„ØªØ§ÙƒØ³ÙŠ Ø§Ù„Ø¢Ù† ğŸš•"; 
        pin.style.display='none';
        chStart.style.display='inline-block'; 
        chEnd.style.display='inline-block';
        const dist=calcDist(startCoords[0],startCoords[1],endCoords[0],endCoords[1]);
        fareVal.innerText=Math.max(3000, Math.round(dist*1000/250)*250).toLocaleString();
        costDiv.style.display='block';
    }
    setTimeout(updatePanelHeight, 50); 
}

chStart.onclick=()=>{currentStage="settingStart"; map.setView(startCoords,16); updateUI();};
chEnd.onclick=()=>{currentStage="settingEnd"; map.setView(endCoords || startCoords,16); updateUI();};

let geoTimer;
map.on('move', () => {
   if(rideId || currentStage === "confirmed") return;
   if(currentStage==="settingStart") startVal.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ¯...";
   else endVal.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ¯...";
});

map.on('moveend',async()=>{
    if(rideId || currentStage === "confirmed") return;
    const c=map.getCenter();
    if(currentStage==="settingStart") startCoords=[c.lat,c.lng];
    else if(currentStage==="settingEnd") endCoords=[c.lat,c.lng];
    
    clearTimeout(geoTimer);
    geoTimer=setTimeout(async()=>{
        const n=await revGeo(c.lat,c.lng);
        if(currentStage==="settingStart") startAreaName=n; else endAreaName=n;
        updateUI();
    },600);
});

async function activeRideMainAction(){
    if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©ØŸ")){
        if(rideRef) await rideRef.update({status: "Ù…Ù„ØºØ§Ø©"});
        cleanup();
    }
}

function findDriver(){
    mainBtn.disabled=true; mainBtn.innerText="Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨...";
    const dist=calcDist(startCoords[0],startCoords[1],endCoords[0],endCoords[1]);
    rideId=Date.now();
    
    db.ref("rides/"+rideId).set({
        riderPhone: localStorage.getItem('phone'),
        startLat:startCoords[0], startLng:startCoords[1], endLat:endCoords[0], endLng:endCoords[1],
        startArea:startAreaName, endArea:endAreaName, 
        fare:Math.max(3000, Math.round(dist*1000/250)*250),
        status:"Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©", time: rideId
    }).then(() => {
        localStorage.setItem('activeRideId',rideId);
        monitorRide(rideId);
    });
}

function monitorRide(id){
    rideRef=db.ref("rides/"+id);
    rideRef.on('value',s=>{
        const r=s.val();
        if(!r || ["Ù…Ù„ØºØ§Ø©","Ù…Ù†ØªÙ‡ÙŠØ©"].includes(r.status)){ cleanup(); return; }
        rideId = id;
        updateUI();
        if(r.status==="Ù…Ù‚Ø¨ÙˆÙ„Ø©"){
            statusP.innerHTML=`âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨! Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù‚Ø§Ø¯Ù… Ø¥Ù„ÙŠÙƒ.<br>Ø§ØªØµØ§Ù„: <a href="tel:${r.driverPhone}">${r.driverPhone}</a>`;
            if(r.driverPhone) trackDriver(r.driverPhone);
        } else if(r.status==="Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©"){
            statusP.innerText="ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ù‚Ø±Ø¨ Ø³Ø§Ø¦Ù‚...";
        }
    });
}

function trackDriver(ph){
    if(driverRef) driverRef.off();
    driverRef=db.ref("drivers/"+ph);
    driverRef.on('value',s=>{
        const d=s.val();
        if(d && d.lat){
            if(driverMarker) map.removeLayer(driverMarker);
            driverMarker=L.marker([d.lat,d.lng],{icon:L.divIcon({html:'ğŸš•',className:'custom-icon',iconSize:[30,30]})}).addTo(map);
        }
    });
}

function cleanup(){ 
    if(rideRef) rideRef.off(); if(driverRef) driverRef.off();
    if(driverMarker) map.removeLayer(driverMarker);
    rideId=null; localStorage.removeItem('activeRideId');
    currentStage = "settingStart";
    updateUI(); 
}

searchIn.addEventListener('input',()=>{
    const q=searchIn.value;
    if(q.length<3) { searchRes.style.display='none'; return; }
    clearTimeout(geoTimer);
    geoTimer=setTimeout(async()=>{
        const r=await fetch(`https://nominatim.openstreetmap.org/search?q=${q}&format=json&limit=5&countrycodes=iq&accept-language=ar`);
        const d=await r.json();
        searchRes.innerHTML=''; searchRes.style.display='block';
        d.forEach(i=>{
            const div=document.createElement('div'); div.className='search-result-item'; div.innerText=i.display_name;
            div.onclick=()=>{
                map.setView([i.lat,i.lon],16); searchRes.style.display='none';
                searchIn.value = "";
            };
            searchRes.appendChild(div);
        });
    },700);
});

window.onload=()=>{
    if(!localStorage.getItem('phone')) window.location.href="index.html";
    navigator.geolocation.getCurrentPosition(p=>{
        const myPos = [p.coords.latitude, p.coords.longitude];
        map.setView(myPos, 16);
    });
    const saved = localStorage.getItem('activeRideId');
    if(saved) monitorRide(saved);
    updateUI();
};
function logout(){ localStorage.clear(); window.location.href="index.html"; }
</script>
</body>
</html>
