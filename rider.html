<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø±Ø§ÙƒØ¨ - ØªÙƒØ³ÙŠ Ø§Ù„Ø¹Ø±Ø§Ù‚ Ø§Ù„Ø´Ø§Ù…Ù„</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#f97316"> 
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body,html{margin:0;padding:0;height:100%;font-family:Tahoma;overflow:hidden;}
#map{height:100vh;position:relative; padding-top: 55px; padding-bottom: 220px; transition: padding-bottom 0.3s ease;} 
#panel{ 
    position:fixed; 
    bottom:0; 
    left:0; 
    right:0; 
    background:#fff; 
    text-align:center; 
    padding:10px 0 0; 
    box-shadow:0 -2px 10px rgba(0,0,0,0.3); 
    border-radius: 15px 15px 0 0; 
    z-index: 1000; 
    transition: bottom 0.3s ease;
}
#fixedActions {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 5px 0 10px;
    background: #fff;
    z-index: 1005; 
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
}
button{ background:#f97316; color:white; border:none; padding:15px 10px; border-radius:10px; font-weight:bold; cursor:pointer; margin:5px 10px; width:calc(100% - 20px); font-size: 1.1em; }
#panel p#status { font-size: 1.0em; margin: 10px; line-height: 1.4; color: #333; padding: 5px; background: #f0f0f0; border-radius: 8px; }
#costDisplay { background: #e0f2f1; color: #004d40; font-size: 1.2em; font-weight: bold; padding: 10px; margin: 10px; border-radius: 8px; display: none; }
#map-center-pin { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -100%); z-index: 999; font-size: 40px; pointer-events: none; display: block; }
#pointContainer { display: flex; flex-direction: column; padding: 0 10px; gap: 10px; text-align: right; }
.point-field { display: flex; justify-content: space-between; align-items: center; background: #f5f5f5; padding: 10px; border-radius: 10px; }
.point-value { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex-grow: 1; text-align: right; margin-right: 5px; }
.point-action { background: none; color: #f97316; width: auto; padding: 0 5px; margin: 0; font-size: 1em; }
#searchContainer { position: fixed; top: 0; left: 0; right: 0; background: #fff; padding: 8px 10px; z-index: 1001; display: flex; align-items: center; border-bottom: 1px solid #ddd; }
#search-input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 8px; margin: 0 10px; text-align: right; }
#searchResults { position: fixed; top: 55px; left: 10px; right: 10px; background: #fff; z-index: 1002; max-height: 50vh; overflow-y: auto; display: none; border: 1px solid #ddd; }
.search-result-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; text-align: right; }
#logoutBtn{ display:block; background:#607d8b; padding:10px 20px; width:calc(100% - 20px); margin: 5px 10px; font-size: 1em; }

.searching-status { display: flex; align-items: center; justify-content: flex-end; padding: 10px; }
.timer-container { width: 36px; height: 36px; position: relative; border-radius: 50%; margin-right: 10px; flex-shrink: 0; }
#countdownProgress { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; }
#countdownText { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.9em; font-weight: bold; color: #f97316; z-index: 10; }
</style>
</head>
<body>

<div id="map"></div>
<div id="map-center-pin" id="pin">ğŸ“</div>

<div id="searchContainer">
    <span>ğŸ”</span>
    <input type="text" id="search-input" placeholder="Ø£Ø¨Ø­Ø« Ø¹Ù† Ù…ÙƒØ§Ù†" />
</div>
<div id="searchResults"></div>

<div id="panel">
    <div id="pointContainer">
        <div class="point-field" id="startPointField">
            <span>Ù…Ù†:</span>
            <span id="startPointValue" class="point-value">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</span>
            <button id="changeStartPointBtn" class="point-action" style="display:none;">ØªØºÙŠÙŠØ±</button>
        </div>
        <div class="point-field" id="endPointField" style="display:none;">
            <span>Ø¥Ù„Ù‰:</span>
            <span id="endPointValue" class="point-value">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</span>
            <button id="changeEndPointBtn" class="point-action" style="display:none;">ØªØºÙŠÙŠØ±</button>
        </div>
    </div>
    <div id="costDisplay">Ø§Ù„ØªÙƒÙ„ÙØ©: <strong><span id="fareValue">---</span> Ø¯.Ø¹</strong></div>
    <p id="status" style="display:none;"></p> 
</div>

<div id="fixedActions">
    <button id="mainActionBtn">ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</button> 
    <button id="logoutBtn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</div>

<script>
const app=firebase.initializeApp({apiKey:"AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M",authDomain:"taxi-15314.firebaseapp.com",databaseURL:"https://taxi-15314-default-rtdb.firebaseio.com/",projectId:"taxi-15314"});
const db=firebase.database();

let map=L.map('map').setView([33.3603, 44.5066],14); 
L.tileLayer("https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}&key=AIzaSyD7TtwniAdUtB8-pnTny4ZwE6gqX36SGUk",{maxZoom:20}).addTo(map);

let startCoords=null, endCoords=null, startAreaName="", endAreaName="";
let currentStage="settingStart", rideId=null, driverMarker=null, rideRef=null, driverRef=null;
let countdownInterval = null; 

const pin=document.getElementById("map-center-pin");
const startVal=document.getElementById("startPointValue"), endVal=document.getElementById("endPointValue");
const mainBtn=document.getElementById("mainActionBtn"), logoutBtn=document.getElementById("logoutBtn");
const statusP=document.getElementById("status"), costDiv=document.getElementById("costDisplay"), fareVal=document.getElementById("fareValue");
const startF=document.getElementById("startPointField"), endF=document.getElementById("endPointField"), chStart=document.getElementById("changeStartPointBtn"), chEnd=document.getElementById("changeEndPointBtn");
const searchIn=document.getElementById("search-input"), searchRes=document.getElementById("searchResults");
const fixedActions = document.getElementById("fixedActions");
const panel = document.getElementById("panel");

function getShortName(a){if(!a)return"ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";if(a.length<50&&!a.includes(','))return a; const p=a.split(',').map(x=>x.trim()).filter(x=>!['Ù‚Ø¶Ø§Ø¡','Ù†Ø§Ø­ÙŠØ©','Ù…Ø±ÙƒØ²','Ø¨ØºØ¯Ø§Ø¯'].some(k=>x.includes(k))); return p.length?p[0]:a.split(',').pop();}
async function revGeo(lat,lon){try{const r=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=ar`);const d=await r.json();return d.display_name||`${lat},${lon}`;}catch{return`${lat},${lon}`;}}
function calcDist(l1,n1,l2,n2){const R=6371, dLat=(l2-l1)*Math.PI/180, dLon=(n2-n1)*Math.PI/180; const a=Math.sin(dLat/2)**2+Math.cos(l1*Math.PI/180)*Math.cos(l2*Math.PI/180)*Math.sin(dLon/2)**2; return parseFloat((R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))).toFixed(2));}

function updatePanelHeight() {
    const totalFixedBottomHeight = fixedActions.offsetHeight;
    panel.style.bottom = totalFixedBottomHeight + 'px';
    const totalPanelHeight = panel.offsetHeight + totalFixedBottomHeight + 10;
    document.getElementById("map").style.paddingBottom = `${totalPanelHeight}px`;
    map.invalidateSize();
}

async function activeRideMainAction(){
    if(!rideId) return;
    if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©ØŸ")) {
        const tempId = rideId;
        if(rideRef) rideRef.off();
        if(driverRef) driverRef.off();
        try {
            await db.ref("rides/" + tempId).update({status: "Ù…Ù„ØºØ§Ø©", canceledBy: "rider"});
        } catch(e) {}
        cleanup(); 
        initGeo(); 
    }
}

function preRideMainAction() {
    if(currentStage==="settingStart"){ if(startCoords) { currentStage="settingEnd"; updateUI(); } }
    else if(currentStage==="settingEnd"){ if(endCoords) { currentStage="confirmed"; updateUI(); } }
    else if(currentStage==="confirmed"){ findDriver(); }
}

async function updateUI(){
    // Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    pin.style.display='block'; 
    mainBtn.style.display='block'; 
    mainBtn.disabled = false;
    mainBtn.style.backgroundColor = '#f97316';
    costDiv.style.display='none';
    chStart.style.display='none'; 
    chEnd.style.display='none'; 
    statusP.style.display='none';
    startF.style.display='flex';
    endF.style.display='flex';
    logoutBtn.style.display='block';

    if(rideId){ 
        pin.style.display='none';
        startF.style.display='none';
        endF.style.display='none';
        mainBtn.innerText="Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ âŒ"; 
        mainBtn.style.backgroundColor = '#E53935'; 
        mainBtn.onclick = activeRideMainAction; 
        logoutBtn.style.display='none'; 
        statusP.style.display='block';
        setTimeout(updatePanelHeight, 50); 
        return; 
    }

    mainBtn.onclick = preRideMainAction;

    if(currentStage==="settingStart"){
        mainBtn.innerText="ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚"; 
        startVal.innerText=startAreaName?getShortName(startAreaName):'ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...'; 
        endF.style.display='none';
    } else if(currentStage==="settingEnd"){
        mainBtn.innerText="ØªØ«Ø¨ÙŠØª Ø§Ù„ÙˆØµÙˆÙ„"; 
        startVal.innerText=getShortName(startAreaName); 
        endVal.innerText=endAreaName?getShortName(endAreaName):'ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ¬Ù‡Ø©...'; 
        chStart.style.display='inline-block';
    } else if(currentStage==="confirmed"){
        mainBtn.innerText="Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚ ğŸš•"; 
        pin.style.display='none';
        chStart.style.display='inline-block'; 
        chEnd.style.display='inline-block';
        if(startCoords && endCoords){
            const dist=calcDist(startCoords[0],startCoords[1],endCoords[0],endCoords[1]);
            fareVal.innerText=Math.max(2000,Math.round(dist*1000)).toLocaleString();
            costDiv.style.display='block';
        }
    }
    setTimeout(updatePanelHeight, 50); 
}

chStart.onclick=()=>{currentStage="settingStart"; map.setView(startCoords,15); updateUI();};
chEnd.onclick=()=>{currentStage="settingEnd"; map.setView(endCoords,15); updateUI();};

let geoTimer;
map.on('moveend',async()=>{
    if(rideId || currentStage === "confirmed") return;
    const c=map.getCenter();
    if(currentStage==="settingStart") startCoords=[c.lat,c.lng];
    else if(currentStage==="settingEnd") endCoords=[c.lat,c.lng];
    
    clearTimeout(geoTimer);
    geoTimer=setTimeout(async()=>{
        const n=await revGeo(c.lat,c.lng);
        if(currentStage==="settingStart") startAreaName=n; else endAreaName=n;
        updateUI();
    },500);
});

function findDriver(){
    if(!startCoords||!endCoords)return;
    mainBtn.disabled=true; mainBtn.innerText="Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...";
    statusP.style.display='block'; statusP.innerText="Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø§Ø¦Ù‚ Ù‚Ø±ÙŠØ¨..."; 
    
    let driversFound = []; 
    db.ref("drivers").once("value",s=>{
        s.forEach(ds=>{
            const d=ds.val();
            if(d.status==="Ù…ØªØµÙ„"&&d.lat){
                if(calcDist(startCoords[0],startCoords[1],d.lat,d.lng) <= 5.0) driversFound.push(ds.key);
            }
        });
        if(driversFound.length > 0) sendReq(driversFound);
        else{ 
            alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø§Ø¦Ù‚ÙˆÙ† Ù…ØªØ§Ø­ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹.");
            updateUI();
        }
    });
}

function sendReq(driversList){
    rideId=Date.now(); 
    localStorage.setItem('activeRideId',rideId);
    const dist=calcDist(startCoords[0],startCoords[1],endCoords[0],endCoords[1]);
    
    db.ref("rides/"+rideId).set({
        riderPhone: localStorage.getItem('phone'),
        targetDrivers: driversList,
        startLat:startCoords[0], startLng:startCoords[1], endLat:endCoords[0], endLng:endCoords[1],
        startArea:startAreaName, endArea:endAreaName, fare:Math.max(2000,Math.round(dist*1000)),
        status:"Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©", time: rideId
    });
    monitorRide(rideId);
}

function monitorRide(id){
    rideRef=db.ref("rides/"+id);
    rideRef.on('value',s=>{
        const r=s.val();
        if(!r || ["Ù…Ù„ØºØ§Ø©","Ù…Ù†ØªÙ‡ÙŠØ©","Ù…Ø±ÙÙˆØ¶Ø©"].includes(r.status)){
            if(r && r.status !== "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©") alert("Ø§Ù„Ø±Ø­Ù„Ø©: " + r.status);
            cleanup(); return;
        }
        rideId = id;
        updateUI();
        if(r.status==="Ù…Ù‚Ø¨ÙˆÙ„Ø©"){
            statusP.innerHTML=`ğŸš• Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù‚Ø§Ø¯Ù…: <a href="tel:${r.driverPhone}">${r.driverPhone}</a>`;
            trackDriver(r.driverPhone);
        } else if(r.status==="Ø¨Ø¯Ø£Øª"){
            statusP.innerText="ğŸš¦ Ø§Ù„Ø±Ø­Ù„Ø© Ø¨Ø¯Ø£Øª Ø§Ù„Ø¢Ù†";
        }
    });
}

function trackDriver(ph){
    if(driverRef) driverRef.off();
    driverRef=db.ref("drivers/"+ph);
    driverRef.on('value',s=>{
        const d=s.val();
        if(d && d.lat){
            if(driverMarker) map.removeLayer(driverMarker);
            driverMarker=L.marker([d.lat,d.lng],{icon:L.divIcon({html:'ğŸš•',className:'custom-icon',iconSize:[30,30]})}).addTo(map);
        }
    });
}

function cleanup(){ 
    if(rideRef) rideRef.off(); if(driverRef) driverRef.off();
    if(driverMarker) map.removeLayer(driverMarker);
    clearInterval(countdownInterval);
    rideId=null; localStorage.removeItem('activeRideId');
    currentStage = "settingStart";
    updateUI(); 
}

function initGeo(){
    navigator.geolocation.getCurrentPosition(p=>{
        startCoords=[p.coords.latitude,p.coords.longitude];
        map.setView(startCoords,15);
        revGeo(startCoords[0],startCoords[1]).then(n=>{startAreaName=n; updateUI();});
    },()=>{ updateUI(); });
    
    const saved = localStorage.getItem('activeRideId');
    if(saved) monitorRide(saved);
}

searchIn.addEventListener('input',()=>{
    const q=searchIn.value;
    if(q.length<3) return;
    clearTimeout(geoTimer);
    geoTimer=setTimeout(async()=>{
        const r=await fetch(`https://nominatim.openstreetmap.org/search?q=${q}&format=json&limit=5&countrycodes=iq&accept-language=ar`);
        const d=await r.json();
        searchRes.innerHTML=''; searchRes.style.display='block';
        d.forEach(i=>{
            const div=document.createElement('div'); div.className='search-result-item'; div.innerText=i.display_name;
            div.onclick=()=>{
                map.setView([i.lat,i.lon],16); searchRes.style.display='none';
                if(currentStage==="settingStart") startCoords=[i.lat,i.lon]; else endCoords=[i.lat,i.lon];
                updateUI();
            };
            searchRes.appendChild(div);
        });
    },700);
});

window.onload=()=>{
    if(!localStorage.getItem('phone')) window.location.href="index.html";
    initGeo();
    window.addEventListener('resize', updatePanelHeight);
};
function logout(){ localStorage.clear(); window.location.href="index.html"; }
</script>
</body>
</html>
