<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¨Ù„ÙŠ - Ø§Ù„Ø±Ø§ÙƒØ¨</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <style>
        :root {
            --baly-yellow: #FFD200;
            --baly-black: #1A1A1A;
            --soft-gray: #f4f4f4;
        }

        body, html { 
            margin: 0; padding: 0; height: 100%; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            overflow: hidden; background-color: #eee;
        }

        #map { height: 100vh; width: 100%; z-index: 1; }

        /* Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© - ØªØµÙ…ÙŠÙ… Ø¹ØµØ±ÙŠ */
        .floating-panel {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: white; border-radius: 30px 30px 0 0;
            padding: 20px; z-index: 1000;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
        }

        .handle {
            width: 40px; height: 5px; background: #ccc;
            border-radius: 10px; margin: 0 auto 15px;
        }

        /* Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† */
        .search-container { margin-bottom: 15px; }
        .input-box {
            background: var(--soft-gray); border-radius: 12px;
            display: flex; align-items: center; padding: 12px 15px;
            margin-bottom: 8px; border: 1px solid transparent;
        }
        .input-box:focus-within { border-color: var(--baly-yellow); background: white; }
        .input-box input {
            border: none; background: transparent; width: 100%;
            outline: none; font-size: 16px; margin-right: 10px;
        }

        /* ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø© (Ø§Ù„Ø£Ø¬Ø±Ø© ÙˆØ§Ù„Ù…Ø³Ø§ÙØ©) */
        .ride-details {
            display: flex; justify-content: space-between;
            background: #fffbe6; padding: 15px;
            border-radius: 15px; margin-bottom: 15px;
            border: 1px solid #ffe58f; display: none;
        }
        .detail-item { text-align: center; flex: 1; }
        .detail-item span { display: block; font-size: 12px; color: #666; }
        .detail-item b { font-size: 18px; color: var(--baly-black); }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn-main {
            background: var(--baly-black); color: white;
            border: none; width: 100%; padding: 18px;
            border-radius: 15px; font-weight: bold; font-size: 18px;
            cursor: pointer; transition: 0.2s;
        }
        .btn-main:active { transform: scale(0.98); }
        .btn-order { background: var(--baly-yellow); color: var(--baly-black); }
        .btn-cancel { background: #ff4d4d; color: white; margin-top: 10px; display: none; }

        /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ */
        .driver-card {
            display: none; align-items: center; background: #fff;
            padding: 15px; border-radius: 15px; border: 1px solid #eee; margin-top: 10px;
        }
        .driver-info { flex-grow: 1; }
        .call-icon {
            background: #2ecc71; color: white; width: 45px; height: 45px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            text-decoration: none; font-size: 20px;
        }

        /* Ù‚Ø§Ø¦Ù…Ø© Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« */
        #results {
            position: absolute; bottom: 250px; left: 20px; right: 20px;
            background: white; border-radius: 15px; z-index: 2000;
            max-height: 200px; overflow-y: auto; box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            list-style: none; padding: 0; margin: 0; display: none;
        }
        #results li { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 14px; }
    </style>
</head>
<body>

<div id="map"></div>
<ul id="results"></ul>

<div class="floating-panel">
    <div class="handle"></div>
    <div id="statusLabel" style="text-align: center; font-weight: bold; margin-bottom: 15px; color: #333;">Ø£ÙŠÙ† ØªÙˆØ¯ Ø§Ù„Ø°Ù‡Ø§Ø¨ØŸ</div>

    <div id="bookingUI">
        <div class="search-container">
            <div class="input-box">
                <span style="color: #2ecc71;">â—</span>
                <input type="text" id="startInput" placeholder="Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚..." readonly>
            </div>
            <div class="input-box">
                <span style="color: #e74c3c;">â—</span>
                <input type="text" id="destInput" placeholder="Ø­Ø¯Ø¯ ÙˆØ¬Ù‡ØªÙƒ">
            </div>
        </div>

        <div class="ride-details" id="rideDetails">
            <div class="detail-item">
                <span>Ø§Ù„Ø£Ø¬Ø±Ø© Ø§Ù„Ù…Ù‚Ø¯Ø±Ø©</span>
                <b id="fareTxt">0</b> <small>Ø¯.Ø¹</small>
            </div>
            <div style="width: 1px; background: #ddd; margin: 0 10px;"></div>
            <div class="detail-item">
                <span>Ø§Ù„Ù…Ø³Ø§ÙØ©</span>
                <b id="distTxt">0</b> <small>ÙƒÙ…</small>
            </div>
        </div>

        <button class="btn-main btn-order" id="orderBtn">Ø·Ù„Ø¨ Ø¨Ù„ÙŠ Ø§Ù„Ø¢Ù†</button>
    </div>

    <div class="driver-card" id="driverCard">
        <div class="driver-info">
            <div style="font-size: 12px; color: #888;">Ø§Ù„ÙƒØ§Ø¨ØªÙ† Ù‚Ø§Ø¯Ù… Ø¥Ù„ÙŠÙƒ</div>
            <div id="driverPhoneDisplay" style="font-weight: bold; font-size: 18px;">07XXXXXXXX</div>
        </div>
        <a href="#" class="call-icon" id="callLink">ğŸ“</a>
    </div>

    <button class="btn-main btn-cancel" id="cancelBtn">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>
</div>

<script>
// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
const firebaseConfig = { 
    apiKey: "AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M", 
    databaseURL: "https://taxi-15314-default-rtdb.firebaseio.com/" 
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let map = L.map('map', {zoomControl: false}).setView([33.3152, 44.3661], 13);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

let startMarker, endMarker, currentRideId = null;
const riderPhone = localStorage.getItem("phone") || "0700000000";

// ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
navigator.geolocation.getCurrentPosition(pos => {
    const latlng = [pos.coords.latitude, pos.coords.longitude];
    map.setView(latlng, 15);
    
    startMarker = L.marker(latlng, {draggable: true}).addTo(map);
    endMarker = L.marker([latlng[0] + 0.005, latlng[1] + 0.005], {draggable: true}).addTo(map);
    
    startMarker.on('dragend', calculatePrice);
    endMarker.on('dragend', calculatePrice);
    
    calculatePrice();
});

// ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù„Ø£Ø³Ù…Ø§Ø¡ Ø£Ù…Ø§ÙƒÙ†
async function updateAddressText(lat, lng, isStart) {
    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
        const data = await response.json();
        const name = data.display_name.split(',')[0] + ", " + (data.display_name.split(',')[1] || "");
        if(isStart) document.getElementById('startInput').value = name;
    } catch(e) {}
}

function calculatePrice() {
    if(currentRideId) return; // Ù…Ù†Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø©

    const start = startMarker.getLatLng();
    const end = endMarker.getLatLng();
    
    const distance = (map.distance(start, end) / 1000).toFixed(1);
    const fare = Math.round(distance * 1500 + 1000); // 1500 Ù„Ù„ÙƒÙŠÙ„Ùˆ + 1000 ÙØªØ­ Ø¹Ø¯Ø§Ø¯

    updateAddressText(start.lat, start.lng, true);
    
    document.getElementById('rideDetails').style.display = 'flex';
    document.getElementById('fareTxt').innerText = fare.toLocaleString();
    document.getElementById('distTxt').innerText = distance;
}

// Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙˆØ¬Ù‡Ø©
document.getElementById('destInput').addEventListener('input', async (e) => {
    const val = e.target.value;
    if(val.length < 3) return;

    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${val}, Iraq&limit=5`);
    const data = await res.json();
    const list = document.getElementById('results');
    list.innerHTML = '';
    list.style.display = 'block';

    data.forEach(item => {
        let li = document.createElement('li');
        li.innerText = item.display_name;
        li.onclick = () => {
            endMarker.setLatLng([item.lat, item.lon]);
            map.flyTo([item.lat, item.lon], 15);
            list.style.display = 'none';
            document.getElementById('destInput').value = item.display_name.split(',')[0];
            calculatePrice();
        };
        list.appendChild(li);
    });
});

// ØªÙ†ÙÙŠØ° Ø§Ù„Ø·Ù„Ø¨
document.getElementById('orderBtn').onclick = function() {
    currentRideId = "RIDE_" + Date.now();
    
    const rideData = {
        riderPhone: riderPhone,
        start: [startMarker.getLatLng().lat, startMarker.getLatLng().lng],
        end: [endMarker.getLatLng().lat, endMarker.getLatLng().lng],
        startName: document.getElementById('startInput').value,
        endName: document.getElementById('destInput').value || "ÙˆØ¬Ù‡Ø© Ù…Ø­Ø¯Ø¯Ø©",
        fare: document.getElementById('fareTxt').innerText,
        status: "Ø¬Ø¯ÙŠØ¯Ø©"
    };

    db.ref("rides/" + currentRideId).set(rideData);

    // ØªØºÙŠÙŠØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
    document.getElementById('bookingUI').style.display = 'none';
    document.getElementById('cancelBtn').style.display = 'block';
    document.getElementById('statusLabel').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙƒØ§Ø¨ØªÙ†...";

    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø­Ù„Ø©
    db.ref("rides/" + currentRideId).on('value', snap => {
        const ride = snap.val();
        if(!ride) return;

        if(ride.status === "Ù…Ù‚Ø¨ÙˆÙ„Ø©") {
            document.getElementById('statusLabel').innerText = "ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨Ùƒ!";
            document.getElementById('driverCard').style.display = 'flex';
            document.getElementById('driverPhoneDisplay').innerText = ride.driverPhone;
            document.getElementById('callLink').href = "tel:" + ride.driverPhone;
        } 
        else if(ride.status === "Ù…Ù†ØªÙ‡ÙŠØ©" || ride.status === "Ù…Ù„ØºÙŠØ©") {
            alert("Ø§Ù„Ø±Ø­Ù„Ø© " + ride.status);
            location.reload(); // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        }
    });
};

// Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©
document.getElementById('cancelBtn').onclick = function() {
    if(currentRideId) {
        db.ref("rides/" + currentRideId).update({status: "Ù…Ù„ØºÙŠØ©"});
        location.reload();
    }
};
</script>

</body>
</html>
