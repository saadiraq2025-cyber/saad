<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø±Ø§ÙƒØ¨ - ØªÙƒØ³ÙŠ Ø§Ù„Ø¹Ø±Ø§Ù‚ Ø§Ù„Ø´Ø§Ù…Ù„</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#f97316"> 
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body,html{margin:0;padding:0;height:100%;font-family:Tahoma;overflow:hidden;}
#map{height:100vh;width:100%;position:relative; transition: padding-bottom 0.3s ease;} 
#panel{ 
    position:fixed; 
    bottom:0; 
    left:0; 
    right:0; 
    background:#fff; 
    text-align:center; 
    padding:10px 0 0; 
    box-shadow:0 -2px 10px rgba(0,0,0,0.3); 
    border-radius: 15px 15px 0 0; 
    z-index: 1000; 
}
#fixedActions {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 5px 0 10px;
    background: #fff;
    z-index: 1005; 
    box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
}
button{ background:#f97316; color:white; border:none; padding:15px 10px; border-radius:10px; font-weight:bold; cursor:pointer; margin:5px 10px; width:calc(100% - 20px); font-size: 1.1em; }
#status { font-size: 1.0em; margin: 10px; line-height: 1.4; color: #333; padding: 5px; background: #f0f0f0; border-radius: 8px; }
#costDisplay { background: #e0f2f1; color: #004d40; font-size: 1.2em; font-weight: bold; padding: 10px; margin: 10px; border-radius: 8px; display: none; }
#map-center-pin { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -100%); z-index: 999; font-size: 40px; pointer-events: none; display: none; }
#pointContainer { display: flex; flex-direction: column; padding: 0 10px; gap: 10px; text-align: right; }
.point-field { display: flex; justify-content: space-between; align-items: center; background: #f5f5f5; padding: 10px; border-radius: 10px; }
.point-value { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex-grow: 1; text-align: right; margin-right: 5px; }
.point-action { background: none; color: #f97316; width: auto; padding: 0 5px; margin: 0; font-size: 0.9em; }
#searchContainer { position: fixed; top: 0; left: 0; right: 0; background: #fff; padding: 8px 10px; z-index: 1001; display: flex; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
#search-input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 8px; margin: 0 10px; text-align: right; }
#searchResults { position: fixed; top: 55px; left: 10px; right: 10px; background: #fff; z-index: 1002; max-height: 50vh; overflow-y: auto; display: none; border: 1px solid #ddd; }
.search-result-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; text-align: right; }
#logoutBtn{ background:#607d8b; padding:10px; width:calc(100% - 20px); margin: 5px 10px; }

/* Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠ */
.searching-status { display: flex; align-items: center; justify-content: flex-end; padding: 10px; }
.timer-container { width: 36px; height: 36px; position: relative; border-radius: 50%; margin-right: 10px; flex-shrink: 0; }
#countdownProgress { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; }
#countdownText { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.9em; font-weight: bold; color: #f97316; z-index: 10; }
</style>
</head>
<body>

<div id="map"></div>
<div id="map-center-pin">ğŸ“</div>

<div id="searchContainer">
    <span>ğŸ”</span>
    <input type="text" id="search-input" placeholder="Ø£Ø¨Ø­Ø« Ø¹Ù† Ù…ÙƒØ§Ù†" />
</div>
<div id="searchResults"></div>

<div id="panel">
    <div id="pointContainer">
        <div class="point-field" id="startPointField">
            <span>Ù…Ù†:</span>
            <span id="startPointValue" class="point-value">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...</span>
            <button id="changeStartPointBtn" class="point-action" style="display:none;">ØªØºÙŠÙŠØ±</button>
        </div>
        <div class="point-field" id="endPointField" style="display:none;">
            <span>Ø¥Ù„Ù‰:</span>
            <span id="endPointValue" class="point-value">Ø­Ø¯Ø¯ Ø§Ù„ÙˆØ¬Ù‡Ø©...</span>
            <button id="changeEndPointBtn" class="point-action" style="display:none;">ØªØºÙŠÙŠØ±</button>
        </div>
    </div>
    <div id="costDisplay">Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠØ©: <strong><span id="fareValue">---</span> Ø¯.Ø¹</strong></div>
    <p id="status" style="display:none;"></p> 
</div>

<div id="fixedActions">
    <button id="mainActionBtn" onclick="handleMainAction()">ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</button> 
    <button id="logoutBtn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</div>

<script>
// ØªÙ‡ÙŠØ¦Ø© Firebase
const app=firebase.initializeApp({apiKey:"AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M",authDomain:"taxi-15314.firebaseapp.com",databaseURL:"https://taxi-15314-default-rtdb.firebaseio.com/",projectId:"taxi-15314"});
const db=firebase.database();

let map=L.map('map', {zoomControl: false}).setView([33.3603, 44.5066],14); 
L.tileLayer("https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}",{maxZoom:20}).addTo(map);

let startCoords=null, endCoords=null, startAreaName="", endAreaName="";
let currentStage="settingStart", rideId=null, driverMarker=null, rideRef=null, driverRef=null;
let countdownInterval = null; 

const pin=document.getElementById("map-center-pin"), startVal=document.getElementById("startPointValue"), endVal=document.getElementById("endPointValue");
const mainBtn=document.getElementById("mainActionBtn"), logoutBtn=document.getElementById("logoutBtn");
const statusP=document.getElementById("status"), costDiv=document.getElementById("costDisplay"), fareVal=document.getElementById("fareValue");
const startF=document.getElementById("startPointField"), endF=document.getElementById("endPointField"), chStart=document.getElementById("changeStartPointBtn"), chEnd=document.getElementById("changeEndPointBtn");
const searchIn=document.getElementById("search-input"), searchRes=document.getElementById("searchResults");
const fixedActions = document.getElementById("fixedActions"), panel = document.getElementById("panel");

function updatePanelHeight() {
    const totalBottomHeight = fixedActions.offsetHeight + panel.offsetHeight;
    panel.style.bottom = fixedActions.offsetHeight + 'px';
    document.getElementById("map").style.paddingBottom = totalBottomHeight + "px";
    map.invalidateSize();
}

function handleMainAction() {
    if (rideId) {
        cancelRideAction();
    } else {
        if(currentStage==="settingStart"){ 
            if(startCoords) { currentStage="settingEnd"; updateUI(); }
        } else if(currentStage==="settingEnd"){ 
            if(endCoords) { currentStage="confirmed"; updateUI(); }
        } else if(currentStage==="confirmed"){ 
            findDriver(); 
        }
    }
}

function cancelRideAction(){
    if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŸ")) {
        db.ref("rides/"+rideId).update({status:"Ù…Ù„ØºØ§Ø©", canceledBy:"rider"})
        .then(() => {
            alert("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©.");
            cleanup();
        }).catch(e => alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ù„ØºØ§Ø¡: " + e.message));
    }
}

async function updateUI(){
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    pin.style.display='none'; 
    mainBtn.disabled = false;
    mainBtn.style.backgroundColor = '#f97316';
    costDiv.style.display='none';
    chStart.style.display='none'; 
    chEnd.style.display='none'; 
    statusP.style.display='none';
    searchIn.parentElement.style.display = 'flex';

    if(rideId){ 
        searchIn.parentElement.style.display = 'none';
        startF.style.display='none';
        endF.style.display='none';
        mainBtn.innerText="Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© âŒ"; 
        mainBtn.style.backgroundColor = '#E53935'; 
        logoutBtn.style.display='none'; 
        statusP.style.display='block';
    } else {
        pin.style.display='block'; // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¯Ø¨ÙˆØ³ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹
        logoutBtn.style.display='block';
        startF.style.display='flex';
        endF.style.display='flex';

        if(currentStage==="settingStart"){
            mainBtn.innerText="ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚";
            endF.style.display='none';
            startVal.innerText = startAreaName || "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ¯...";
        } else if(currentStage==="settingEnd"){
            mainBtn.innerText="ØªØ«Ø¨ÙŠØª Ø§Ù„ÙˆØµÙˆÙ„";
            chStart.style.display='inline-block';
            endVal.innerText = endAreaName || "Ø­Ø±Ùƒ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ù„ÙˆØ¬Ù‡Ø©...";
        } else if(currentStage==="confirmed"){
            pin.style.display='none';
            mainBtn.innerText="Ø£Ø·Ù„Ø¨ Ø§Ù„ØªØ§ÙƒØ³ÙŠ Ø§Ù„Ø¢Ù† ğŸš•";
            chStart.style.display='inline-block';
            chEnd.style.display='inline-block';
            costDiv.style.display='block';
            const dist=calcDist(startCoords[0],startCoords[1],endCoords[0],endCoords[1]);
            fareVal.innerText=Math.max(2000,Math.round(dist*1000)).toLocaleString();
        }
    }
    updatePanelHeight();
}

function findDriver(){
    mainBtn.disabled=true; 
    mainBtn.innerText="Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...";
    statusP.style.display='block'; 
    statusP.innerText="Ù†Ø¨Ø­Ø« Ø¹Ù† Ø£Ù‚Ø±Ø¨ Ø³Ø§Ø¦Ù‚ Ù„Ùƒ...";
    
    db.ref("drivers").once("value",s=>{
        let targets = [];
        s.forEach(ds=>{
            const d=ds.val();
            if(d.status==="Ù…ØªØµÙ„" && d.lat){
                if(calcDist(startCoords[0],startCoords[1],d.lat,d.lng) <= 3.0) targets.push(ds.key);
            }
        });
        
        if(targets.length > 0) sendReq(targets);
        else {
            alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø§Ø¦Ù‚ÙŠÙ† Ù…ØªØ§Ø­ÙŠÙ† ÙÙŠ Ù…Ù†Ø·Ù‚ØªÙƒ Ø­Ø§Ù„ÙŠØ§Ù‹.");
            currentStage = "confirmed";
            updateUI();
        }
    });
}

function sendReq(targets){
    rideId = Date.now();
    localStorage.setItem('activeRideId', rideId);
    const dist=calcDist(startCoords[0],startCoords[1],endCoords[0],endCoords[1]);
    
    db.ref("rides/"+rideId).set({
        riderPhone: localStorage.getItem('phone'),
        targetDrivers: targets,
        startLat:startCoords[0], startLng:startCoords[1], endLat:endCoords[0], endLng:endCoords[1],
        startArea:startAreaName, endArea:endAreaName, fare:Math.max(2000,Math.round(dist*1000)),
        status:"Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©", time: rideId
    });
    monitorRide(rideId);
}

function monitorRide(id){
    rideRef=db.ref("rides/"+id);
    rideRef.on('value',s=>{
        const r=s.val();
        if(!r || r.status === "Ù…Ù„ØºØ§Ø©" || r.status === "Ù…Ù†ØªÙ‡ÙŠØ©" || r.status === "Ù…Ø±ÙÙˆØ¶Ø©"){
            if(r && r.status !== "Ù…Ù„ØºØ§Ø©") alert("Ø§Ù„Ø±Ø­Ù„Ø©: " + (r.status || "Ø§Ù†ØªÙ‡Øª"));
            cleanup(); return;
        }
        rideId = id; 
        updateUI();

        if(r.status==="Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©") {
            statusP.innerText = "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚...";
        } else if(r.status==="Ù…Ù‚Ø¨ÙˆÙ„Ø©") {
            statusP.innerHTML=`ğŸš• Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø¥Ù„ÙŠÙƒ! <br> Ù‡Ø§ØªÙ: <a href="tel:${r.driverPhone}">${r.driverPhone}</a>`;
            trackDriver(r.driverPhone);
        } else if(r.status==="Ø¨Ø¯Ø£Øª") {
            statusP.innerText = "Ø£Ù†Øª ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø§Ù„Ø¢Ù†. Ø±Ø­Ù„Ø© Ø³Ø¹ÙŠØ¯Ø©!";
        }
    });
}

function trackDriver(ph){
    if(driverRef) driverRef.off();
    driverRef=db.ref("drivers/"+ph);
    driverRef.on('value',s=>{
        const d=s.val();
        if(d && d.lat){
            if(driverMarker) map.removeLayer(driverMarker);
            driverMarker=L.marker([d.lat,d.lng],{icon:L.divIcon({html:'ğŸš•',className:'',iconSize:[30,30]})}).addTo(map);
        }
    });
}

function cleanup(){
    if(rideRef) rideRef.off();
    if(driverRef) driverRef.off();
    if(driverMarker) map.removeLayer(driverMarker);
    rideId=null;
    localStorage.removeItem('activeRideId');
    currentStage="settingStart";
    updateUI();
}

// Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
function calcDist(l1,n1,l2,n2){
    const R=6371, dLat=(l2-l1)*Math.PI/180, dLon=(n2-n1)*Math.PI/180;
    const a=Math.sin(dLat/2)**2+Math.cos(l1*Math.PI/180)*Math.cos(l2*Math.PI/180)*Math.sin(dLon/2)**2;
    return parseFloat((R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))).toFixed(2));
}

async function revGeo(lat,lon){
    try{const r=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=ar`);
    const d=await r.json(); return d.display_name.split(',')[0] + " " + (d.display_name.split(',')[1] || "");}
    catch{return "Ù…ÙˆÙ‚Ø¹ Ù…Ø®ØµØµ";}
}

map.on('moveend', async () => {
    if(rideId) return;
    const c=map.getCenter();
    if(currentStage==="settingStart") { startCoords=[c.lat,c.lng]; revGeo(c.lat,c.lng).then(n=>{startAreaName=n; updateUI();}); }
    else if(currentStage==="settingEnd") { endCoords=[c.lat,c.lng]; revGeo(c.lat,c.lng).then(n=>{endAreaName=n; updateUI();}); }
});

chStart.onclick=()=>{ currentStage="settingStart"; updateUI(); map.setView(startCoords, 16); };
chEnd.onclick=()=>{ currentStage="settingEnd"; updateUI(); map.setView(endCoords || startCoords, 16); };

function logout(){ cleanup(); localStorage.clear(); window.location.href="index.html"; }

window.onload=()=>{
    if(!localStorage.getItem('phone')) window.location.href="index.html";
    navigator.geolocation.getCurrentPosition(p=>{
        const c=[p.coords.latitude, p.coords.longitude];
        map.setView(c, 16);
        startCoords = c;
        const saved = localStorage.getItem('activeRideId');
        if(saved) monitorRide(saved);
        else updateUI();
    }, () => updateUI());
};
</script>
</body>
</html>
