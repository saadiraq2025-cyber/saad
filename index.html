<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ุชูุณู ุงูุนุฑุงู ุงูุดุงูู - ุชุณุฌูู ุงูุฏุฎูู</title>
  <!-- ุชุญููู Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- ุชุญููู ุงูุฎุท ุงูููุงุณุจ ููุบุฉ ุงูุนุฑุจูุฉ (Inter for Latin fallback, but Tahoma/Arial will be picked up for Arabic) -->
  <style>
    :root {
      /* ุงูุฃููุงู ุงูุฃุณุงุณูุฉ */
      --color-primary: #2e7d32; /* ุงูุฃุฎุถุฑ ุงูุนููู */
      --color-secondary: #fdd835; /* ุงูุฃุตูุฑ ุงูุฒุงูู */
      --color-background: #f5f5f5;
      font-family: 'Inter', 'Tahoma', sans-serif;
    }
    /* ุฏูุฌ ุงูุฎุทูุท ุงูุนุฑุจูุฉ ุงูููุงุณูุฉ */
    body {
      font-family: 'Tahoma', 'Arial', sans-serif;
      background-color: var(--color-background);
    }
    .text-primary { color: var(--color-primary); }
    .bg-secondary { background-color: var(--color-secondary); }
    .hover\:bg-secondary-dark:hover { background-color: #fbc02d; } /* ุชุธููู ุฎููู ููุฃุตูุฑ */
  </style>

  <!-- ุฅุนุฏุงุฏ Tailwind ูุงุณุชุฎุฏุงู ุงูุฃููุงู ุงููุฎุตุตุฉ -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#2e7d32', /* ุงูุฃุฎุถุฑ */
            secondary: '#fdd835', /* ุงูุฃุตูุฑ */
          },
        }
      }
    }
  </script>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

  <!-- Header -->
  <header class="absolute top-0 w-full pt-8 text-center">
    <h1 class="text-4xl font-extrabold text-primary mb-2">
      ๐ ุชูุณู ุงูุนุฑุงู
    </h1>
    <p class="text-gray-600">ุฎุฏูุชู ูู ูู ููุงู</p>
  </header>

  <!-- Container for Auth Boxes -->
  <div id="authContainer" class="w-full max-w-sm">

    <!-- Login Box -->
    <div id="loginBox" class="bg-white p-6 rounded-xl shadow-2xl transition-opacity duration-500 ease-in-out">
      <h2 class="text-3xl font-bold text-primary mb-6">ุชุณุฌูู ุงูุฏุฎูู</h2>

      <div class="space-y-4">
        <input type="text" id="loginPhone" placeholder="ุฑูู ุงููุงุชู" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-lg text-center focus:outline-none focus:ring-2 focus:ring-secondary focus:border-secondary transition">
        <input type="password" id="loginPassword" placeholder="ูููุฉ ุงููุฑูุฑ" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-lg text-center focus:outline-none focus:ring-2 focus:ring-secondary focus:border-secondary transition">
      </div>

      <button onclick="login()" class="w-full px-4 py-3 mt-6 bg-secondary text-gray-900 font-extrabold text-xl rounded-lg hover:bg-secondary-dark transition transform hover:scale-[1.01] shadow-md">
        ุฏุฎูู
      </button>

      <button onclick="adminLogin()" class="w-full px-4 py-3 mt-3 bg-primary text-white font-bold text-lg rounded-lg hover:bg-green-700 transition transform hover:scale-[1.01] shadow-md flex items-center justify-center">
        <span class="ml-2">๐ ุฏุฎูู ุงูุฃุฏูู</span>
      </button>

      <div class="switch text-primary mt-6 cursor-pointer text-sm font-medium hover:underline" onclick="showRegister()">
        ููุณ ูุฏูู ุญุณุงุจุ ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ
      </div>
    </div>

    <!-- Register Box -->
    <div id="registerBox" class="bg-white p-6 rounded-xl shadow-2xl transition-opacity duration-500 ease-in-out absolute w-full max-w-sm top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 hidden" style="opacity:0;">
      <h2 class="text-3xl font-bold text-primary mb-6">ุฅูุดุงุก ุญุณุงุจ</h2>

      <div class="space-y-4">
        <input type="text" id="regPhone" placeholder="ุฑูู ุงููุงุชู" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-lg text-center focus:outline-none focus:ring-2 focus:ring-secondary focus:border-secondary transition">
        <input type="password" id="regPassword" placeholder="ูููุฉ ุงููุฑูุฑ" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-lg text-center focus:outline-none focus:ring-2 focus:ring-secondary focus:border-secondary transition">
        
        <select id="regType" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-lg text-center appearance-none focus:outline-none focus:ring-2 focus:ring-secondary focus:border-secondary transition">
          <option value="rider">ุฑุงูุจ (Passenger)</option>
          <option value="driver">ุณุงุฆู (Driver)</option>
        </select>
      </div>

      <button onclick="register()" class="w-full px-4 py-3 mt-6 bg-secondary text-gray-900 font-extrabold text-xl rounded-lg hover:bg-secondary-dark transition transform hover:scale-[1.01] shadow-md">
        ุชุณุฌูู
      </button>

      <div class="switch text-primary mt-6 cursor-pointer text-sm font-medium hover:underline" onclick="showLogin()">
        ูุฏูู ุญุณุงุจ ุจุงููุนูุ ุชุณุฌูู ุงูุฏุฎูู
      </div>
    </div>

  </div>

  <!-- Message Box (Custom Alert) -->
  <div id="messageBox" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-xs text-center">
      <p id="messageText" class="text-lg font-bold mb-4"></p>
      <button onclick="hideMessage()" class="w-full px-4 py-2 bg-primary text-white rounded-lg hover:bg-green-700 transition">
        ููุงูู
      </button>
    </div>
  </div>

  <!-- Firebase & App Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


    // ----------------------------------------------------
    // 1. ุฅุนุฏุงุฏุงุช Firebase
    // ----------------------------------------------------
    setLogLevel('Debug');
    
    // ุงููุชุบูุฑุงุช ุงูุนุงูุฉ ุงูููุฏูุฉ ูู ุงูุจูุฆุฉ
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    if (Object.keys(firebaseConfig).length === 0) {
      showMessage("โ ุฎุทุฃ ุงูุฅุนุฏุงุฏุงุช", "ูู ูุชู ุชูููุฑ ุฅุนุฏุงุฏุงุช Firebase. ูู ุชุนูู ูุธุงุฆู ุชุณุฌูู ุงูุฏุฎูู/ุงูุชุณุฌูู.");
      console.error("Firebase config is missing.");
    }

    let app, db, auth;

    try {
      app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);
      console.log("Firebase Initialized.");

      // ูุธููุฉ ุชุณุฌูู ุงูุฏุฎูู ุงูุฃููู
      async function initializeAuth() {
        try {
          if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
            console.log("Signed in with custom token.");
          } else {
            await signInAnonymously(auth);
            console.log("Signed in anonymously.");
          }
        } catch (error) {
          console.error("Error during initial sign in:", error);
          showMessage("ุฎุทุฃ ูู ุงูุงุชุตุงู", "ูุดู ุชุณุฌูู ุงูุฏุฎูู ุงูุฃููู. ูุฑุฌู ุงููุญุงููุฉ ูุงุญููุง.");
        }
      }
      initializeAuth();

    } catch (e) {
      console.error("Error initializing Firebase:", e);
      showMessage("ุฎุทุฃ", "ูุดู ูู ุฅุนุฏุงุฏ Firebase. ูุฑุฌู ุงูุชุญูู ูู ุงูุฅุนุฏุงุฏุงุช.");
    }

    // ----------------------------------------------------
    // 2. ูุธุงุฆู ุงููุงุฌูุฉ (UI Functions)
    // ----------------------------------------------------

    const loginBox = document.getElementById('loginBox');
    const registerBox = document.getElementById('registerBox');

    window.showMessage = (title, message) => {
      document.getElementById('messageText').innerHTML = `<strong class="text-primary">${title}</strong><br>${message}`;
      document.getElementById('messageBox').classList.remove('hidden');
      document.getElementById('messageBox').classList.add('flex');
    };

    window.hideMessage = () => {
      document.getElementById('messageBox').classList.add('hidden');
      document.getElementById('messageBox').classList.remove('flex');
    };

    window.showRegister = () => {
      loginBox.style.opacity = '0';
      setTimeout(() => {
        loginBox.classList.add('hidden');
        registerBox.classList.remove('hidden');
        setTimeout(() => {
          registerBox.style.opacity = '1';
        }, 50);
      }, 300);
    };

    window.showLogin = () => {
      registerBox.style.opacity = '0';
      setTimeout(() => {
        registerBox.classList.add('hidden');
        loginBox.classList.remove('hidden');
        setTimeout(() => {
          loginBox.style.opacity = '1';
        }, 50);
      }, 300);
    };

    window.adminLogin = () => {
      const pass = prompt("ุฃุฏุฎู ูููุฉ ูุฑูุฑ ุงูุฃุฏูู:");
      if(pass === "12312344@"){
        showMessage("โ ูุฌุงุญ", "ุชู ุชุณุฌูู ุฏุฎูู ุงูุฃุฏูู ุจูุฌุงุญ. ุณูุชู ูููู ุฅูู ุตูุญุฉ ุงูุฅุฏุงุฑุฉ (ูุญุงูุงุฉ).");
        // For a single file demo, we can't redirect to admin.html, so we show a success message.
      } else {
        showMessage("โ ุฎุทุฃ", "ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ.");
      }
    };
    
    // ุฏุงูุฉ ูุณุงุนุฏุฉ ูุชุญููู ุฑูู ุงููุงุชู ุฅูู ุจุฑูุฏ ุฅููุชุฑููู ุตุงูุญ ูู Firebase
    const phoneToEmail = (phone) => `${phone.replace(/\D/g, '')}@iraqtaxiapp.com`;


    // ----------------------------------------------------
    // 3. ูุธุงุฆู ุงูุชุณุฌูู ูุงูุฏุฎูู (Auth Logic)
    // ----------------------------------------------------

    window.register = async () => {
      const phone = document.getElementById('regPhone').value.trim();
      const password = document.getElementById('regPassword').value;
      const userType = document.getElementById('regType').value;

      if (!phone || !password || password.length < 6) {
        showMessage("โ ุฎุทุฃ ูู ุงูุฅุฏุฎุงู", "ูุฑุฌู ุฅุฏุฎุงู ุฑูู ูุงุชู ููููุฉ ูุฑูุฑ (6 ุฃุญุฑู ุนูู ุงูุฃูู).");
        return;
      }

      const email = phoneToEmail(phone);
      
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        const userId = user.uid;

        // ุญูุธ ููุน ุงููุณุชุฎุฏู ูู Firestore
        const userProfileRef = doc(db, 'artifacts', appId, 'users', userId, 'user_profiles', userId);
        await setDoc(userProfileRef, {
          phone: phone,
          userType: userType,
          createdAt: new Date().toISOString()
        });

        showMessage("โ ุชุณุฌูู ูุงุฌุญ", `ุชู ุฅูุดุงุก ุญุณุงุจู ูู <strong>${userType === 'rider' ? 'ุฑุงูุจ' : 'ุณุงุฆู'}</strong>. ุฑูู ุงูู ID ุงูุฎุงุต ุจู (ููุชุชุจุน): ${userId.substring(0, 8)}...`);
        showLogin(); // ุงูุงูุชูุงู ุฅูู ุดุงุดุฉ ุงูุฏุฎูู ุจุนุฏ ุงูุชุณุฌูู

      } catch (error) {
        let errorMessage = "ูุดู ุนูููุฉ ุงูุชุณุฌูู. ุญุงูู ูุฑุฉ ุฃุฎุฑู.";
        if (error.code === 'auth/email-already-in-use') {
          errorMessage = "ูุฐุง ุงูุฑูู (ุงูุจุฑูุฏ ุงูุฅููุชุฑููู) ูุณุฌู ุจุงููุนู.";
        } else {
          console.error("Registration error:", error);
          errorMessage = `ุฎุทุฃ: ${error.message}`;
        }
        showMessage("โ ูุดู ุงูุชุณุฌูู", errorMessage);
      }
    };

    window.login = async () => {
      const phone = document.getElementById('loginPhone').value.trim();
      const password = document.getElementById('loginPassword').value;

      if (!phone || !password) {
        showMessage("โ ุฎุทุฃ ูู ุงูุฅุฏุฎุงู", "ูุฑุฌู ุฅุฏุฎุงู ุฑูู ุงููุงุชู ููููุฉ ุงููุฑูุฑ.");
        return;
      }

      const email = phoneToEmail(phone);

      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        const userId = user.uid;

        // ูุฑุงุกุฉ ููุน ุงููุณุชุฎุฏู ูู Firestore
        const userProfileRef = doc(db, 'artifacts', appId, 'users', userId, 'user_profiles', userId);
        const docSnap = await getDoc(userProfileRef);
        
        let userTypeDisplay = 'ูุณุชุฎุฏู';
        if (docSnap.exists()) {
          const userProfile = docSnap.data();
          userTypeDisplay = userProfile.userType === 'rider' ? 'ุฑุงูุจ' : (userProfile.userType === 'driver' ? 'ุณุงุฆู' : 'ูุณุชุฎุฏู');
        }

        showMessage("โ ุฏุฎูู ูุงุฌุญ", `ูุฑุญุจุงู ุจู ูุฌุฏุฏุงู ูุง <strong>${userTypeDisplay}</strong>! ุฃูุช ุงูุขู ูุชุตู.`);
        // ููุง ูููู ุชูุฌูู ุงููุณุชุฎุฏู ุฅูู ูุงุฌูุฉ ุงูุชุทุจูู ุงูุฑุฆูุณูุฉ (ูุญุงูุงุฉ)

      } catch (error) {
        let errorMessage = "ูุดู ุชุณุฌูู ุงูุฏุฎูู. ูุฑุฌู ุงูุชุญูู ูู ุงูุฑูู ููููุฉ ุงููุฑูุฑ.";
        if (error.code === 'auth/invalid-credential') {
            errorMessage = "ุฑูู ุงููุงุชู ุฃู ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ.";
        }
        console.error("Login error:", error);
        showMessage("โ ูุดู ุงูุฏุฎูู", errorMessage);
      }
    };
    
  </script>
</body>
</html>

