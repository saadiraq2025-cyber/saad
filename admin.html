<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"> 
<title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù† - Taxi Iraq</title>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body { font-family: Tahoma; background:#f3f3f3; margin:0; padding:10px; }
h2 { text-align:center; color:#2e7d32; margin:15px 0; }

.counterBox, .searchBox {
    background:white;padding:10px;margin-bottom:15px;border-radius:8px;
    box-shadow:0 2px 5px #0001;font-size:16px;text-align:center;
}

input, select { padding:8px; width:100%; margin-top:8px; border:1px solid #ccc; border-radius:5px; }

.notifyBox, .whatsappBox {
    background:white;padding:15px;margin-top:20px;border-radius:8px;
    box-shadow:0 2px 5px #0001;
}

textarea { width:100%; height:90px; padding:10px; border:1px solid #ccc; border-radius:5px; }

table { width:100%; background:white; border-collapse:collapse; margin-top:20px; box-shadow:0 2px 5px #0001; }
th, td { padding:10px; border:1px solid #ddd; text-align:center; font-size:14px; }
th { background:#2e7d32; color:white; }

button { border:none; padding:6px 10px; border-radius:5px; cursor:pointer; font-size:12px; }
.days { background:#2e7d32; color:white; }
.minutes { background:#00bcd4; color:white; }
.month { background:#7b1fa2; color:white; }
.ban { background:#e53935; color:white; }
.unban { background:#fdd835; }
.del { background:#333; color:white; }
</style>
</head>

<body>

<h2>ğŸ‘‘ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù† - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>

<div class="counterBox">
    ğŸš– Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†: <span id="driversCount">0</span><br>
    ğŸ‘¤ Ø¹Ø¯Ø¯ Ø§Ù„Ø±ÙƒØ§Ø¨: <span id="ridersCount">0</span>
</div>

<div class="searchBox">
    <h3>ğŸ” Ø§Ù„Ø¨Ø­Ø«</h3>
    <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ...">
    <select id="searchType">
        <option value="">Ø§Ù„ÙƒÙ„</option>
        <option value="driver">Ø³Ø§Ø¦Ù‚ ÙÙ‚Ø·</option>
        <option value="rider">Ø±Ø§ÙƒØ¨ ÙÙ‚Ø·</option>
    </select>
    <button onclick="filterUsers()">Ø¨Ø­Ø«</button>
</div>

<div class="notifyBox">
    <h3>ğŸ“£ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</h3>
    <select id="notifyType">
        <option value="single">Ø¥Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ø­Ø¯</option>
        <option value="allDrivers">ÙƒÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†</option>
        <option value="allRiders">ÙƒÙ„ Ø§Ù„Ø±ÙƒØ§Ø¨</option>
    </select>
    <input type="text" id="singlePhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
    <textarea id="notifyMessage"></textarea>
    <button onclick="sendNotification()">Ø¥Ø±Ø³Ø§Ù„</button>
</div>

<table>
    <thead>
        <tr>
            <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
            <th>Ø§Ù„Ù†ÙˆØ¹</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th>
            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
        </tr>
    </thead>
    <tbody id="usersTable"></tbody>
</table>

<script>
// Firebase Init
var firebaseConfig = {
    apiKey: "AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M",
    authDomain: "taxi-15314.firebaseapp.com",
    databaseURL: "https://taxi-15314-default-rtdb.firebaseio.com/",
    projectId: "taxi-15314"
};
firebase.initializeApp(firebaseConfig);

var db = firebase.database();
var usersRef = db.ref("users");
let allUsers = {}; // Ù„Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ù„Ø¨Ø­Ø«

// Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
function sendNotification() {
    const type = notifyType.value;
    const msg = notifyMessage.value.trim();
    const phone = singlePhone.value.trim();

    if (!msg) return alert("âŒ Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø©");

    if (type === "single" && !phone)
        return alert("âŒ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ");

    usersRef.once("value", snap => {
        const data = snap.val();
        let count = 0;

        for (let p in data) {
            const u = data[p].type;
            if (type === "single" && p === phone) {
                db.ref("notifications/" + phone).set({ message: msg, time: Date.now() });
                count = 1;
            }
            else if (type === "allDrivers" && u === "driver") {
                db.ref("notifications/" + p).set({ message: msg, time: Date.now() });
                count++;
            }
            else if (type === "allRiders" && u === "rider") {
                db.ref("notifications/" + p).set({ message: msg, time: Date.now() });
                count++;
            }
        }

        alert("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ " + count + " Ù…Ø³ØªØ®Ø¯Ù…");
    });
}

// Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­ÙƒÙ…
function activateDays(phone) {
    usersRef.child(phone).update({ banned:false, expire: Date.now() + 86400000 });
}
function activateMinutes(phone) {
    usersRef.child(phone).update({ banned:false, expire: Date.now() + 60000 });
}
function activateMonth(phone) {
    usersRef.child(phone).update({ banned:false, expire: Date.now() + (30*24*60*60*1000) });
}
function banUser(phone) { usersRef.child(phone).update({ banned:true }); }
function unbanUser(phone) { usersRef.child(phone).update({ banned:false }); }
function deleteUser(phone) { if (confirm("Ø­Ø°ÙØŸ")) usersRef.child(phone).remove(); }

// Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† + Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª + Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
usersRef.on("value", snap => {
    allUsers = snap.val() || {};
    
    // --- ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (Ø§Ù„Ø¬Ø¯ÙŠØ¯) ---
    // Ù†Ù‚ÙˆÙ… Ø¨Ø§Ù„Ø¯ÙˆØ±Ø§Ù† Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†ØŒ ÙˆØ¥Ø°Ø§ ÙˆØ¬Ø¯Ù†Ø§ Ø³Ø§Ø¦Ù‚Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹ Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ØŒ Ù†ÙØ¹Ù„Ù‡ 30 ÙŠÙˆÙ…Ø§Ù‹
    for (let phone in allUsers) {
        const user = allUsers[phone];
        
        // Ø§Ù„Ø´Ø±Ø·: Ø§Ù„Ù†ÙˆØ¹ Ø³Ø§Ø¦Ù‚ØŒ ÙˆÙ„Ø§ ÙŠÙ…Ù„Ùƒ Ø®Ø§ØµÙŠØ© expire (ÙŠØ¹Ù†ÙŠ Ø¬Ø¯ÙŠØ¯)
        if (user.type === "driver" && !user.expire) {
            console.log("ØªÙØ¹ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ù…Ø´ØªØ±Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯: " + phone);
            usersRef.child(phone).update({
                expire: Date.now() + (30 * 24 * 60 * 60 * 1000), // ØªÙØ¹ÙŠÙ„ 30 ÙŠÙˆÙ…
                banned: false
            });
        }
    }
    // -------------------------------------

    loadUsers(allUsers);
});

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
function loadUsers(data) {
    usersTable.innerHTML = "";
    let drivers = 0, riders = 0;

    for (let phone in data) {
        const u = data[phone];
        if (u.type === "driver") drivers++; else riders++;

        const exp = u.expire || 0;
        const now = Date.now();

        let status = "ÙØ¹Ø§Ù„";
        if (u.banned) status = "Ù…Ø­Ø¸ÙˆØ±";
        else if (u.type === "driver" && exp < now) status = "Ù…Ù†ØªÙ‡ÙŠ";
        else if (u.type === "driver") status = "Ù…Ø´ØªØ±Ùƒ";

        let expire = "---";
        if (exp > 0)
            expire = new Date(exp).toLocaleString("ar-IQ");

        usersTable.innerHTML += `
            <tr>
                <td>${phone}</td>
                <td>${u.type === "driver" ? "Ø³Ø§Ø¦Ù‚" : "Ø±Ø§ÙƒØ¨"}</td>
                <td>${status}</td>
                <td>${expire}</td>
                <td>
                    <button class="days" onclick="activateDays('${phone}')">ÙŠÙˆÙ…</button>
                    <button class="minutes" onclick="activateMinutes('${phone}')">Ø¯Ù‚ÙŠÙ‚Ø©</button>
                    <button class="month" onclick="activateMonth('${phone}')">Ø´Ù‡Ø±</button>
                    <button class="ban" onclick="banUser('${phone}')">Ø­Ø¸Ø±</button>
                    <button class="unban" onclick="unbanUser('${phone}')">Ø¥Ù„ØºØ§Ø¡</button>
                    <button class="del" onclick="deleteUser('${phone}')">Ø­Ø°Ù</button>
                </td>
            </tr>
        `;
    }

    driversCount.innerText = drivers;
    ridersCount.innerText = riders;
}

// Ø§Ù„Ø¨Ø­Ø«
function filterUsers() {
    const text = searchInput.value.trim();
    const type = searchType.value;

    let result = {};

    for (let p in allUsers) {
        const u = allUsers[p];

        if (text && !p.includes(text)) continue;
        if (type && u.type !== type) continue;

        result[p] = u;
    }

    loadUsers(result);
}
</script>

</body>
</html>
