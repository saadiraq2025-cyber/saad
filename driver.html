<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¨Ù„ÙŠ ÙƒØ§Ø¨ØªÙ†</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        :root { --baly-yellow: #FFD200; }
        body, html { margin:0; height:100%; font-family: sans-serif; }
        #map { height: 100%; width:100%; }
        .popup-request { position: fixed; bottom: 20px; left: 10px; right: 10px; background: white; border-radius: 20px; padding: 20px; z-index: 9999; box-shadow: 0 0 20px rgba(0,0,0,0.3); display: none; text-align: center; }
        .active { display: block; animation: bounce 0.5s; }
        .btn-accept { background: var(--baly-yellow); border:none; padding:15px; width:100%; border-radius:10px; font-weight:bold; font-size:20px; cursor:pointer; }
        #riderActiveInfo { position:fixed; top:10px; left:10px; right:10px; z-index:1000; background:white; padding:15px; border-radius:15px; box-shadow:0 2px 10px rgba(0,0,0,0.1); display:none; }
        .action-btns { display: flex; gap: 5px; margin-top: 10px; }
        .btn-finish { background: #2ecc71; color: white; border:none; padding:10px; flex:1; border-radius:5px; font-weight:bold; }
        .btn-cancel-d { background: #e74c3c; color: white; border:none; padding:10px; flex:1; border-radius:5px; font-weight:bold; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="popup-request" id="pop">
    <h2 style="margin:0;">Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ðŸš•</h2>
    <div id="popDetails" style="margin:10px 0; font-size:16px; line-height:1.5;"></div>
    <button class="btn-accept" id="accBtn">Ù‚Ù€Ø¨Ù€ÙˆÙ„</button>
</div>

<div id="riderActiveInfo">
    <strong>Ø§Ù„Ø±Ø§ÙƒØ¨: </strong> <span id="rPhone"></span><br>
    <small id="rLocs"></small>
    <div class="action-btns">
        <button class="btn-finish" id="finishBtn">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>
        <button class="btn-cancel-d" id="cancelRideBtn">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
</div>

<script>
const firebaseConfig = { apiKey: "AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M", databaseURL: "https://taxi-15314-default-rtdb.firebaseio.com/" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const alertSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3'); 
let map = L.map('map', {zoomControl: false}).setView([33.3152, 44.3661], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let driverMarker = L.marker([33.3152, 44.3661]).addTo(map);
let currentRideKey = null;
const driverPhone = localStorage.getItem("phone") || "07800000000";

db.ref("rides").on("child_added", snap => {
    const r = snap.val();
    if(r.status === "Ø¬Ø¯ÙŠØ¯Ø©") {
        alertSound.play();
        document.getElementById('popDetails').innerHTML = `
            <b>Ø§Ù„Ø£Ø¬Ø±Ø©: ${r.fare} Ø¯.Ø¹</b><br>
            Ù…Ù†: ${r.startName || 'Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø±Ø§ÙƒØ¨'}<br>
            Ø¥Ù„Ù‰: ${r.endName || 'ÙˆØ¬Ù‡Ø© Ø§Ù„Ø±Ø§ÙƒØ¨'}
        `;
        document.getElementById('pop').classList.add('active');
        
        document.getElementById('accBtn').onclick = () => {
            currentRideKey = snap.key;
            db.ref("rides/"+snap.key).update({status: "Ù…Ù‚Ø¨ÙˆÙ„Ø©", driverPhone: driverPhone});
            document.getElementById('pop').classList.remove('active');
            showActiveRide(r);
        };
    }
});

function showActiveRide(r) {
    document.getElementById('riderActiveInfo').style.display = 'block';
    document.getElementById('rPhone').innerText = r.riderPhone;
    document.getElementById('rLocs').innerText = `Ù…Ù†: ${r.startName} \nØ¥Ù„Ù‰: ${r.endName}`;
    
    L.marker(r.start, {icon: L.divIcon({html: 'ðŸŸ¢'})}).addTo(map);
    L.marker(r.end, {icon: L.divIcon({html: 'ðŸ'})}).addTo(map);
    map.fitBounds([r.start, r.end]);
}

document.getElementById('finishBtn').onclick = () => updateStatus("Ù…Ù†ØªÙ‡ÙŠØ©");
document.getElementById('cancelRideBtn').onclick = () => updateStatus("Ù…Ù„ØºÙŠØ©");

function updateStatus(status) {
    if(currentRideKey) {
        db.ref("rides/" + currentRideKey).update({status: status});
        location.reload(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©
    }
}

setInterval(() => {
    navigator.geolocation.getCurrentPosition(pos => {
        const p = [pos.coords.latitude, pos.coords.longitude];
        driverMarker.setLatLng(p);
        db.ref("drivers/"+driverPhone).update({lat: p[0], lng: p[1]});
    });
}, 5000);
</script>
</body>
</html>
