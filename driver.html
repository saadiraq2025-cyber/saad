<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø³Ø§Ø¦Ù‚ - ØªÙƒØ³ÙŠ Ø§Ù„Ø¹Ø±Ø§Ù‚ Ø§Ù„Ø´Ø§Ù…Ù„</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body, html {
    margin: 0;
    padding: 0;
    height: 100%;
    font-family: Tahoma;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

#panel {
    background: #fff;
    padding: 10px;
    text-align: center;
    box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.2);
    flex-shrink: 0; 
}

#panel p#status {
    font-size: 1.2em;
    font-weight: bold;
    margin: 10px 0;
    line-height: 1.6;
    color: #333;
}

#map {
    height: calc(100vh - 120px);
    transition: height 0.3s ease-in-out;
    flex-grow: 1;
}

button {
    background: #ffb300;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    margin: 5px;
    font-weight: bold;
    cursor: pointer;
}
#logoutBtn {
    background: #455a64;
    color: white;
    margin-top: 10px;
    width: 95%;
}

#floatingControls {
    position: absolute;
    bottom: 10px;
    left: 10px;
    z-index: 1000;
    direction: ltr;
    display: flex;
    flex-direction: column-reverse;
    align-items: flex-start;
    gap: 10px;
}
#floatingControls button,
#floatingControls .ride-action-info {
    display: block;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    width: 150px;
    font-size: 14px;
    padding: 10px;
    margin: 0;
}
.ride-action-info {
    background: #fff;
    padding: 5px;
    color: #333;
    font-size: 0.9em;
    direction: rtl;
    text-align: center;
}
.phone-link {
    color: #007bff;
    text-decoration: none;
    font-weight: bold;
    display: block;
    margin: 0;
    font-size: 1em;
}
.phone-link:hover {
    text-decoration: underline;
}
#startRideBtn { background: #ff9800; color: white; }
#finishBtn { background: #1e88e5; color: white; }
#wazeBtn { background: #32CCFE; color: white; }
</style>
</head>
<body onclick="initializeAudioContext()"> <div id="map"></div>

<div id="floatingControls" style="display:none;">
    <button id="startRideBtn" style="display:none;">Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© ğŸš¦</button> 
    <button id="finishBtn" style="display:none;">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>
    <button id="wazeBtn" onclick="openWaze()"></button>
    <div id="riderContactInfo" class="ride-action-info" style="display:none;"></div>
</div>

<div id="panel">
    <h3>ğŸš– ÙˆØ¶Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚</h3>
    <p id="status">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p>
    
    <button id="acceptBtn" style="display:none;background:#4caf50;color:white;">Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©</button>
    <button id="rejectBtn" style="display:none;background:#e53935;color:white;">Ø±ÙØ¶ Ø§Ù„Ø±Ø­Ù„Ø©</button>
    
    <button id="logoutBtn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</div>

<script>
window.onload=function(){
    let phone=localStorage.getItem("phone");
    let type=localStorage.getItem("userType");
    if(!phone||type!=="driver"){
        window.location.href="index.html";
    }
    updateMapHeight();
    window.addEventListener('resize', updateMapHeight);
};

function logout(){
    localStorage.clear();
    window.location.href="index.html";
}

const app=firebase.initializeApp({
  apiKey:"AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M",
  authDomain:"taxi-15314.firebaseapp.com",
  databaseURL:"https://taxi-15314-default-rtdb.firebaseio.com/",
  projectId:"taxi-15314"
});
const db=firebase.database();

let map=L.map('map').setView([33.3152,44.3661],13);

L.tileLayer(
 "https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}&key=AIzaSyD7TtwniAdUtB8-pnTny4ZwE6gqX36SGUk",
 {maxZoom:20}
).addTo(map);

map.whenReady(()=>map.invalidateSize());

let driverMarker=null;
let driverPhone=localStorage.getItem("phone");

let currentRideId=null;
let passengerMarker=null;
let pickupRoute=null;
let destinationRoute=null;
let currentRideData=null;

// === Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØª ===
let audioContext = null;
let oscillator = null;
let ringingInterval = null;
let isAudioContextInitialized = false;

function initializeAudioContext() {
    if (isAudioContextInitialized) return;
    try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        isAudioContextInitialized = true;
    } catch (e) {
        console.error("AudioContext failed:", e);
    }
    document.body.onclick = null;
}

function startRinging() {
    if (!isAudioContextInitialized) return;
    stopRinging(); 
    const playTone = () => {
        oscillator = audioContext.createOscillator();
        oscillator.frequency.setValueAtTime(440, audioContext.currentTime); 
        const gainNode = audioContext.createGain();
        gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        oscillator.start(0);
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);
        oscillator.stop(audioContext.currentTime + 0.5); 
    };
    playTone();
    ringingInterval = setInterval(playTone, 1000); 
}

function stopRinging() {
    if (ringingInterval) {
        clearInterval(ringingInterval);
        ringingInterval = null;
    }
    if (oscillator) {
        try { oscillator.stop(); } catch(e) {} finally { oscillator = null; }
    }
}

function updateMapHeight() {
    const panelHeight = panelElement.offsetHeight;
    if (panelElement.style.display !== "none") {
        mapElement.style.height = `calc(100vh - ${panelHeight}px)`;
    } else {
        mapElement.style.height = '100vh';
    }
    map.invalidateSize();
}

setInterval(()=>{
    navigator.geolocation.getCurrentPosition(pos=>{
        let lat=pos.coords.latitude;
        let lng=pos.coords.longitude;

        if(driverMarker) map.removeLayer(driverMarker);
        driverMarker=L.marker([lat,lng]).addTo(map).bindPopup("ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ");

        db.ref("drivers/"+driverPhone).set({
            lat:lat,lng:lng,status:"Ù…ØªØµÙ„"
        });
        
        if (!currentRideId) {
            map.setView([lat, lng], map.getZoom() > 13 ? map.getZoom() : 13);
        }

    },err=>{},{
        enableHighAccuracy:true,timeout:5000
    });
},5000);

function removeAllRideMarkers(){
    if(passengerMarker) map.removeLayer(passengerMarker);
    if(pickupRoute) map.removeLayer(pickupRoute);
    if(destinationRoute) map.removeLayer(destinationRoute);
    passengerMarker=null;
    pickupRoute=null;
    destinationRoute=null;
    
    map.eachLayer(layer => {
        if (layer instanceof L.Marker && layer !== driverMarker) {
            const popupContent = layer.getPopup().getContent();
            if (popupContent && (popupContent.includes("Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ©") || popupContent.includes("Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©"))) {
                map.removeLayer(layer);
            }
        }
    });
}

async function drawStreetRoute(lat1, lng1, lat2, lng2, color, dashArray = '') {
    const OSRM_URL = `https://router.project-osrm.org/route/v1/driving/${lng1},${lat1};${lng2},${lat2}?geometries=geojson&overview=full`;
    try {
        const response = await fetch(OSRM_URL);
        const data = await response.json();
        if (data.code !== 'Ok' || !data.routes || data.routes.length === 0) {
            return L.polyline([[lat1, lng1], [lat2, lng2]], { color: color, dashArray: dashArray, weight: 5 }).addTo(map);
        }
        const geojsonCoords = data.routes[0].geometry.coordinates;
        const leafletCoords = geojsonCoords.map(coord => [coord[1], coord[0]]);
        let route = L.polyline(leafletCoords, { color: color, dashArray: dashArray, weight: 5 }).addTo(map);
        return route;
    } catch (error) {
        return L.polyline([[lat1, lng1], [lat2, lng2]], { color: color, dashArray: dashArray, weight: 5 }).addTo(map);
    }
}

function openWaze(){
    if(!currentRideData) return;
    let lat, lng;
    let status = currentRideData.status;
    
    if (status === "Ù…Ù‚Ø¨ÙˆÙ„Ø©" && currentRideData.startLat && currentRideData.startLng) {
        lat = currentRideData.startLat;
        lng = currentRideData.startLng;
    } 
    else if (status === "Ø¨Ø¯Ø£Øª" && currentRideData.endLat && currentRideData.endLng) {
        lat = currentRideData.endLat;
        lng = currentRideData.endLng;
    } else {
        return;
    }

    if(lat && lng){
        window.open(`https://www.waze.com/ul?ll=${lat},${lng}&navigate=yes`, '_blank');
    }
}

function getShortAreaName(fullArea) {
    if (!fullArea) return "Ù…Ù†Ø·Ù‚Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©";
    const parts = fullArea.split(',').map(p => p.trim()).filter(p => p.length > 0);
    const relevantParts = parts.filter(p => !p.includes("Ù‚Ø¶Ø§Ø¡") && !p.includes("Ù†Ø§Ø­ÙŠØ©") && !p.includes("Ù…Ø±ÙƒØ²") && !p.includes("Ø¨ØºØ¯Ø§Ø¯"));
    if (relevantParts.length > 0) return relevantParts[0]; 
    return parts[parts.length - 1]; 
}

const statusText=document.getElementById("status");
const acceptBtn=document.getElementById("acceptBtn");
const rejectBtn=document.getElementById("rejectBtn");
const startRideBtn=document.getElementById("startRideBtn");
const finishBtn=document.getElementById("finishBtn");
const wazeBtn=document.getElementById("wazeBtn");
const logoutBtn=document.getElementById("logoutBtn"); 
const floatingControls=document.getElementById("floatingControls");
const riderContactInfo=document.getElementById("riderContactInfo");
const mapElement = document.getElementById("map"); 
const panelElement = document.getElementById("panel");

db.ref("rides").on("value",snap=>{
    let data=snap.val();
    if(!data) return;

    // ** Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ø£Ùˆ Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡ Ù„Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© **
    if(currentRideId && data[currentRideId]){
        let r = data[currentRideId];
        // Ø¥Ø°Ø§ Ù‚Ø§Ù… Ø§Ù„Ø±Ø§ÙƒØ¨ Ø¨Ø§Ù„Ø¥Ù„ØºØ§Ø¡ ÙˆØ§Ù„Ø±Ø­Ù„Ø© ÙƒØ§Ù†Øª Ù†Ø´Ø·Ø©
        if(r.status === "Ù…Ù„ØºØ§Ø©" && r.canceledBy === "rider"){
            alert("âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ù‚Ø§Ù… Ø§Ù„Ø±Ø§ÙƒØ¨ Ø¨Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©!");
            // Ø³ÙŠØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ Ù„Ø£Ù† Ø§Ù„Ø­Ø§Ù„Ø© ØªØºÙŠØ±Øª
        }
    }

    let rideFound=false;

    Object.keys(data).forEach(id=>{
        let r=data[id];
        if(r.status==="Ø¬Ø¯ÙŠØ¯Ø©" && !rideFound){
            rideFound=true;
            showRideRequest(id,r);
        }
        else if(r.status==="Ù…Ù‚Ø¨ÙˆÙ„Ø©" && r.driverPhone===driverPhone){
             rideFound=true;
             handleAcceptedRide(id,r);
        }
        else if(r.status==="Ø¨Ø¯Ø£Øª" && r.driverPhone===driverPhone){
             rideFound=true;
             handleStartedRide(id,r);
        }
    });

    if(!rideFound){
        stopRinging(); 
        removeAllRideMarkers();
        currentRideId=null;
        currentRideData=null;
        acceptBtn.style.display="none";
        rejectBtn.style.display="none";
        
        startRideBtn.style.display="none";
        finishBtn.style.display="none";
        wazeBtn.style.display="none";
        riderContactInfo.style.display="none";
        floatingControls.style.display="none";
        
        logoutBtn.style.display="inline-block";
        statusText.innerText="ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª...";
        
        panelElement.style.display="block"; 
        updateMapHeight();
    }
});

function showRideRequest(id,r){
    currentRideId=id;
    currentRideData=r;
    
    startRinging();

    startRideBtn.style.display="none";
    finishBtn.style.display="none";
    wazeBtn.style.display="none";
    riderContactInfo.style.display="none";
    floatingControls.style.display="none";
    logoutBtn.style.display="inline-block";
    removeAllRideMarkers();

    panelElement.style.display="block"; 
    updateMapHeight();

    const distance = parseFloat(r.distance) || 0;
    const fare = r.fare || Math.round(distance * 1000);
    const formattedFare = fare.toLocaleString('ar-IQ') || '...';
    
    const shortStartArea = getShortAreaName(r.startArea);
    const shortEndArea = getShortAreaName(r.endArea);
    
    const fareStyle = "font-size: 1.1em; font-weight: bold; color: #e53935;";
    const distanceStyle = "font-size: 1.1em; font-weight: bold; color: #455a64;";

    statusText.innerHTML=
      `ğŸš– Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯<br>
       Ù…Ù†: ${shortStartArea} Ø¥Ù„Ù‰: ${shortEndArea}<br>
       Ù…Ø³Ø§ÙØ© Ø§Ù„Ø±Ø­Ù„Ø©: <span style="${distanceStyle}">${r.distance} ÙƒÙ…</span><br>
       Ø§Ù„Ø£Ø¬Ø±Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©: <span style="${fareStyle}">${formattedFare} Ø¯.Ø¹</span>`;

    acceptBtn.style.display="inline-block";
    rejectBtn.style.display="inline-block";

    acceptBtn.onclick=function(){
        stopRinging(); 
        db.ref("rides/"+id).update({status:"Ù…Ù‚Ø¨ÙˆÙ„Ø©",driverPhone:driverPhone});
    };

    rejectBtn.onclick=function(){
        stopRinging();
        db.ref("rides/"+id).update({status:"Ù…Ø±ÙÙˆØ¶Ø©"});
        statusText.innerText="ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø±Ø­Ù„Ø©.";
        acceptBtn.style.display="none";
        rejectBtn.style.display="none";
    };
}

async function handleAcceptedRide(id,r){
    currentRideId=id;
    currentRideData=r;
    
    acceptBtn.style.display="none";
    rejectBtn.style.display="none";
    logoutBtn.style.display="none"; 
    
    panelElement.style.display="none"; 
    updateMapHeight(); 
    
    floatingControls.style.display="flex";
    riderContactInfo.style.display = "block";
    startRideBtn.style.display="inline-block";
    finishBtn.style.display="none";
    wazeBtn.style.display="inline-block";
    wazeBtn.innerText = "ÙˆÙŠØ²: Ø§Ø°Ù‡Ø¨ Ù„Ù„Ø±Ø§ÙƒØ¨ ğŸš—";

    riderContactInfo.innerHTML = `
        <a href="tel:${r.riderPhone}" class="phone-link">
            ğŸ“ Ø§ØªØµÙ„ Ø¨Ø§Ù„Ø±Ø§ÙƒØ¨: ${r.riderPhone}
        </a>
    `;

    removeAllRideMarkers();
    
    if(r.startLat && r.startLng && driverMarker){
        let driverLat=driverMarker.getLatLng().lat;
        let driverLng=driverMarker.getLatLng().lng;
        pickupRoute = await drawStreetRoute(driverLat, driverLng, r.startLat, r.startLng, '#4caf50', '10, 10'); 
        passengerMarker=L.marker([r.startLat, r.startLng]).addTo(map).bindPopup("ğŸ‘¤ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø±Ø§ÙƒØ¨");
        map.setView([r.startLat, r.startLng], 14);
    }

    const shortStartArea = getShortAreaName(r.startArea);
    statusText.innerHTML=`ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©. ÙÙŠ Ø·Ø±ÙŠÙ‚Ùƒ Ù„Ù„Ø±Ø§ÙƒØ¨ (${shortStartArea})...`;

    startRideBtn.onclick=function(){
        db.ref("rides/"+id).update({status:"Ø¨Ø¯Ø£Øª"});
    };
    
    finishBtn.onclick=function(){
        db.ref("rides/"+id).update({status:"Ù…Ù†ØªÙ‡ÙŠØ©"});
    };
}

async function handleStartedRide(id,r){
    currentRideId=id;
    currentRideData=r;
    
    acceptBtn.style.display="none";
    rejectBtn.style.display="none";
    logoutBtn.style.display="none";
    
    panelElement.style.display="none"; 
    updateMapHeight();
    
    floatingControls.style.display="flex";
    riderContactInfo.style.display = "block";
    startRideBtn.style.display="none";
    finishBtn.style.display="inline-block";
    wazeBtn.style.display="inline-block";
    wazeBtn.innerText = "ÙˆÙŠØ²: Ø§Ø°Ù‡Ø¨ Ù„Ù„ÙˆØµÙˆÙ„ ğŸ";

    removeAllRideMarkers(); 

    riderContactInfo.innerHTML = `
        <a href="tel:${r.riderPhone}" class="phone-link">
            ğŸ“ Ø§ØªØµÙ„ Ø¨Ø§Ù„Ø±Ø§ÙƒØ¨: ${r.riderPhone}
        </a>
    `;
    
    const shortEndArea = getShortAreaName(r.endArea);
    statusText.innerHTML=`Ø§Ù„Ø±Ø­Ù„Ø© Ø¨Ø¯Ø£Øª! Ø§Ù„ÙˆØ¬Ù‡Ø©: ${shortEndArea}`;
    
    if(r.startLat && r.startLng && r.endLat && r.endLng){
        let startLat=r.startLat;
        let startLng=r.startLng;
        let endLat=r.endLat;
        let endLng=r.endLng;
        
        destinationRoute = await drawStreetRoute(startLat, startLng, endLat, endLng, '#1e88e5');
        passengerMarker=L.marker([startLat, startLng]).addTo(map).bindPopup("ğŸŸ¢ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©").openPopup();
        L.marker([endLat, endLng]).addTo(map).bindPopup("ğŸ Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ©");
        map.fitBounds([[startLat, startLng], [endLat, endLng]]); 
    }

    finishBtn.onclick=function(){
        db.ref("rides/"+id).update({status:"Ù…Ù†ØªÙ‡ÙŠØ©"});
    };
}
</script>
</body>
</html>
