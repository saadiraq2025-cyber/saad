<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø³Ø§Ø¦Ù‚ - ØªÙƒØ³ÙŠ Ø§Ù„Ø¹Ø±Ø§Ù‚ Ø§Ù„Ø´Ø§Ù…Ù„</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body, html { margin: 0; padding: 0; height: 100%; font-family: Tahoma; overflow: hidden; display: flex; flex-direction: column; }
#panel { background: #fff; padding: 10px; text-align: center; box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.2); flex-shrink: 0; z-index: 1001; }
#panel p#status { font-size: 1.2em; font-weight: bold; margin: 10px 0; line-height: 1.6; color: #333; }
#map { height: calc(100vh - 120px); transition: height 0.3s ease-in-out; flex-grow: 1; z-index: 1; }
button { background: #ffb300; border: none; padding: 10px 20px; border-radius: 8px; margin: 5px; font-weight: bold; cursor: pointer; }
#logoutBtn { background: #455a64; color: white; margin-top: 10px; width: 95%; }
#floatingControls { position: absolute; bottom: 10px; left: 10px; z-index: 1000; direction: ltr; display: flex; flex-direction: column-reverse; align-items: flex-start; gap: 10px; }
#floatingControls button, #floatingControls .ride-action-info { display: block; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3); border-radius: 8px; width: 150px; font-size: 14px; padding: 10px; margin: 0; }
.ride-action-info { background: #fff; padding: 5px; color: #333; font-size: 0.9em; direction: rtl; text-align: center; }
.phone-link { color: #007bff; text-decoration: none; font-weight: bold; display: block; margin: 0; font-size: 1em; }
.phone-link:hover { text-decoration: underline; }
#startRideBtn { background: #ff9800; color: white; }
#finishBtn { background: #1e88e5; color: white; }
#wazeBtn { background: #32CCFE; color: white; }
/* ØªÙ†Ø¨ÙŠÙ‡ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª */
#audioOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); color: white; z-index: 9999; display: flex; align-items: center; justify-content: center; text-align: center; font-size: 1.2em; padding: 20px; box-sizing: border-box; }
</style>
</head>
<body onload="initApp()">

<div id="audioOverlay" onclick="activateAudio()">
    <div>
        <p>ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¶ØºØ· Ù‡Ù†Ø§ Ù„ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø§Øª ğŸ”Š</p>
        <button style="font-size: 1.2em; padding: 15px 30px;">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¢Ù†</button>
    </div>
</div>

<div id="map"></div>

<div id="floatingControls" style="display:none;">
    <button id="startRideBtn" style="display:none;">Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© ğŸš¦</button> 
    <button id="finishBtn" style="display:none;">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>
    <button id="wazeBtn" onclick="openWaze()"></button>
    <div id="riderContactInfo" class="ride-action-info" style="display:none;"></div>
</div>

<div id="panel">
    <h3>ğŸš– ÙˆØ¶Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚</h3>
    <p id="status">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ...</p>
    <button id="acceptBtn" style="display:none;background:#4caf50;color:white;">Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©</button>
    <button id="rejectBtn" style="display:none;background:#e53935;color:white;">Ø±ÙØ¶ Ø§Ù„Ø±Ø­Ù„Ø©</button>
    <button id="logoutBtn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</div>

<script>
const app=firebase.initializeApp({
  apiKey:"AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M",
  authDomain:"taxi-15314.firebaseapp.com",
  databaseURL:"https://taxi-15314-default-rtdb.firebaseio.com/",
  projectId:"taxi-15314"
});
const db=firebase.database();

let map=L.map('map').setView([33.3152,44.3661],13);
L.tileLayer("https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}&key=AIzaSyD7TtwniAdUtB8-pnTny4ZwE6gqX36SGUk",{maxZoom:20}).addTo(map);

let driverMarker=null;
let driverPhone=localStorage.getItem("phone");
let currentRideId=null;
let passengerMarker=null;
let pickupRoute=null;
let destinationRoute=null;
let currentRideData=null;

// === Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø·ÙˆØ± ===
let audioContext=null, ringingInterval=null;
function activateAudio(){
    if(!audioContext){
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙ…Øª Ø§Ù„Ø£ÙˆÙ„ÙŠ Ù„ØªØ¬Ø§ÙˆØ² Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…ØªØµÙØ­
        let buffer = audioContext.createBuffer(1, 1, 22050);
        let source = audioContext.createBufferSource();
        source.buffer = buffer;
        source.connect(audioContext.destination);
        source.start(0);
    }
    document.getElementById("audioOverlay").style.display = "none";
}

function startRinging(){
    if(!audioContext) return;
    if(ringingInterval) return;

    const playTone = () => {
        let osc = audioContext.createOscillator();
        let gain = audioContext.createGain();
        
        osc.type = 'triangle'; 
        osc.frequency.setValueAtTime(880, audioContext.currentTime); // ØªØ±Ø¯Ø¯ Ø¹Ø§Ù„ÙŠ ÙˆÙˆØ§Ø¶Ø­
        
        gain.gain.setValueAtTime(1.0, audioContext.currentTime); // Ø£Ù‚ØµÙ‰ Ø´Ø¯Ø© ØµÙˆØª (100%)
        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.8);
        
        osc.connect(gain);
        gain.connect(audioContext.destination);
        
        osc.start();
        osc.stop(audioContext.currentTime + 0.8);
    };
    playTone();
    ringingInterval = setInterval(playTone, 1500);
}

function stopRinging(){
    if(ringingInterval){ clearInterval(ringingInterval); ringingInterval=null; }
}

// === Ø§Ù„Ù…ÙˆÙ‚Ø¹ ===
function updateLocation(){
    navigator.geolocation.getCurrentPosition(pos=>{
        let lat=pos.coords.latitude, lng=pos.coords.longitude;
        if(driverMarker) map.removeLayer(driverMarker);
        driverMarker=L.marker([lat,lng]).addTo(map).bindPopup("ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ");
        
        db.ref("drivers/"+driverPhone).update({lat:lat,lng:lng,status:"Ù…ØªØµÙ„"});
        
        if (!currentRideId) {
            map.setView([lat, lng], 15);
            document.getElementById("status").innerText = "ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª...";
        }
    },err=>{
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹", err);
    },{enableHighAccuracy:true});
}

function initApp(){
    let phone=localStorage.getItem("phone");
    let type=localStorage.getItem("userType");
    if(!phone||type!=="driver"){ window.location.href="index.html"; return; }
    
    updateMapHeight();
    updateLocation(); // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙÙˆØ±ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„
    setInterval(updateLocation, 5000); // ØªØ­Ø¯ÙŠØ« Ø¯ÙˆØ±ÙŠ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ
}

function logout(){ localStorage.clear(); window.location.href="index.html"; }

function updateMapHeight(){
    const panelHeight = document.getElementById("panel").offsetHeight;
    document.getElementById("map").style.height = `calc(100vh - ${panelHeight}px)`;
    map.invalidateSize();
}

async function drawStreetRoute(lat1, lng1, lat2, lng2, color) {
    try {
        const response = await fetch(`https://router.project-osrm.org/route/v1/driving/${lng1},${lat1};${lng2},${lat2}?geometries=geojson&overview=full`);
        const data = await response.json();
        if (data.code === 'Ok' && data.routes.length > 0) {
            const coords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
            return L.polyline(coords, { color: color, weight: 6 }).addTo(map);
        }
    } catch (e) {}
    return L.polyline([[lat1, lng1], [lat2, lng2]], { color: color, weight: 6, dashArray: '10, 10' }).addTo(map);
}

function openWaze(){
    if(!currentRideData) return;
    let lat = (currentRideData.status === "Ù…Ù‚Ø¨ÙˆÙ„Ø©") ? currentRideData.startLat : currentRideData.endLat;
    let lng = (currentRideData.status === "Ù…Ù‚Ø¨ÙˆÙ„Ø©") ? currentRideData.startLng : currentRideData.endLng;
    if(lat && lng) window.open(`https://www.waze.com/ul?ll=${lat},${lng}&navigate=yes`, '_blank');
}

function getShortAreaName(fullArea) {
    if (!fullArea) return "Ù…Ù†Ø·Ù‚Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©";
    return fullArea.split(',')[0].trim();
}

const statusText=document.getElementById("status");
const acceptBtn=document.getElementById("acceptBtn");
const rejectBtn=document.getElementById("rejectBtn");
const startRideBtn=document.getElementById("startRideBtn");
const finishBtn=document.getElementById("finishBtn");
const wazeBtn=document.getElementById("wazeBtn");
const logoutBtn=document.getElementById("logoutBtn"); 
const floatingControls=document.getElementById("floatingControls");
const riderContactInfo=document.getElementById("riderContactInfo");

// === Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª ===
db.ref("rides").on("value",snap=>{
    let data=snap.val();
    if(!data) return;

    let rideFound=false;
    Object.keys(data).forEach(id=>{
        let r=data[id];
        if(r.status==="Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©" && r.targetDrivers && r.targetDrivers.includes(driverPhone) && !rideFound){
            rideFound=true;
            showRideRequest(id,r);
        }
        else if((r.status==="Ù…Ù‚Ø¨ÙˆÙ„Ø©" || r.status==="Ø¨Ø¯Ø£Øª") && r.driverPhone===driverPhone){
             rideFound=true;
             r.status==="Ù…Ù‚Ø¨ÙˆÙ„Ø©" ? handleAcceptedRide(id,r) : handleStartedRide(id,r);
        }
    });

    if(!rideFound){
        stopRinging(); 
        resetUI();
    }
});

function showRideRequest(id,r){
    currentRideId=id; 
    startRinging();
    document.getElementById("panel").style.display="block";
    updateMapHeight();

    statusText.innerHTML= `ğŸš– Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† ${getShortAreaName(r.startArea)}<br>Ø§Ù„Ø£Ø¬Ø±Ø©: ${r.fare.toLocaleString()} Ø¯.Ø¹`;
    acceptBtn.style.display="inline-block";
    rejectBtn.style.display="inline-block";

    acceptBtn.onclick=()=> db.ref("rides/"+id).update({status:"Ù…Ù‚Ø¨ÙˆÙ„Ø©", driverPhone:driverPhone, targetDrivers: null});
    rejectBtn.onclick=()=> { stopRinging(); db.ref("rides/"+id).update({status:"Ù…Ø±ÙÙˆØ¶Ø©"}); };
}

async function handleAcceptedRide(id,r){
    currentRideId=id; currentRideData=r; stopRinging();
    document.getElementById("panel").style.display="none"; 
    floatingControls.style.display="flex"; 
    startRideBtn.style.display="inline-block";
    wazeBtn.innerText = "ÙˆÙŠØ²: Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø±Ø§ÙƒØ¨ ğŸ“";
    riderContactInfo.style.display="block";
    riderContactInfo.innerHTML = `<a href="tel:${r.riderPhone}" class="phone-link">ğŸ“ Ø§ØªØµÙ„ Ø¨Ø§Ù„Ø±Ø§ÙƒØ¨</a>`;

    if(passengerMarker) map.removeLayer(passengerMarker);
    passengerMarker=L.marker([r.startLat, r.startLng]).addTo(map).bindPopup("ğŸ‘¤ Ø§Ù„Ø±Ø§ÙƒØ¨ Ù‡Ù†Ø§").openPopup();
    map.panTo([r.startLat, r.startLng]);

    startRideBtn.onclick=()=>db.ref("rides/"+id).update({status:"Ø¨Ø¯Ø£Øª"});
}

async function handleStartedRide(id,r){
    currentRideId=id; currentRideData=r;
    startRideBtn.style.display="none";
    finishBtn.style.display="inline-block";
    wazeBtn.innerText = "ÙˆÙŠØ²: ÙˆØ¬Ù‡Ø© Ø§Ù„ÙˆØµÙˆÙ„ ğŸ";
    
    if(passengerMarker) map.removeLayer(passengerMarker);
    L.marker([r.endLat, r.endLng]).addTo(map).bindPopup("ğŸ Ø§Ù„ÙˆØ¬Ù‡Ø©").openPopup();
    
    finishBtn.onclick=()=>db.ref("rides/"+id).update({status:"Ù…Ù†ØªÙ‡ÙŠØ©"});
}

function resetUI(){
    currentRideId=null;
    acceptBtn.style.display="none"; rejectBtn.style.display="none";
    floatingControls.style.display="none";
    document.getElementById("panel").style.display="block";
    statusText.innerText="ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª...";
    updateMapHeight();
}
</script>
</body>
</html>
