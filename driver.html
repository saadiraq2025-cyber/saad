<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¨Ù„ÙŠ - Ø§Ù„ÙƒØ§Ø¨ØªÙ†</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, sans-serif; background: #eee; overflow: hidden; }
        #map { height: 100%; width: 100%; z-index: 1; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ (Ø§Ù„Ø£ÙˆÙ„Ù‰) */
        .offline-overlay {
            position: absolute; bottom: 120px; left: 0; right: 0;
            z-index: 2000; display: flex; justify-content: center;
            pointer-events: none;
        }
        .btn-activate {
            pointer-events: auto;
            background: #2196F3; color: white; border: none;
            padding: 15px 40px; border-radius: 50px;
            font-size: 18px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 20px rgba(33, 150, 243, 0.5);
            display: flex; align-items: center; gap: 10px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(33, 150, 243, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(33, 150, 243, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(33, 150, 243, 0); }
        }

        /* Ù†Ø§ÙØ°Ø© Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ (Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©) */
        .request-sheet {
            position: fixed; bottom: -100%; left: 0; right: 0;
            background: white; z-index: 3000;
            border-radius: 25px 25px 0 0; padding: 25px;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
            transition: bottom 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex; flex-direction: column;
        }
        .request-sheet.show { bottom: 0; }

        .sheet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .service-badge { background: #e3f2fd; color: #1976d2; padding: 6px 15px; border-radius: 20px; font-weight: bold; font-size: 14px; }
        .price-display { font-size: 26px; font-weight: 900; color: #333; }

        /* ØªØµÙ…ÙŠÙ… Ø®Ø· Ø§Ù„Ø±Ø­Ù„Ø© */
        .trip-timeline { margin-bottom: 25px; padding-right: 15px; border-right: 2px solid #eee; margin-right: 10px; }
        .timeline-item { position: relative; margin-bottom: 25px; }
        .timeline-item:last-child { margin-bottom: 0; }
        
        .timeline-dot {
            position: absolute; right: -22px; top: 3px;
            width: 12px; height: 12px; border-radius: 50%;
            z-index: 2; box-shadow: 0 0 0 4px white;
        }
        .dot-green { background: #4CAF50; }
        .dot-black { background: #000; }

        .info-title { font-size: 13px; color: #888; display: flex; gap: 10px; margin-bottom: 3px; }
        .info-address { font-size: 15px; font-weight: 600; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… */
        .btn-accept {
            background: #2962ff; color: white; border: none;
            width: 100%; padding: 18px; border-radius: 15px;
            font-size: 18px; font-weight: bold; cursor: pointer;
            box-shadow: 0 5px 15px rgba(41, 98, 255, 0.3);
        }
        
        .btn-reject {
            position: absolute; top: 20px; left: 20px;
            background: #f5f5f5; border: none; width: 35px; height: 35px;
            border-radius: 50%; color: #666; font-size: 20px; cursor: pointer;
        }

        /* Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø© */
        .active-ride-panel {
            position: fixed; top: 10px; left: 10px; right: 10px;
            background: white; padding: 15px; border-radius: 12px;
            z-index: 2500; box-shadow: 0 4px 20px rgba(0,0,0,0.15); display: none;
        }
        .rider-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .btn-action { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; }
        
        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ùˆ Waze */
        .contact-actions { display: flex; gap: 10px; }
        .btn-call { background: #4CAF50; color: white; padding: 8px 15px; text-decoration: none; border-radius: 8px; display: inline-flex; align-items: center; font-weight: bold; font-size: 14px; }
        .btn-waze { background: #33ccff; color: white; padding: 8px 15px; text-decoration: none; border-radius: 8px; display: inline-flex; align-items: center; font-weight: bold; font-size: 14px; }

        .btn-finish { background: #f44336; color: white; }

        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© */
        .bottom-nav {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: white; height: 75px; border-top: 1px solid #f0f0f0;
            display: flex; justify-content: space-around; align-items: center;
            z-index: 1000;
        }
        .nav-icon { font-size: 24px; color: #bbb; cursor: pointer; }
        .nav-icon.active { color: #2196F3; font-size: 32px; filter: drop-shadow(0 4px 10px rgba(33, 150, 243, 0.4)); }
    </style>
</head>
<body>

<div id="map"></div>

<div class="offline-overlay" id="activateBtn">
    <button class="btn-activate" onclick="goOnline()">
        <span>ğŸš€</span> Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¹Ù…Ù„
    </button>
</div>

<div class="request-sheet" id="requestSheet">
    <button class="btn-reject" onclick="rejectRide()">âœ•</button>
    
    <div class="sheet-header">
        <div class="service-badge">âš¡ Ø³ÙˆØ¨Ø±</div>
        <div class="price-display"><span id="reqFare">0</span> Ø¯.Ø¹</div>
    </div>

    <div class="trip-timeline">
        <div class="timeline-item">
            <div class="timeline-dot dot-green"></div>
            <div class="info-title">
                <span>ğŸ“ Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</span>
                <b style="color:#2196F3" id="distToPickup">-- Ø¯Ù‚ÙŠÙ‚Ø©</b>
            </div>
            <div class="info-address" id="pickupAddr">...</div>
        </div>

        <div class="timeline-item">
            <div class="timeline-dot dot-black"></div>
            <div class="info-title">
                <span>ğŸ Ø§Ù„ÙˆØ¬Ù‡Ø©</span>
                <b id="tripDist">-- ÙƒÙ…</b>
            </div>
            <div class="info-address" id="dropoffAddr">...</div>
        </div>
    </div>

    <button class="btn-accept" id="acceptBtn">Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©</button>
</div>

<div class="active-ride-panel" id="activePanel">
    <div class="rider-row">
        <div>
            <div style="font-size: 14px; color: #888;">Ø§Ù„Ø±Ø§ÙƒØ¨</div>
            <b style="font-size: 18px;" id="riderPhone">07XXXXXXXX</b>
        </div>
        <div class="contact-actions">
            <a href="#" id="wazeBtn" class="btn-waze" target="_blank">ğŸš™ Waze</a>
            <a href="#" id="callBtn" class="btn-call">ğŸ“ Ø§ØªØµØ§Ù„</a>
        </div>
    </div>
    <button class="btn-action btn-finish" onclick="finishRide()">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>
</div>

<div class="bottom-nav">
    <div class="nav-icon">ğŸ </div>
    <div class="nav-icon">ğŸ“Š</div>
    <div class="nav-icon active">ğŸ”˜</div>
    <div class="nav-icon">ğŸ’¬</div>
    <div class="nav-icon">âš™ï¸</div>
</div>

<script>
// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
const firebaseConfig = { apiKey: "AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M", databaseURL: "https://taxi-15314-default-rtdb.firebaseio.com/" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
let map, driverMarker;
let isOnline = false;
let currentRideKey = null;
const driverPhone = localStorage.getItem("phone") || "07800000000";

// Ù…Ù„Ù Ø§Ù„ØµÙˆØª
const alertSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3');
alertSound.loop = true;

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©
function initMap() {
    map = L.map('map', {zoomControl: false}).setView([33.3152, 44.3661], 13);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
    
    // Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚
    const driverIcon = L.divIcon({
        html: '<div style="background:#2196F3; width:20px; height:20px; border-radius:50%; border:3px solid white; box-shadow:0 0 10px rgba(0,0,0,0.3);"></div>',
        className: 'driver-dot',
        iconSize: [26, 26]
    });
    driverMarker = L.marker([33.3152, 44.3661], {icon: driverIcon}).addTo(map);
}

// ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ù…ØªØµÙ„
function goOnline() {
    isOnline = true;
    document.getElementById('activateBtn').style.display = 'none';
    
    alertSound.play().then(() => {
        alertSound.pause();
        alertSound.currentTime = 0;
    }).catch(e => console.log("Audio requires interaction"));

    listenForRides();
    
    if(navigator.geolocation) {
        navigator.geolocation.watchPosition(pos => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            driverMarker.setLatLng([lat, lng]);
            map.panTo([lat, lng]);
            
            db.ref("drivers/" + driverPhone).set({
                lat: lat,
                lng: lng,
                lastUpdate: Date.now()
            });
        });
    }
}

// Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø·Ù„Ø¨Ø§Øª
function listenForRides() {
    db.ref("rides").off();
    db.ref("rides").orderByChild("status").equalTo("Ø¬Ø¯ÙŠØ¯Ø©").on("child_added", snap => {
        if(!isOnline || currentRideKey) return;

        const r = snap.val();
        const rideTime = parseInt(snap.key);
        const now = Date.now();

        if (now - rideTime < 30 * 60 * 1000) {
            showRequest(snap.key, r);
        }
    });
}

// Ø¥Ø¸Ù‡Ø§Ø± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø·Ù„Ø¨
function showRequest(key, r) {
    currentRideKey = key;
    alertSound.play().catch(e => console.error(e));

    document.getElementById('reqFare').innerText = r.fare;
    document.getElementById('pickupAddr').innerText = r.startName || "Ù…ÙˆÙ‚Ø¹ Ù…Ø­Ø¯Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©";
    document.getElementById('dropoffAddr').innerText = r.endName || "ÙˆØ¬Ù‡Ø© Ù…Ø­Ø¯Ø¯Ø©";

    try {
        if(r.start) {
            const driverLoc = driverMarker.getLatLng();
            const pickupLoc = L.latLng(r.start[0], r.start[1]);
            const distM = driverLoc.distanceTo(pickupLoc);
            document.getElementById('distToPickup').innerText = Math.ceil(distM / 400) + " Ø¯Ù‚ÙŠÙ‚Ø©";
        }
        if(r.start && r.end) {
            const p1 = L.latLng(r.start[0], r.start[1]);
            const p2 = L.latLng(r.end[0], r.end[1]);
            const distK = (p1.distanceTo(p2) / 1000).toFixed(1);
            document.getElementById('tripDist').innerText = distK + " ÙƒÙ…";
        }
    } catch(e) {}

    document.getElementById('requestSheet').classList.add('show');
    document.getElementById('acceptBtn').onclick = () => acceptRide(key, r);
}

// Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©
function acceptRide(key, r) {
    alertSound.pause();
    alertSound.currentTime = 0;
    
    db.ref("rides/" + key).update({
        status: "Ù…Ù‚Ø¨ÙˆÙ„Ø©",
        driverPhone: driverPhone
    });

    document.getElementById('requestSheet').classList.remove('show');
    showActiveRide(r);
}

// Ø±ÙØ¶ Ø§Ù„Ø±Ø­Ù„Ø©
function rejectRide() {
    alertSound.pause();
    alertSound.currentTime = 0;
    document.getElementById('requestSheet').classList.remove('show');
    currentRideKey = null;
}

// ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø© (Ù…Ø¹ Ø²Ø± Waze)
function showActiveRide(r) {
    document.getElementById('activePanel').style.display = 'block';
    document.getElementById('riderPhone').innerText = r.riderPhone;
    document.getElementById('callBtn').href = "tel:" + r.riderPhone;

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø±Ø§Ø¨Ø· Waze
    if (r.start) {
        // Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠÙØªØ­ Waze ÙˆÙŠØ¨Ø¯Ø£ Ø§Ù„Ù…Ù„Ø§Ø­Ø© Ø¥Ù„Ù‰ Ù†Ù‚Ø·Ø© Ø§Ù†Ø·Ù„Ø§Ù‚ Ø§Ù„Ø±Ø§ÙƒØ¨
        const wazeUrl = `https://www.waze.com/ul?ll=${r.start[0]},${r.start[1]}&navigate=yes`;
        document.getElementById('wazeBtn').href = wazeUrl;
    }

    if(r.start && r.end) {
        L.marker(r.start, {icon: L.divIcon({className: 'timeline-dot dot-green', html: ''})}).addTo(map);
        L.marker(r.end, {icon: L.divIcon({className: 'timeline-dot dot-black', html: ''})}).addTo(map);
        map.fitBounds([r.start, r.end, driverMarker.getLatLng()], {padding: [50,50]});
    }
}

// Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©
function finishRide() {
    if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©ØŸ")) {
        if(currentRideKey) {
            db.ref("rides/" + currentRideKey).update({status: "Ù…Ù†ØªÙ‡ÙŠØ©"});
            location.reload();
        }
    }
}

initMap();
</script>
</body>
</html>
