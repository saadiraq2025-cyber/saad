<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø³Ø§Ø¦Ù‚ - ØªÙƒØ³ÙŠ Ø§Ù„Ø¹Ø±Ø§Ù‚ Ø§Ù„Ø´Ø§Ù…Ù„</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body,html{margin:0;padding:0;height:100%;font-family:Tahoma;}
#map{height:60vh;}
#panel{
    background:#fff;padding:10px;text-align:center;
    box-shadow:0 -2px 5px rgba(0,0,0,0.2);
}
button{
    background:#ffb300;border:none;padding:10px 20px;
    border-radius:8px;margin:5px;font-weight:bold;
    cursor:pointer;
}
#logoutBtn{
    background:#455a64;color:white;margin-top:10px;width:95%;
}
#wazeBtn{
    background:#1E90FF;color:white;
}
</style>
</head>
<body>

<div id="map"></div>

<div id="panel">
    <h3>ğŸš– ÙˆØ¶Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚</h3>
    <p id="status">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p>
    
    <button id="wazeBtn" style="display:none;" onclick="openWaze()">ÙˆÙŠØ² Ø­Ø¯Ø« ğŸ—ºï¸</button>
    <br>

    <button id="acceptBtn" style="display:none;background:#4caf50;color:white;">Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©</button>
    <button id="rejectBtn" style="display:none;background:#e53935;color:white;">Ø±ÙØ¶ Ø§Ù„Ø±Ø­Ù„Ø©</button>
    
    <button id="startRideBtn" style="display:none;background:#ff9800;color:white;">Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© ğŸš¦</button> 

    <button id="finishBtn" style="display:none;background:#1e88e5;color:white;">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>

    <button id="logoutBtn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</div>

<script>
// Ù…Ù†Ø¹ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¯ÙˆÙ† Ø­Ø³Ø§Ø¨
window.onload=function(){
    let phone=localStorage.getItem("phone");
    let type=localStorage.getItem("userType");
    if(!phone||type!=="driver"){
        window.location.href="index.html";
    }
};

function logout(){
    localStorage.clear();
    window.location.href="index.html";
}

// Firebase
const app=firebase.initializeApp({
  apiKey:"AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M",
  authDomain:"taxi-15314.firebaseapp.com",
  databaseURL:"https://taxi-15314-default-rtdb.firebaseio.com/",
  projectId:"taxi-15314"
});
const db=firebase.database();

// Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
let map=L.map('map').setView([33.3152,44.3661],13);

// â­â­ ØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¨Ø®Ø±ÙŠØ·Ø© OpenStreetMap Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ© â­â­
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

map.whenReady(()=>map.invalidateSize());

// Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚
let driverMarker=null;
let driverPhone=localStorage.getItem("phone");

// ===== Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø±Ø­Ù„Ø© ÙˆØ§Ù„Ù…Ø³Ø§Ø±Ø§Øª =====
let currentRideId=null;
let passengerMarker=null;
let pickupRoute=null; // Ù…Ø³Ø§Ø± Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (Ù…Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù„Ù„Ø±Ø§ÙƒØ¨)
let destinationRoute=null; // Ù…Ø³Ø§Ø± Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© (Ù…Ù† Ø§Ù„Ø±Ø§ÙƒØ¨ Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ©)
let currentRideData=null;
// ===========================================

// ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†Ù
setInterval(()=>{
    navigator.geolocation.getCurrentPosition(pos=>{
        let lat=pos.coords.latitude;
        let lng=pos.coords.longitude;

        if(driverMarker) map.removeLayer(driverMarker);
        driverMarker=L.marker([lat,lng]).addTo(map).bindPopup("ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ");

        db.ref("drivers/"+driverPhone).set({
            lat:lat,lng:lng,status:"Ù…ØªØµÙ„"
        });

    },err=>{},{
        enableHighAccuracy:true,timeout:5000
    });
},5000);

// Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ù…Ø³Ø§Ø±Ø§Øª ÙˆØ§Ù„Ù…Ø¤Ø´Ø±Ø§Øª
function removeAllRideMarkers(){
    if(passengerMarker) map.removeLayer(passengerMarker);
    if(pickupRoute) map.removeLayer(pickupRoute);
    if(destinationRoute) map.removeLayer(destinationRoute);
    passengerMarker=null;
    pickupRoute=null;
    destinationRoute=null;
}

// Ø¹Ø±Ø¶ Ù…Ø³Ø§Ø± (polyline) Ø¨Ø³ÙŠØ· Ø¨ÙŠÙ† Ù†Ù‚Ø·ØªÙŠÙ† (Ù„Ù„ØªÙˆØ¶ÙŠØ­ØŒ ÙŠØ¬Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø¯Ù…Ø© Ù…Ø³Ø§Ø±Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ©)
function drawRoute(coords, color, dashArray=''){
    let route=L.polyline(coords,{color:color,dashArray:dashArray,weight:5}).addTo(map);
    return route;
}

// ÙØªØ­ Waze
function openWaze(){
    if(currentRideData && currentRideData.startLat && currentRideData.startLng){
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù†Ù‚Ø·Ø© Ø§Ù†Ø·Ù„Ø§Ù‚ Ø§Ù„Ø±Ø§ÙƒØ¨ ÙƒÙˆØ¬Ù‡Ø© ÙÙŠ Waze
        let lat=currentRideData.startLat;
        let lng=currentRideData.startLng;
        window.open(`https://www.waze.com/ul?ll=${lat},${lng}&navigate=yes`, '_blank');
    }
}


// Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
const statusText=document.getElementById("status");
const acceptBtn=document.getElementById("acceptBtn");
const rejectBtn=document.getElementById("rejectBtn");
const startRideBtn=document.getElementById("startRideBtn"); // Ø§Ù„Ø²Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
const finishBtn=document.getElementById("finishBtn");
const wazeBtn=document.getElementById("wazeBtn");

db.ref("rides").on("value",snap=>{
    let data=snap.val();
    if(!data) return;

    let rideFound=false;

    Object.keys(data).forEach(id=>{
        let r=data[id];
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        if(r.status==="Ø¬Ø¯ÙŠØ¯Ø©" && !rideFound){
            rideFound=true;
            showRideRequest(id,r);
        }
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹
        else if(r.status==="Ù…Ù‚Ø¨ÙˆÙ„Ø©" && r.driverPhone===driverPhone){
             rideFound=true;
             handleAcceptedRide(id,r);
        }
    });

    if(!rideFound){
        removeAllRideMarkers();
        currentRideId=null;
        currentRideData=null;
        acceptBtn.style.display="none";
        rejectBtn.style.display="none";
        startRideBtn.style.display="none";
        finishBtn.style.display="none";
        wazeBtn.style.display="none";
        statusText.innerText="ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª...";
    }
});

function showRideRequest(id,r){
    currentRideId=id;
    currentRideData=r;
    
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
    startRideBtn.style.display="none";
    finishBtn.style.display="none";
    wazeBtn.style.display="none";
    removeAllRideMarkers();


    statusText.innerHTML=
      `ğŸš– Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯<br>Ù…Ù†: <b>${r.startArea}</b><br>Ø¥Ù„Ù‰: <b>${r.endArea}</b><br>Ø§Ù„Ù…Ø³Ø§ÙØ©: ${r.distance} ÙƒÙ…`;

    acceptBtn.style.display="inline-block";
    rejectBtn.style.display="inline-block";

    // **ØªÙ†ÙÙŠØ° Ø·Ù„Ø¨Ùƒ: Ø¹Ù†Ø¯ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©**
    acceptBtn.onclick=function(){
        db.ref("rides/"+id).update({status:"Ù…Ù‚Ø¨ÙˆÙ„Ø©",driverPhone:driverPhone});
        // ÙŠØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£Ù…ÙˆØ± ÙÙŠ Ø¯Ø§Ù„Ø© handleAcceptedRide
    };

    rejectBtn.onclick=function(){
        db.ref("rides/"+id).update({status:"Ù…Ø±ÙÙˆØ¶Ø©"});
        statusText.innerText="ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø±Ø­Ù„Ø©.";
        acceptBtn.style.display="none";
        rejectBtn.style.display="none";
    };
}

function handleAcceptedRide(id,r){
    currentRideId=id;
    currentRideData=r;
    
    acceptBtn.style.display="none";
    rejectBtn.style.display="none";
    startRideBtn.style.display="inline-block"; // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¨Ø¯Ø¡
    finishBtn.style.display="none"; // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡ Ù…Ø¤Ù‚ØªØ§Ù‹
    wazeBtn.style.display="inline-block"; // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± ÙˆÙŠØ²

    removeAllRideMarkers();
    
    // **ØªÙ†ÙÙŠØ° Ø·Ù„Ø¨Ùƒ: Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§Ø± Ø§Ù„Ø±Ø§ÙƒØ¨**
    if(r.startLat && r.startLng && driverMarker){
        let driverCoords=[driverMarker.getLatLng().lat, driverMarker.getLatLng().lng];
        let passengerCoords=[r.startLat, r.startLng];
        
        // Ø±Ø³Ù… Ù…Ø³Ø§Ø± Ù…Ù† Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø§ÙƒØ¨ (Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©) - Ø®Ø· Ù…ØªÙ‚Ø·Ø¹
        pickupRoute=drawRoute([driverCoords, passengerCoords], '#4caf50', '10, 10'); 

        // ÙˆØ¶Ø¹ Ù…Ø¤Ø´Ø± Ø§Ù„Ø±Ø§ÙƒØ¨
        passengerMarker=L.marker(passengerCoords).addTo(map).bindPopup("ğŸ‘¤ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø±Ø§ÙƒØ¨");
        map.setView(passengerCoords, 14); // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§ÙƒØ¨

    }

    statusText.innerHTML=`ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©. ÙÙŠ Ø·Ø±ÙŠÙ‚Ùƒ Ù„Ù„Ø±Ø§ÙƒØ¨...`;


    // **ØªÙ†ÙÙŠØ° Ø·Ù„Ø¨Ùƒ: Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© (Ø²Ø± Ø¬Ø¯ÙŠØ¯)**
    startRideBtn.onclick=function(){
        db.ref("rides/"+id).update({status:"Ø¨Ø¯Ø£Øª"});
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø¨Ø¯Ø¡
        startRideBtn.style.display="none";
        finishBtn.style.display="inline-block";

        // **ØªÙ†ÙÙŠØ° Ø·Ù„Ø¨Ùƒ: Ø¥Ø¸Ù‡Ø§Ø± Ø±Ù‚Ù… Ø§Ù„Ø±Ø§ÙƒØ¨ ØªØ´Ø¹Ø¨ÙŠ**
        statusText.innerHTML=`
            Ø§Ù„Ø±Ø­Ù„Ø© Ø¨Ø¯Ø£Øª! Ø±Ù‚Ù… Ø§Ù„Ø±Ø§ÙƒØ¨: 
            <a href="tel:${r.passengerPhone}">
                **${r.passengerPhone}**
            </a>
            <br>
            Ø§Ù„ÙˆØ¬Ù‡Ø©: **${r.endArea}**
        `;

        // **ØªÙ†ÙÙŠØ° Ø·Ù„Ø¨Ùƒ: Ù…Ø³Ø§Ø± Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ©**
        if(pickupRoute) map.removeLayer(pickupRoute); // Ù…Ø³Ø­ Ù…Ø³Ø§Ø± Ø§Ù„Ù‚Ø¨ÙˆÙ„
        
        if(r.startLat && r.startLng && r.endLat && r.endLng){
            let startCoords=[r.startLat, r.startLng];
            let endCoords=[r.endLat, r.endLng];
            
            // Ø±Ø³Ù… Ù…Ø³Ø§Ø± Ù…Ù† Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø¥Ù„Ù‰ Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© - Ø®Ø· ØµÙ„Ø¨
            destinationRoute=drawRoute([startCoords, endCoords], '#1e88e5');

            // ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø± Ø§Ù„Ø±Ø§ÙƒØ¨ Ù„ÙŠÙƒÙˆÙ† ÙÙŠ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
            if(passengerMarker) map.removeLayer(passengerMarker);
            passengerMarker=L.marker(startCoords).addTo(map).bindPopup("ğŸŸ¢ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©").openPopup();
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø± Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
            L.marker(endCoords).addTo(map).bindPopup("ğŸ Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ©");
            map.fitBounds([startCoords, endCoords]); // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
        }
    };
    
    // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©
    finishBtn.onclick=function(){
        db.ref("rides/"+id).update({status:"Ù…Ù†ØªÙ‡ÙŠØ©"});
        // Ù…Ø³Ø­ ÙƒÙ„ Ø´ÙŠØ¦
        removeAllRideMarkers();
        finishBtn.style.display="none";
        wazeBtn.style.display="none";
        statusText.innerText="ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©.";
    };
}
</script>

</body>
</html>
