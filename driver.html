<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>بلي كابتن</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        :root { --baly-yellow: #FFD200; --baly-black: #1A1A1A; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; overflow: hidden; }
        #map { height: 100%; width: 100%; }

        /* شريط الحالة */
        .top-bar {
            position: absolute; top: 15px; left: 15px; right: 15px;
            background: var(--baly-black); color: white; padding: 15px;
            border-radius: 12px; text-align: center; z-index: 1000; font-weight: bold;
        }

        /* بطاقة الطلب الجديد */
        .new-ride-card {
            position: absolute; bottom: 20px; left: 15px; right: 15px;
            background: white; border-radius: 20px; padding: 25px;
            z-index: 2000; box-shadow: 0 -5px 25px rgba(0,0,0,0.2);
            display: none; text-align: center;
        }
        .new-ride-card.active { display: block; animation: slideUp 0.4s ease; }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .btn-accept {
            background: var(--baly-yellow); border: none; width: 100%;
            padding: 18px; border-radius: 12px; font-weight: 900;
            font-size: 20px; cursor: pointer; margin-top: 15px;
        }

        .action-btns {
            position: absolute; bottom: 20px; left: 15px; right: 15px;
            z-index: 1500; display: none;
        }
        .btn-step {
            width: 100%; padding: 18px; border-radius: 12px; border: none;
            font-weight: bold; font-size: 18px; margin-top: 10px;
        }
    </style>
</head>
<body>

<div class="top-bar" id="statusHeader">أنت متصل - بانتظار طلبات</div>
<div id="map"></div>

<div class="new-ride-card" id="popCard">
    <div style="color: #666; font-size: 14px;">رحلة جديدة متاحة</div>
    <div id="popFare" style="font-size: 32px; font-weight: 900; margin: 10px 0;">0 د.ع</div>
    <div id="popDist" style="color: #28a745; font-weight: bold;">تبعد 2.5 كم</div>
    <button class="btn-accept" id="acceptBtn">قـبـول الـطـلـب</button>
</div>

<div class="action-btns" id="controls">
    <button id="arrivedBtn" class="btn-step" style="background: white; border: 2px solid black;">لقد وصلت للموقع</button>
    <button id="startBtn" class="btn-step" style="background: var(--baly-yellow); display:none;">بدء الرحلة الآن</button>
    <button id="endBtn" class="btn-step" style="background: #E53935; color: white; display:none;">إنهاء الرحلة وتحصيل المبلغ</button>
</div>

<script>
const app = firebase.initializeApp({
  apiKey: "AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M",
  databaseURL: "https://taxi-15314-default-rtdb.firebaseio.com/"
});
const db = firebase.database();

let map = L.map('map', {zoomControl: false}).setView([33.3152, 44.3661], 13);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

let driverMarker = L.marker([33.3152, 44.3661]).addTo(map);
const phone = localStorage.getItem("phone");

// تحديث موقع السائق باستمرار
setInterval(() => {
    navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        driverMarker.setLatLng([lat, lng]);
        db.ref("drivers/"+phone).update({lat, lng, lastSeen: Date.now()});
    });
}, 4000);

// مراقبة الرحلات الجديدة
db.ref("rides").on("value", snap => {
    const rides = snap.val();
    if(!rides) return;
    Object.keys(rides).forEach(id => {
        const r = rides[id];
        if(r.status === "جديدة") {
            document.getElementById('popFare').innerText = r.fare;
            document.getElementById('popCard').classList.add('active');
            document.getElementById('acceptBtn').onclick = () => acceptRide(id);
        }
    });
});

function acceptRide(id) {
    db.ref("rides/"+id).update({status: "مقبولة", driverPhone: phone});
    document.getElementById('popCard').classList.remove('active');
    document.getElementById('controls').style.display = 'block';
    document.getElementById('statusHeader').innerText = "توجه لموقع الراكب";
}

document.getElementById('arrivedBtn').onclick = function() {
    this.style.display = 'none';
    document.getElementById('startBtn').style.display = 'block';
    document.getElementById('statusHeader').innerText = "بانتظار صعود الراكب";
};

document.getElementById('startBtn').onclick = function() {
    this.style.display = 'none';
    document.getElementById('endBtn').style.display = 'block';
    document.getElementById('statusHeader').innerText = "الرحلة مستمرة...";
};

document.getElementById('endBtn').onclick = function() {
    alert("تم إنهاء الرحلة بنجاح");
    location.reload();
};
</script>
</body>
</html>
