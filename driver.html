<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø³Ø§Ø¦Ù‚ - ØªÙƒØ³ÙŠ Ø§Ù„Ø¹Ø±Ø§Ù‚ Ø§Ù„Ø´Ø§Ù…Ù„</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<style>
body,html{margin:0;padding:0;height:100%;font-family:Tahoma;overflow:hidden;display:flex;flex-direction:column;}
#map{flex-grow:1;width:100%;}
#panel{background:#fff;padding:15px;text-align:center;box-shadow:0 -2px 10px rgba(0,0,0,0.1);z-index:1001;}
#status{font-size:1.2em;font-weight:bold;color:#333;margin-bottom:10px;}
button{padding:12px 20px;border-radius:10px;border:none;font-weight:bold;cursor:pointer;margin:5px;}
#acceptBtn{background:#4caf50;color:white;}
#rejectBtn{background:#f44336;color:white;}
#floatingControls{position:absolute;bottom:20px;left:20px;z-index:1000;display:flex;flex-direction:column;gap:10px;}
.float-btn{background:#32CCFE;color:white;box-shadow:0 4px 8px rgba(0,0,0,0.2);width:150px;}
.phone-link{background:#fff;padding:10px;border-radius:10px;text-decoration:none;color:#007bff;font-weight:bold;border:1px solid #007bff;}
</style>
</head>
<body onclick="initAudio()">
<div id="map"></div>
<div id="floatingControls" style="display:none;">
    <a id="callRider" class="phone-link" href="#">ğŸ“ Ø§ØªØµÙ„ Ø¨Ø§Ù„Ø±Ø§ÙƒØ¨</a>
    <button class="float-btn" onclick="openWaze()">ÙØªØ­ ÙˆÙŠØ² ğŸ—ºï¸</button>
    <button id="actionBtn" style="background:#ff9800;color:white;width:150px;"></button>
</div>
<div id="panel">
    <p id="status">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p>
    <div id="reqBtns" style="display:none;">
        <button id="acceptBtn">Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø© âœ…</button>
        <button id="rejectBtn">Ø±ÙØ¶ âŒ</button>
    </div>
    <button id="logoutBtn" onclick="logout()" style="background:#607d8b;color:white;">Ø®Ø±ÙˆØ¬</button>
</div>

<script>
const db=firebase.initializeApp({apiKey:"AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M",databaseURL:"https://taxi-15314-default-rtdb.firebaseio.com/"}).database();
let map=L.map('map').setView([33.3152,44.3661],13);
L.tileLayer("https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}&key=AIzaSyD7TtwniAdUtB8-pnTny4ZwE6gqX36SGUk").addTo(map);

let driverPhone=localStorage.getItem("phone"),driverMarker=null,currentRide=null,osc=null,audioCtx=null;

function initAudio(){ if(!audioCtx) audioCtx=new(window.AudioContext||window.webkitAudioContext)(); }
function ring(s){ if(s){ osc=audioCtx.createOscillator(); osc.connect(audioCtx.destination); osc.start(); }else if(osc){ osc.stop(); osc=null; } }

setInterval(()=>{
    navigator.geolocation.getCurrentPosition(pos=>{
        const lat=pos.coords.latitude, lng=pos.coords.longitude;
        if(driverMarker) map.removeLayer(driverMarker);
        driverMarker=L.marker([lat,lng],{icon:L.divIcon({html:'ğŸš•',className:'custom-driver-icon'})}).addTo(map);
        db.ref("drivers/"+driverPhone).update({lat,lng,status:"Ù…ØªØµÙ„"});
    });
},5000);

db.ref("rides").on("value",snap=>{
    const rides=snap.val(); let found=false;
    if(rides) Object.keys(rides).forEach(id=>{
        const r=rides[id];
        if(r.status==="Ø¬Ø¯ÙŠØ¯Ø©" && !found){
            found=true; showReq(id,r);
        } else if((r.status==="Ù…Ù‚Ø¨ÙˆÙ„Ø©"||r.status==="Ø¨Ø¯Ø£Øª") && r.driverPhone===driverPhone){
            found=true; handleRide(id,r);
        }
    });
    if(!found) resetUI();
});

function showReq(id,r){
    ring(true); document.getElementById("reqBtns").style.display="block";
    document.getElementById("status").innerHTML=`Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯! Ø§Ù„Ø£Ø¬Ø±Ø©: ${r.fare} Ø¯.Ø¹`;
    document.getElementById("acceptBtn").onclick=()=>{ ring(false); db.ref("rides/"+id).update({status:"Ù…Ù‚Ø¨ÙˆÙ„Ø©",driverPhone}); };
    document.getElementById("rejectBtn").onclick=()=>{ ring(false); db.ref("rides/"+id).update({status:"Ù…Ø±ÙÙˆØ¶Ø©"}); };
}

function handleRide(id,r){
    currentRide=r; currentRide.id=id;
    document.getElementById("reqBtns").style.display="none";
    document.getElementById("floatingControls").style.display="flex";
    document.getElementById("callRider").href="tel:"+r.riderPhone;
    const btn=document.getElementById("actionBtn");
    if(r.status==="Ù…Ù‚Ø¨ÙˆÙ„Ø©"){
        btn.innerText="Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© ğŸš¦";
        btn.onclick=()=>db.ref("rides/"+id).update({status:"Ø¨Ø¯Ø£Øª"});
        document.getElementById("status").innerText="ØªÙˆØ¬Ù‡ Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø±Ø§ÙƒØ¨";
    }else{
        btn.innerText="Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© ğŸ";
        btn.onclick=()=>db.ref("rides/"+id).update({status:"Ù…Ù†ØªÙ‡ÙŠØ©"});
        document.getElementById("status").innerText="Ø£Ù†Øª ÙÙŠ Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø¢Ù†";
    }
}

function openWaze(){
    const lat=currentRide.status==="Ù…Ù‚Ø¨ÙˆÙ„Ø©"?currentRide.startLat:currentRide.endLat;
    const lng=currentRide.status==="Ù…Ù‚Ø¨ÙˆÙ„Ø©"?currentRide.startLng:currentRide.endLng;
    window.open(`https://www.waze.com/ul?ll=${lat},${lng}&navigate=yes`);
}

function resetUI(){ ring(false); document.getElementById("reqBtns").style.display="none"; document.getElementById("floatingControls").style.display="none"; document.getElementById("status").innerText="ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª..."; }
function logout(){ localStorage.clear(); location.href="index.html"; }
</script>
</body>
</html>
