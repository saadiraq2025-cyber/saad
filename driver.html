<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø³Ø§Ø¦Ù‚ - ØªÙƒØ³ÙŠ Ø§Ù„Ø¹Ø±Ø§Ù‚ Ø§Ù„Ø´Ø§Ù…Ù„</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body,html{margin:0;padding:0;height:100%;font-family:Tahoma;}
#map{height:60vh;}
#panel{
    background:#fff;padding:10px;text-align:center;
    box-shadow:0 -2px 5px rgba(0,0,0,0.2);
}
button{
    background:#ffb300;border:none;padding:10px 20px;
    border-radius:8px;margin:5px;font-weight:bold;
    cursor:pointer;
}
#logoutBtn{
    background:#455a64;color:white;margin-top:10px;width:95%;
}
</style>
</head>
<body>

<div id="map"></div>

<div id="panel">
    <h3>ğŸš– ÙˆØ¶Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚</h3>
    <p id="status">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p>

    <button id="acceptBtn" style="display:none;background:#4caf50;color:white;">Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©</button>
    <button id="rejectBtn" style="display:none;background:#e53935;color:white;">Ø±ÙØ¶ Ø§Ù„Ø±Ø­Ù„Ø©</button>

    <button id="finishBtn" style="display:none;background:#1e88e5;color:white;">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>

    <button id="logoutBtn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</div>

<script>
// Ù…Ù†Ø¹ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¯ÙˆÙ† Ø­Ø³Ø§Ø¨
window.onload=function(){
    let phone=localStorage.getItem("phone");
    let type=localStorage.getItem("userType");
    if(!phone||type!=="driver"){
        window.location.href="index.html";
    }
};

function logout(){
    localStorage.clear();
    window.location.href="index.html";
}

// Firebase
const app=firebase.initializeApp({
  apiKey:"AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M",
  authDomain:"taxi-15314.firebaseapp.com",
  databaseURL:"https://taxi-15314-default-rtdb.firebaseio.com/",
  projectId:"taxi-15314"
});
const db=firebase.database();

// Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
let map=L.map('map').setView([33.3152,44.3661],13);

// â­â­ ØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¨Ø®Ø±ÙŠØ·Ø© Google ÙÙ‚Ø· â€” Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªØºÙŠÙŠØ± Ø¢Ø®Ø± â­â­
L.tileLayer(
 "https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}&key=AIzaSyD7TtwniAdUtB8-pnTny4ZwE6gqX36SGUk",
 {maxZoom:20}
).addTo(map);

map.whenReady(()=>map.invalidateSize());

// Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚
let driverMarker=null;
let driverPhone=localStorage.getItem("phone");

// ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†Ù
setInterval(()=>{
    navigator.geolocation.getCurrentPosition(pos=>{
        let lat=pos.coords.latitude;
        let lng=pos.coords.longitude;

        if(driverMarker) map.removeLayer(driverMarker);
        driverMarker=L.marker([lat,lng]).addTo(map).bindPopup("ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ");

        db.ref("drivers/"+driverPhone).set({
            lat:lat,lng:lng,status:"Ù…ØªØµÙ„"
        });

    },err=>{},{
        enableHighAccuracy:true,timeout:5000
    });
},5000);

// Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
const statusText=document.getElementById("status");
const acceptBtn=document.getElementById("acceptBtn");
const rejectBtn=document.getElementById("rejectBtn");
const finishBtn=document.getElementById("finishBtn");

db.ref("rides").on("value",snap=>{
    let data=snap.val();
    if(!data) return;

    let rideFound=false;

    Object.keys(data).forEach(id=>{
        let r=data[id];
        if(r.status==="Ø¬Ø¯ÙŠØ¯Ø©" && !rideFound){
            rideFound=true;
            showRideRequest(id,r);
        }
    });

    if(!rideFound){
        acceptBtn.style.display="none";
        rejectBtn.style.display="none";
        statusText.innerText="Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹";
    }
});

function showRideRequest(id,r){
    statusText.innerHTML=
      `ğŸš– Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯<br>Ù…Ù†: <b>${r.startArea}</b><br>Ø¥Ù„Ù‰: <b>${r.endArea}</b><br>Ø§Ù„Ù…Ø³Ø§ÙØ©: ${r.distance} ÙƒÙ…`;

    acceptBtn.style.display="inline-block";
    rejectBtn.style.display="inline-block";

    acceptBtn.onclick=function(){
        db.ref("rides/"+id).update({status:"Ù…Ù‚Ø¨ÙˆÙ„Ø©",driverPhone:driverPhone});
        statusText.innerText="ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©. Ø¬Ø§Ø±ÙŠ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø±Ø§ÙƒØ¨...";
        acceptBtn.style.display="none";
        rejectBtn.style.display="none";
        finishBtn.style.display="inline-block";
    };

    rejectBtn.onclick=function(){
        db.ref("rides/"+id).update({status:"Ù…Ø±ÙÙˆØ¶Ø©"});
        statusText.innerText="ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø±Ø­Ù„Ø©.";
        acceptBtn.style.display="none";
        rejectBtn.style.display="none";
    };

    finishBtn.onclick=function(){
        db.ref("rides/"+id).update({status:"Ù…Ù†ØªÙ‡ÙŠØ©"});
        finishBtn.style.display="none";
        statusText.innerText="ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©.";
    };
}
</script>

</body>
</html>