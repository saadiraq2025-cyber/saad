<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¨Ù„ÙŠ ÙƒØ§Ø¨ØªÙ†</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        :root { --baly-yellow: #FFD200; }
        body, html { margin:0; height:100%; font-family: sans-serif; }
        #map { height: 100%; width:100%; }
        .popup-request {
            position: fixed; bottom: 20px; left: 10px; right: 10px;
            background: white; border-radius: 20px; padding: 20px;
            z-index: 9999; box-shadow: 0 0 20px rgba(0,0,0,0.3);
            display: none; text-align: center;
        }
        .active { display: block; animation: bounce 0.5s; }
        @keyframes bounce { 0% {transform: scale(0.9);} 70% {transform: scale(1.05);} 100% {transform: scale(1);} }
        .btn-accept { background: var(--baly-yellow); border:none; padding:15px; width:100%; border-radius:10px; font-weight:bold; font-size:20px; }
        #riderInfo { background:#f9f9f9; padding:10px; border-radius:10px; margin-top:10px; display:none; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="popup-request" id="pop">
    <h2 style="margin:0;">Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ðŸš•</h2>
    <div id="popDetails" style="margin:10px 0; font-size:18px;"></div>
    <button class="btn-accept" id="accBtn">Ù‚Ù€Ø¨Ù€ÙˆÙ„</button>
</div>

<div id="riderInfo" style="position:fixed; top:10px; left:10px; right:10px; z-index:1000; background:white; padding:15px; box-shadow:0 2px 10px rgba(0,0,0,0.1);">
    <strong>Ø±Ù‚Ù… Ø§Ù„Ø±Ø§ÙƒØ¨: </strong> <span id="rPhone"></span>
    <br><a id="rCall" style="color:green; font-weight:bold; text-decoration:none;">ðŸ“ž Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø±Ø§ÙƒØ¨</a>
</div>

<script>
const firebaseConfig = { apiKey: "AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M", databaseURL: "https://taxi-15314-default-rtdb.firebaseio.com/" };
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Ù†ØºÙ…Ø© ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ø§Ù„ÙŠØ©
const alertSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3'); 

// Ø®Ø±ÙŠØ·Ø© Ù†Ù‡Ø§Ø±ÙŠØ©
let map = L.map('map', {zoomControl: false}).setView([33.3152, 44.3661], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let driverMarker = L.marker([33.3152, 44.3661]).addTo(map);
const driverPhone = localStorage.getItem("phone") || "07800000000";

// Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
db.ref("rides").on("child_added", snap => {
    const r = snap.val();
    if(r.status === "Ø¬Ø¯ÙŠØ¯Ø©") {
        alertSound.play(); // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª
        document.getElementById('popDetails').innerHTML = `Ø§Ù„Ø£Ø¬Ø±Ø©: ${r.fare} Ø¯.Ø¹`;
        document.getElementById('pop').classList.add('active');
        
        document.getElementById('accBtn').onclick = () => {
            db.ref("rides/"+snap.key).update({status: "Ù…Ù‚Ø¨ÙˆÙ„Ø©", driverPhone: driverPhone});
            document.getElementById('pop').classList.remove('active');
            showRiderData(r);
        };
    }
});

function showRiderData(r) {
    document.getElementById('riderInfo').style.display = 'block';
    document.getElementById('rPhone').innerText = r.riderPhone;
    document.getElementById('rCall').href = "tel:" + r.riderPhone;
    
    // ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    L.marker(r.start, {icon: L.divIcon({html: 'ðŸŸ¢'})}).addTo(map).bindPopup("Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø±Ø§ÙƒØ¨").openPopup();
    L.marker(r.end, {icon: L.divIcon({html: 'ðŸ'})}).addTo(map);
    map.fitBounds([r.start, r.end]);
}

// ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚
setInterval(() => {
    navigator.geolocation.getCurrentPosition(pos => {
        const p = [pos.coords.latitude, pos.coords.longitude];
        driverMarker.setLatLng(p);
        db.ref("drivers/"+driverPhone).update({lat: p[0], lng: p[1]});
    });
}, 5000);
</script>
</body>
</html>
