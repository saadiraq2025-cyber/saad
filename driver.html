<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø³Ø§Ø¦Ù‚ - ØªÙƒØ³ÙŠ Ø§Ù„Ø¹Ø±Ø§Ù‚ Ø§Ù„Ø´Ø§Ù…Ù„</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<style>
/* 1. ğŸ› ï¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„: ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© ÙˆØ§Ù„ØªØ£Ø«ÙŠØ±Ø§Øª */
html,body{margin:0;padding:0;height:100%;font-family:Tahoma;font-size:18px;background:#f5f5f5;}
#map{
    height:60vh;
    width:100%;
    background:#ccc; 
    opacity: 1; 
    transition: all 0.5s ease-in-out; /* ğŸŒŸ ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø¶Ø§ÙØ© Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù€ all */
    position: relative; /* Ù…Ù‡Ù… Ù„Ù„Ø²Ø± Ø§Ù„Ø¹Ø§Ø¦Ù… */
}
/* ğŸ†• ÙƒÙ„Ø§Ø³ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙÙŠ ÙˆØ¶Ø¹ Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© */
.map-fullscreen {
    height: 100vh !important;
    box-shadow: none !important;
}

#panel{
    background:#fff;
    text-align:center;
    padding:15px 0 0 0;
    box-shadow:0 -2px 5px rgba(0,0,0,0.2); 
    opacity: 1; 
    transition: all 0.5s ease-in-out; /* ğŸŒŸ ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø¶Ø§ÙØ© Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù€ all */
    position: relative;
    z-index: 10;
}
/* ğŸ†• ÙƒÙ„Ø§Ø³ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø®ÙØ§Ø¡ */
.panel-hidden {
    height: 0;
    padding-top: 0;
    padding-bottom: 0;
    overflow: hidden;
    opacity: 0;
    box-shadow: none;
}


h3{color:#2e7d32;margin:5px 0;font-size:22px;}
/* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ø§Ù…Ø© */
.panel-button {
    border: none;
    padding: 8px 15px; 
    border-radius: 10px;
    font-weight: bold;
    cursor: pointer;
    margin: 3px 15px; 
    font-size: 17px;
    width: calc(100% - 30px);
}
.panel-button:hover{filter: brightness(0.9);}

/* ğŸ†• ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ - ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù€ padding Ø§Ù„Ø³ÙÙ„ÙŠ Ù„ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ */
#driverPanelContent { 
    padding: 0 15px 0 15px;
}

/* ğŸ“ Ø¹Ø±Ø¶ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù…Ø³Ø§Ø­Ø© Ø¹Ø±Ø¶ Ø£ØµØºØ±) - ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù„ØªÙƒÙˆÙ† Ø¹Ø§Ø¦Ù…Ø© */
/* ğŸ†• Ø¥Ø²Ø§Ù„Ø© ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ù€ panel-based Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© */
/* #riderPhoneDisplay { display: none; } */ 

/* ğŸš¨ Ø²Ø± Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©: ÙŠØªÙ… ØªØµÙÙŠØ± ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ù€ panel-button Ù„Ø¬Ø¹Ù„Ù‡ Ø¹Ø§Ø¦Ù…Ø§Ù‹ */
/* 2. ğŸ› ï¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ: ØªÙ†Ø³ÙŠÙ‚ Ø²Ø± Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø¹Ø§Ø¦Ù… */
#endRide{
    background:#e53935;
    color:white; 
    display: none;
    /* ğŸ†• ØªØµÙÙŠØ± Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© */
    width: auto;
    padding: 8px 15px;
    margin: 0;
    border-radius: 10px;
} 
/* ğŸ†• Ø§Ù„ÙƒÙ„Ø§Ø³ Ø§Ù„Ø¹Ø§Ø¦Ù… - ØªÙ… ØªØ¹Ø¯ÙŠÙ„ 'top' Ùˆ 'transform' Ù„Ø¬Ø¹Ù„Ù‡ ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„ÙŠØ³Ø§Ø± */
.floating-end-btn {
    position: absolute;
    top: 50%; /* ğŸ”„ Ù„Ø¬Ø¹Ù„Ù‡ ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ø´Ø§Ø´Ø© Ø¹Ù…ÙˆØ¯ÙŠØ§Ù‹ */
    transform: translateY(-50%); /* ğŸ”„ Ù„Ù…Ø±ÙƒØ²Ù‡ ØªÙ…Ø§Ù…Ø§Ù‹ */
    left: 10px; /* Ù„Ø¬Ø¹Ù„Ù‡ ÙÙŠ Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„ÙŠØ³Ø±Ù‰ */
    z-index: 600; 
    width: auto !important; /* Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
    border: none;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}

/* ğŸ†• ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ */
#floatingInfo {
    position: absolute;
    /* ğŸŒŸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø³Ø§ÙØ© Ù…Ù† Ø²Ø± Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡/Ø§Ù„Ø¨Ø¯Ø¡ */
    top: calc(50% + 80px); 
    transform: translateY(-50%); 
    left: 10px;
    z-index: 600;
    display: none; /* ÙŠØªÙ… Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø¸Ù‡ÙˆØ±Ù‡ ÙÙŠ JS */
    text-align: center;
    direction: ltr; /* Ù„ØªØ³Ù‡ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… */
}

#floatingInfo #riderPhoneDisplay {
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 10px;
    padding: 5px 10px; 
    box-shadow: 0 1px 5px rgba(0,0,0,0.3);
    width: auto;
    white-space: nowrap; /* Ù„Ù…Ù†Ø¹ Ø§Ù†Ù‚Ø³Ø§Ù… Ø§Ù„Ù†Øµ */
}

#floatingInfo #riderPhoneDisplay h4 { 
    margin: 0; 
    font-size: 14px; 
    color: #555; 
    direction: rtl; /* Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ù„Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† */
} 
/* ğŸŒŸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø· Ø§Ù„ØªØ´Ø¹Ø¨ÙŠ Ù„Ù„Ø±Ù‚Ù… */
#floatingInfo #riderPhoneNumber { 
    font-size: 20px; 
    font-weight: bold; 
    color: #2196F3; /* Ù„ÙˆÙ† Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø· */
    text-decoration: none; /* Ø¥Ø²Ø§Ù„Ø© Ø®Ø· Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø· */
    display: block; 
}
#floatingInfo #riderPhoneNumber:hover { 
    text-decoration: underline; /* Ø¥Ø¶Ø§ÙØ© Ø®Ø· Ø¹Ù†Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠØ± */
}

/* ğŸ†• ØªÙ†Ø³ÙŠÙ‚ Ø²Ø± Waze */
#wazeBtn {
    background: #00bcd4; /* Ù„ÙˆÙ† Ø£Ø²Ø±Ù‚ Ø³Ù…Ø§ÙˆÙŠ */
    color: white; 
    padding: 8px 10px;
    border-radius: 10px;
    font-weight: bold;
    cursor: pointer;
    border: none;
    margin-top: 5px; /* ÙØ§ØµÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø±Ù‚Ù… ÙˆØ§Ù„Ø²Ø± */
    display: block;
    text-decoration: none;
    font-size: 16px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.3);
}
#wazeBtn:hover {
    filter: brightness(0.9);
}


#chatBtn{background:#2196F3;color:white; display: none; margin-bottom: 0;}

/* Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù‡Ø§Ù…Ø´ Ø¹Ù„ÙˆÙŠ Ù„ÙŠÙ„ØªØµÙ‚ Ø¨Ø²Ø± Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
#logoutBtn{background:#333;color:white; display: block; margin: 0; border-radius: 0; border-top-left-radius: 10px; border-top-right-radius: 10px;}

/* Ø²Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© */
#retry{background:#81c784; margin-top: 10px; width: calc(100% - 30px);}

/* ğŸ†• ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø¨ÙˆÙ„ ÙˆØ§Ù„Ø±ÙØ¶ */
#rideActions {
    display: none; 
    justify-content: space-around;
    padding-bottom: 10px;
}
.ride-action-button {
    padding: 8px 20px; 
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    border: none;
    border-radius: 10px;
    margin: 5px;
    width: 45%; 
}
#acceptRide { background: #2e7d32; color: white; }
#rejectRide { background: #e53935; color: white; }


/* ğŸ’¬ ØªÙ†Ø³ÙŠÙ‚Ø§Øª ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø´Ø§Øª */
#chatBox {
    position: fixed;
    bottom: 0;
    right: 0;
    width: 100%;
    height: 40vh; 
    background: #fff;
    border-top: 1px solid #ccc;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
    display: none; 
    z-index: 1000;
    flex-direction: column;
}
#chatHeader {
    padding: 10px 15px;
    background: #2196F3;
    color: white;
    font-weight: bold;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
#closeChatBtn {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    margin: 0;
    width: auto;
}
#messages {
    flex-grow: 1;
    overflow-y: auto;
    padding: 10px;
    background: #f9f9f9;
    text-align: right;
    font-size: 14px;
}
#messages p { margin: 5px 0; padding: 8px 12px; border-radius: 18px; max-width: 75%; }
.rider-msg { background: #e0f7fa; text-align: right; margin-right: auto; margin-left: 10px; }
.driver-msg { background: #fffde7; text-align: left; margin-left: auto; margin-right: 10px; }
#messageInputContainer {
    padding: 10px;
    border-top: 1px solid #eee;
    display: flex;
}
#messageInput {
    flex-grow: 1;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 20px;
    font-size: 15px;
    direction: rtl;
    margin-left: 10px;
}
#sendMsgBtn {
    width: auto;
    padding: 8px 15px;
    background: #00bcd4;
    color: white;
    font-size: 15px;
    border-radius: 20px;
    margin: 0;
}

/* ğŸ›‘ ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ù…Ø±Ø¨Ø¹ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ */
#expiredModal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 2000;
    background: #fff;
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(229, 57, 52, 0.8);
    text-align: center;
    max-width: 400px;
    width: 90%;
    border: 3px solid #e53935;
    display: none;
}
#expiredModal h3 { color: #e53935; margin-top: 0; font-size: 24px; }
#expiredModal p { margin: 10px 0; font-size: 16px; }
#expiredModal .zain-cash-number { font-size: 24px; color: #00bcd4; font-weight: bold; direction: ltr; display: block; background: #eee; padding: 5px; border-radius: 5px; }

/* ğŸ“ ØªÙ†Ø³ÙŠÙ‚ Ø²Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
#recenterBtn {
    position: absolute;
    top: 10px; 
    right: 10px; 
    z-index: 500; 
    width: 40px;
    height: 40px;
    background-color: #fff;
    border: 2px solid #ccc;
    border-radius: 5px;
    box-shadow: 0 1px 5px rgba(0,0,0,0.4);
    cursor: pointer;
    line-height: 38px;
    text-align: center;
    font-size: 20px;
    font-weight: bold;
    color: #2e7d32;
    padding: 0;
    transition: opacity 0.3s;
}
#recenterBtn:hover {
    background-color: #f4f4f4;
}
</style>
</head>
<body>
<div id="map">
    <button id="recenterBtn" title="ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ">ğŸ“</button>
    <button id="endRide" disabled class="panel-button">Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© â¡ï¸</button>
    
    <div id="floatingInfo">
        <div id="riderPhoneDisplay">
            <h4>Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ø±Ø§ÙƒØ¨</h4>
            <a id="riderPhoneNumber" href="tel:07700000000">07700000000</a> 
        </div>
        <a id="wazeBtn" target="_blank" href="#">ğŸ—ºï¸ Ø§ÙØªØ­ ÙÙŠ Waze</a>
    </div>
</div>
<div id="panel">
Â  <div id="driverPanelContent">
    <h3>ğŸš– Ù„ÙˆØ­Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚</h3>
    
    <div id="rideInfo">ğŸ“ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ.</div>
    
    <div id="rideActions">
        <button id="acceptRide" class="ride-action-button">âœ… Ù‚Ø¨ÙˆÙ„</button>
        <button id="rejectRide" class="ride-action-button">âŒ Ø±ÙØ¶</button>
    </div>
    
    <button id="chatBtn" class="panel-button">ğŸ’¬ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹ Ø§Ù„Ø±Ø§ÙƒØ¨</button>
    
    Â    <button id="retry" class="panel-button" style="display:none;">ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø¢Ù†</button>
  </div>
    
  <button id="logoutBtn" class="panel-button">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ ğŸš«</button>
</div>

<div id="chatBox">
    <div id="chatHeader">
        <span>ğŸ’¬ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹ Ø§Ù„Ø±Ø§ÙƒØ¨</span>
        <button id="closeChatBtn">Ã—</button>
    </div>
    <div id="messages"></div>
    <div id="messageInputContainer">
Â  Â  Â  <input type="text" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ...">
Â  Â  Â  <button id="sendMsgBtn">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
</div>

<div id="expiredModal">
    <h3>ğŸ›‘ ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ!</h3>
    <p style="font-size: 18px; font-weight: bold;">ÙŠØ±Ø¬Ù‰ Ø¯ÙØ¹ <span style="color: #2e7d32;">5000 Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ</span> Ù„Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø±ÙŠ.</p>
    <p>Ù‚Ù… Ø¨Ø§Ù„Ø¯ÙØ¹ Ù„Ù€ **Ø²ÙŠÙ† ÙƒØ§Ø´** Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù‚Ù…:</p>
    <span class="zain-cash-number">07816175944</span>
    <p style="font-size: 14px; color: #777; margin-top: 15px;">Ø³ÙŠØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¨Ø¹Ø¯ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹.</p>
</div>


<script>
document.addEventListener("DOMContentLoaded",()=>{

// ** ğŸš¨ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ù„Ø³Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ **
const driverPhone = localStorage.getItem('phone');
const userType = localStorage.getItem('userType');

if (!driverPhone || userType !== 'driver') {
    alert("âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ³Ø§Ø¦Ù‚ Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©.");
    window.location.href = "index.html";
    return; 
}
// ----------------------------------------

// ğŸ”¥ Firebase
const app=firebase.initializeApp({
Â  apiKey:"AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M",
Â  authDomain:"taxi-15314.firebaseapp.com",
Â  databaseURL:"https://taxi-15314-default-rtdb.firebaseio.com/",
Â  projectId:"taxi-15314"
});
const db=firebase.database();

// ğŸ—ºï¸ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
const mapElement = document.getElementById('map'); // ğŸ†• Ù…ØªØºÙŠØ± Ø¬Ø¯ÙŠØ¯
const panelElement = document.getElementById('panel'); // ğŸ†• Ù…ØªØºÙŠØ± Ø¬Ø¯ÙŠØ¯
let map=L.map('map').setView([33.3152,44.3661],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
setTimeout(()=>{ map.invalidateSize(); },1000);

let driverMarker=null;
let currentCoords=[33.3152,44.3661];
const retryBtn=document.getElementById("retry");
const expiredModal = document.getElementById('expiredModal');
const logoutBtn = document.getElementById('logoutBtn');
const recenterBtn = document.getElementById('recenterBtn'); 

// ğŸ’¬ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø´Ø§Øª
const chatBox = document.getElementById('chatBox');
const messagesDiv = document.getElementById('messages');
const messageInput = document.getElementById('messageInput');
const sendMsgBtn = document.getElementById('sendMsgBtn');
const chatBtn = document.getElementById('chatBtn');
const closeChatBtn = document.getElementById('closeChatBtn');
let chatRef = null; 

// ğŸ“ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø§ØªØµØ§Ù„ (ØªÙ… ØªØºÙŠÙŠØ± Ù…ÙˆÙ‚Ø¹Ù‡Ø§ ÙÙŠ HTML)
const floatingInfoDiv = document.getElementById("floatingInfo"); // ğŸ†• Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ø§Ø¦Ù…Ø©
const riderPhoneDisplay = document.getElementById("riderPhoneDisplay");
// ğŸŒŸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø¬Ù„Ø¨ Ø¹Ù†ØµØ± Ø§Ù„Ù€ a Ø§Ù„Ø¬Ø¯ÙŠØ¯
const riderPhoneNumberLink = document.getElementById("riderPhoneNumber"); 
// ğŸ†• Ø¹Ù†ØµØ± Ø²Ø± Waze
const wazeBtn = document.getElementById("wazeBtn");


// ğŸ†• Ø¹Ù†Ø§ØµØ± Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø¨ÙˆÙ„ ÙˆØ§Ù„Ø±ÙØ¶
const rideActionsDiv = document.getElementById("rideActions");
const acceptBtn = document.getElementById("acceptRide");
const rejectBtn = document.getElementById("rejectRide");


// âš™ï¸ Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© Ù„Ù„Ø±Ø­Ù„Ø© ÙˆØ§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ†
const rideInfo=document.getElementById("rideInfo");
const endBtn=document.getElementById("endRide");
let routeControl=null;
let driverStatus="available";
let activeRideId=null;
let currentRide=null;
let newRidesListener = null; 
let rideChangesListener = null;
let isInitialCheckDone = false; 
let isRideStarted = false; 

// ğŸ†• Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ù‚Ø±Ø¨ Ø³Ø§Ø¦Ù‚
const MAX_DISTANCE_KM = 3; // 3 ÙƒÙŠÙ„ÙˆÙ…ØªØ±
let pendingRideId = null; // Ù„ØªØ®Ø²ÙŠÙ† ID Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© Ø­Ø§Ù„ÙŠØ§Ù‹
let isSearching = false; // ğŸ†• Ø¹Ù„Ø§Ù…Ø© Ù„ÙˆÙ‚Ù/Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø­Ø«

// ğŸ“ Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹
retryBtn.onclick=()=>getLocation(true); 
recenterBtn.onclick=()=>getLocation(true); 

function getLocation(setMapCenter = false){ 
Â  if(!navigator.geolocation){
Â  Â  document.getElementById("rideInfo").innerText="âš ï¸ Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.";
Â  Â  return;
Â  }
Â  document.getElementById("rideInfo").innerText="â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ...";
Â  navigator.geolocation.getCurrentPosition(pos=>{
Â  Â  currentCoords=[pos.coords.latitude,pos.coords.longitude];
Â  Â  updateDriverMarker(setMapCenter); 
Â  Â  retryBtn.style.display="none";

    // ğŸŒŸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø¹Ø¯Ù… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ Ù†Ø´Ø·
    if (activeRideId) {
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø±Ø­Ù„Ø© Ù†Ø´Ø·Ø©ØŒ Ù„Ø§ ØªÙØ¹Ù„ Ø´ÙŠØ¦Ù‹Ø§ØŒ Ø§Ù„Ù†Øµ Ø¨Ø§Ù„ÙØ¹Ù„ Ù…ÙØ­Ø¯Ù‘ÙØ«
    } else if (rideActionsDiv.style.display === "flex" && currentRide) {
        // ğŸ†• Ø¹Ø±Ø¶ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ù„Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¹Ù„Ù‚
        rideInfo.innerHTML = `ğŸš– <b>Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</b><br>
        Ù…Ù†: <b>${currentRide.startArea || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</b><br>
        Ø¥Ù„Ù‰: <b>${currentRide.endArea || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</b><br>
        Ø§Ù„Ù…Ø³Ø§ÙØ©: ${currentRide.distance} ÙƒÙ… â€” Ø§Ù„Ø£Ø¬Ø±Ø©: ${currentRide.fare} Ø¯.Ø¹`;
    } else {
        // Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© (Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨)
        document.getElementById("rideInfo").innerText="âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø¨Ù†Ø¬Ø§Ø­ â€” Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø±Ø­Ù„Ø§Øª...";
    }
    
Â  Â  map.invalidateSize();
    loadActiveRideFromStorage(); 
    if (driverStatus !== "banned") {
        watchForRides(); // ğŸ†• ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ ÙÙ‚Ø· Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹
    }
Â  },err=>{
Â  Â  document.getElementById("rideInfo").innerText="âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹.";
Â  Â  retryBtn.style.display="inline-block";
    toggleRideButtons(false);
    showRideActions(false); 
Â  },{enableHighAccuracy:true,timeout:10000});
}

// ğŸš– Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø§Ù„Ù…ØªØ­Ø±ÙƒØ©
function updateDriverMarker(setMapCenter=false){
Â  if(!driverMarker){
Â  Â  const carIcon=L.icon({
Â  Â  Â  iconUrl:"https://cdn-icons-png.flaticon.com/512/744/744465.png",
Â  Â  Â  iconSize:[40,40],
Â  Â  Â  iconAnchor:[20,20]
Â  Â  });
Â  Â  driverMarker=L.marker(currentCoords,{icon:carIcon}).addTo(map).bindPopup("ğŸš– Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ");
Â  Â  if(setMapCenter) map.setView(currentCoords,15);
Â  }else{
Â  Â  driverMarker.setLatLng(currentCoords);
Â  }
  if (activeRideId || setMapCenter) { 
    map.panTo(currentCoords);
  }
}

// ** ğŸš€ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªÙ…Ø± **
let lastFirebaseUpdate = 0;
const FIREBASE_UPDATE_INTERVAL = 3000; 

setInterval(() => {
    if (navigator.geolocation && driverStatus !== "banned") {
        navigator.geolocation.getCurrentPosition(pos => {
            currentCoords = [pos.coords.latitude, pos.coords.longitude];
            updateDriverMarker(); 

            const now = Date.now();
            if (now - lastFirebaseUpdate > FIREBASE_UPDATE_INTERVAL) {
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØµØ­ÙŠØ­
                const locationPath = activeRideId ? `driverLocations/${driverPhone}` : `availableDrivers/${driverPhone}`;
                
                db.ref(locationPath).update({
                    location: currentCoords,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    status: activeRideId ? "busy" : "available"
                })
                .catch(error => {
                    console.error("Firebase location update error:", error);
                });
                lastFirebaseUpdate = now;
            }
        });
    }
}, 500); 
// ----------------------------------------------


// ** ğŸ†• Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ù†Ù‚Ø·ØªÙŠÙ† (Haversine Formula) **
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // Ù†ØµÙ Ù‚Ø·Ø± Ø§Ù„Ø£Ø±Ø¶ Ø¨Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return (R * c); // Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±
}


// ğŸ”Š Ø§Ù„ØµÙˆØª 
let audioCtx=null,beepInterval=null;
function startBeep(){
Â  stopBeep();
Â  if(!audioCtx)audioCtx=new (window.AudioContext||window.webkitAudioContext)();
Â  beepInterval=setInterval(()=>{
Â  Â  const osc=audioCtx.createOscillator();
Â  Â  const gain=audioCtx.createGain();
Â  Â  osc.type="sine";osc.frequency.value=800;
Â  Â  osc.connect(gain);gain.connect(audioCtx.destination);
Â  Â  osc.start();
Â  Â  setTimeout(()=>osc.stop(),300);
Â  },1000);
Â  setTimeout(stopBeep,20000);
}
function stopBeep(){if(beepInterval){clearInterval(beepInterval);beepInterval=null;}}


// ğŸ’¬ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø´Ø§Øª - ÙˆØ¸ÙŠÙØ© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
function sendMessage(senderType) {
    if (driverStatus === "banned") return alert("âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ØŒ Ø§Ø´ØªØ±Ø§ÙƒÙƒ Ù…Ù†ØªÙ‡ÙŠ.");
Â  Â  const text = messageInput.value.trim();
Â  Â  if (text === "") return;Â 
Â  Â Â 
Â  Â  if (!chatRef) {
Â  Â  Â  Â  alert("âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: Ù„Ù… ÙŠØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø© Ø¨Ø¹Ø¯ Ø£Ùˆ ØªÙ… Ø¥Ù†Ù‡Ø§Ø¤Ù‡Ø§.");
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  chatRef.push({
Â  Â  Â  Â  sender: senderType, // 'driver'
Â  Â  Â  Â  text: text,
Â  Â  Â  Â  timestamp: Date.now()
Â  Â  }).then(() => {
Â  Â  Â  Â  messageInput.value = '';
        messageInput.focus();
Â  Â  }).catch(error => {
Â  Â  Â  Â  alert("âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: " + error.message);
Â  Â  });
}

// ğŸ’¬ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø´Ø§Øª - ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„
function listenForChatMessages() {
Â  Â  messagesDiv.innerHTML = ''; // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
Â  Â  if(chatRef) chatRef.off('child_added');Â 
Â  Â Â 
Â  Â  chatRef.on('child_added', (snap) => {
Â  Â  Â  Â  const message = snap.val();
Â  Â  Â  Â  const p = document.createElement('p');
Â  Â  Â  Â  p.className = (message.sender === 'driver') ? 'driver-msg' : 'rider-msg';
Â  Â  Â  Â  p.innerText = message.text;
Â  Â  Â  Â  messagesDiv.appendChild(p);
Â  Â  Â  Â  messagesDiv.scrollTop = messagesDiv.scrollHeight;Â 
Â  Â  });
}

// ğŸ’¬ Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø´Ø§Øª
sendMsgBtn.addEventListener('click', () => sendMessage('driver'));
messageInput.addEventListener('keypress', (e) => {
Â  Â  if (e.key === 'Enter') {
Â  Â  Â  Â  sendMessage('driver');
Â  Â  }
});
chatBtn.addEventListener('click', () => {
    if (activeRideId) {
        chatBox.style.display = 'flex';
        messageInput.focus();
    } else {
        alert("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø­Ù„Ø© Ù†Ø´Ø·Ø© Ù„Ù„Ø¯Ø±Ø¯Ø´Ø©.");
    }
});
closeChatBtn.addEventListener('click', () => {
    chatBox.style.display = 'none';
});

// ----------------------------------------
// Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø© (Ø¨Ø¯ÙˆÙ† Ø²Ø± Ø§Ù„Ø§ØªØµØ§Ù„)
function toggleRideButtons(isAccepted) {
    // endBtn.style.display = isAccepted ? "block" : "none"; // ğŸš¨ Ù„Ù… ÙŠØ¹Ø¯ Ù‡Ù†Ø§
    chatBtn.style.display = isAccepted ? "block" : "none";
    // ğŸ“ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯: Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø¸Ù‡ÙˆØ± Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© Ù„Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
    floatingInfoDiv.style.display = isAccepted ? "block" : "none"; 
    endBtn.disabled = !isAccepted;
    // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø§Ù„Ø²Ø± Ø¹Ù†Ø¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
    if (isAccepted) {
        endBtn.innerText = isRideStarted ? "Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© ğŸ›‘" : "Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© â¡ï¸";
        endBtn.style.background = isRideStarted ? "#e53935" : "#2e7d32";
    }
    
    // 4. ğŸ› ï¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø§Ø¨Ø¹: Ø§Ù„ØªØ­ÙƒÙ… Ø¨ÙƒÙ„Ø§Ø³ Ø§Ù„Ø²Ø± Ø§Ù„Ø¹Ø§Ø¦Ù… ÙˆØ¸Ù‡ÙˆØ±Ù‡/Ø§Ø®ØªÙØ§Ø¦Ù‡
    if (isAccepted) {
        endBtn.style.display = "block";
        endBtn.classList.add('floating-end-btn');
        recenterBtn.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
    } else {
        endBtn.style.display = "none";
        endBtn.classList.remove('floating-end-btn');
        recenterBtn.style.display = 'block'; // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
    }
    
    // 5. ğŸ› ï¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø®Ø§Ù…Ø³: Ø§Ù„ØªØ­ÙƒÙ… Ø¨ÙˆØ¶Ø¹ Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© (ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù‚Ø¨ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©)
    if (isAccepted) {
        mapElement.classList.add('map-fullscreen');
        panelElement.classList.add('panel-hidden');
        map.invalidateSize(); // ğŸ†• Ù…Ù‡Ù…: Ù„ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¨Ø¹Ø¯ ØªØºÙŠÙŠØ± Ø­Ø¬Ù…Ù‡Ø§
    } else {
        mapElement.classList.remove('map-fullscreen');
        panelElement.classList.remove('panel-hidden');
    }
    
}

// Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø¨ÙˆÙ„ ÙˆØ§Ù„Ø±ÙØ¶
function showRideActions(show) {
    rideActionsDiv.style.display = show ? "flex" : "none";
    
    // 6. ğŸ› ï¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¯Ø³: Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø²Ø§Ù„Ø© ÙˆØ¶Ø¹ Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
    if (show) {
        mapElement.classList.remove('map-fullscreen');
        panelElement.classList.remove('panel-hidden');
    }
}
// ----------------------------------------

// **********************************************
// ğŸ†• Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Waze
// **********************************************
function updateWazeButton(isStarted, rideData) {
    if (!rideData || !rideData.start || !rideData.end) {
        wazeBtn.style.display = 'none';
        return;
    }
    
    // Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù‡Ø¯Ù: Ù†Ù‚Ø·Ø© Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ø±Ø§ÙƒØ¨ Ø¥Ø°Ø§ Ù„Ù… ØªØ¨Ø¯Ø£ Ø§Ù„Ø±Ø­Ù„Ø©ØŒ Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ø°Ø§ Ø¨Ø¯Ø£Øª
    const targetCoords = isStarted ? rideData.end : rideData.start;
    const lat = targetCoords[0];
    const lon = targetCoords[1];
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Waze
    const wazeUrl = `https://waze.com/ul?ll=${lat},${lon}&navigate=yes&zoom=17`;
    
    wazeBtn.href = wazeUrl;
    wazeBtn.style.display = 'block';
    
    // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø§Ù„Ø²Ø±
    wazeBtn.innerText = isStarted ? 'ğŸ—ºï¸ ØªÙˆØ¬Ù‡ Ù„Ù„ÙˆØ¬Ù‡Ø© (Waze)' : 'ğŸ—ºï¸ ØªÙˆØ¬Ù‡ Ù„Ù„Ø±Ø§ÙƒØ¨ (Waze)';
}


// **********************************************
// ğŸ†• Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³Ø§Ø± Ø¥Ù„Ù‰ Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© (Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©)
// **********************************************
function updateRouteToEndPoint() {
    if (!currentRide || !routeControl) return;

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³Ø§Ø± Ø¥Ù„Ù‰ Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
    const endPoint = L.latLng(currentRide.end[0], currentRide.end[1]);

    // ğŸš¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… setWaypoints Ùˆ route Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³Ø§Ø± Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ routeControl
    routeControl.setWaypoints([L.latLng(currentCoords[0], currentCoords[1]), endPoint]);
    routeControl.route();
    
    // ØªØºÙŠÙŠØ± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… 
    isRideStarted = true;
    localStorage.setItem('isRideStarted', 'true'); 
    endBtn.innerText = "Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© ğŸ›‘";
    endBtn.style.background = "#e53935";
    endBtn.onclick = endRide; // Ø±Ø¨Ø· Ø§Ù„Ø²Ø± Ø¨Ø¯Ø§Ù„Ø© Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©
    
    // ğŸ†• Ø¹Ø±Ø¶ Ø§Ø³Ù… Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙˆØµÙˆÙ„ ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ÙÙŠ Ø­Ø§Ù„ Ø§Ù„Ø¥Ø®ÙØ§Ø¡ØŒ Ù„Ø§ Ù†Ø­ØªØ§Ø¬Ù‡ØŒ Ù„ÙƒÙ† Ù†Ø¨Ù‚ÙŠÙ‡ Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„)
    rideInfo.innerHTML = `âœ… ØªÙ… **Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©** - ÙˆØ¬Ù‡ØªÙƒ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: <b>${currentRide.endArea || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</b> Ø¸Ø§Ù‡Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©.<br>
    Ø§Ù„Ù…Ø³Ø§ÙØ©: ${currentRide.distance} ÙƒÙ…<br>Ø§Ù„Ø£Ø¬Ø±Ø©: ${currentRide.fare} Ø¯.Ø¹<br><b>ğŸ‘‹ Ø¹Ù†Ø¯ Ø§Ù„ÙˆØµÙˆÙ„ØŒ Ø§Ø¶ØºØ· "Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©"</b>`;
    
    // ğŸ†• ØªØ­Ø¯ÙŠØ« Ø²Ø± Waze Ù„Ù„ÙˆØ¬Ù‡Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
    updateWazeButton(true, currentRide);
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø±Ø§ÙƒØ¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    db.ref("rides/" + activeRideId).update({
        notification: "ğŸš— Ø¨Ø¯Ø£ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø§Ù„Ø±Ø­Ù„Ø© Ù†Ø­Ùˆ ÙˆØ¬Ù‡ØªÙƒ."
    });
}

// **********************************************
// ğŸ†• Ø¯Ø§Ù„Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© (ØªØ³Ù…Ù‰ Ø¹Ù†Ø¯ Ø¶ØºØ· Ø²Ø± "Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©")
// **********************************************
function startRide() {
    if (!activeRideId || isRideStarted) return;
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ù„ÙˆØ¬Ù‡Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
    updateRouteToEndPoint();
}
// ----------------------------------------


// **********************************************
// ğŸš€ Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©: Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø© Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ†
// **********************************************
function loadActiveRideFromStorage() {
    const storedRideId = localStorage.getItem('activeRideId');
    const storedIsStarted = localStorage.getItem('isRideStarted') === 'true'; 

    if (!storedRideId) return;

    db.ref("rides/" + storedRideId).once('value', snap => {
        const ride = snap.val();
        if (ride && ride.status === "Ù…Ù‚Ø¨ÙˆÙ„Ø©" && ride.assignedDriver === driverPhone) {
            driverStatus = "busy";
            activeRideId = storedRideId;
            currentRide = ride;
            isRideStarted = storedIsStarted; 
            
            initializeRideUI(ride); // Ù‡Ø°Ø§ Ø³ÙŠØ¹ÙŠÙ† Ø²Ø± Ø§Ù„Ø¨Ø¯Ø¡/Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡ ÙˆÙŠÙØ¹Ù„ Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù‚Ø¨ÙˆÙ„

            // ğŸŒŸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: ØªØ­Ø¯ÙŠØ« Ø±Ø§Ø¨Ø· ÙˆØ±Ù‚Ù… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©
            riderPhoneNumberLink.innerText = ride.riderPhone || "07700000000";
            riderPhoneNumberLink.href = `tel:${ride.riderPhone || ''}`; 
            
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØµØ­ÙŠØ­ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©
            if (isRideStarted) {
                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø­Ù„Ø© Ù‚Ø¯ Ø¨Ø¯Ø£ØªØŒ Ø§Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
                updateRoute(ride.end);
            } else {
                // Ø¥Ø°Ø§ Ù„Ù… ØªØ¨Ø¯Ø£ØŒ Ø§Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ù†Ù‚Ø·Ø© Ø§Ù„ØªÙ‚Ø§Ø¡ Ø§Ù„Ø±Ø§ÙƒØ¨
                updateRoute(ride.start);
            }
            
            // ğŸ†• ØªØ­Ø¯ÙŠØ« Ø²Ø± Waze Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©
            updateWazeButton(isRideStarted, ride);


            // ğŸ†• Ø¹Ø±Ø¶ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø¹Ù†Ø¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø­Ù„Ø©
            const startName = ride.startArea || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            const endName = ride.endArea || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            const actionText = isRideStarted ? `ÙˆØ§ØµÙ„ Ù†Ø­Ùˆ Ø§Ù„ÙˆØ¬Ù‡Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: ${endName}` : `ØªÙˆØ¬Ù‡ Ù†Ø­Ùˆ Ø§Ù„Ø±Ø§ÙƒØ¨ ÙÙŠ: ${startName}`;

            rideInfo.innerHTML = `âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø­Ù„Ø© (ID: ${storedRideId})<br>
            Ù…Ù†: <b>${startName}</b><br>
            Ø¥Ù„Ù‰: <b>${endName}</b><br>
            Ø§Ù„Ù…Ø³Ø§ÙØ©: ${ride.distance} ÙƒÙ… â€” Ø§Ù„Ø£Ø¬Ø±Ø©: ${ride.fare} Ø¯.Ø¹<br><b>${actionText}</b>`;
            
            // Ø±Ø¨Ø· Ø²Ø± "Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©" / "Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©" Ø¨Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©
            endBtn.onclick = isRideStarted ? endRide : startRide;
            
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø²Ø± Ø§Ù„Ø¹Ø§Ø¦Ù…
            endBtn.classList.add('floating-end-btn');


        } else {
            localStorage.removeItem('activeRideId');
            localStorage.removeItem('isRideStarted'); 
            resetDriverState(false); 
        }
    }).catch(error => {
        console.error("Error loading active ride:", error);
        localStorage.removeItem('activeRideId');
        localStorage.removeItem('isRideStarted'); 
        resetDriverState(false);
    });
}

// **********************************************
// âš™ï¸ Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„Ø©
// **********************************************
function initializeRideUI(rideData) {
    toggleRideButtons(true); // Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø© (ÙˆÙ‡Ø°Ø§ Ø³ÙŠÙØ¹Ù„ Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©)
    showRideActions(false); // Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø¨ÙˆÙ„/Ø§Ù„Ø±ÙØ¶

    // ğŸŒŸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: ØªØ­Ø¯ÙŠØ« Ø±Ø§Ø¨Ø· ÙˆØ±Ù‚Ù… Ø§Ù„Ø§ØªØµØ§Ù„
    const riderPhoneNumber = rideData.riderPhone;
    riderPhoneNumberLink.innerText = riderPhoneNumber || "07700000000"; 
    riderPhoneNumberLink.href = `tel:${riderPhoneNumber || ''}`;

    // ğŸ†• ØªØ­Ø¯ÙŠØ« Ø²Ø± Waze Ù„Ù†Ù‚Ø·Ø© Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ø±Ø§ÙƒØ¨
    updateWazeButton(false, rideData);

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø´Ø§Øª
    chatRef = db.ref("chats/" + activeRideId); 
    listenForChatMessages(); 
    
    // ğŸ†• ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø£ÙˆÙ„ÙŠ Ø¥Ù„Ù‰ Ù†Ù‚Ø·Ø© Ø§Ù„ØªÙ‚Ø§Ø¡ Ø§Ù„Ø±Ø§ÙƒØ¨
    updateRoute(rideData.start);
    
    endBtn.onclick = startRide; // ğŸ†• Ø±Ø¨Ø· Ø§Ù„Ø²Ø± Ø¨ÙˆØ¸ÙŠÙØ© Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©

}

// **********************************************
// âš™ï¸ Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ (ZOOM) ğŸ†•ğŸ”
// **********************************************
function updateRoute(targetCoords) {
    if(routeControl){map.removeControl(routeControl);}
    routeControl = L.Routing.control({
        waypoints: [L.latLng(currentCoords[0], currentCoords[1]), L.latLng(targetCoords[0], targetCoords[1])],
        router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
        lineOptions: { styles: [{ color: 'blue', opacity: 0.8, weight: 6 }] }, // ğŸ” Ø²ÙŠØ§Ø¯Ø© Ø³Ù…Ùƒ Ø§Ù„Ø®Ø·
        addWaypoints: false, 
        fitSelectedRoutes: false, // ğŸš« Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù†Ù‚ÙˆÙ… Ø¨Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¨Ø´ÙƒÙ„ Ø£ÙØ¶Ù„
        show: false
    }).addTo(map);

    // ğŸ” Ø­Ø¯Ø«: Ø¹Ù†Ø¯ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø±ØŒ Ù‚Ù… Ø¨Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„Ù‚ÙˆÙŠ
    routeControl.on('routesfound', function(e) {
        const bounds = L.latLngBounds([currentCoords, targetCoords]);
        // ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ´Ù…Ù„ Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ§Ù„Ù‡Ø¯Ù Ù„ÙƒÙ† Ø¨Ø­Ø¯ Ø£Ù‚ØµÙ‰ Ù„Ù„Ø²ÙˆÙ… Ø¹Ø§Ù„Ù (Ù‚Ø±ÙŠØ¨)
        map.fitBounds(bounds, {
            padding: [100, 100], // Ù‡ÙˆØ§Ù…Ø´ Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø§Ù„ØªØµØ§Ù‚ Ø§Ù„Ù†Ù‚Ø§Ø· Ø¨Ø§Ù„Ø­Ø§ÙØ©
            maxZoom: 17, // ğŸŒŸ Ù‡Ù†Ø§ Ø§Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ù‡Ù…: Ù…Ø³ØªÙˆÙ‰ ØªÙ‚Ø±ÙŠØ¨ 17 ÙŠØ¬Ø¹Ù„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù‚Ø±ÙŠØ¨Ø© Ø¬Ø¯Ø§Ù‹
            animate: true
        });
    });

    map.invalidateSize();
}


// **********************************************
// ğŸ†• Ø¯Ø§Ù„Ø© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯ (Ù…ÙØµÙˆÙ„Ø© Ø¹Ù† Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹)
// **********************************************
function handleNewRideRequest(ride, id) {
    // 1. Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø±Ø­Ù„Ø© Ù†Ø´Ø·Ø© Ø£Ùˆ Ø­Ø¸Ø±
    if(activeRideId || driverStatus === "banned") return; 
    
    // 2. ğŸ›‘ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³Ø§ÙØ© (Ø´Ø±Ø· Ø§Ù„Ù€ 3 ÙƒÙ…)
    const distanceToRider = calculateDistance(currentCoords[0], currentCoords[1], ride.start[0], ride.start[1]);
    if (distanceToRider > MAX_DISTANCE_KM) {
        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¨Ø¹ÙŠØ¯Ø§Ù‹
        return; 
    }
    
    // 3. ğŸ›‘ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… Ø¹Ø±Ø¶ Ø·Ù„Ø¨ Ø¢Ø®Ø± Ø­Ø§Ù„ÙŠØ§Ù‹ (Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† pendingRideId)
    if(pendingRideId && pendingRideId !== id) return;
    
    pendingRideId = id; // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶
    currentRide = ride; // ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¤Ù‚ØªØ§Ù‹

    stopBeep();
    startBeep();
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø¨ÙˆÙ„/Ø§Ù„Ø±ÙØ¶
    toggleRideButtons(false); 
    showRideActions(true);
    
    // ğŸ†• Ø¹Ø±Ø¶ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚
    const startName = ride.startArea || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    const endName = ride.endArea || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    
    rideInfo.innerHTML=`ğŸš– <b>Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© (Ù‚Ø±ÙŠØ¨Ø©)</b><br>
    Ù…Ù†: <b>${startName}</b><br>
    Ø¥Ù„Ù‰: <b>${endName}</b><br>
    Ø§Ù„Ù…Ø³Ø§ÙØ©: ${ride.distance} ÙƒÙ… â€” Ø§Ù„Ø£Ø¬Ø±Ø©: ${ride.fare} Ø¯.Ø¹<br><b>ØªØ¨Ø¹Ø¯ Ø¹Ù†Ùƒ: ${distanceToRider.toFixed(2)} ÙƒÙ…</b>`;

    acceptBtn.onclick=()=>{
        db.ref("rides/"+id).once('value', currentSnap => {
            const currentRideData = currentSnap.val();
            
            if (!currentRideData || currentRideData.status !== "Ø¬Ø¯ÙŠØ¯Ø©" || driverStatus === "banned") {
                stopBeep();
                rideInfo.innerHTML="âš ï¸ Ø¢Ø³ÙØŒ ØªÙ… Ù‚Ø¨ÙˆÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø­Ù„Ø© Ù…Ù† Ù‚Ø¨Ù„ Ø³Ø§Ø¦Ù‚ Ø¢Ø®Ø± Ø£Ùˆ Ù„Ù… ØªØ¹Ø¯ Ù…ØªØ§Ø­Ø©.";
                showRideActions(false);
                pendingRideId = null; 
                currentRide = null;
                return;
            }

            const acceptedRide = currentRideData; 
            
            stopBeep();
            activeRideId=id;
            currentRide=acceptedRide; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† currentRide Ø¨Ø¹Ø¯ Ø§Ù„Ù‚Ø¨ÙˆÙ„
            driverStatus="busy"; 
            localStorage.setItem('activeRideId', id);
            localStorage.setItem('isRideStarted', 'false'); 
            pendingRideId = null; 

            db.ref("rides/"+id).update({
                status:"Ù…Ù‚Ø¨ÙˆÙ„Ø©",
                notification:"âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø© Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø³Ø§Ø¦Ù‚",
                assignedDriver:driverPhone, 
                driverPhone:driverPhone,
                acceptedAt:Date.now()
            });
            
            initializeRideUI(acceptedRide);
            // ğŸ†• Ø¹Ø±Ø¶ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù‚Ø¨ÙˆÙ„
            const acceptedStartName = acceptedRide.startArea || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            const acceptedEndName = acceptedRide.endArea || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            
            rideInfo.innerHTML=`âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©<br>
            Ù…Ù†: <b>${acceptedStartName}</b><br>
            Ø¥Ù„Ù‰: <b>${acceptedEndName}</b><br>
            Ø§Ù„Ù…Ø³Ø§ÙØ©: ${acceptedRide.distance} ÙƒÙ… â€” Ø§Ù„Ø£Ø¬Ø±Ø©: ${acceptedRide.fare} Ø¯.Ø¹<br><b>ğŸš— ØªÙˆØ¬Ù‡ Ø§Ù„Ø¢Ù† Ù„Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ø±Ø§ÙƒØ¨.</b>`;
        }); 
    };

    rejectBtn.onclick=()=>{
        stopBeep();
        db.ref("rides/"+id).update({
            status:"Ù…Ø±ÙÙˆØ¶Ø©",
            notification:"âŒ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø±ÙØ¶ Ø§Ù„Ø±Ø­Ù„Ø©"
        });
        showRideActions(false); 
        rideInfo.innerText="ğŸš• ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø±Ø­Ù„Ø© â€” Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯.";
        pendingRideId = null;
        currentRide = null; 
    };
}
// ----------------------------------------


// ğŸ›‘ Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙˆØ§Ù„Ø­Ø¸Ø± (Ù…ÙØ¹Ù„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„)
const driverDataRef = db.ref(`users/${driverPhone}`);
driverDataRef.on('value', snapshot => {
    const userData = snapshot.val();
    if (!userData || userData.type !== 'driver') return;

    const currentTime = Date.now();
    const expirationTime = userData.expire || 0;
    let isBanned = userData.banned || false;

    // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© ÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø¸Ø± (Ù…Ù†Ø·Ù‚ Ø§Ø­ØªÙŠØ§Ø·ÙŠ)
    if (expirationTime > 0 && expirationTime <= currentTime && !isBanned) {
        driverDataRef.update({ banned: true })
            .then(() => console.log("ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ø³Ø§Ø¦Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ."))
            .catch(error => console.error("ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø¸Ø± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:", error));
        
        isBanned = true; 
    }

    // 2. ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¸Ø±
    if (isBanned) {
        stopWatchForRides(); 
        stopMonitorRideChanges(); // ğŸ†• Ø¥ÙŠÙ‚Ø§Ù Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø£ÙŠØ¶Ø§Ù‹
        expiredModal.style.display = 'block';
        document.getElementById('map').style.opacity = '0.3';
        document.getElementById('panel').style.opacity = '0.3';
        driverStatus = "banned"; 
        
        if (activeRideId) {
             alert("âš ï¸ ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø³Ø¨Ø¨ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ø´ØªØ±Ø§ÙƒÙƒ.");
             resetDriverState(true);
        }

    } else {
        expiredModal.style.display = 'none';
        document.getElementById('map').style.opacity = '1';
        document.getElementById('panel').style.opacity = '1';
        driverStatus = activeRideId ? "busy" : "available";
        
        // 3. Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø¹Ø¯ Ø£ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚
        if (!isInitialCheckDone) {
            monitorRideChanges(); 
            getLocation(true); 
            isInitialCheckDone = true;
        }
        
        // ğŸ†• Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¹Ù†Ø¯ Ø¹Ø¯Ù… Ø§Ù„Ø­Ø¸Ø± (Ø³ÙŠØªÙ… ØªØ´ØºÙŠÙ„Ù‡ ÙÙŠ getLocation)
        if (!newRidesListener && !activeRideId) {
            watchForRides();
        }
    }
});


// ğŸŸ¢ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø¨Ø­Ø§Ù„Ø© "Ø¬Ø¯ÙŠØ¯Ø©")
function watchForRides(){
    if (newRidesListener || activeRideId) return;

    // ğŸ”‘ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    let newRidesQueryRef = db.ref("rides").orderByChild("status").equalTo("Ø¬Ø¯ÙŠØ¯Ø©");

    newRidesListener = newRidesQueryRef.on("child_added", snap=>{
        const ride=snap.val();
        const id=snap.key;
        
        // ğŸ†• ÙŠØ¬Ø¨ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…Ø³Ø§ÙØ© Ù‚Ø¨Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨
        if (!pendingRideId && driverStatus !== "banned" && currentCoords.length === 2 && ride.start && ride.start.length === 2) {
            handleNewRideRequest(ride, id);
        }
    });
}

// ğŸ”„ Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø© (Ø¥Ù„ØºØ§Ø¡ Ø£Ùˆ Ù‚Ø¨ÙˆÙ„ Ù…Ù† Ø³Ø§Ø¦Ù‚ Ø¢Ø®Ø±)
function monitorRideChanges() {
    if (rideChangesListener) return;

    // Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ ÙŠØ±Ø§Ù‚Ø¨ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø­Ù„Ø§Øª
    rideChangesListener = db.ref("rides").on("child_changed", snap => {
        const ride = snap.val();
        const id = snap.key;
        
        // 1. Ø­Ø§Ù„Ø© Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø© Ù…Ù† Ø³Ø§Ø¦Ù‚ Ø¢Ø®Ø±
        if (ride.status === "Ù…Ù‚Ø¨ÙˆÙ„Ø©" && id !== activeRideId) {
            
            // ğŸ†• Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ: Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ø§Ù„Ø¢Ø®Ø±ÙŠÙ† Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ Ù„Ù‡Ù… Ø§Ù„Ø·Ù„Ø¨
            if (pendingRideId === id) { 
                stopBeep();
                rideInfo.innerHTML = "âš ï¸ **ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©** Ù…Ù† Ù‚Ø¨Ù„ Ø³Ø§Ø¦Ù‚ Ø¢Ø®Ø±. Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯...";
                showRideActions(false);
                // ğŸŒŸ ØªØ­Ø¯ÙŠØ«: Ù…Ø³Ø­ Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
                currentRide = null; 
                pendingRideId = null;
            }
        }
        
        // 2. Ø­Ø§Ù„Ø© Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© Ù…Ù† Ø§Ù„Ø±Ø§ÙƒØ¨ (Ø£Ùˆ Ø§Ù†ØªÙ‡Øª)
        if (id === activeRideId && (ride.status === "Ù…Ù„ØºØ§Ø© Ù…Ù† Ø§Ù„Ø±Ø§ÙƒØ¨" || ride.status === "Ù…Ù†ØªÙ‡ÙŠØ©")) {
            if(ride.status === "Ù…Ù„ØºØ§Ø© Ù…Ù† Ø§Ù„Ø±Ø§ÙƒØ¨") alert("âŒ Ø§Ù†ØªØ¨Ø§Ù‡: Ø§Ù„Ø±Ø§ÙƒØ¨ Ø£Ù„ØºÙ‰ Ø§Ù„Ø±Ø­Ù„Ø©!");
            resetDriverState(true);
            rideInfo.innerText=`${ride.status === "Ù…Ù„ØºØ§Ø© Ù…Ù† Ø§Ù„Ø±Ø§ÙƒØ¨" ? 'âŒ Ø§Ù„Ø±Ø§ÙƒØ¨ Ø£Ù„ØºÙ‰ Ø§Ù„Ø±Ø­Ù„Ø©.' : 'ğŸš— ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©.'} Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯...`;
        }
        
        // 3. Ø­Ø§Ù„Ø© ØªÙ… Ø±ÙØ¶Ù‡Ø§ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø³Ø§Ø¦Ù‚ (Ù„Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ø§Ù„Ø¢Ø®Ø±ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† Ù‚Ø¯ ÙŠÙƒÙˆÙ†ÙˆÙ† Ù‚Ø±ÙŠØ¨ÙŠÙ†)
        if (id === pendingRideId && ride.status === "Ù…Ø±ÙÙˆØ¶Ø©") {
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù„Ù…ØªØ§Ø¨Ø¹ÙŠÙ† Ø§Ù„Ø¢Ø®Ø±ÙŠÙ† Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø·Ù„Ø¨ Ù„Ø§ ÙŠØ²Ø§Ù„ Ù…Ø¹Ø±ÙˆØ¶Ø§Ù‹ Ù„Ø¯ÙŠÙ‡Ù… Ù„Ø³Ø¨Ø¨ Ù…Ø§
            if (rideActionsDiv.style.display === "flex") {
                 showRideActions(false);
                 rideInfo.innerText = "ğŸš• Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯...";
                 currentRide = null;
                 pendingRideId = null;
            }
        }
    });
}


// Ø¯Ø§Ù„Ø© Ù„Ø¥ÙŠÙ‚Ø§Ù Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙ‚Ø·
function stopWatchForRides() {
    if (newRidesListener) {
        db.ref("rides").orderByChild("status").equalTo("Ø¬Ø¯ÙŠØ¯Ø©").off("child_added", newRidesListener);
        newRidesListener = null;
    }
}
// Ø¯Ø§Ù„Ø© Ù„Ø¥ÙŠÙ‚Ø§Ù Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø§Øª ÙÙ‚Ø·
function stopMonitorRideChanges() {
    if (rideChangesListener) {
        db.ref("rides").off("child_changed", rideChangesListener);
        rideChangesListener = null;
    }
}
// ----------------------------------------------------


// ğŸš— Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©
function endRide() {
Â  if(!activeRideId)return;
Â  stopBeep();
Â  db.ref("rides/"+activeRideId).update({
Â  Â  status:"Ù…Ù†ØªÙ‡ÙŠØ©",
Â  Â  notification:"ğŸš— ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©"
Â  });
Â Â 
Â  resetDriverState(true);
Â  rideInfo.innerText="ğŸš— ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©. Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯...";
};
// ğŸ†• Ø±Ø¨Ø· Ø§Ù„Ø²Ø± Ø¨Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ø¥Ù†Ù‡Ø§Ø¡ (Ø³ØªØªØºÙŠØ± Ø¹Ù†Ø¯ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©)
endBtn.onclick=endRide;


// ğŸƒâ€â™‚ï¸ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
logoutBtn.onclick = () => {
    // 1. Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
    localStorage.removeItem('phone');
    localStorage.removeItem('userType');
    localStorage.removeItem('activeRideId');
    localStorage.removeItem('isRideStarted'); 
    
    // 2. Ù…Ø³Ø­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Firebase
    db.ref(`availableDrivers/${driverPhone}`).remove();
    db.ref(`driverLocations/${driverPhone}`).remove();
    
    // 3. Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡
    window.location.href = "index.html";
};

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚
function resetDriverState(clearLocationInFirebase) {
Â  if(routeControl){map.removeControl(routeControl);}
Â  toggleRideButtons(false); // 9. ğŸ› ï¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ§Ø³Ø¹: Ø³ÙŠÙ‚ÙˆÙ… Ù‡Ø°Ø§ Ø¨Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØ¥Ù„ØºØ§Ø¡ Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©
Â  showRideActions(false); 
Â  chatBox.style.display = 'none'; 
Â  messagesDiv.innerHTML = '';
Â  if(chatRef) chatRef.off();
Â  chatRef = null;
Â  
  localStorage.removeItem('activeRideId');
  localStorage.removeItem('isRideStarted'); 
  isRideStarted = false; 
  pendingRideId = null; // ğŸ†• Ù…Ø³Ø­ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù‚
  
  // ğŸŒŸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ù‚Ù… Ø¥Ù„Ù‰ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ÙˆØ§Ù„Ø±Ø§Ø¨Ø· ÙØ§Ø±Øº
  riderPhoneNumberLink.innerText = "07700000000";
  riderPhoneNumberLink.href = "tel:07700000000";
  // ğŸ†• Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Waze
  wazeBtn.style.display = 'none';
  
  if (clearLocationInFirebase) {
      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø¤Ù‚Øª (ÙÙŠ Ø­Ø§Ù„ ÙƒØ§Ù†Øª Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ busy)
      db.ref(`driverLocations/${driverPhone}`).remove();
      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØ§Ø­ÙŠÙ† Ù…Ø¬Ø¯Ø¯Ø§Ù‹
      db.ref(`availableDrivers/${driverPhone}`).update({
          location: currentCoords,
          timestamp: firebase.database.ServerValue.TIMESTAMP,
          status: "available"
      });
  }

Â  driverStatus="available";
Â  activeRideId=null;
Â  currentRide=null;
  
  if (driverStatus !== "banned" && !newRidesListener) {
      watchForRides(); 
      rideInfo.innerText="âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø¨Ù†Ø¬Ø§Ø­ â€” Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø±Ø­Ù„Ø§Øª...";
  }
}

// ============================================
// ğŸ“£ Ù‚Ø³Ù… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù†
// ============================================
// ÙŠØªÙ… ÙˆØ¶Ø¹Ù‡Ø§ Ù‡Ù†Ø§ Ù„Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…ØªØºÙŠØ± driverPhone
if (driverPhone) {
    db.ref("notifications/" + driverPhone).on("value", snap => {
        const data = snap.val();
        if (data && data.message) {
            // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
            alert("ğŸ“£ Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©:\n\n" + data.message);
            
            // Ø­Ø°Ù Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù„Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø¸Ù‡ÙˆØ±Ù‡
            db.ref("notifications/" + driverPhone).remove();
        }
    });
}
// ============================================

});
</script>
</body>
</html>
