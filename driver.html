<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¨Ù„ÙŠ - Ø§Ù„ÙƒØ§Ø¨ØªÙ†</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #eee; overflow: hidden; }
        #map { height: 100%; width: 100%; z-index: 1; }

        /* Ø²Ø± Ø§Ù„ØªÙØ¹ÙŠÙ„ (Ù…Ø«Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ) */
        .offline-overlay {
            position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%);
            z-index: 2000; text-align: center; width: 80%;
        }
        .btn-activate {
            background: #2196F3; color: white; border: none;
            padding: 15px 30px; border-radius: 30px;
            font-size: 18px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
            display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%;
        }
        .pulse { animation: pulse-animation 2s infinite; }
        @keyframes pulse-animation { 0% { box-shadow: 0 0 0 0 rgba(33, 150, 243, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(33, 150, 243, 0); } 100% { box-shadow: 0 0 0 0 rgba(33, 150, 243, 0); } }

        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© */
        .bottom-nav {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: white; height: 70px; display: flex;
            justify-content: space-around; align-items: center;
            z-index: 1000; border-top: 1px solid #eee;
        }
        .nav-item { text-align: center; color: #757575; font-size: 12px; }
        .nav-item i { display: block; font-size: 20px; margin-bottom: 4px; }
        .nav-item.active { color: #2196F3; }

        /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ù„Ø¨ (BottomSheet) */
        .request-sheet {
            position: fixed; bottom: -100%; left: 0; right: 0;
            background: white; z-index: 3000;
            border-radius: 20px 20px 0 0; padding: 20px;
            box-shadow: 0 -5px 30px rgba(0,0,0,0.2);
            transition: bottom 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .request-sheet.show { bottom: 0; }

        .sheet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .price-tag { font-size: 28px; font-weight: 800; color: #333; }
        .service-type { background: #E3F2FD; color: #1565C0; padding: 5px 12px; border-radius: 15px; font-weight: bold; font-size: 14px; display: flex; align-items: center; gap: 5px; }

        /* ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø© (Ø§Ù„Ø®Ø· ÙˆØ§Ù„Ø¯ÙˆØ§Ø¦Ø±) */
        .trip-line { position: relative; padding-right: 25px; margin-bottom: 20px; }
        .trip-point { position: relative; margin-bottom: 20px; }
        .trip-point:last-child { margin-bottom: 0; }
        
        .dot {
            position: absolute; right: -25px; top: 5px; width: 12px; height: 12px;
            border-radius: 50%; z-index: 2;
        }
        .dot.pickup { background: #2196F3; border: 2px solid white; box-shadow: 0 0 0 2px #2196F3; }
        .dot.dropoff { background: black; border-radius: 0; width: 10px; height: 10px; }

        /* Ø®Ø· ÙŠØ±Ø¨Ø· Ø§Ù„Ù†Ù‚Ø§Ø· */
        .trip-line::before {
            content: ''; position: absolute; right: -19px; top: 10px; bottom: 10px;
            width: 2px; background: #ddd; z-index: 1;
        }

        .info-row { font-size: 14px; font-weight: bold; color: #333; margin-bottom: 4px; }
        .address-row { font-size: 13px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø¨ÙˆÙ„ */
        .btn-accept-ride {
            background: #1565C0; color: white; width: 100%;
            padding: 18px; border: none; border-radius: 12px;
            font-size: 18px; font-weight: bold; cursor: pointer;
            margin-top: 10px;
        }
        .btn-close {
            position: absolute; top: 15px; left: 15px;
            background: #f5f5f5; border: none; width: 30px; height: 30px;
            border-radius: 50%; font-size: 18px; color: #666; cursor: pointer;
        }

        /* Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø­Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø© */
        .active-ride-panel {
            position: fixed; top: 10px; left: 10px; right: 10px;
            background: white; padding: 15px; border-radius: 10px;
            z-index: 3000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: none;
        }
    </style>
</head>
<body>

<div id="map"></div>

<div class="offline-overlay" id="offlineUI">
    <button class="btn-activate pulse" onclick="goOnline()">
        <span>ğŸ“</span> Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ù„ØªÙØ¹ÙŠÙ„
    </button>
</div>

<div class="request-sheet" id="requestSheet">
    <button class="btn-close" onclick="rejectRide()">âœ•</button>
    
    <div class="sheet-header">
        <div class="service-type">ğŸš— Ø³ÙˆØ¨Ø±</div>
        <div class="price-tag"><span id="reqPrice">0</span> Ø¯ÙŠÙ†Ø§Ø±</div>
    </div>

    <div class="trip-line">
        <div class="trip-point">
            <div class="dot pickup"></div>
            <div class="info-row">
                <span id="pickupTime">1 Ø¯Ù‚ÙŠÙ‚Ø©</span> â€¢ <span id="pickupDist">300 Ù…ØªØ±</span>
            </div>
            <div class="address-row" id="pickupAddr">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>

        <div class="trip-point">
            <div class="dot dropoff"></div>
            <div class="info-row">
                <span id="tripTime">15 Ø¯Ù‚ÙŠÙ‚Ø©</span> â€¢ <span id="tripDist">5 ÙƒÙ…</span>
            </div>
            <div class="address-row" id="dropoffAddr">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>
    </div>

    <button class="btn-accept-ride" id="acceptBtn">Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø© Ø³ÙˆØ¨Ø±</button>
</div>

<div class="active-ride-panel" id="activePanel">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <div style="font-weight: bold;" id="riderPhoneDisp"></div>
            <small style="color:green;">â— Ø§Ù„Ø±Ø­Ù„Ø© Ø¬Ø§Ø±ÙŠØ©</small>
        </div>
        <a id="callRiderBtn" href="#" style="background: green; color: white; padding: 8px 15px; text-decoration: none; border-radius: 5px;">ğŸ“ Ø§ØªØµØ§Ù„</a>
    </div>
    <button onclick="finishRide()" style="width:100%; background:#f44336; color:white; border:none; padding:10px; margin-top:10px; border-radius:5px;">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>
</div>

<div class="bottom-nav">
    <div class="nav-item"><i>ğŸ </i>Ø§Ù„Ù…Ù†Ø²Ù„</div>
    <div class="nav-item"><i>âœ‰ï¸</i>Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</div>
    <div class="nav-item active" style="color: #2196F3; font-size: 30px; margin-top: -10px;"><i>ğŸ”˜</i></div> <div class="nav-item"><i>ğŸ</i>Ø§Ù„Ø­ÙˆØ§ÙØ²</div>
    <div class="nav-item"><i>ğŸ§</i>Ø§Ù„Ø¯Ø¹Ù…</div>
</div>

<script>
// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
const firebaseConfig = { apiKey: "AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M", databaseURL: "https://taxi-15314-default-rtdb.firebaseio.com/" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
let map, driverMarker;
let isOnline = false;
let currentRideKey = null;
const driverPhone = localStorage.getItem("phone") || "07800000000";

// Ø§Ù„ØµÙˆØª
const alertSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3');
alertSound.loop = true; // ØªÙƒØ±Ø§Ø± Ø§Ù„ØµÙˆØª Ø­ØªÙ‰ ÙŠØªÙ… Ø§Ù„Ø±Ø¯

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©
function initMap() {
    map = L.map('map', {zoomControl: false}).setView([33.3152, 44.3661], 13);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
    driverMarker = L.marker([33.3152, 44.3661]).addTo(map);
}

// ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ "Ù…ØªØµÙ„"
function goOnline() {
    isOnline = true;
    document.getElementById('offlineUI').style.display = 'none';
    
    // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ù„Ø­Ø¸ÙŠØ§Ù‹ Ù„Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ù…ØªØµÙØ­ Ù„Ù„ØµÙˆØª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø«Ù… Ø¥ÙŠÙ‚Ø§ÙÙ‡
    alertSound.play().then(() => {
        alertSound.pause();
        alertSound.currentTime = 0;
    }).catch(e => console.log("Audio permission needed"));

    // Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø·Ù„Ø¨Ø§Øª
    listenForRides();
    
    // Ù…Ø­Ø§ÙƒØ§Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹
    if (navigator.geolocation) {
        navigator.geolocation.watchPosition(pos => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            const newLatLng = new L.LatLng(lat, lng);
            driverMarker.setLatLng(newLatLng);
            map.setView(newLatLng, 15);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            db.ref("drivers/" + driverPhone).update({lat: lat, lng: lng});
        });
    }
}

// Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
function listenForRides() {
    db.ref("rides").limitToLast(1).on("child_added", snap => {
        if (!isOnline) return;
        const r = snap.val();
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯Ø§Ù‹ ÙˆÙ„Ù… ÙŠÙ…Ø± Ø¹Ù„ÙŠÙ‡ ÙˆÙ‚Øª Ø·ÙˆÙŠÙ„ (Ù…Ø«Ù„Ø§Ù‹ Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ†)
        if (r.status === "Ø¬Ø¯ÙŠØ¯Ø©") {
            showRequestUI(snap.key, r);
        }
    });
}

function showRequestUI(key, r) {
    currentRideKey = key;
    
    // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„ØµÙˆØªÙŠ
    alertSound.play();

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª (ØªÙ‚Ø¯ÙŠØ±ÙŠ Ù„Ù„Ø¹Ø±Ø¶)
    const driverLoc = driverMarker.getLatLng();
    const pickupLoc = L.latLng(r.start[0], r.start[1]);
    const dropoffLoc = L.latLng(r.end[0], r.end[1]);

    // Ø§Ù„Ù…Ø³Ø§ÙØ© Ù„Ù„ÙƒØ§Ø¨ØªÙ† (Ø¨Ø§Ù„Ù…ØªØ± ÙˆØ§Ù„Ø¯Ù‚Ø§Ø¦Ù‚)
    const distToPickup = driverLoc.distanceTo(pickupLoc); // Ù…ØªØ±
    const timeToPickup = Math.ceil(distToPickup / 400); // ÙØ±Ø¶ÙŠØ©: 400 Ù…ØªØ± Ø¨Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©

    // Ù…Ø³Ø§ÙØ© Ø§Ù„Ø±Ø­Ù„Ø©
    const tripDist = (pickupLoc.distanceTo(dropoffLoc) / 1000).toFixed(1); // ÙƒÙ…
    const tripTime = Math.ceil(tripDist * 3); // ÙØ±Ø¶ÙŠØ©: 3 Ø¯Ù‚Ø§Ø¦Ù‚ Ù„ÙƒÙ„ ÙƒÙ…

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    document.getElementById('reqPrice').innerText = r.fare;
    
    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    document.getElementById('pickupTime').innerText = timeToPickup + " Ø¯Ù‚ÙŠÙ‚Ø©";
    document.getElementById('pickupDist').innerText = Math.round(distToPickup) + " Ù…ØªØ±";
    document.getElementById('pickupAddr').innerText = r.startName || "Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…";

    document.getElementById('tripTime').innerText = tripTime + " Ø¯Ù‚ÙŠÙ‚Ø©";
    document.getElementById('tripDist').innerText = tripDist + " ÙƒÙ…";
    document.getElementById('dropoffAddr').innerText = r.endName || "Ø§Ù„ÙˆØ¬Ù‡Ø©";

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø©
    document.getElementById('requestSheet').classList.add('show');

    // Ø²Ø± Ø§Ù„Ù‚Ø¨ÙˆÙ„
    document.getElementById('acceptBtn').onclick = () => acceptRide(key, r);
}

function acceptRide(key, r) {
    alertSound.pause();
    alertSound.currentTime = 0;
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ³
    db.ref("rides/" + key).update({
        status: "Ù…Ù‚Ø¨ÙˆÙ„Ø©",
        driverPhone: driverPhone
    });

    // Ø¥Ø®ÙØ§Ø¡ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø­Ù„Ø©
    document.getElementById('requestSheet').classList.remove('show');
    showActiveRideUI(r);
}

function rejectRide() {
    alertSound.pause();
    alertSound.currentTime = 0;
    document.getElementById('requestSheet').classList.remove('show');
    currentRideKey = null;
}

function showActiveRideUI(r) {
    document.getElementById('activePanel').style.display = 'block';
    document.getElementById('riderPhoneDisp').innerText = "Ø§Ù„Ø±Ø§ÙƒØ¨: " + r.riderPhone;
    document.getElementById('callRiderBtn').href = "tel:" + r.riderPhone;

    // Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± (Ù†Ù‚Ø§Ø· ÙÙ‚Ø·)
    L.marker(r.start, {icon: L.divIcon({className: 'dot pickup', html: 'ğŸŸ¢'})}).addTo(map);
    L.marker(r.end, {icon: L.divIcon({className: 'dot dropoff', html: 'ğŸ'})}).addTo(map);
    map.fitBounds([r.start, r.end, driverMarker.getLatLng()], {padding: [50,50]});
}

function finishRide() {
    if(currentRideKey) {
        db.ref("rides/" + currentRideKey).update({status: "Ù…Ù†ØªÙ‡ÙŠØ©"});
        location.reload(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù„Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¬Ø§Ù‡Ø²
    }
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
initMap();

</script>
</body>
</html>
