<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø³Ø§Ø¦Ù‚ - ØªÙƒØ³ÙŠ Ø§Ù„Ø¹Ø±Ø§Ù‚ Ø§Ù„Ø´Ø§Ù…Ù„</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<style>
body, html {
    margin: 0;
    padding: 0;
    height: 100%;
    font-family: Tahoma;
    overflow: hidden; /* Ø¥Ø²Ø§Ù„Ø© Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± */
    display: flex;
    flex-direction: column;
}

#panel {
    background: #fff;
    padding: 10px;
    text-align: center;
    box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.2);
    /* Ø¶Ù…Ø§Ù† Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ù„ÙˆØ­Ø© ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ */
    flex-shrink: 0; 
}

/* Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ù„ØªÙƒØ¨ÙŠØ± ÙˆØªØ«Ø®ÙŠÙ† Ø§Ù„Ø®Ø· */
#panel p#status {
    font-size: 1.2em; /* ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø· */
    font-weight: bold; /* ØªØ«Ø®ÙŠÙ† Ø§Ù„Ø®Ø· */
    margin: 10px 0;
    line-height: 1.6;
    color: #333;
}


/* ØªØ¹Ø¯ÙŠÙ„ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ÙŠÙƒÙˆÙ† Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ */
#map {
    height: calc(100vh - 120px); /* Ù‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø³ÙŠØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JS */
    transition: height 0.3s ease-in-out;
    flex-grow: 1; /* Ù„ØªØ£Ø®Ø° Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© */
}

button {
    background: #ffb300;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    margin: 5px;
    font-weight: bold;
    cursor: pointer;
}
#logoutBtn {
    background: #455a64;
    color: white;
    margin-top: 10px;
    width: 95%;
}

/* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
#floatingControls {
    position: absolute;
    bottom: 10px;
    left: 10px;
    z-index: 1000;
    direction: ltr;
    display: flex; /* ØªÙØ¹ÙŠÙ„ Flexbox */
    flex-direction: column-reverse; /* Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„ Ù„Ù„Ø£Ø¹Ù„Ù‰ (Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡ ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„) */
    align-items: flex-start; /* Ù…Ø­Ø§Ø°Ø§Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¥Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± */
    gap: 10px; /* Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø¹Ù†Ø§ØµØ± */
}
#floatingControls button,
#floatingControls .ride-action-info {
    display: block;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    width: 150px;
    font-size: 14px;
    padding: 10px;
    margin: 0; /* Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù‡Ø§Ù…Ø´ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø§Ø®ØªÙ„Ø§Ø· */
}
.ride-action-info {
    background: #fff;
    padding: 5px;
    color: #333;
    font-size: 0.9em;
    direction: rtl;
    text-align: center;
}
.phone-link {
    color: #007bff;
    text-decoration: none;
    font-weight: bold;
    display: block;
    margin: 0;
    font-size: 1em;
}
.phone-link:hover {
    text-decoration: underline;
}
#startRideBtn {
    background: #ff9800;
    color: white;
}
#finishBtn {
    background: #1e88e5;
    color: white;
}
/* Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù„ÙˆÙ† Ø£Ø²Ø±Ù‚ Ù…Ù…ÙŠØ² ÙˆÙ‚Ø±ÙŠØ¨ Ù…Ù† Ù„ÙˆÙ† ÙˆÙŠØ² Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ø¬Ø¹Ù„Ù‡ Ø¨Ø§Ø±Ø²Ø§Ù‹ */
#wazeBtn {
    background: #32CCFE; /* Waze Blue */
    color: white;
}
</style>
</head>
<body onclick="initializeAudioContext()"> <div id="map"></div>

<div id="floatingControls" style="display:none;">
    <button id="startRideBtn" style="display:none;">Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© ğŸš¦</button> 
    <button id="finishBtn" style="display:none;">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>
    
    <button id="wazeBtn" onclick="openWaze()"></button>
    
    <div id="riderContactInfo" class="ride-action-info" style="display:none;"></div>
</div>


<div id="panel">
    <h3>ğŸš– ÙˆØ¶Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚</h3>
    <p id="status">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</p>
    
    <button id="acceptBtn" style="display:none;background:#4caf50;color:white;">Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©</button>
    <button id="rejectBtn" style="display:none;background:#e53935;color:white;">Ø±ÙØ¶ Ø§Ù„Ø±Ø­Ù„Ø©</button>
    
    <button id="logoutBtn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</div>

<script>
// Ù…Ù†Ø¹ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¯ÙˆÙ† Ø­Ø³Ø§Ø¨
window.onload=function(){
    let phone=localStorage.getItem("phone");
    let type=localStorage.getItem("userType");
    if(!phone||type!=="driver"){
        window.location.href="index.html";
    }
    // Ø­Ø³Ø§Ø¨ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ 
    updateMapHeight();
    window.addEventListener('resize', updateMapHeight);
};

function logout(){
    localStorage.clear();
    window.location.href="index.html";
}

// Firebase
const app=firebase.initializeApp({
  apiKey:"AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M",
  authDomain:"taxi-15314.firebaseapp.com",
  databaseURL:"https://taxi-15314-default-rtdb.firebaseio.com/",
  projectId:"taxi-15314"
});
const db=firebase.database();

// Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
let map=L.map('map').setView([33.3152,44.3661],13);

// Ø®Ø±ÙŠØ·Ø© Google Maps 
L.tileLayer(
 "https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}&key=AIzaSyD7TtwniAdUtB8-pnTny4ZwE6gqX36SGUk",
 {maxZoom:20}
).addTo(map);

map.whenReady(()=>map.invalidateSize());

// Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚
let driverMarker=null;
let driverPhone=localStorage.getItem("phone");

// ===== Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø±Ø­Ù„Ø© ÙˆØ§Ù„Ù…Ø³Ø§Ø±Ø§Øª =====
let currentRideId=null;
let passengerMarker=null;
let pickupRoute=null; // Ù…Ø³Ø§Ø± Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (Ù…Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù„Ù„Ø±Ø§ÙƒØ¨)
let destinationRoute=null; // Ù…Ø³Ø§Ø± Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© (Ù…Ù† Ø§Ù„Ø±Ø§ÙƒØ¨ Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ©)
let currentRideData=null;
// ===========================================

// â­â­ Ù…ØªØºÙŠØ±Ø§Øª Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø±Ø³/Ø§Ù„Ø±Ù†ÙŠÙ† â­â­
let audioContext = null;
let oscillator = null;
let ringingInterval = null; // Ø§Ø³ØªØ®Ø¯Ø§Ù… Interval Ù„Ù„ØªÙƒØ±Ø§Ø±
let isAudioContextInitialized = false;

// â­â­ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªÙ‡ÙŠØ¦Ø© Ø³ÙŠØ§Ù‚ Ø§Ù„ØµÙˆØª Ø¹Ù†Ø¯ Ø£ÙˆÙ„ ØªÙØ§Ø¹Ù„ â­â­
function initializeAudioContext() {
    if (isAudioContextInitialized) return;

    try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        isAudioContextInitialized = true;
        console.log("âœ… AudioContext initialized on user interaction.");
    } catch (e) {
        console.error("AudioContext initialization failed:", e);
    }
    // Ø¥Ø²Ø§Ù„Ø© Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø­Ø¯Ø« Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
    document.body.onclick = null;
}

function startRinging() {
    // ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† AudioContext Ù…Ù‡ÙŠØ£ Ù‚Ø¨Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„
    if (!isAudioContextInitialized) {
        console.warn("AudioContext not initialized yet. Waiting for user interaction.");
        return; 
    }
    
    // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ Ø±Ù†ÙŠÙ† Ø³Ø§Ø¨Ù‚ Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø¯Ø¡
    stopRinging(); 

    // Ø¯Ø§Ù„Ø© Ù„ØªÙˆÙ„ÙŠØ¯ Ù†ØºÙ…Ø© ÙˆØ§Ø­Ø¯Ø©
    const playTone = () => {
        // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø°Ø¨Ø°Ø¨ (Oscillator) Ù„ØªÙˆÙ„ÙŠØ¯ Ù†ØºÙ…Ø©
        oscillator = audioContext.createOscillator();
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ØºÙ…Ø© Ù…Ø³Ù…ÙˆØ¹Ø© ÙˆÙ…Ù…ÙŠØ²Ø© (A4)
        oscillator.frequency.setValueAtTime(440, audioContext.currentTime); 
        
        // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ³Ø¨ (Gain) Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ØµÙˆØª ÙˆØªØ¬Ù†Ø¨ Ø§Ù„Ù†Ù‚Ø±Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„ØªÙˆÙ‚Ù
        const gainNode = audioContext.createGain();
        // *** Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ø±ÙØ¹ Ø§Ù„ØµÙˆØª Ù…Ù† 0.5 Ø¥Ù„Ù‰ 0.8 ***
        gainNode.gain.setValueAtTime(0.8, audioContext.currentTime); // Ù…Ø³ØªÙˆÙ‰ ØµÙˆØª 80%
        
        // ØªÙˆØµÙŠÙ„ Ø§Ù„Ù…Ø°Ø¨Ø°Ø¨ Ø¨Ù€ Gain Ø«Ù… Ø¨Ù…Ø®Ø±Ø¬ Ø§Ù„ØµÙˆØª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        // Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ø§Ù„Ø±Ù†ÙŠÙ† ÙÙˆØ±Ø§Ù‹
        oscillator.start(0);

        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù†ØºÙ…Ø© Ø¨Ø¹Ø¯ ÙØªØ±Ø© Ù‚ØµÙŠØ±Ø© (Ù…Ø«Ù„Ø§Ù‹ 500 Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©)
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);
        oscillator.stop(audioContext.currentTime + 0.5); 
    };

    // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†ØºÙ…Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
    playTone();
    
    // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†ØºÙ…Ø© Ø¨Ø´ÙƒÙ„ Ù…ØªÙƒØ±Ø± (ÙƒÙ„ Ø«Ø§Ù†ÙŠØ© Ù…Ø«Ù„Ø§Ù‹) Ø­ØªÙ‰ ÙŠØªÙ… Ø¥ÙŠÙ‚Ø§ÙÙ‡Ø§
    ringingInterval = setInterval(playTone, 1000); 
    
    console.log("ğŸ”” Ø¨Ø¯Ø£ Ø§Ù„Ø±Ù†ÙŠÙ†. Ø³ÙŠØ³ØªÙ…Ø± Ø¨Ø§Ù„ØªÙƒØ±Ø§Ø± Ø­ØªÙ‰ ÙŠØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„ Ø£Ùˆ Ø§Ù„Ø±ÙØ¶.");
}

function stopRinging() {
    if (ringingInterval) {
        clearInterval(ringingInterval);
        ringingInterval = null;
        console.log("ğŸ”” ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø±Ù†ÙŠÙ† ÙŠØ¯ÙˆÙŠØ§Ù‹.");
    }
    // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ Ù†ØºÙ…Ø© ØªØ¹Ù…Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹ Ø¨Ø´ÙƒÙ„ ÙØ±Ø¯ÙŠ
    if (oscillator) {
        try {
            oscillator.stop();
        } catch(e) {
            console.error("Error stopping oscillator:", e);
        } finally {
            oscillator = null;
        }
    }
}
// â­â­â­â­â­â­â­â­â­â­â­â­â­â­â­â­â­â­â­â­â­â­â­

// Ø¯Ø§Ù„Ø© Ù„Ø­Ø³Ø§Ø¨ Ø§Ø±ØªÙØ§Ø¹ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØªØ¹ÙŠÙŠÙ† Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø®Ø±ÙŠØ·Ø© 
function updateMapHeight() {
    const panelHeight = panelElement.offsetHeight;
    if (panelElement.style.display !== "none") {
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù„ÙˆØ­Ø© Ù…Ø±Ø¦ÙŠØ©ØŒ Ø§Ø¬Ø¹Ù„ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙŠØ³Ø§ÙˆÙŠ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„ÙƒÙ„ÙŠ Ù†Ø§Ù‚Øµ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ù„ÙˆØ­Ø©
        mapElement.style.height = `calc(100vh - ${panelHeight}px)`;
    } else {
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù„ÙˆØ­Ø© Ù…Ø®ÙÙŠØ©ØŒ Ø§Ø¬Ø¹Ù„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¨ÙƒØ§Ù…Ù„ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø´Ø§Ø´Ø©
        mapElement.style.height = '100vh';
    }
    map.invalidateSize();
}

// ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†Ù
setInterval(()=>{
    navigator.geolocation.getCurrentPosition(pos=>{
        let lat=pos.coords.latitude;
        let lng=pos.coords.longitude;

        if(driverMarker) map.removeLayer(driverMarker);
        driverMarker=L.marker([lat,lng]).addTo(map).bindPopup("ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ");

        db.ref("drivers/"+driverPhone).set({
            lat:lat,lng:lng,status:"Ù…ØªØµÙ„"
        });
        
        // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ø¹Ù†Ø¯ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø±Ø­Ù„Ø© Ù†Ø´Ø·Ø©
        if (!currentRideId) {
            map.setView([lat, lng], map.getZoom() > 13 ? map.getZoom() : 13);
        }

    },err=>{},{
        enableHighAccuracy:true,timeout:5000
    });
},5000);

// Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ù…Ø³Ø§Ø±Ø§Øª ÙˆØ§Ù„Ù…Ø¤Ø´Ø±Ø§Øª
function removeAllRideMarkers(){
    if(passengerMarker) map.removeLayer(passengerMarker);
    if(pickupRoute) map.removeLayer(pickupRoute);
    if(destinationRoute) map.removeLayer(destinationRoute);
    passengerMarker=null;
    pickupRoute=null;
    destinationRoute=null;
    
    // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¤Ø´Ø±Ø§Øª Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø£Ø®Ø±Ù‰
    map.eachLayer(layer => {
        if (layer instanceof L.Marker && layer !== driverMarker) {
            const popupContent = layer.getPopup().getContent();
            if (popupContent && (popupContent.includes("Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ©") || popupContent.includes("Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©"))) {
                map.removeLayer(layer);
            }
        }
    });
}

// Ø§Ù„Ø¯Ø§Ù„Ø©: Ø¬Ù„Ø¨ ÙˆØ±Ø³Ù… Ù…Ø³Ø§Ø± Ø­Ù‚ÙŠÙ‚ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø´ÙˆØ§Ø±Ø¹ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… OSRM
async function drawStreetRoute(lat1, lng1, lat2, lng2, color, dashArray = '') {
    // Ø®Ø¯Ù…Ø© OSRM ØªØªØ·Ù„Ø¨ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø¨ØµÙŠØºØ©: lng,lat
    const OSRM_URL = `https://router.project-osrm.org/route/v1/driving/${lng1},${lat1};${lng2},${lat2}?geometries=geojson&overview=full`;
    
    try {
        const response = await fetch(OSRM_URL);
        const data = await response.json();

        if (data.code !== 'Ok' || !data.routes || data.routes.length === 0) {
            console.error('OSRM route calculation failed or no route found. Falling back to straight line.');
            // Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨Ø³ÙŠØ· ÙÙŠ Ø­Ø§Ù„ Ø§Ù„ÙØ´Ù„
            return L.polyline([[lat1, lng1], [lat2, lng2]], { color: color, dashArray: dashArray, weight: 5 }).addTo(map);
        }

        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø§Ø± Ù…Ù† Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© (Ø¨ØµÙŠØºØ© GeoJSON: [lng, lat])
        const geojsonCoords = data.routes[0].geometry.coordinates;

        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø¥Ù„Ù‰ ØµÙŠØºØ© Leaflet ([lat, lng])
        const leafletCoords = geojsonCoords.map(coord => [coord[1], coord[0]]);

        let route = L.polyline(leafletCoords, { color: color, dashArray: dashArray, weight: 5 }).addTo(map);
        return route;

    } catch (error) {
        console.error('Error fetching route from OSRM. Falling back to straight line.', error);
        // Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨Ø³ÙŠØ· ÙÙŠ Ø­Ø§Ù„ Ø§Ù„ÙØ´Ù„
        return L.polyline([[lat1, lng1], [lat2, lng2]], { color: color, dashArray: dashArray, weight: 5 }).addTo(map);
    }
}


// Ø¯Ø§Ù„Ø© Waze Ø§Ù„Ù…ÙˆØ­Ø¯Ø© Ø§Ù„ØªÙŠ ØªØ­Ø¯Ø¯ Ø§Ù„ÙˆØ¬Ù‡Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø­Ù„Ø©
function openWaze(){
    if(!currentRideData) return;

    let lat, lng;
    let status = currentRideData.status;
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ù‚Ø¨ÙˆÙ„Ø© (Ø°Ø§Ù‡Ø¨ Ù„Ù„Ø±Ø§ÙƒØ¨)ØŒ Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø±Ø§ÙƒØ¨ (Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©)
    if (status === "Ù…Ù‚Ø¨ÙˆÙ„Ø©" && currentRideData.startLat && currentRideData.startLng) {
        lat = currentRideData.startLat;
        lng = currentRideData.startLng;
    } 
    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¨Ø¯Ø£Øª (Ø°Ø§Ù‡Ø¨ Ù„Ù„ÙˆØ¬Ù‡Ø©)ØŒ Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
    else if (status === "Ø¨Ø¯Ø£Øª" && currentRideData.endLat && currentRideData.endLng) {
        lat = currentRideData.endLat;
        lng = currentRideData.endLng;
    } else {
        return; // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø£Ùˆ Ø­Ø§Ù„Ø© ØºÙŠØ± Ù…Ù†Ø§Ø³Ø¨Ø©
    }

    if(lat && lng){
        window.open(`https://www.waze.com/ul?ll=${lat},${lng}&navigate=yes`, '_blank');
    }
}

// Ø§Ù„Ø¯Ø§Ù„Ø©: Ø§Ø³ØªØ®Ù„Ø§Øµ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£Ù‚ØµØ± Ù„Ù„Ù…Ù†Ø·Ù‚Ø© 
function getShortAreaName(fullArea) {
    if (!fullArea) return "Ù…Ù†Ø·Ù‚Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©";
    const parts = fullArea.split(',').map(p => p.trim()).filter(p => p.length > 0);
    
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£Ø®ÙŠØ± Ø£Ùˆ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø°ÙŠ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙƒÙ„Ù…Ø© "Ù‚Ø¶Ø§Ø¡" Ø£Ùˆ "Ù†Ø§Ø­ÙŠØ©" Ø£Ùˆ "Ù…Ø±ÙƒØ²"
    const relevantParts = parts.filter(p => 
        !p.includes("Ù‚Ø¶Ø§Ø¡") && 
        !p.includes("Ù†Ø§Ø­ÙŠØ©") && 
        !p.includes("Ù…Ø±ÙƒØ²") &&
        !p.includes("Ø¨ØºØ¯Ø§Ø¯") // Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø¨ØºØ¯Ø§Ø¯ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø©
    );

    if (relevantParts.length > 0) {
        // Ù†Ø£Ø®Ø° Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£ÙƒØ«Ø± Ø¯Ù‚Ø© (Ø¹Ø§Ø¯Ø© Ø§Ù„Ø£Ù‚Ø±Ø¨ Ù„Ù„Ø¨Ø¯Ø§ÙŠØ© ÙÙŠ Ø³Ù„Ø³Ù„Ø© Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†)
        return relevantParts[0]; 
    }
    
    // Ø¥Ø°Ø§ Ù„Ù… ØªÙ†Ø¬Ø­ Ø§Ù„ÙÙ„ØªØ±Ø©ØŒ Ù†Ø£Ø®Ø° Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£Ø®ÙŠØ± (Ø§Ù„Ø£Ù‚ØµØ± ÙˆØ§Ù„Ø£ÙƒØ«Ø± Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ø³Ù… Ø§Ù„Ø­ÙŠ)
    return parts[parts.length - 1]; 
}
// ===============================================

// Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
const statusText=document.getElementById("status");
const acceptBtn=document.getElementById("acceptBtn");
const rejectBtn=document.getElementById("rejectBtn");
const startRideBtn=document.getElementById("startRideBtn");
const finishBtn=document.getElementById("finishBtn");
const wazeBtn=document.getElementById("wazeBtn");
const logoutBtn=document.getElementById("logoutBtn"); 
const floatingControls=document.getElementById("floatingControls"); // Ø¹Ù†ØµØ± Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¹Ø§Ø¦Ù…
const riderContactInfo=document.getElementById("riderContactInfo"); // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„

const mapElement = document.getElementById("map"); 
const panelElement = document.getElementById("panel");

db.ref("rides").on("value",snap=>{
    let data=snap.val();
    if(!data) return;

    let rideFound=false;

    Object.keys(data).forEach(id=>{
        let r=data[id];
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        if(r.status==="Ø¬Ø¯ÙŠØ¯Ø©" && !rideFound){
            rideFound=true;
            showRideRequest(id,r);
        }
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹
        else if(r.status==="Ù…Ù‚Ø¨ÙˆÙ„Ø©" && r.driverPhone===driverPhone){
             rideFound=true;
             handleAcceptedRide(id,r);
        }
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„ØªÙŠ Ø¨Ø¯Ø£Øª Ø­Ø§Ù„ÙŠØ§Ù‹ (ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©)
        else if(r.status==="Ø¨Ø¯Ø£Øª" && r.driverPhone===driverPhone){
             rideFound=true;
             handleStartedRide(id,r);
        }
    });

    if(!rideFound){
        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø±Ù†ÙŠÙ† Ø¹Ù†Ø¯ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø·Ù„Ø¨ Ù†Ø´Ø· 
        stopRinging(); 

        removeAllRideMarkers();
        currentRideId=null;
        currentRideData=null;
        acceptBtn.style.display="none";
        rejectBtn.style.display="none";
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© ÙˆÙ…Ø­ØªÙˆÙŠØ§ØªÙ‡Ø§
        startRideBtn.style.display="none";
        finishBtn.style.display="none";
        wazeBtn.style.display="none";
        riderContactInfo.style.display="none";
        floatingControls.style.display="none";
        
        logoutBtn.style.display="inline-block"; // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        statusText.innerText="ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª...";
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø­Ø¬Ù… Ø§Ù„Ø®Ø±ÙŠØ·Ø© 
        panelElement.style.display="block"; 
        updateMapHeight();
    }
});

function showRideRequest(id,r){
    currentRideId=id;
    currentRideData=r;
    
    // â­â­ Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ù†ÙŠÙ† Ø¹Ù†Ø¯ ÙˆØ±ÙˆØ¯ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ â­â­
    startRinging();

    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© ÙˆØ§Ù„Ø¹Ø§Ø¦Ù…Ø©
    startRideBtn.style.display="none";
    finishBtn.style.display="none";
    wazeBtn.style.display="none";
    riderContactInfo.style.display="none";
    floatingControls.style.display="none";
    logoutBtn.style.display="inline-block"; // Ø¥Ø¸Ù‡Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    removeAllRideMarkers();

    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¶Ø¹ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆÙ„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    panelElement.style.display="block"; 
    updateMapHeight();

    // Ø­Ø³Ø§Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø£Ø¬Ø±Ø©
    const distance = parseFloat(r.distance) || 0;
    const fare = r.fare || Math.round(distance * 1000); // 1000 Ø¯ÙŠÙ†Ø§Ø± Ù„ÙƒÙ„ ÙƒÙ…
    const formattedFare = fare.toLocaleString('ar-IQ') || '...';
    
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¹Ø±Ø¶ Ù…Ø®ØªØµØ± 
    const shortStartArea = getShortAreaName(r.startArea);
    const shortEndArea = getShortAreaName(r.endArea);
    
    // ØªÙ†Ø³ÙŠÙ‚ Ø¬Ø¯ÙŠØ¯ Ù„Ø¬Ø¹Ù„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø£ÙƒØ¨Ø± ÙˆØ£ÙƒØ«Ø± ÙˆØ¶ÙˆØ­Ù‹Ø§
    const fareStyle = "font-size: 1.1em; font-weight: bold; color: #e53935;"; // Ø£Ø­Ù…Ø± Ø¯Ø§ÙƒÙ† Ù„Ù„Ø£Ø¬Ø±Ø©
    const distanceStyle = "font-size: 1.1em; font-weight: bold; color: #455a64;"; // Ø±Ù…Ø§Ø¯ÙŠ Ø¯Ø§ÙƒÙ† Ù„Ù„Ù…Ø³Ø§ÙØ©

    // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ø¬ÙˆÙ… ÙˆØªØ·Ø¨ÙŠÙ‚ ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ø³Ø§ÙØ© ÙˆØ§Ù„Ø£Ø¬Ø±Ø©
    statusText.innerHTML=
      `ğŸš– Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯<br>
       Ù…Ù†: ${shortStartArea} Ø¥Ù„Ù‰: ${shortEndArea}<br>
       Ù…Ø³Ø§ÙØ© Ø§Ù„Ø±Ø­Ù„Ø©: <span style="${distanceStyle}">${r.distance} ÙƒÙ…</span><br>
       Ø§Ù„Ø£Ø¬Ø±Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©: <span style="${fareStyle}">${formattedFare} Ø¯.Ø¹</span>`;

    acceptBtn.style.display="inline-block";
    rejectBtn.style.display="inline-block";

    // Ø¹Ù†Ø¯ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©
    acceptBtn.onclick=function(){
        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø±Ù†ÙŠÙ† Ø¹Ù†Ø¯ Ø§Ù„Ù‚Ø¨ÙˆÙ„ 
        stopRinging(); 
        db.ref("rides/"+id).update({status:"Ù…Ù‚Ø¨ÙˆÙ„Ø©",driverPhone:driverPhone});
    };

    // Ø¹Ù†Ø¯ Ø±ÙØ¶ Ø§Ù„Ø±Ø­Ù„Ø©
    rejectBtn.onclick=function(){
        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø±Ù†ÙŠÙ† Ø¹Ù†Ø¯ Ø§Ù„Ø±ÙØ¶ 
        stopRinging();
        db.ref("rides/"+id).update({status:"Ù…Ø±ÙÙˆØ¶Ø©"});
        statusText.innerText="ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø±Ø­Ù„Ø©.";
        acceptBtn.style.display="none";
        rejectBtn.style.display="none";
    };
}

// Ø¬Ø¹Ù„ Ø§Ù„Ø¯Ø§Ù„Ø© ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù†Ø© (async) Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… fetch
async function handleAcceptedRide(id,r){
    currentRideId=id;
    currentRideData=r;
    
    // Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    acceptBtn.style.display="none";
    rejectBtn.style.display="none";
    logoutBtn.style.display="none"; 
    
    // Ø¥Ø®ÙØ§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø±ÙŠØ·Ø© 
    panelElement.style.display="none"; 
    updateMapHeight(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø¥Ù„Ù‰ 100vh 
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ø§Ø¦Ù…Ø©
    floatingControls.style.display="flex";
    riderContactInfo.style.display = "block";
    startRideBtn.style.display="inline-block"; // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¨Ø¯Ø¡
    finishBtn.style.display="none"; // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡
    wazeBtn.style.display="inline-block"; // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± ÙˆÙŠØ²
    wazeBtn.innerText = "ÙˆÙŠØ²: Ø§Ø°Ù‡Ø¨ Ù„Ù„Ø±Ø§ÙƒØ¨ ğŸš—"; // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø²Ø± ÙˆÙŠØ²

    // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø±Ø§ÙƒØ¨
    riderContactInfo.innerHTML = `
        <a href="tel:${r.riderPhone}" class="phone-link">
            ğŸ“ Ø§ØªØµÙ„ Ø¨Ø§Ù„Ø±Ø§ÙƒØ¨: ${r.riderPhone}
        </a>
    `;

    removeAllRideMarkers();
    
    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§Ø± Ø§Ù„Ø±Ø§ÙƒØ¨
    if(r.startLat && r.startLng && driverMarker){
        let driverLat=driverMarker.getLatLng().lat;
        let driverLng=driverMarker.getLatLng().lng;

        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø±Ø³Ù… Ù…Ø³Ø§Ø± Ø§Ù„Ø´ÙˆØ§Ø±Ø¹
        pickupRoute = await drawStreetRoute(driverLat, driverLng, r.startLat, r.startLng, '#4caf50', '10, 10'); 

        // ÙˆØ¶Ø¹ Ù…Ø¤Ø´Ø± Ø§Ù„Ø±Ø§ÙƒØ¨
        passengerMarker=L.marker([r.startLat, r.startLng]).addTo(map).bindPopup("ğŸ‘¤ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø±Ø§ÙƒØ¨");
        map.setView([r.startLat, r.startLng], 14); // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§ÙƒØ¨
    }

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¹Ø±Ø¶ Ù…Ø®ØªØµØ± 
    const shortStartArea = getShortAreaName(r.startArea);
    // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø¬ÙˆÙ… Ù‡Ù†Ø§
    statusText.innerHTML=`ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø­Ù„Ø©. ÙÙŠ Ø·Ø±ÙŠÙ‚Ùƒ Ù„Ù„Ø±Ø§ÙƒØ¨ (${shortStartArea})...`;


    // Ø²Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© ÙŠÙ‚ÙˆÙ… ÙÙ‚Ø· Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
    startRideBtn.onclick=function(){
        db.ref("rides/"+id).update({status:"Ø¨Ø¯Ø£Øª"});
    };
    
    // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© (Ù„Ù…Ù†Ø¹ Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¹Ø±Ø¶ÙŠ)
    finishBtn.onclick=function(){
        db.ref("rides/"+id).update({status:"Ù…Ù†ØªÙ‡ÙŠØ©"});
    };
}

// Ø¬Ø¹Ù„ Ø§Ù„Ø¯Ø§Ù„Ø© ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù†Ø© (async) Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… fetch
async function handleStartedRide(id,r){
    currentRideId=id;
    currentRideData=r;
    
    // Ø¥Ø®ÙØ§Ø¡ Ø£Ø²Ø±Ø§Ø± Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    acceptBtn.style.display="none";
    rejectBtn.style.display="none";
    logoutBtn.style.display="none";
    
    // Ø¥Ø®ÙØ§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø±ÙŠØ·Ø© 
    panelElement.style.display="none"; 
    updateMapHeight(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø¥Ù„Ù‰ 100vh 
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ø§Ø¦Ù…Ø©
    floatingControls.style.display="flex";
    riderContactInfo.style.display = "block";
    startRideBtn.style.display="none";
    finishBtn.style.display="inline-block"; // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡
    wazeBtn.style.display="inline-block"; // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± ÙˆÙŠØ²
    wazeBtn.innerText = "ÙˆÙŠØ²: Ø§Ø°Ù‡Ø¨ Ù„Ù„ÙˆØµÙˆÙ„ ğŸ"; // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø²Ø± ÙˆÙŠØ²

    removeAllRideMarkers(); // Ù…Ø³Ø­ Ø£ÙŠ Ù…Ø³Ø§Ø±Ø§Øª Ø³Ø§Ø¨Ù‚Ø© (Ù…Ø«Ù„ Ù…Ø³Ø§Ø± Ø§Ù„Ù‚Ø¨ÙˆÙ„)

    // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø±Ø§ÙƒØ¨
    riderContactInfo.innerHTML = `
        <a href="tel:${r.riderPhone}" class="phone-link">
            ğŸ“ Ø§ØªØµÙ„ Ø¨Ø§Ù„Ø±Ø§ÙƒØ¨: ${r.riderPhone}
        </a>
    `;
    
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¹Ø±Ø¶ Ù…Ø®ØªØµØ± 
    const shortEndArea = getShortAreaName(r.endArea);
    // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø¬ÙˆÙ… Ù‡Ù†Ø§
    statusText.innerHTML=`Ø§Ù„Ø±Ø­Ù„Ø© Ø¨Ø¯Ø£Øª! Ø§Ù„ÙˆØ¬Ù‡Ø©: ${shortEndArea}`;
    
    // Ù…Ø³Ø§Ø± Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© (Ù…Ù† Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø¥Ù„Ù‰ Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„)
    if(r.startLat && r.startLng && r.endLat && r.endLng){
        let startLat=r.startLat;
        let startLng=r.startLng;
        let endLat=r.endLat;
        let endLng=r.endLng;
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø±Ø³Ù… Ù…Ø³Ø§Ø± Ø§Ù„Ø´ÙˆØ§Ø±Ø¹
        destinationRoute = await drawStreetRoute(startLat, startLng, endLat, endLng, '#1e88e5');

        // ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø± Ø§Ù„Ø±Ø§ÙƒØ¨ Ù„ÙŠÙƒÙˆÙ† ÙÙŠ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
        passengerMarker=L.marker([startLat, startLng]).addTo(map).bindPopup("ğŸŸ¢ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©").openPopup();
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø± Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
        L.marker([endLat, endLng]).addTo(map).bindPopup("ğŸ Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ©");
        map.fitBounds([[startLat, startLng], [endLat, endLng]]); // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
    }

    // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©
    finishBtn.onclick=function(){
        db.ref("rides/"+id).update({status:"Ù…Ù†ØªÙ‡ÙŠØ©"});
        // Ø§Ù„ØªÙ†Ø¸ÙŠÙ ÙŠØªÙ… ÙÙŠ Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    };
}
// ===============================================
</script>

</body>
</html>
