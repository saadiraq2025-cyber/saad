<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¨Ù„ÙŠ ÙƒØ§Ø¨ØªÙ†</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        :root { --baly-yellow: #FFD200; --baly-dark: #1A1A1A; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; overflow: hidden; }
        #map { height: 100%; width: 100%; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠ */
        #topStatus {
            position: absolute; top: 15px; left: 15px; right: 15px;
            background: var(--baly-dark); color: white; padding: 12px;
            border-radius: 12px; text-align: center; z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); font-weight: bold;
        }

        /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ù…Ù†Ø¨Ø«Ù‚Ø© Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„) */
        #requestCard {
            position: absolute; bottom: 20px; left: 15px; right: 15px;
            background: white; border-radius: 20px; padding: 25px;
            z-index: 2000; box-shadow: 0 -5px 25px rgba(0,0,0,0.2);
            display: none; transform: translateY(110%); transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #requestCard.active { transform: translateY(0); display: block; }

        .btn-accept {
            background: var(--baly-yellow); border: none; width: 80px; height: 80px;
            border-radius: 50%; font-weight: bold; font-size: 16px; cursor: pointer;
            box-shadow: 0 5px 15px rgba(255, 210, 0, 0.4); margin-top: 15px;
        }

        .ride-details { margin: 15px 0; border-top: 1px solid #eee; padding-top: 15px; }
        .location-item { display: flex; align-items: center; margin: 8px 0; font-size: 14px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; margin-left: 10px; }

        /* Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¹Ø§Ø¦Ù… Ù„Ù„Ø³Ø§Ø¦Ù‚ */
        #driverControls {
            position: absolute; bottom: 20px; left: 15px; right: 15px;
            z-index: 1500; display: none;
        }
        .btn-action {
            width: 100%; padding: 18px; border-radius: 12px; border: none;
            font-weight: bold; font-size: 18px; cursor: pointer; margin-top: 10px;
        }
    </style>
</head>
<body>

<div id="topStatus">Ø£Ù†Øª Ø§Ù„Ø¢Ù† Ù…ØªØµÙ„ - Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø­Ù„Ø©</div>
<div id="map"></div>

<div id="requestCard">
    <div style="text-align:center;">
        <div style="color: #888; font-size: 12px;">Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯</div>
        <div id="fareEstimate" style="font-size: 28px; font-weight: 900;">0 Ø¯.Ø¹</div>
    </div>
    
    <div class="ride-details">
        <div class="location-item"><span class="dot" style="background: #00c853;"></span> <span id="fromLoc">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span></div>
        <div class="location-item"><span class="dot" style="background: #ff3d00;"></span> <span id="toLoc">Ø§Ù„ÙˆØ¬Ù‡Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</span></div>
    </div>

    <div style="display: flex; justify-content: space-around; align-items: center;">
        <button onclick="rejectRide()" style="background: none; border: none; color: #888;">ØªØ¬Ø§Ù‡Ù„</button>
        <button class="btn-accept" id="confirmAccept">Ù‚Ø¨ÙˆÙ„</button>
    </div>
</div>

<div id="driverControls">
    <button id="startRideBtn" class="btn-action" style="background: var(--baly-yellow);">ğŸš¦ Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø­Ù„Ø© (Ø§Ù„Ø±Ø§ÙƒØ¨ ØµØ¹Ø¯)</button>
    <button id="finishRideBtn" class="btn-action" style="display:none; background: #1e88e5; color: white;">ğŸ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©</button>
    <button onclick="openWaze()" class="btn-action" style="background: #eee;">ğŸ—ºï¸ ÙØªØ­ Ø§Ù„Ø®Ø±ÙŠØ·Ø© (Waze)</button>
</div>

<script>
// Firebase ÙˆØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© (Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù…Ø¹ ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØµÙ…ÙŠÙ…)
const app=firebase.initializeApp({
  apiKey:"AIzaSyBZy7GTKn62CqeXAgm2fLrXI67P4Lc4Q3M",
  authDomain:"taxi-15314.firebaseapp.com",
  databaseURL:"https://taxi-15314-default-rtdb.firebaseio.com/",
  projectId:"taxi-15314"
});
const db=firebase.database();

let map=L.map('map', {zoomControl: false}).setView([33.3152,44.3661],13);
L.tileLayer("https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}&key=AIzaSyD7TtwniAdUtB8-pnTny4ZwE6gqX36SGUk").addTo(map);

let driverMarker = L.marker([33.3152,44.3661]).addTo(map);
let currentRideId = null;
const driverPhone = localStorage.getItem("phone");

// ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¦Ù‚
setInterval(() => {
    navigator.geolocation.getCurrentPosition(pos => {
        const {latitude, longitude} = pos.coords;
        driverMarker.setLatLng([latitude, longitude]);
        db.ref("drivers/"+driverPhone).set({lat: latitude, lng: longitude, status: "Ù…ØªØµÙ„"});
    });
}, 5000);

// Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª
db.ref("rides").on("value", snap => {
    const rides = snap.val();
    if(!rides) return;

    Object.keys(rides).forEach(id => {
        const r = rides[id];
        if(r.status === "Ø¬Ø¯ÙŠØ¯Ø©" && !currentRideId) {
            showRequest(id, r);
        } else if(r.status === "Ù…Ù‚Ø¨ÙˆÙ„Ø©" && r.driverPhone === driverPhone) {
            showActiveRide(id, r);
        } else if(r.status === "Ø¨Ø¯Ø£Øª" && r.driverPhone === driverPhone) {
            showInRoute(id, r);
        }
    });
});

function showRequest(id, r) {
    currentRideId = id;
    document.getElementById('fromLoc').innerText = "Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø±Ø§ÙƒØ¨ (ÙŠØ¨Ø¹Ø¯ " + r.distance + " ÙƒÙ…)";
    document.getElementById('fareEstimate').innerText = r.fare.toLocaleString() + " Ø¯.Ø¹";
    document.getElementById('requestCard').classList.add('active');
    
    document.getElementById('confirmAccept').onclick = () => {
        db.ref("rides/"+id).update({status: "Ù…Ù‚Ø¨ÙˆÙ„Ø©", driverPhone: driverPhone});
        document.getElementById('requestCard').classList.remove('active');
    };
}

function showActiveRide(id, r) {
    document.getElementById('topStatus').innerText = "ØªÙˆØ¬Ù‡ Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø±Ø§ÙƒØ¨";
    document.getElementById('driverControls').style.display = "block";
    document.getElementById('startRideBtn').style.display = "block";
    document.getElementById('finishRideBtn').style.display = "none";
    
    document.getElementById('startRideBtn').onclick = () => {
        db.ref("rides/"+id).update({status: "Ø¨Ø¯Ø£Øª"});
    };
}

function showInRoute(id, r) {
    document.getElementById('topStatus').innerText = "ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ù„Ù„ÙˆØ¬Ù‡Ø©";
    document.getElementById('startRideBtn').style.display = "none";
    document.getElementById('finishRideBtn').style.display = "block";
    
    document.getElementById('finishRideBtn').onclick = () => {
        db.ref("rides/"+id).update({status: "Ù…Ù†ØªÙ‡ÙŠØ©"});
        location.reload();
    };
}

function rejectRide() {
    document.getElementById('requestCard').classList.remove('active');
    currentRideId = null;
}

function openWaze() {
    // ÙƒÙˆØ¯ ÙØªØ­ ÙˆÙŠØ² Ø§Ù„Ø³Ø§Ø¨Ù‚
}
</script>
</body>
</html>
